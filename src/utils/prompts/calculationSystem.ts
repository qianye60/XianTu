/**
 * @fileoverview AI数值计算和判定系统提示词
 * 包含属性计算公式、随机偏差、判定规则等
 */

/**
 * 数值计算系统提示词
 */
export const CALCULATION_SYSTEM_PROMPT = `
## **数值计算与判定系统 (AI必须遵循):**

### **基础属性计算公式:**

#### **生命相关:**
- **气血上限** = (根骨 × 10) + (境界等级 × 50) + 装备加成
- **气血回复** = 根骨 + (心性 ÷ 2)
- **寿命上限** = 基础寿命[境界] + (根骨 × 年龄系数) + 福缘加成

#### **修炼相关:**
- **灵气上限** = (灵性 × 15) + (境界等级 × 80) + 功法加成
- **灵气回复** = 灵性 + (悟性 ÷ 3)
- **修炼效率** = (悟性 × 0.7) + (灵性 × 0.3) + 环境系数

#### **感知相关:**
- **神识范围** = (悟性 × 5) + (境界等级 × 20) 米
- **神识强度** = 悟性 + (灵性 ÷ 2) + 功法加成

### **随机偏差系统:**

#### **行动成功率计算:**
基础成功率 = min(95%, max(5%, 基础能力值 + 气运影响 + 随机偏差))

**随机偏差范围:**
- **普通行动:** ±10
- **重要行动:** ±15  
- **关键行动:** ±20

**气运影响公式:**
- 气运影响 = (角色气运 - 5) × 2  (气运5为基准值)

#### **判定修正系数:**

**体质加成:**
- 特殊体质根据描述给予 +3 到 +8 的相关判定加成
- 例如："寒冰体质"对冰系法术 +5，对火系法术 -3

**天赋加成:**
- 相关天赋给予 +2 到 +6 的专项加成
- 例如："剑道天才"对剑法修炼和剑术战斗 +4

**灵根加成:**
- 对应属性的法术和修炼给予加成
- 单灵根：+6加成，但只对单一属性
- 双灵根：+4加成，对两种属性
- 三灵根：+2加成，对三种属性
- 四灵根及以上：+1加成，属性广泛

### **多元化胜利条件判定:**

#### **战斗外胜利方式:**

**1. 魅力诱惑 (适用条件):**
- 对方不是生死仇敌
- 对方有正常审美和欲望
- 角色魅力 ≥ 7 且有对应技能/天赋
- 成功率 = (魅力 × 10) + 技能加成 + 情境加成 - 对方意志
- **情境加成示例:**
  - 对方处于放松状态: +15
  - 有共同话题或兴趣: +10
  - 环境浪漫或私密: +8
  - 对方酒后或疲惫: +12

**2. 智慧说服:**
- 成功率 = (悟性 × 8) + (魅力 × 5) + 论据合理性 + 对方好感
- 需要合理的论据和逻辑
- 对方性格影响：固执-10，开明+10

**3. 财富收买:**
- 成功率基于提供财富与对方需求的匹配度
- 清廉者难以收买，贪婪者易于收买

**4. 威望震慑:**
- 成功率 = 角色声望等级 × 10 + 境界威压 - 对方意志
- 境界差距每级 +/-15

**5. 情报交换:**
- 提供有价值信息换取合作
- 信息价值由AI根据情况判定

### **判定结果等级:**
- **大成功 (95-100):** 超预期效果，可能触发特殊奖励
- **成功 (70-94):** 正常达成目标
- **部分成功 (40-69):** 基本达成，但有小缺陷
- **失败 (20-39):** 未达成目标，但无严重后果  
- **大失败 (1-19):** 不仅失败，还带来负面后果
- **灾难性失败 (天然1):** 意外发生，可能有严重后果
`;

/**
 * 生成角色数值状态提示词
 */
export function generateNumericalStatusPrompt(characterData: {
  baseAttributes: any; // 基础六司
  cultivation: any; // 修为状态
  talents: string[]; // 天赋列表
  constitution: string; // 体质
  spiritRoot: string; // 灵根
  fortune: number; // 气运值
}): string {
  const { baseAttributes, cultivation, talents, constitution, spiritRoot, fortune } = characterData;

  return `
## **角色数值状态:**

### **基础六司属性:**
- **根骨:** ${baseAttributes.根骨}/10 (影响气血上限和寿命)
- **灵性:** ${baseAttributes.灵性}/10 (影响灵气上限和修炼)  
- **悟性:** ${baseAttributes.悟性}/10 (影响神识和领悟)
- **福缘:** ${baseAttributes.福缘}/10 (影响机遇和宝物发现)
- **魅力:** ${baseAttributes.魅力}/10 (影响社交和诱惑)
- **心性:** ${baseAttributes.心性}/10 (影响抗压和心境)

### **特殊属性:**
- **当前气运值:** ${fortune}/10 (影响所有判定的基础修正)
- **体质类型:** ${constitution} (特定情况下的强化加成)
- **灵根类型:** ${spiritRoot} (法术和修炼的天赋加成)

### **天赋列表:**
${talents.map(talent => `- ${talent} (提供相应领域的专项加成)`).join('\n')}

### **当前修炼状态:**
- **境界:** ${cultivation.境界?.名称 || '凡人'} (等级${cultivation.境界?.等级 || 0})
- **修为进度:** ${cultivation.修为?.当前 || 0}/${cultivation.修为?.最大 || 100}
- **突破瓶颈:** ${cultivation.瓶颈状态 || '无'}

**重要提醒:** AI必须根据这些数值进行合理的成功率判定，不得无视角色能力限制。
`;
}

/**
 * 生成环境影响系数提示词
 */
export function generateEnvironmentPrompt(location: {
  name: string;
  type: string; // 类型：城镇、野外、洞府等
  spiritDensity: number; // 灵气密度 1-10
  dangerLevel: number; // 危险等级 1-10
  specialEffects?: string[]; // 特殊效果
}): string {
  const { name, type, spiritDensity, dangerLevel, specialEffects = [] } = location;

  return `
## **当前环境信息:**

### **位置:** ${name} (${type})
- **灵气密度:** ${spiritDensity}/10 (修炼效率系数: ×${(spiritDensity * 0.1 + 0.5).toFixed(1)})
- **危险等级:** ${dangerLevel}/10 (随机事件概率增加 ${dangerLevel * 10}%)

### **环境特效:**
${specialEffects.length > 0 ? 
  specialEffects.map(effect => `- ${effect}`).join('\n') : 
  '- 无特殊环境效果'}

### **环境对判定的影响:**
- **修炼相关:** 灵气密度加成 ${spiritDensity - 5 > 0 ? '+' : ''}${(spiritDensity - 5) * 2}
- **探索相关:** 危险等级修正 ${dangerLevel - 5 > 0 ? '+' : ''}${(dangerLevel - 5) * 3}
- **社交相关:** 根据环境类型调整成功率
`;
}