import { DICE_ROLLING_RULES } from '../definitions/textFormats';

/**
 * @fileoverview CoT 核心提示词 v2.1.0
 * @version 2.1.0
 * @lastUpdated 2025-11-19
 *
 * 【更新日志】
 * - v2.1.0: 优化 Intent 分析逻辑，区分指令与叙事
 * - v2.1.0: 强化 Character 步骤的动态交互推演
 * - v2.1.0: 明确 Output 步骤的数据变更逻辑
 */

export function getCotCorePrompt(userInput: string, enableActionOptions: boolean = false): string {
  return `
# 🧠 思维链 (CoT) 协议

**必须先输出 <thinking> 标签，再输出 JSON 响应。**

## 思维链模板
<thinking>
### 1. 意图分析 (Intent)
- **输入**: ${userInput || '无'}
- **类型**: 指令 / 叙事 / 混合
- **目标**: 用户想要达成什么？
- **场景**: 当前环境与状态上下文

### 2. 判定评估 (Dice)
- **触发检查**: 生死战斗/危险探索/明确风险 -> 触发；日常/对话/碾压 -> 跳过
- **要素分析**: 境界压制 | 五行相克 | 环境契合 | 道心状态
- **计算**: (属性 + 境界 + 修正 + 加成 + d20) vs 难度
- **结论**: 失败 / 成功 / 大成功 / 完美

### 3. 角色演绎 (Character)
- **核心**: 性格标签 | 身份背景 | 核心萌点
- **状态**: 好感度 | 关系阶段 | 当前情感 | 记忆回响
- **推演**: 刺激 -> 情感反应 -> 内心想法 -> 外在表现
- **原则**: 拒绝脸谱化，保持独立人格，反应符合逻辑

### 4. 质量管控 (Quality)
- **检查**: 逻辑自洽? 符合世界观? 情感自然?
- **修正**:
  - 神化主角 -> 协作共赢
  - 绝望崩溃 -> 释怀接受
  - 过度戏剧 -> 平和过渡

### 5. 输出规划 (Output)
- **叙事**: 铺垫 -> 冲突/互动 -> 高潮/转折 -> 余韵 (500-1500字)
- **指令**: add/set/push/delete (确保逻辑合理、消耗正确)
${enableActionOptions ? '- **选项**: 激进 / 保守 / 探索 / 社交 (3-4个)' : ''}
</thinking>

## 核心原则
1. **输入优先**: 倒数第二条 <行动趋向> 为真实输入，严禁忽视或替玩家决定。
2. **质量红线**: 拒绝八股化、机械化、过度反应；追求真实细节与合理情感。
3. **判定克制**: 95%场景直接叙述，仅在关键冲突/风险时判定。
4. **字数控制**: 思维链保持简洁高效，聚焦核心逻辑。
`;
}

// 保留旧的导出以兼容现有代码
export const cotCorePrompt = getCotCorePrompt('');
