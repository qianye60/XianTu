import { DICE_ROLLING_RULES } from '../definitions/textFormats';

/**
 * @fileoverview CoT 核心提示词 v5.1.0
 * @version 5.1.0
 * @lastUpdated 2025-01-14
 *
 * 【更新日志】
 * - v5.1.0: 适配 v4.0 新功能
 *   - 使用 V3 存档短路径（元数据/角色/社交/世界/系统）
 *   - 新增世界事件系统同步
 *   - 新增宗门系统相关指令
 *   - 新增联机穿越状态检查
 * - v5.0.0: 针对修仙游戏优化（渡劫/境界/修炼）
 * - v4.0.0: 全面重构思维链，增强AI感知游戏状态能力
 */

export function getCotCorePrompt(userInput: string, enableActionOptions: boolean = false): string {
  const intentMatch = userInput.match(/<行动趋向>([\s\S]*?)<\/行动趋向>/);
  const actualIntent = intentMatch ? intentMatch[1].trim() : (userInput || '无');

  return `
# 🧭 低噪声协议（无思维链）

用户意图："${actualIntent}"

## 禁止
- 绝对禁止输出：\`<thinking>\` / 思维链 / 任何推理过程标签

## 内部自检清单（不要写出来）

### 基础同步（V3短路径）
□ 位置变化 → set \`角色.位置\`
□ 时间流逝 → add \`元数据.时间.分钟\`（修炼/闭关按实际时长）
□ 灵石变化 → add \`角色.背包.灵石.下品/中品/上品/极品\`
□ 物品增删 → push/delete \`角色.背包.物品\`

### 修炼与突破
□ 日常修炼 → add \`角色.属性.境界.当前进度\`
□ 功法熟练 → add \`角色.背包.物品.[功法ID].修炼进度\`
□ 悟道进展 → add \`角色.大道.大道列表.[道名].当前经验\`
□ 小阶段突破 → set \`角色.属性.境界.阶段\`（初期→中期→后期→圆满→极境）
□ 大境界突破 → set \`角色.属性.境界.名称\` + 更新属性上限

### 渡劫系统（重要！）
□ 渡劫开始 → push \`角色.效果\` 添加"渡劫中"状态
□ 每道天雷 → add \`角色.属性.气血.当前\`（负）+ add \`角色.属性.灵气.当前\`（负）
□ 渡劫成功 → set 新境界 + 更新属性上限 + push \`社交.事件.事件记录\`
□ 渡劫失败 → 重伤/陨落处理 + push \`社交.事件.事件记录\`
⚠️ 渡劫必须多回合！每道雷劫=1+对话轮次，禁止一回合完成！

### 战斗与消耗
□ 施法/出招 → add \`角色.属性.灵气.当前\`（负，按技能消耗%）
□ 受伤 → add \`角色.属性.气血.当前\`（负）
□ 神识消耗 → add \`角色.属性.神识.当前\`（负）
□ 禁术代价 → add \`角色.属性.寿命.当前\`（负）
□ 状态效果 → push \`角色.效果\`（中毒/重伤/虚弱等）

### NPC交互
□ NPC出场 → set \`社交.关系.[NPC名]\`（完整对象）
□ 好感变化 → add \`社交.关系.[NPC名].好感度\`
□ NPC记忆 → push \`社交.关系.[NPC名].记忆\`
□ NPC状态 → set \`社交.关系.[NPC名].当前外貌状态\`
□ 实时关注NPC → 若\`实时关注\`为true，即使不在身边也要更新其位置/状态/内心想法

### 世界事件系统
□ 重大事件发生 → push \`社交.事件.事件记录\`
  格式：{事件ID,事件名称,事件类型,事件描述,影响等级,影响范围,相关人物,发生时间}
□ 事件类型：天灾/人祸/人物风波/势力变动/秘境开启/宝物出世

### 宗门系统
□ 宗门贡献 → add \`世界.宗门.贡献点\`
□ 宗门声望 → add \`世界.宗门.声望\`
□ 宗门任务 → push/pull \`社交.任务.当前任务列表\`

### 特殊事件
□ 机缘获得 → push \`角色.背包.物品\`
□ 声望变化 → add \`角色.属性.声望\`

## 行动选项
- 若启用：输出 \`action_options\`（3-5个）
- 若未启用：不要输出 \`action_options\`

${DICE_ROLLING_RULES}
`;
}

// 保留旧的导出以兼容现有代码
export const cotCorePrompt = getCotCorePrompt('');
