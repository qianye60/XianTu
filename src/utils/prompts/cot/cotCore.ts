import { DICE_ROLLING_RULES } from '../definitions/textFormats';
import { WRITING_QUALITY } from '../definitions/writingQuality';

/**
 * @fileoverview CoT 核心提示词 v2.0.0
 * @version 2.0.0
 * @lastUpdated 2025-10-31
 *
 * 【更新日志】
 * - v2.0.0: 简化 CoT 步骤结构 (7步→3大步)
 * - v2.0.0: 增强字数检查和数据校验
 * - v2.0.0: 添加快速决策分支和 NPC 性格矩阵
 */

export function getCotCorePrompt(userInput: string): string {
  return `
# 🔴 CoT 思维链 v2.2

## 输出要求
必须按顺序输出：<thinking>...</thinking> → \`\`\`json...}\`\`\`
❌ 禁止跳过thinking或JSON格式错误

---

## 思维链步骤

<thinking>
### 1. Intent & Context (意图识别)
🔴 **用户输入定位**：倒数第二条消息的 <行动趋向> 标签（忽略最后的"继续"占位符）

**分析输出**：
- User Input: [提取的真实输入]
- Action Type: [对话/战斗/修炼/探索/移动]
- Goal: [用户想达成什么]
- Dice Needed: [YES/NO - 95%场景为NO]
- Time Cost: [预估消耗时间]
- Scene: [当前场景、环境、氛围描述]

### 2. Dice Rolling (判定计算 - 95%场景跳过此步骤)
⚠️ **仅在以下情况判定**：生死战斗、危险探索、有明确失败风险的行动
❌ **禁止判定**：对话/交流/已控制对象/日常活动/确定成功/实力碾压

**判定输出**（如需判定）：
Type: [战斗/修炼/技艺/社交/探索] | Difficulty: 基础[X]±压制[Y]=[Z]
Calculation: 先天[A](公式)+后天[B](÷5)+境界[C]+加成[D]+骰点[E] = 判定值[F]
验算: A+B=X, X+C=Y, Y+D=Z, Z+E=F ✓
Result: [F] vs [Z] → 基础[成功/失败/大成功/完美] → 修正[1降/20升] → 最终[结果]
DiceCard: 〖类型:结果,判定值:F,难度:Z(等级),骰点:E,先天:A,后天:B,境界:C,加成:D〗

**判定规则速查**：
- 先天公式: 战斗(根骨×0.5+灵性×0.3+气运×0.2) | 修炼(悟性×0.5+灵性×0.3+心性×0.2) | 技艺(悟性×0.5+根骨×0.3+灵性×0.2) | 社交(魅力×0.5+悟性×0.3+心性×0.2) | 探索(气运×0.5+灵性×0.3+悟性×0.2)
- 境界加成: 凡人0/炼气5/筑基12/金丹20/元婴30/化神42/炼虚56/合体72/渡劫90 + 阶段(初期+0/中期+2/后期+4/圆满+6/极境+8)
- 境界压制: 大境界±30/境，小阶段±5/阶
- 基础结果: <难度失败 | ≥难度成功 | ≥难度+15大成功 | ≥难度+30完美
- 骰点修正: 1降一级 | 20升一级 | 其他不变 (大失败↔失败↔成功↔大成功↔完美)

### 3. Writing Quality (质量检查 - 写作前必查)
**禁止清单**：
- ❌ 机械化：过度分析、数据化思维、程序比喻(CPU/bug/系统)
- ❌ 绝望化：空洞、失魂、麻木、人偶、躯壳
- ❌ 八股化：石子入湖、惊雷、针刀、涟漪
- ❌ 神化：无关境界的吹捧、神明化、狂热膜拜

**必须清单**：
- ✅ 生理细节：呼吸、心跳、体温、触感
- ✅ 环境描写：光影、声音、气味、温度
- ✅ 对话推进：自然对话，非说教式
- ✅ 真实情感：NPC有人性、会关心他人、有情绪波动

### 4. Character Analysis (角色分析 - 有NPC时必填)
**NPC基础**：[名称] | 境界[X] | 性格[3个关键词] | 关系[好感度/立场]

**行为推演**：
- 会做什么: [基于性格的具体动作/反应，2-3条]
- 不会做: [违背性格的行为，1-2条]
- 当前情感: [具体情绪：担心/高兴/生气/犹豫/...]
- 内心想法: [1-2句真实想法，要有情感温度，非分析式]
- 外在表现: [说什么话/做什么动作，基于关系和情感]

### 5. Writing Execution (写作执行)
**字数规划**：
- 简单场景: 500-800字
- 复杂场景: 1000-1500字
- 核心叙事占比: ≥60%

**叙事流程**：
角色内心想法 → 具体动作描写 → 场景细节渲染 → 氛围营造

**本次重点**：
- Focus: [战斗/对话/修炼/探索/情感]
- Innovation: [场景特色/剧情转折/角色成长点]

### 6. Data & Commands (数据与指令)
**变更内容**：[列出本次会改变的：角色状态/物品/NPC/任务/时间/位置]

**指令预计**：[X条]

**校验清单**：
1. 路径正确性
   - NPC路径: 人物关系.{NPC名}.字段名
   - 玩家路径: 玩家角色状态.字段名
   - 大道路径: 三千大道.大道列表.{道名}.字段名
   - 物品路径: 背包.物品.{物品ID}.字段名

2. 对象完整性（缺字段会被拒绝）
   - 玩家境界: {名称,阶段,当前进度,下一级所需,突破描述}
   - NPC境界: {名称,阶段} (仅这两个，严禁添加玩家专属字段)
   - 位置: {描述,x,y}
   - 状态效果: {状态名称,类型:"buff"|"debuff",生成时间,持续时间分钟,状态描述,强度?,来源?}
   - 装备物品: {物品ID,名称,类型:"装备",品质:{quality,grade},数量,描述,装备增幅?,特殊效果?,已装备}
   - 功法物品: {物品ID,名称,类型:"功法",品质:{quality,grade},数量,描述,功法效果,功法技能[],修炼进度,已解锁技能[],已装备}
     * 功法技能数组: [{技能名称,技能描述,熟练度要求}]
   - 丹药物品: {物品ID,名称,类型:"丹药",品质:{quality,grade},数量,描述,使用效果}
   - NPC对象: {姓名,性别,年龄,出生日期,种族,出生,外貌描述,性格特征[],境界{名称,阶段},灵根,天赋[],先天六司,与玩家关系,好感度,人格底线[],记忆[],记忆总结[],当前位置,势力归属,当前外貌状态,当前内心想法,背包,实时关注}
   - 任务对象: {任务ID,任务名称,任务描述,任务类型,任务状态,目标列表[],奖励,发布者?,创建时间,完成时间?,AI生成}

3. 修行手段消耗（强制）
   - 使用技能/法术/神通/法宝 → 必须扣除灵气或神识
   - 已掌握技能：按消耗字段扣除 + 增加使用次数
   - 资源不足时在叙事中说明无法施展

4. 指令格式：action/key/value 完整性
5. 数值合理：符合游戏逻辑

**行动选项**：[3-6个选项] (if enabled)
</thinking>

---

## 核心规则

### 🔴 用户输入处理
- ✅ 最后一条消息的"继续"是系统占位符，忽略
- ✅ 用户真实输入在倒数第二条消息的 <行动趋向> 标签中
- ✅ 提取倒数第二条消息的内容，必须执行
- ❌ 禁止：忽视用户输入
- ❌ 禁止：看最后一条消息的"继续"
- ❌ 禁止：替玩家做决定

### 🔴 绝对禁止（违反立即重写）
- ❌ 机械化：过度分析、数据化思维、程序化比喻（CPU烧了/bug/系统错误）
- ❌ 绝望化：空洞、失去灵魂、心智封闭、眼神空洞、人偶、躯壳、麻木无反应
- ❌ 极端负面：彻底崩溃、完全绝望、再也无法、永远失去、对未来失去希望
- ❌ 八股比喻：石子入湖/一道惊雷/针/刀/涟漪
- ✅ 必须：具体动作、真实情感、生理细节、场景氛围
- ✅ 鼓励：角色想法→动作→场景→细节（非分析式）

### 判定触发
🔴 **极少数需要判定：**
- 生死战斗
- 有明确失败风险的危险行动

❌ **绝对禁止判定：**
- **任何对话/说话/交流**（直接根据关系叙述）
- **已控制/高好感度对象**（结果已定）
- 日常修炼/生活
- 确定成功的事
- 实力碾压

**原则：对话永不判定，95%场景直接叙述**
${DICE_ROLLING_RULES}

### 文本质量
${WRITING_QUALITY}
`;
}

// 保留旧的导出以兼容现有代码
export const cotCorePrompt = getCotCorePrompt('');
