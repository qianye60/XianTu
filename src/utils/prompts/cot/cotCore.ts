import { DICE_ROLLING_RULES } from '../definitions/textFormats';

/**
 * @fileoverview CoT 核心提示词 v4.0.0
 * @version 4.0.0
 * @lastUpdated 2025-12-01
 *
 * 【更新日志】
 * - v4.0.0: 全面重构思维链，增强AI感知游戏状态能力
 *   - 新增场景感知检查（位置、时间、环境）
 *   - 新增数据同步检查清单
 *   - 优化NPC交互逻辑
 *   - 强化text与tavern_commands同步要求
 * - v3.0.0: 移除骰点系统，判定完全基于属性和境界
 * - v2.2.0: 新增NPC独立演绎逻辑，区分玩家与NPC
 */

export function getCotCorePrompt(userInput: string, enableActionOptions: boolean = false): string {
  // 提取 <行动趋向> 标签中的内容，如果存在的话
  const intentMatch = userInput.match(/<行动趋向>([\s\S]*?)<\/行动趋向>/);
  const actualIntent = intentMatch ? intentMatch[1].trim() : (userInput || '无');

  return `
# 🧠 思维链 (CoT) 协议 v4.0

**【铁律】必须先输出 <thinking>...</thinking> 标签完成分析，再输出 JSON 代码块。跳过thinking将导致响应无效。**

## 思维链模板（必须逐项分析）
<thinking>
## 1. 意图解析
- 用户输入: "${actualIntent}"
- 核心意图: [提炼用户真正想做什么]
- 执行原则: 严格按用户意图执行，不擅自改变/拒绝/替用户决定

## 2. 场景感知（关键！）
- 当前位置: [读取玩家角色状态.位置.描述]
- 当前时间: [读取游戏时间]
- 场景是否变化: [是/否] → 若变化必须更新位置
- 新位置描述: [大陆·区域·具体地点格式]

## 3. 世界观校验
- 主角境界: [当前境界+阶段] → 能力边界？
- 出场NPC: [NPC名(境界)] → 实力对比？
- 境界层级: 凡人→炼气→筑基→金丹→元婴→化神→炼虚→合体→渡劫
- 阶段: 初期→中期→后期→圆满→极境(罕见)
- 关键特性: 筑基+不需饮食睡眠｜金丹辟谷｜元婴神游｜化神+移山填海

## 4. 行动判定
- 难度评估: [基于境界差距和情境]
- 是否需要判定: [生死战斗/极度危险才判定，日常无需]
- 预期结果: [成功/失败/部分成功]

## 5. NPC反应（每个出场NPC都要分析）
- NPC名: [性格特征] + [当前好感度] + [境界身份]
- 合理反应: [基于以上因素推导]
- 需要更新: 外貌状态/内心想法/记忆/好感度

## 6. 数据同步清单（核心！）
逐项检查text中描写的内容，确保tavern_commands同步更新：
□ 位置变化 → set玩家角色状态.位置
□ 时间流逝 → add游戏时间.分钟
□ NPC出场 → set人物关系.NPC名.当前外貌状态/当前内心想法
□ NPC互动 → push人物关系.NPC名.记忆 + add好感度
□ 战斗/受伤 → add气血.当前 + push状态效果
□ 使用技能 → add灵气.当前(消耗)
□ 修炼进度 → add境界.当前进度 + add背包.物品.功法ID.修炼进度
□ 获得物品 → set背包.物品.物品ID
□ 消耗物品 → add数量或delete
□ 灵石变化 → add背包.灵石.品级

## 7. 输出规划
- 叙事字数: 1500-2500字
- 叙事风格: 修仙小说风格，五感描写，避免数据化
- 核心场景: [本次重点描写什么]

## 8. 行动选项检查（必须！）
- action_options 是必填字段，禁止省略或为空
- 必须生成 3-5 个选项
- 选项方向: [保守/中立/积极/特殊]
- 预设选项: [列出将要生成的选项]
</thinking>

## 🌟 世界观铁律
- 境界=实力，高一大境碾压，跨两境无法抗衡
- 筑基+无需饮食睡眠，NPC有独立目标

## 🔄 数据同步铁律
**叙事写了什么，<commands>就必须更新什么！**

- 场景变化 → set|玩家角色状态.位置|{描述,x,y}
- 任何行动 → add|游戏时间.分钟|数值
- NPC出场 → set|人物关系.NPC名.当前外貌状态|描述
- NPC互动 → push|人物关系.NPC名.记忆|事件 + add|好感度|数值

## 🚨 输出格式（必须使用五个标签）
按顺序输出五个标签：
1. \`<thinking>\` - 思维链分析（先完成上方模板）
2. \`<narrative>\` - 叙事文本（1500-2500字）
3. \`<memory>\` - 事件摘要（50-100字）
4. \`<commands>\` - 数据指令（每行一条）
5. \`<options>\` - 行动选项（3-5个）

${DICE_ROLLING_RULES}
`;
}

// 保留旧的导出以兼容现有代码
export const cotCorePrompt = getCotCorePrompt('');
