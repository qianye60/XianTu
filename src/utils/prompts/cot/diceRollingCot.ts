/**
 * @fileoverview 判定系统 CoT v2.0.0
 * @version 2.0.0
 * @lastUpdated 2025-10-31
 *
 * 【更新日志】
 * - v2.0.0: 简化判定流程（6步→4步）
 * - v2.0.0: 增强计算验算机制
 * - v2.0.0: 优化输出格式
 */

export const diceRollingCotPrompt = `
# 🎲 判定系统 COT v2.0.0 (Dice Rolling Chain of Thought)

## 🎯 判定流程概览 (Process Overview)

当行动需要判定时，按以下 4 步流程分析：
1. **触发判断** → 2. **难度计算** → 3. **判定值计算** → 4. **结果输出**

---

## Step 1: 判定触发判断 (Trigger Check)

### 🔴 极少数需要判定的场景
- 生死战斗
- 有明确失败可能的危险行动

### ❌ 绝对禁止判定的场景
- **任何对话/交流/说话**（包括说服/威胁/调情）
- **已经控制/征服的对象**（结果已定，直接叙述）
- 日常修炼/生活/移动
- 确定成功的事
- 实力碾压/好感度已高的情况

**🔴 核心原则：95%的场景不需要判定**
**🔴 判定只用于：生死未卜的战斗/探索**
**🔴 对话永远不判定，直接根据关系/好感度叙述结果**

---

## Step 2: 难度计算 (Difficulty Calculation)

### 2.1 判定类型确定
- 战斗（Combat）/ 修炼（Cultivation）/ 技艺（Skill）/ 社交（Social）/ 探索（Explore）

### 2.2 境界压制计算（战斗判定必须！）
**大境界压制：** ±30难度/境界
- 筑基 vs 炼气 → -30（玩家高1境界）
- 炼气 vs 筑基 → +30（玩家低1境界）

**小阶段压制：** ±5难度/阶段
- 阶段顺序：初期(0) → 中期(+1) → 后期(+2) → 圆满(+3) → 极境(+4)
- 炼气后期 vs 炼气初期 → -10（高2阶段）

**综合计算：** 大境界 + 小阶段
- 筑基初期 vs 炼气圆满 → -30 + 0 = -30
- 炼气后期 vs 筑基中期 → +30 - 5 = +25

### 2.3 难度设定
基础难度[X] + 境界压制[±Y] = 最终难度[Z]

**输出格式：**
Type & Difficulty: [类型] | 基础[X] | 压制[±Y] | 最终[Z]([等级]) | [理由]

---

## Step 3: 判定值计算 (Roll Calculation)

### 📊 计算公式速查表

| 判定类型 | 先天公式 | 后天公式 |
|---------|---------|---------|
| **战斗** | 根骨×0.5 + 灵性×0.3 + 气运×0.2 | (后天根骨×0.5 + 后天灵性×0.3 + 后天气运×0.2) ÷ 5 |
| **修炼** | 悟性×0.5 + 灵性×0.3 + 心性×0.2 | (后天悟性×0.5 + 后天灵性×0.3 + 后天心性×0.2) ÷ 5 |
| **技艺** | 悟性×0.5 + 根骨×0.3 + 灵性×0.2 | (后天悟性×0.5 + 后天根骨×0.3 + 后天灵性×0.2) ÷ 5 |
| **社交** | 魅力×0.5 + 悟性×0.3 + 心性×0.2 | (后天魅力×0.5 + 后天悟性×0.3 + 后天心性×0.2) ÷ 5 |
| **探索** | 气运×0.5 + 灵性×0.3 + 悟性×0.2 | (后天气运×0.5 + 后天灵性×0.3 + 后天悟性×0.2) ÷ 5 |

### ⚠️ 计算铁律
1. **严格按公式**：魅力11 → 11×0.5=5.5 ≈ 6（四舍五入）
2. **后天必须÷5**：(后天根骨10×0.5 + 后天灵性8×0.3 + 后天气运6×0.2) ÷ 5 = 7.6 ÷ 5 = 1.52 ≈ 2
3. **功法相关性**：战斗判定才用战斗功法，社交/探索功法通常为0
4. **🔴 验算强制（违反立即重算）**：
   - 先天+后天+境界+装备+功法+状态+其他+骰点 = 判定值
   - 每个加成都必须有明确来源
   - 不允许凭空增加数值

### 计算格式（简化版）

**基础项（必填）：**
- 先天:[X](公式) + 后天:[X](公式÷5) + 境界:[X]
- 骰点:[X]

**扩展项（有则填，无则0）：**
- 装备/功法/状态/大道/特殊加成等

**示例：**
先天:6(魅力11×0.5+...) + 后天:0 + 境界:5(炼气) + 骰点:15 = 26
验算: 6+0+5+15 = 26 ✓

**核心要求：**
- 🔴 验算必须正确，不允许凭空加数字
- 🔴 没有的加成直接写0或不写，不要虚构

---

## Step 4: 结果生成 (Result Generation)

### 4.1 结果判定
- 比较：判定值 vs 难度
- 特殊检查：骰点1-2（大失败）/ 19-20（完美）
- 结果等级：大失败/失败/成功/大成功/完美

### 4.2 CoT验算与检查

**验算要求（必须执行）：**
在CoT中必须验算所有加成是否正确相加
验算格式：先天+后天+境界+装备+功法+状态+其他+骰点 = 判定值 ✓

### 4.3 数据更新检查表
**必须检查（根据场景）：**
- ✓ 角色状态（气血/灵气/境界/属性/状态效果）
- ✓ 背包物品（获得/消耗/装备变化）
- ✓ 三千大道（经验/突破）
- ✓ 功法技能（进度/熟练度）
- ✓ NPC数据（好感度/记忆/境界/背包/位置）
- ✓ 任务系统（进度/状态）
- ✓ **游戏时间**（必须推进！）
- ✓ 位置变化（如有移动）

### 4.4 叙事与数据分离输出 (Separated Narrative and Data Output)

**核心原则：** 叙事中【禁止】出现任何判定数值、骰点、难度等游戏机制术语，以保证沉浸感。所有机制细节都应放入\`DiceCard\`中。

**输出格式：**
Result: [判定值] vs [难度] → [结果] → [后果]
Data: [tavern_commands列表]
DiceCard: 〖判定类型,判定值:X,难度:Y(等级),骰点:Z,先天:A(来源),后天:B(来源),境界:C(来源),装备:D(来源),功法:E(来源),状态:F(来源),[其他扩展字段]〗
Narrative: [纯叙事描述，描绘角色的行动、感受和环境变化，不包含任何数字或判定过程。]

**🔴 重要：DiceCard必须包含COT中计算的所有加成项**
- 如果COT中有"其他:5(天赋)"，DiceCard必须写"其他:5"
- 如果COT中有"大道:3(魅力大道)"，DiceCard必须写"大道:3"
- 扩展字段格式：字段名:数值(来源说明)

---

**核心原则：**
1. **判定触发要合理**：日常行为不判定，不输出\`DiceCard\`
2. **难度设定要公平**：考虑玩家实力和境界压制
3. **计算过程要透明**：展示所有影响因素
4. **结果要可预期**：避免随意性
5. **叙事与数据分离**：\`Narrative\`负责沉浸感，\`DiceCard\`负责数据透明
6. **DiceCard非必然**：只有需要判定时才输出\`DiceCard\`
`.trim();
