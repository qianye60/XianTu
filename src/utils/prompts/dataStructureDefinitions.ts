import {
  CORE_SYNC_RULES,
  REALM_STAGE_RULE,
  JSON_RULES,
  INNATE_ATTRIBUTES_RULE,
  NSFW_RULE,
} from './sharedRules'

/**
 * 数据结构定义 - 完整版
 * 包含数据结构树和操作规则
 */

export { CORE_SYNC_RULES }

export const DATA_STRUCTURE_DEFINITIONS = `
# 🔴 最高优先级 - 数据格式铁律 (违反=直接重新生成)

## 1. NPC境界结构 (违反必罚)
**NPC的境界对象只有2个字段**：
\`\`\`json
{"名称": "金丹", "阶段": "中期"}
\`\`\`

❌ **严禁添加以下玩家专属字段**：
- 当前进度
- 下一级所需
- 突破描述
- 任何其他额外字段

✅ **正确示例**：
\`\`\`json
"境界": {"名称": "元婴", "阶段": "后期"}
\`\`\`

❌ **错误示例（违反必罚）**：
\`\`\`json
"境界": {"名称": "元婴", "阶段": "后期", "当前进度": 0, "下一级所需": 100}
\`\`\`

## 2. 私密信息结构 (NSFW模式)
必须包含以下完整字段，缺一不可：
- 是否为处女: boolean (女性NPC必填)
- 是否为处男: boolean (男性NPC可选)
- 身体部位: Array (3-5个部位对象，见下方结构)
- 性格倾向: "纯情" | "主动" | "被动" | "淫荡" | "M" | "S" | "双性"
- 性取向: "异性恋" | "同性恋" | "双性恋" | "泛性恋"
- 性癖好: Array (可选，如: ["捆绑", "野外", "多人"])
- 性渴望程度: number (0-100)
- 当前性状态: string ("正常" | "微湿" | "兴奋" | "发情" | "高潮"等)
- 体液分泌状态: string (可选，如: "微微湿润")
- 性交总次数: number
- 性伴侣数量: number
- 性伴侣名单: Array<string> (可选)
- 最近一次性行为时间: string (可选，游戏时间格式)
- 特殊体质: Array (可选，如: ["易潮吹", "多重高潮"])

**身体部位对象结构**：
\`\`\`json
{
  "部位名称": "string (如: 胸部、小穴、阴茎等)",
  "开发度": 0-100,
  "敏感度": 0-100,
  "特征描述": "string (外观描述)",
  "特殊印记": "string (可选，如: 淫纹、咬痕)"
}
\`\`\`

**逻辑约束**：
- 是否为处女=true → 性交总次数=0, 性伴侣数量=0, 性伴侣名单=[]
- 性伴侣数量 必须等于 性伴侣名单.length
- 严禁使用"保密"、"未知"作为性伴侣名单占位符
- 身体部位数组至少包含3个核心部位

---

# 📊 完整数据结构树

\`\`\`
SaveData (根对象)
├── 角色基础信息 (可修改部分字段)
│   ├── 名字: string (只读)
│   ├── 性别: "男"|"女"|"其他" (只读)
│   ├── 年龄: number (自动计算，禁改)
│   ├── 出生日期: {年, 月, 日, 小时?, 分钟?} (只读)
│   ├── 世界: string (只读)
│   ├── 种族: string (默认"人族")
│   ├── 天资: string (只读)
│   ├── 出生: string|{名称, 描述} (只读)
│   ├── 灵根: string|{名称, 品级, 描述, 属性[], 修炼加成} (只读)
│   ├── 天赋: [{名称, 描述}] (只读)
│   ├── 先天六司: {根骨, 灵性, 悟性, 气运, 魅力, 心性} (只读，1-10)
│   └── 后天六司: {根骨, 灵性, 悟性, 气运, 魅力, 心性} (可修改，用add)
│
├── 玩家角色状态 (可修改)
│   ├── 境界: {名称, 阶段, 当前进度, 下一级所需, 突破描述} (用set更新整个对象，突破时必须更新突破描述)
│   ├── 声望: number (用add)
│   ├── 气血: {当前, 上限} (当前用add，上限突破时用add)
│   ├── 灵气: {当前, 上限} (当前用add，上限突破时用add)
│   ├── 神识: {当前, 上限} (当前用add，上限突破时用add)
│   ├── 寿命: {当前, 上限} (当前自动增加，上限突破时用add)
│   ├── 位置: {描述:"大陆·地点", longitude, latitude} (三个字段同时set)
│   ├── 状态效果: [{状态名称, 类型, 剩余时间, 效果}] (用push添加)
│   └── 大道感悟: {道名: {感悟内容, 时间}} (用set)
│
├── 装备栏 (只读，禁止修改)
│   ├── 装备1: string|null (装备ID或null)
│   ├── 装备2: string|null
│   ├── 装备3: string|null
│   ├── 装备4: string|null
│   ├── 装备5: string|null
│   └── 装备6: string|null
│
├── 三千大道 (可修改)
│   ├── 已解锁大道: [道名] (用push添加)
│   └── 大道进度: {道名: {当前阶段, 当前经验, 总经验}} (用set或add经验)
│
├── 背包 (可修改)
│   ├── 灵石: {下品, 中品, 上品, 极品} (用add增减)
│   └── 物品: {物品ID: Item对象} (用set添加物品，用add修改数量，用delete删除)
│       ├── 装备物品: {物品ID, 名称, 类型:"装备", 品质, 数量, 描述, 装备增幅, 已装备}
│       ├── 功法物品: {物品ID, 名称, 类型:"功法", 品质, 数量, 描述, 功法效果, 功法技能[], 修炼进度, 已装备}
│       ├── 丹药物品: {物品ID, 名称, 类型:"丹药", 品质, 数量, 描述, 使用效果}
│       └── 其他物品: {物品ID, 名称, 类型:"材料"|"其他", 品质, 数量, 描述}
│
├── 修炼功法 (只读引用，禁止直接修改)
│   ├── 物品ID: string
│   └── 名称: string
│
├── 掌握技能 (自动计算，禁止修改)
│   └── [{技能名称, 技能描述, 来源, 消耗, 熟练度, 使用次数}]
│
├── 人物关系 (可修改)
│   └── {NPC名字: NPC档案对象}
│       ├── 名字: string
│       ├── 性别: "男"|"女"|"其他"
│       ├── 年龄: number (自动计算)
│       ├── 出生日期: {年, 月, 日}
│       ├── 种族: string
│       ├── 出生: string
│       ├── 外貌描述: string
│       ├── 性格特征: [string]
│       ├── 境界: {名称, 阶段} (⚠️注意：NPC境界是简化结构，严禁添加"当前进度"等玩家专属字段)
│       ├── 灵根: {名称, 品级}
│       ├── 天赋: [{名称, 描述}]
│       ├── 先天六司: {根骨, 灵性, 悟性, 气运, 魅力, 心性}
│       ├── 与玩家关系: string
│       ├── 好感度: number (-100~100，用add)
│       ├── 人格底线: [string]
│       ├── 记忆: [{时间, 事件}] (用push添加)
│       ├── 记忆总结: [string]
│       ├── 当前位置: {描述, longitude, latitude}
│       ├── 势力归属: string
│       ├── 当前外貌状态: string (用set实时更新)
│       ├── 当前内心想法: string (用set实时更新)
│       ├── 背包: {灵石, 物品}
│       ├── 私密信息: {是否为处女, 身体部位[], 性格倾向, 性取向, ...} (NSFW)
│       └── 实时关注: boolean
│
├── 记忆 (可修改)
│   ├── 短期记忆: [string] (AI自动生成，用于下次生成)
│   ├── 中期记忆: [string]
│   └── 长期记忆: [string]
│
├── 世界信息 (可修改)
│   ├── 地图: {continents[], factions[], features[]}
│   ├── 大陆信息: [{名称, 描述, 地理特征, ...}]
│   ├── 势力信息: [{id, 名称, 类型, 等级, 位置, ...}]
│   └── 地点信息: [{名称, 类型, 位置, coordinates, ...}]
│
├── 游戏时间 (可修改)
│   ├── 年: number
│   ├── 月: number (1-12)
│   ├── 日: number (1-30)
│   ├── 小时: number (0-23)
│   └── 分钟: number (0-59) (用add推进，自动进位)
│
├── 宗门 (可修改)
│   ├── sectName: string
│   ├── sectType: string
│   ├── position: string
│   ├── contribution: number (用add)
│   ├── relationship: string
│   ├── reputation: number (用add)
│   └── ...
│
├── 穿越者系统 (可修改)
│   ├── 系统类型: string
│   ├── 任务颁发提示词: string
│   ├── 自动刷新: boolean
│   ├── 默认任务数量: number
│   ├── 未完成任务: [{任务ID, 任务类型, 任务描述, ...}] (用push添加，用delete删除)
│   └── 已完成任务名单: [string]
│
├── 系统任务 (可修改)
│   ├── 配置: {启用, 任务类型, 颁发数量}
│   ├── 进行中任务: [任务对象]
│   └── 已完成任务名称: [string]
│
└── 系统 (只读，禁止修改)
    ├── nsfwMode: boolean
    └── nsfwGenderFilter: "all"|"female"|"male"
\`\`\`

${JSON_RULES}

# 📋 字段操作规则速查表

| 字段路径 | 操作类型 | 说明 | 示例 |
|---------|---------|------|------|
| **游戏时间.分钟** | add | 推进时间，自动进位 | \`{"action":"add","key":"游戏时间.分钟","value":30}\` |
| **玩家角色状态.境界** | set | 更新整个境界对象 | \`{"action":"set","key":"玩家角色状态.境界","value":{...}}\` |
| **玩家角色状态.气血.当前** | add | 增减气血（负数=扣血） | \`{"action":"add","key":"玩家角色状态.气血.当前","value":-50}\` |
| **玩家角色状态.气血.上限** | add | 突破时增加上限 | \`{"action":"add","key":"玩家角色状态.气血.上限","value":100}\` |
| **玩家角色状态.寿命.上限** | add | **必须用add**，禁止set | \`{"action":"add","key":"玩家角色状态.寿命.上限","value":130}\` |
| **玩家角色状态.位置.描述** | set | 同时更新描述+坐标 | \`{"action":"set","key":"玩家角色状态.位置.描述","value":"大陆·地点"}\` |
| **玩家角色状态.状态效果** | push | 添加buff/debuff | \`{"action":"push","key":"玩家角色状态.状态效果","value":{...}}\` |
| **背包.灵石.下品** | add | 增减灵石（负数=消耗） | \`{"action":"add","key":"背包.灵石.下品","value":-100}\` |
| **背包.物品.sword_001** | set | 添加新物品（完整对象） | \`{"action":"set","key":"背包.物品.sword_001","value":{...}}\` |
| **背包.物品.pill_001.数量** | add | 修改物品数量 | \`{"action":"add","key":"背包.物品.pill_001.数量","value":-1}\` |
| **背包.物品.pill_001** | delete | 删除物品 | \`{"action":"delete","key":"背包.物品.pill_001"}\` |
| **背包.物品.gongfa_001.修炼进度** | add | **唯一修改功法进度的方式** | \`{"action":"add","key":"背包.物品.gongfa_001.修炼进度","value":5}\` |
| **人物关系.张三** | set | 创建新NPC（完整对象） | \`{"action":"set","key":"人物关系.张三","value":{...}}\` |
| **人物关系.张三.好感度** | add | 增减好感度（-100~100） | \`{"action":"add","key":"人物关系.张三.好感度","value":10}\` |
| **人物关系.张三.当前外貌状态** | set | 实时更新NPC状态 | \`{"action":"set","key":"人物关系.张三.当前外貌状态","value":"..."}\` |
| **人物关系.张三.记忆** | push | 添加NPC记忆 | \`{"action":"push","key":"人物关系.张三.记忆","value":{时间,事件}}\` |
| **角色基础信息.后天六司.根骨** | add | 增加后天属性 | \`{"action":"add","key":"角色基础信息.后天六司.根骨","value":1}\` |
| **三千大道.已解锁大道** | push | 解锁新大道 | \`{"action":"push","key":"三千大道.已解锁大道","value":"剑道"}\` |
| **三千大道.大道进度.剑道.当前经验** | add | 增加大道经验 | \`{"action":"add","key":"三千大道.大道进度.剑道.当前经验","value":100}\` |
| **装备栏.*** | ❌禁止 | 由玩家UI操作，AI不能修改 | - |
| **修炼功法.*** | ❌禁止 | 只读引用，由装备功法自动管理 | - |
| **掌握技能** | ❌禁止 | 自动计算，AI不能修改 | - |
| **系统.*** | ❌禁止 | 前端设置，AI只能读取 | - |

# 🔴 关键规则（必须遵守）

## 1. 只读字段（禁止修改）
- **装备栏.***: 由玩家UI操作
- **修炼功法.***: 由装备功法自动管理
- **掌握技能**: 根据功法进度自动计算
- **系统.***: 前端用户设置
- **角色基础信息** 的大部分字段（除了后天六司）
- **年龄**: 自动计算（当前年 - 出生年）

## 2. 必须用add的字段（禁止set）
- **玩家角色状态.寿命.上限**: 突破时必须用add增加
- **玩家角色状态.气血/灵气/神识.上限**: 突破时用add增加
- **背包.灵石.***: 增减用add
- **好感度**: 增减用add，范围-100~100
- **数量**: 物品数量增减用add

## 3. 必须同时更新的字段
- **位置**: 必须同时更新 描述 + longitude + latitude 三个字段
- **境界突破**: 必须更新 境界对象（名称+阶段+进度+所需+**突破描述**）+ 寿命上限 + 属性上限
  - **突破描述** 必须根据当前剧情动态生成，例如："借助筑基丹冲破瓶颈"、"感悟剑道真意破境"

## 4. 数值范围限制
- **好感度**: -100 ~ 100
- **亲密渴望**: 0 ~ 100
- **感知度/唤醒度**: 0 ~ 100
- **修炼进度**: 0 ~ 100
- **先天六司**: 1 ~ 10
- add操作前必须计算，确保不超范围

## 5. 特殊格式要求
- **物品ID**: 必须唯一，格式：类型_随机数字（如 sword_12345, pill_001, gongfa_001）
- **位置描述**: 格式："大陆名·地点名"（如"青云大陆·青云宗"）
- **时间字段**: "小时""分钟"（不能简写"时""分"）
- **品质**: {"quality":"凡|黄|玄|地|天|仙|神","grade":0-10}
- **功法技能**: 必须是数组[]，不能是对象{}

## 6. JSON洁癖 (JSON Purism)
- **严格遵守结构**：你的输出必须严格匹配上方定义的结构树。
- **禁止添加额外字段**：严禁在任何对象中添加结构树未定义的字段。例如，NPC的\`境界\`对象只有\`名称\`和\`阶段\`，不可添加\`当前进度\`。
- **结构错误 > 内容不佳**：一个结构完全正确但内容平庸的JSON，远好于一个内容丰富但结构错误的JSON。前端解析失败会导致整个对象无法显示。

${INNATE_ATTRIBUTES_RULE}

# 📦 完整数据结构示例

## 物品结构

### 装备物品
\`\`\`json
{
  "物品ID": "sword_12345",
  "名称": "玄铁剑",
  "类型": "装备",
  "品质": {"quality": "黄", "grade": 5},
  "数量": 1,
  "描述": "一把锋利的长剑，剑身刻有玄纹",
  "装备增幅": {
    "后天六司": {
      "根骨": 2,
      "气运": 1
    },
    "气血上限": 50,
    "灵气上限": 30
  },
  "已装备": false
}
\`\`\`

### 功法物品
\`\`\`json
{
  "物品ID": "gongfa_001",
  "名称": "青木长生诀",
  "类型": "功法",
  "品质": {"quality": "玄", "grade": 7},
  "数量": 1,
  "描述": "木属性高级功法，修炼可延年益寿",
  "功法效果": {
    "修炼速度加成": 1.5,
    "属性加成": {
      "根骨": 2,
      "灵气上限": 100
    },
    "特殊能力": ["木遁术", "生命恢复加速"]
  },
  "功法技能": [
    {
      "技能名称": "青木盾",
      "技能描述": "凝聚木之灵气形成防护盾",
      "消耗": "灵气30点",
      "解锁需要熟练度": 0
    },
    {
      "技能名称": "木龙缠绕",
      "技能描述": "召唤木龙束缚敌人",
      "消耗": "灵气80点",
      "解锁需要熟练度": 50
    }
  ],
  "修炼进度": 35,
  "已装备": true
}
\`\`\`
⚠️ 第一个技能的"解锁需要熟练度"必须为0（开局可用）

### 丹药物品
\`\`\`json
{
  "物品ID": "pill_001",
  "名称": "回灵丹",
  "类型": "丹药",
  "品质": {"quality": "黄", "grade": 6},
  "数量": 5,
  "描述": "快速恢复灵气的丹药",
  "使用效果": {
    "恢复灵气": 100,
    "持续时间": 0
  }
}
\`\`\`

## NPC档案结构

⚠️ **格式铁律复核点**：
1. \`境界\`只有2个字段：\`名称\`和\`阶段\`，严禁添加\`当前进度\`、\`下一级所需\`、\`突破描述\`
2. \`私密信息\`必须包含完整的14个必填字段（见上方NSFW规则）

\`\`\`json
{
  "名字": "林清璃",
  "性别": "女",
  "年龄": 18,
  "出生日期": {"年": 982, "月": 3, "日": 15},
  "种族": "人族",
  "出生": "青云宗弟子",
  "外貌描述": "容貌清丽，一袭白衣，气质出尘",
  "性格特征": ["温柔", "坚韧", "重情"],
  "境界": {
    "名称": "筑基",
    "阶段": "初期"
  },
  "灵根": {
    "名称": "冰霜灵根",
    "品级": "上品"
  },
  "天赋": [
    {"名称": "冰心", "描述": "不受心魔侵扰"}
  ],
  "先天六司": {
    "根骨": 7,
    "灵性": 9,
    "悟性": 8,
    "气运": 6,
    "魅力": 9,
    "心性": 8
  },
  "与玩家关系": "师姐",
  "好感度": 60,
  "人格底线": ["不能伤害无辜", "不能背叛宗门"],
  "记忆": [
    {"时间": "仙道1000年2月1日", "事件": "第一次见到玩家"}
  ],
  "记忆总结": ["对玩家印象不错"],
  "当前位置": {
    "描述": "青云大陆·青云宗·内门",
    "longitude": 115.23,
    "latitude": 35.67
  },
  "势力归属": "青云宗",
  "当前外貌状态": "面色红润，嘴角含笑",
  "当前内心想法": "这师弟资质不错，可以多加关照",
  "背包": {
    "灵石": {
      "下品": 500,
      "中品": 50,
      "上品": 5,
      "极品": 0
    },
    "物品": {
      "sword_001": {
        "物品ID": "sword_001",
        "名称": "霜华剑",
        "类型": "装备",
        "品质": {"quality": "玄", "grade": 6},
        "数量": 1,
        "描述": "冰属性法剑",
        "已装备": false
      }
    }
  },
  "私密信息": {
    "是否为处女": true,
    "身体部位": [
      {
        "部位名称": "胸部",
        "开发度": 0,
        "敏感度": 20,
        "特征描述": "发育良好，白皙柔软",
        "特殊印记": "无"
      },
      {
        "部位名称": "小穴",
        "开发度": 0,
        "敏感度": 30,
        "特征描述": "未经人事，紧致粉嫩",
        "特殊印记": "无"
      },
      {
        "部位名称": "颈部",
        "开发度": 0,
        "敏感度": 25,
        "特征描述": "肌肤白皙细腻",
        "特殊印记": "无"
      }
    ],
    "性格倾向": "纯情",
    "性取向": "异性恋",
    "性癖好": [],
    "性渴望程度": 10,
    "当前性状态": "正常",
    "体液分泌状态": "正常",
    "性交总次数": 0,
    "性伴侣数量": 0,
    "性伴侣名单": [],
    "最近一次性行为时间": "从未",
    "特殊体质": []
  },
  "实时关注": false
}
\`\`\`

${NSFW_RULE}

## 境界结构
\`\`\`json
{
  "名称": "炼气",
  "阶段": "中期",
  "当前进度": 350,
  "下一级所需": 500
}
\`\`\`

### 境界系统说明
| 境界 | 寿命 | 阶段 | 特征 |
|------|------|------|------|
| 凡人 | 100年 | 无 | 生老病死 |
| 炼气 | 120年 | 初期/中期/后期/圆满/极境 | 引气入体、搬运周天 |
| 筑基 | 250年 | 初期/中期/后期/圆满/极境 | 紫府开辟、辟谷 |
| 金丹 | 500-800年 | 初期/中期/后期/圆满/极境 | 金丹成型、御空飞行 |
| 元婴 | 1500-2000年 | 初期/中期/后期/圆满/极境 | 元婴出窍、可夺舍 |

${REALM_STAGE_RULE}

⚠️ **境界突破必须增加寿命上限**：
- 用 **add** 增加，禁用 set
- 境界突破：+100-150年
- 阶段突破：+20-50年
- 高境界更大：元婴+500年、化神+2000年

✅ 正确：\`{"action":"add","scope":"chat","key":"玩家角色状态.寿命.上限","value":130}\`
❌ 错误：\`{"action":"set","scope":"chat","key":"玩家角色状态.寿命.上限","value":250}\`

## 位置结构
\`\`\`json
{
  "描述": "青云大陆·青云宗·藏经阁",
  "longitude": 115.23,
  "latitude": 35.67
}
\`\`\`

⚠️ **更新位置必须同时更新三个字段**：
\`\`\`json
[
  {"action":"set","scope":"chat","key":"玩家角色状态.位置.描述","value":"青云大陆·青云宗·藏经阁"},
  {"action":"set","scope":"chat","key":"玩家角色状态.位置.longitude","value":115.23},
  {"action":"set","scope":"chat","key":"玩家角色状态.位置.latitude","value":35.67}
]
\`\`\`

# 🎯 修仙世界设定

**人物命名**：古韵叠字(楚清璃)、兵器借势(剑无尘)、天地意象(风袭月)
**服饰**：材质(云纱/冰蚕丝)、色彩(月白/霜雪)、款式(广袖流仙)
**叙事词汇**：元炁/真元(非能量)、元神/真灵(非灵魂)、神通/术法(非魔法)

## 坐标系统
- longitude: 100-130
- latitude: 25-45
- 精度: 2-4位小数

## 品质系统
格式：\`{"quality":"凡|黄|玄|地|天|仙|神","grade":0-10}\`
- 凡/黄：开局常见
- 玄/地：中期
- 天/仙/神：高级

## NPC物品配置
- 必须3-8件物品
- 品质匹配境界：炼气(凡)、筑基(黄)、金丹(玄)
- 灵石：散修100-500、弟子500-2000、长老1000+`.trim();

// 功法生成提示词
export const TECHNIQUE_ITEM_GENERATION_PROMPT = `# 任务：生成功法秘籍

品质加成：凡(1.05-1.15) | 黄(1.2-1.35) | 玄(1.4-1.6) | 地(1.7-1.9) | 天(2.0-2.3) | 仙(2.5-3.0) | 神(3.5-5.0)
技能要求：凡/黄(可无) | 玄(≥1) | 地(≥2) | 天(≥3) | 仙(≥4)

## JSON输出格式
\`\`\`json
{
  "物品ID": "gongfa_随机数字",
  "名称": "功法名称",
  "类型": "功法",
  "品质": {"quality": "品质", "grade": 5},
  "数量": 1,
  "描述": "功法描述",
  "功法效果": {
    "修炼速度加成": 1.35,
    "属性加成": {
      "根骨": 1,
      "灵气上限": 50
    },
    "特殊能力": ["特殊能力描述"]
  },
  "功法技能": [
    {
      "技能名称": "技能1名称",
      "技能描述": "技能1效果描述",
      "消耗": "消耗描述",
      "解锁需要熟练度": 0
    }
  ],
  "修炼进度": 0,
  "已装备": false
}
\`\`\`

⚠️ 功法技能必须数组[]非对象{} | 第一个技能解锁需求必须为0 | 修炼进度0-100 | 已装备默认false
`;