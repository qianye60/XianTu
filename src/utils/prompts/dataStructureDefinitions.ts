import { ROLE_PLAY_INSTRUCTION } from './gameElementPrompts';
import { CORE_SYNC_RULES, REALM_STAGE_RULE, JSON_RULES, INNATE_ATTRIBUTES_RULE, NSFW_RULE } from './sharedRules';

/**
 * 数据结构定义（仅结构，不含操作说明）
 */

export { CORE_SYNC_RULES };

export const DATA_STRUCTURE_DEFINITIONS = `
# 数据结构 (Data Structure)

## 修仙世界设定 (World Setting)

**人物命名** (Naming)：古韵叠字(楚清璃)、兵器借势(剑无尘)、天地意象(风袭月)
**服饰** (Clothing)：材质(云纱/冰蚕丝)、色彩(月白/霜雪)、款式(广袖流仙)、特性(难撕/不染尘)
**叙事词汇** (Narration)：元炁/真元(非能量)、元神/真灵(非灵魂)、神通/术法(非魔法)、因果/劫数(非命运)

${JSON_RULES}

## 坐标/品质/六司 (Coords/Quality/Attributes)
**坐标**：longitude(100-130)、latitude(25-45)、精度2-4位
**品质**：{"quality":"凡|黄|玄|地|天|仙|神","grade":0-10}，开局≤玄
**六司**：
- 先天(Innate)：天生固定，永不可改
- 后天(Acquired)：装备/大道加成，可变

${INNATE_ATTRIBUTES_RULE}

## 境界
{"名称":"string","阶段":"初期|中期|后期|圆满|极境","当前进度":number,"下一级所需":number}

### 境界介绍 (Realm Intro)
| 境界 | 寿命 | 核心特征 |
|------|------|---------|
| 凡人 | 100年 | 生老病死 |
| 炼气 | 120年 | 引气入体、搬运周天、仍需饮食 |
| 筑基 | 250年 | 紫府开辟、灵气液化、辟谷、神识外放 |
| 金丹 | 500-800年 | 金丹成型、本命法宝、御空飞行 |
| 元婴 | 1500-2000年 | 碎丹成婴、元婴出窍、可夺舍 |
| 化神 | 5000年 | 元神转化、言出法随、领域形成 |
| 炼虚 | 10000年+ | 空间法则、瞬移、撕裂空间 |
| 合体 | 与世同君 | 法则合体、一念毁城、天劫心魔 |
| 渡劫 | 不定 | 九重仙劫、破碎虚空、飞升 |

${REALM_STAGE_RULE}

⚠️ **境界突破必须增加寿命上限** (Breakthrough Lifespan Rule | 重要重复强调)：
- 用 **add** 增加，禁用 set 替换
- 境界突破：+100-150年 | 阶段突破：+20-50年 | 高境界更大：元婴+500年、化神+2000年

✅ {"action":"add","key":"属性.寿命.上限","value":130}
❌ {"action":"set","key":"属性.寿命.上限","value":250}

## NPC物品规则 (NPC Item Rules)
NPC必须3-8件物品、品质匹配境界(炼气:凡/筑基:黄/金丹:玄)、灵石(散修100-500/弟子500-2000/长老1000+)

## 角色基础 (Character Base)
\`\`\`json
{"名字":"string","性别":"男|女|其他","年龄":number,"出生日期":{"年":number,"月":number,"日":number},"世界":"string","种族":"string(默认人族)","灵根":{"名称":"string","品级":"string"},"天赋":[{"名称":"string","描述":"string"}],"先天六司":{"根骨":5,"灵性":5,"悟性":5,"气运":5,"魅力":5,"心性":5},"后天六司":{"根骨":0,"灵性":0,"悟性":0,"气运":0,"魅力":0,"心性":0}}
\`\`\`

⚠️ 年龄=当前年-出生年(自动计算/禁改) | 后天六司开局=0(装备/大道增加)

## NPC档案 (NPC Profile | 完整结构)
\`\`\`json
{"名字":"string","性别":"男|女|其他","年龄":number,"出生日期":{"年":number,"月":number,"日":number},"种族":"string(默认人族)","出生":"string","外貌描述":"string","性格特征":["string"],"境界":{"名称":"练气|筑基|金丹","阶段":"初期|中期|后期|圆满|极境"},"灵根":{"名称":"string","品级":"string"},"天赋":[{"名称":"string","描述":"string"}],"先天六司":{"根骨":5,"灵性":5,"悟性":5,"气运":5,"魅力":5,"心性":5},"与玩家关系":"道侣|师徒|朋友|敌人|陌生人","好感度":number(-100到100),"人格底线":["string(0-5个)"],"记忆":[{"时间":"具体日期","事件":"事件描述"}],"记忆总结":["string"],"当前位置":{"描述":"大陆名·具体位置","longitude":number(100-130),"latitude":number(25-45)},"势力归属":"string","当前外貌状态":"string(实时用set替换)","当前内心想法":"string(实时用set替换)","背包":{"灵石":{"下品":number,"中品":number,"上品":number,"极品":number},"物品":{"物品ID":{"名称":"string","类型":"丹药|装备|功法|材料|其他","品质":{...},"描述":"string"}}},"私密信息":{"是否为处女":boolean,"是否为处男":boolean,"身体部位":[{"部位名称":"string","敏感度":number(0-100),"开发程度":number(0-100),"特殊标记":"string","描述":"string"}],"性格倾向":"纯情|主动|被动|淫荡|M|S|双性","性取向":"异性恋|同性恋|双性恋|泛性恋","性癖好":["string"],"性渴望程度":number(0-100),"当前性状态":"正常|微湿|兴奋|发情|潮吹|高潮|连续高潮|贤者时间","体液分泌状态":"string","性交总次数":number,"性伴侣数量":number,"性伴侣名单":["string"],"最近一次性行为时间":"string","特殊体质":["易潮吹|多重高潮|性爱成瘾|淫纹"]},"实时关注":boolean(默认false)}
\`\`\`

⚠️ 年龄=当前年-出生年(生成NPC时出生年=当前年-年龄，永不修改)
⚠️ 私密信息仅在nsfwMode=true且性别符合过滤时生成
⚠️ 性伴侣名单：数量>0时必须有具体NPC名字，严禁"保密""未知"占位符

⚠️ **数值范围限制** (Value Range Limit | 重要重复强调)：
- **好感度**：-100~100，超出立即截断
- **性渴望程度**：0~100，禁负数/超100
- **敏感度/开发程度**：0~100
- add操作必须预先计算，确保不超范围(如：当前95要增加10，应add 5使其达100，而非add 10导致105)

## 游戏时间 (Game Time)
\`\`\`json
{"年":number,"月":number(1-12),"日":number(1-30),"小时":number(0-23),"分钟":number(0-59)}
\`\`\`
⚠️ 字段名："小时""分钟"(禁简写"时""分"，禁添加"纪元")
⚠️ 时间推进：{"action":"add","key":"游戏时间.分钟","value":推进分钟数}，自动进位

## 位置 (Location)
\`\`\`json
{"描述":"大陆名·地点名","longitude":number(100-130),"latitude":number(25-45)}
\`\`\`
⚠️ **更新位置铁律** (Location Update Rule | 重要重复强调)：
1. 获取地图：世界信息.地图
2. 查询坐标所在大陆(continents)/势力(factions)/地点(features)
3. 生成描述："大陆名·地点名"(基于查询，禁编造)
4. 同时更新描述+longitude+latitude三个字段
❌ 禁止：描述与坐标不匹配/只更新部分字段/沿用旧描述不查地图

⚠️ NSFW生成：首次创建NPC时立即生成，身体部位含敏感度(20-80)/开发程度(0-30)/描述
⚠️ NPC独立人格：好感<60拒绝物化，触犯底线好感断崖下跌
⚠️ 性关系门槛：好感≥60或性渴望≥70，纯情需好感≥80

## 三千大道 (Thousand Dao)
\`\`\`json
{"大道列表":{"剑道":{"道名":"剑道","描述":"string","阶段列表":[{"名称":"剑意入门","描述":"string","突破经验":1000}],"是否解锁":true,"当前阶段":0,"当前经验":500,"总经验":500}}}
\`\`\`

## 世界信息 (World Info | 简化结构)
- **大陆信息**：名称/描述/地理特征/修真环境/气候/天然屏障/大洲边界(≥4点多边形)/主要势力
- **势力信息**：id/名称/类型(修仙宗门|魔道宗门等)/等级(超级|一流|二流|三流)/所在大洲/位置+势力范围/描述/特色/与玩家关系/leadership(宗主/修为/弟子数等)/加入条件/特殊福利
- **地点信息**：名称/类型(城池|宗门|秘境|险地|商会|坊市|洞府)/位置/coordinates/描述/特色/安全等级/开放状态/相关势力/特殊功能

⚠️ 坐标系统：longitude(100-130)/latitude(25-45)，位置格式："大陆名·地点名"，边界≥4点闭合多边形

## 灵根/出生背景 (Spirit Root/Birth)
\`\`\`json
{"灵根":{"名称":"string","品级":"下品|中品|上品|极品|天品|神品","描述":"string","属性":["string"],"修炼加成":number},"出生背景":{"名称":"string","描述":"string","初始资源":{"灵石":{"下品":number,"中品":number,"上品":number,"极品":number},"物品":["string"],"关系":["string"]}}}
\`\`\`

## 功法 (Technique)
⚠️ **功法技能必须是数组，≥1个技能**
\`\`\`json
{"物品ID":"gongfa_001","名称":"基础功法名称","类型":"功法","品质":{"quality":"凡|黄|玄|地|天|仙|神","grade":0-10},"数量":1,"描述":"功法描述...","功法效果":{"修炼速度加成":1.2,"属性加成":{"灵气上限":50,"根骨":1},"特殊能力":["特殊能力描述"]},"功法技能":[{"技能名称":"技能1名称","技能描述":"技能1效果描述","消耗":"灵气10点","解锁需要熟练度":0},{"技能名称":"技能2名称","技能描述":"技能2效果描述","消耗":"灵气30点","解锁需要熟练度":50}],"修炼进度":0,"已装备":false}
\`\`\`
⚠️ 第一个技能解锁需求=0(开局可用)，后续技能可设30/50/80等

## 宗门系统 (Sect System)
\`\`\`json
{"sectName":"string","sectType":"正道宗门|魔道宗门|中立宗门|商会|世家|散修联盟","position":"散修|外门弟子|内门弟子|核心弟子|传承弟子|执事|长老|太上长老|副掌门|掌门","contribution":0,"relationship":"仇敌|敌对|冷淡|中立|友好|盟友|附庸","reputation":0,"joinDate":"string","description":"string","师父":"string","同门关系":["string"],"宗门职务":["string"]}
\`\`\`

## 装备系统 (Equipment System | 重要重复强调)
⚠️ **装备栏和"已装备"字段都是只读的（由程序/玩家操作管理）**

装备栏结构(只读/禁改)：{"装备栏":{"装备1":null,"装备2":null,"装备3":null,"装备4":null,"装备5":null,"装备6":null}}

⚠️ **装备管理原则** (Equipment Rule | 最高优先级/重要重复强调)：
- ❌ **禁止通过 tavern_commands 操作任何与装备相关的内容**
- ❌ 禁止操作 装备栏.*
- ❌ 禁止操作 背包_物品.*.已装备 字段
- 装备和卸下完全由玩家在UI操作，AI无需也不能干预
- AI只负责创建物品到背包，装备由玩家自行决定

✅ **AI职责**：创建物品时已装备=false，**之后不要再碰这个字段**
\`\`\`json
{"action":"set","key":"背包_物品.天蚕羽衣","value":{"物品ID":"天蚕羽衣","名称":"天蚕羽衣","类型":"装备","品质":{"quality":"玄","grade":5},"描述":"...","已装备":false}}
\`\`\`

## 修炼功法系统 (Cultivation System | 重要重复强调)
⚠️ **三层架构** (3-Layer Architecture)：
  - **背包_物品.功法ID**：功法本体，存储所有数据和进度（❗唯一可修改，修炼进度在这里更新）
  - **修炼功法**：只读引用（装备时自动复制，卸下时自动清空，❌禁止通过命令直接修改）
  - **掌握技能**：自动计算数组（根据功法修炼进度自动解锁技能，❌禁止通过命令直接修改）

⚠️ **重要**：AI只能操作背包中的功法本体，不能直接修改"修炼功法"和"掌握技能"分片

背包功法本体(可修改)：
\`\`\`json
{"物品ID":"yinqi_jue_001","名称":"引气诀","类型":"功法","品质":{"quality":"凡","grade":3},"数量":1,"描述":"基础功法...","功法效果":{"修炼速度加成":1.1,"属性加成":{"灵气上限":50},"特殊能力":["感知灵气"]},"功法技能":[{"技能名称":"引气术","技能描述":"快速吸收周围灵气","消耗":"灵气10点","解锁需要熟练度":30}],"修炼进度":51,"已装备":true}
\`\`\`
⚠️ 修炼进度：0-100百分比 | 功法技能：必须数组非对象 | 已装备：true=正在修炼 | 更新进度：{"action":"add","key":"背包_物品.功法ID.修炼进度","value":增量}

修炼功法分片(只读/禁改)：{"物品ID":"yinqi_jue_001","名称":"引气诀"}

⚠️ **严禁操作**：
- ❌ 禁用 set 修改 修炼功法.*
- ❌ 禁在修炼功法中存储完整功法对象
- ✅ 修炼进度只能通过 背包_物品.功法ID.修炼进度 修改

## 穿越者系统 (Transmigrator System | 金手指系统)
⚠️ **扁平化结构，≤1层对象嵌套**

系统结构：{"系统类型":"道侣养成系统","任务颁发提示词":"AI任务生成提示词","自动刷新":true,"默认任务数量":3,"未完成任务":[{"任务ID":"task_001","任务类型":"道侣培养","任务描述":"与林清璃好感度达到80","触发条件":"好感度60以上","完成条件":"好感度≥80","奖励":"灵石×1000，筑基丹×1","发布时间":"1000年3月15日"}],"已完成任务名单":[]}

任务生命周期：
1. 触发：AI根据"任务颁发提示词"+游戏状态生成任务
2. 发布：push到"未完成任务"
3. 完成：发放奖励→delete任务→push任务描述到"已完成任务名单"
4. 刷新：自动刷新=true时自动补充至默认数量

操作示例：
- 发布：{"action":"push","key":"穿越系统.未完成任务","value":{完整任务对象}}
- 完成：[{"action":"add","key":"背包.灵石.下品","value":1000},{"action":"push","key":"穿越者系统.已完成任务名单","value":"任务描述"},{"action":"delete","key":"穿越者系统.未完成任务.task_001"}]

⚠️ 系统类型/任务类型可自定义，完成后必须delete

## 系统设置 (System Settings | 重要重复强调)
⚠️ **系统分片是只读的（由前端管理，存储用户设置）**

系统分片结构(只读/禁改)：{"nsfwMode":boolean,"nsfwGenderFilter":"all"|"female"|"male"}

⚠️ **禁止操作** (Forbidden Operations)：
- ❌ 禁止通过 tavern_commands 修改 \`系统.*\`
- 这些是用户在设置界面配置的选项，由前端程序管理
- AI只能读取这些设置来决定是否生成NSFW内容，但不能修改它们

`.trim();

// 功法生成 (Technique Generation)
export const ADDITIONAL_RULES = `
// ⚠️ **境界突破流程铁律** (Breakthrough Rule)：
//   - 阶段内突破：初期→中期→后期→圆满
//   - 境界间突破：必须从圆满(或极境)突破至新境界的初期

// ⚠️ **重要区分** (Important Distinction)：
//   - 修炼进度: 存储在背包_物品中的功法本体上，0-100百分比。**AI唯一可修改的功法进度字段**
//   - 解锁需要熟练度: 功法定义内部的只读条件，判断何时解锁技能，AI不能修改或添加此字段，更不能创造名为"熟练度"的新字段
`;

export const TECHNIQUE_ITEM_GENERATION_PROMPT = `${ROLE_PLAY_INSTRUCTION}
# 任务：生成功法秘籍 (Generate Technique)
品质加成：凡(1.05-1.15) | 黄(1.2-1.35) | 玄(1.4-1.6) | 地(1.7-1.9) | 天(2.0-2.3) | 仙(2.5-3.0) | 神(3.5-5.0)
技能要求：凡/黄(可无) | 玄(≥1) | 地(≥2) | 天(≥3) | 仙(≥4)

## JSON输出格式
\`\`\`json
{"物品ID":"unique_id","名称":"功法名称","类型":"功法","品质":{"quality":"品质","grade":5},"数量":1,"描述":"功法描述","功法效果":{"修炼速度加成":1.35,"属性加成":{"根骨":1,"灵气上限":50},"特殊能力":["特殊能力描述"]},"功法技能":[{"技能名称":"技能1名称","技能描述":"技能1效果描述","消耗":"消耗描述","解锁需要熟练度":30}],"修炼进度":0,"已装备":false}
\`\`\`

⚠️ 功法技能必须数组[]非对象{} | 解锁需求0-100 | 修炼进度0-100 | 已装备默认false
`;