/**
 * 游戏正文AI生成提示词 - 核心剧情推进系统
 * 用于处理玩家在游戏中的行动和AI回复
 */

import {
  COMMON_CORE_RULES,
  COMMON_TEXT_REQUIREMENTS,
  COMMON_FORMAT_MARKERS,
  COMMON_NPC_RULES,
  COMMON_ITEM_RULES,
  COMMON_DAO_RULES,
  COMMON_MEMORY_RULES,
} from './commonPromptRules'

// === 使用通用规则组件 ===
const CORE_RULES = COMMON_CORE_RULES
const TEXT_REQUIREMENTS = COMMON_TEXT_REQUIREMENTS
const FORMAT_MARKERS = COMMON_FORMAT_MARKERS
const MEMORY_MANAGEMENT = COMMON_MEMORY_RULES
// 直接使用导入的通用组件，不再重新声明

// === 4. 玩家操作处理优先级 ===
const PLAYER_ACTION_PRIORITY = [
  '【玩家操作处理优先级】',
  '⚠️ **执行顺序至关重要**：当收到包含【玩家最近操作】的输入时，必须按以下顺序处理：',
  '',
  '## 🎯 第一优先级：处理玩家具体操作',
  '- **优先响应**：首先基于【玩家最近操作】中列出的具体动作生成回应',
  '- **动作反馈**：必须在叙事中明确体现每个操作的结果和效果',
  '- **数据更新**：根据操作类型更新对应的游戏数据（修为、装备、状态等）',
  '- **即时反馈**：玩家的每个操作都应该得到直接的叙事反馈',
  '',
  '## 📝 第二优先级：回应用户文本输入',
  '- **文本处理**：在处理完具体操作后，再基于用户输入的文本内容继续叙事',
  '- **内容融合**：将用户文本意图与操作结果自然融合到一个连贯的回应中',
  '- **逻辑连贯**：确保操作效果和文本回应在逻辑上连贯一致',
  '',
  '## ✅ 处理示例：',
  '```',
  '用户操作：感悟了《五行调和术》大道',
  '用户文本：我要去市集看看',
  '正确回应：先描述感悟大道的过程和收获，然后自然过渡到前往市集的情节',
  '```',
  '',
  '❌ **严禁**：忽略具体操作，直接回应文本内容',
  '✅ **正确**：先处理操作，再融入文本意图',
].join('\n')

// === 5. 判定系统 ===
const JUDGMENT_SYSTEM = [
  '【判定系统｜天道演算 v4.2】',
  '- 当输入中出现【判定|检定:{法力|神海|道心|空速|气运}|DC:数值|情景:…】或【判定|斗法|敌人:…|敌方状态:…】时：',
  '  1) 直接读取character.saveData.系统.天道演算（由前端预计算提供），不得自行杜撰',
  '  2) 通用检定：按预计算.成功率曲线中对应类型与DC给出的成功率执行d100比较',
  '  3) 天道特许：若预计算.特许.天道之眷标签与本次检定强相关，可视作自动成功或最多+20%',
  '  4) 斗法检定：以预计算.斗法基线作基准，结合叙事上下文的敌我优势微调±10%以内',
  '  5) 在输出JSON中可附加judgement字段：{type, dc, roll, success_rate, grade, details}',
  '  6) 文字增幅：根据预计算.文字增幅选取增幅词融入text',
  '  7) tavern_commands只做与叙事相符的最小必要改动',
].join('\n')

// 使用通用物品系统规则

// === 7. NPC系统 ===
const NPC_SYSTEM = [
  '【NPC系统】',
  '- **基础信息完整性**：性别、年龄、天资、出生、灵根等字段必须具体化，不能为"未知"',
  '- **互动更新**：text中出现与具体人物的明确互动时，必须set到人物关系.<姓名>',
  '- **物品携带强制要求**：',
  '  * **商人类NPC**：必须在背包中携带3-5件可交易物品（丹药、符篆、材料、装备等），绝不能空背包',
  '  * **宗门长老/重要人物**：必须携带2-4件符合身份的物品（功法、法宝、珍贵材料等）',
  '  * **普通NPC**：根据身份携带1-2件合适物品（工具、日用品、小物件等）',
  '  * **背包格式**：背包.物品.{物品ID}: {完整Item对象}',
  '  * **物品命名**：避免模板化，创造富有个性的物品名称',
  '- **记忆格式**：["[日期][地点]事件"]格式',
  '- **好感度范围**：-100到100',
  '- **交易机制**：支持物品交换、赠送、偷窃等操作',
].join('\n')

// === 8. 三千大道系统规则 ===
const DAO_SYSTEM_RULES = [
  '【三千大道系统】',
  '- **完全动态**：所有大道都由AI根据游戏情况动态创建，没有固定的基础大道',
  '- **机缘驱动**：大道的解锁应该与剧情、机缘、师承、奇遇等相关',
  '- **个性化进阶**：每条大道都应该有独特的阶段名称、描述和经验需求',
  '- **数据存储**：所有三千大道数据必须存储在character.saveData.三千大道路径下',
  '- **解锁条件**：遇到师父传授、获得典籍秘笈、特殊环境感悟、完成任务等',
  '- **经验获得**：实际操作、研读典籍、名师指点、悟道机缘等',
  '- **阶段设计**：7-12个不等的修炼阶段，使用富有修仙韵味的阶段名',
  '- **经验递增**：第1阶段0经验，2-4阶段100-500，5-7阶段800-2000，8-10阶段3000-8000，11+阶段10000+',
].join('\n')

// === 9. AI数据更新规则 ===
const UPDATE_RULES = [
  '【AI数据更新规则】',
  '⚠️ **重要提醒**：每次回复都必须分析当前游戏状态，主动更新相关数据！',
  '',
  '## 🔄 **重要数据结构更新** - 必须遵循以下新规则',
  '',
  '### 📦 装备和修炼系统同步',
  '- **装备操作后**：所有装备/卸下操作完成后，必须同步更新装备状态',
  '  * 装备时：设置物品的"已装备"字段为true：`_.set("character.saveData.背包.物品.物品ID.已装备", true)`',
  '  * 卸下时：设置物品的"已装备"字段为false：`_.set("character.saveData.背包.物品.物品ID.已装备", false)`',
  '  * 装备栏更新：`_.set("character.saveData.装备栏.装备1", Item对象或null)`',
  '- **修炼功法操作后**：开始/停止修炼功法后，必须同步更新酒馆变量',
  '  * `_.set("character.saveData.修炼功法", 完整的修炼功法数据)`',
  '',
  '### 👥 NPC数据结构规范',
  '- **NPC行为字段**：所有NPC数据中必须使用"NPC行为"字段，不再使用"AI行为"',
  '  * 正确：`"NPC行为": {"行为模式": "...", "日常路线": [...]}`',
  '  * 错误：`"AI行为": {...}` (已废弃)',
  '',
  '### 🌟 必须生成和显示的字段',
  '- **天赋字段**：每个角色都必须有"天赋"字段，没有天赋时填"无"',
  '  * `_.set("character.saveData.角色基础信息.天赋", ["具体天赋"] 或 ["无"])`',
  '- **角色状态数值**：必须确保以下数值存在并更新：',
  '  * 当前气血/最大气血：`_.set("character.saveData.玩家角色状态.气血", {"当前": X, "最大": Y})`',
  '  * 当前灵气/最大灵气：`_.set("character.saveData.玩家角色状态.灵气", {"当前": X, "最大": Y})`',
  '  * 当前神识/最大神识：`_.set("character.saveData.玩家角色状态.神识", {"当前": X, "最大": Y})`',
  '  * 当前寿命/最大寿命：`_.set("character.saveData.玩家角色状态.寿命", {"当前": X, "最大": Y})`',
  '- **灵石显示**：如果角色拥有灵石，必须在适当时机提及和显示',
  '  * 从`character.saveData.背包.灵石`中读取灵石数量',
  '',
  '### 🧠 记忆系统清理',
  '- **移除指令数据**：NPC记忆中不再包含指令数据，只保留时间和事件',
  '  * 正确格式：`[{"时间": "时间描述", "事件": "事件描述"}]`',
  '  * 移除字段：不再使用"指令数据"字段',
  '',
  '## 📊 当前游戏状态获取',
  '你可以通过酒馆变量获取当前完整的游戏状态：',
  '- character.saveData.玩家角色状态 - 角色的实时状态数据',
  '- character.saveData.人物关系 - 所有NPC关系数据',
  '- character.saveData.游戏时间 - 当前游戏时间',
  '- character.saveData.记忆 - 玩家记忆数据',
  '- character.saveData.背包 - 物品和灵石数据',
  '',
  '## 🔄 强制更新检查清单',
  '每次AI回复必须检查以下项目并在tavern_commands中更新：',
  '',
  '### 1️⃣ 时间推进',
  '- **对话时间**：普通对话推进5-15分钟',
  '- **修炼时间**：根据修炼内容推进，根据境界来，境界越高时间越长，比如练气恢复一下灵气需要几小时，闭关修炼一下几个月，金丹期恢复一下灵气几天甚至几十天，闭关一下就是几十年，如果更高，例如合体期，一次闭关就是一个皇朝兴起和灭亡',
  '- **战斗时间**：激烈战斗和境界推进，境界越高时间越长，像玄幻修仙小说中的大战几月也不是没有可能',
  '- **移动时间**：根据距离推进距离和境界还有乘坐的东西决定相应时间',
  '- **强制更新**：`_.set("character.saveData.游戏时间.小时", 当前小时+推进小时数)`',
  '',
  '### 2️⃣ 生命状态监控',
  '- **气血变化**：战斗受伤、治疗、休息恢复',
  '  * 轻伤：`_.add("character.saveData.玩家角色状态.气血.当前", -10到-30)`',
  '  * 重伤：`_.add("character.saveData.玩家角色状态.气血.当前", -50到-100)`',
  '  * 治疗：`_.add("character.saveData.玩家角色状态.气血.当前", +20到+80)`',
  '- **灵气消耗**：使用法术、功法时必须消耗',
  '  * 普通法术：`_.add("character.saveData.玩家角色状态.灵气.当前", -5到-20)`',
  '  * 强力法术：`_.add("character.saveData.玩家角色状态.灵气.当前", -30到-100)`',
  '- **神识损耗**：精神攻击、过度思考、炼丹失败',
  '- **寿命变化**：突破境界增加寿命上限，受重伤或诅咒减少',
  '',
  '### 3️⃣ 位置更新',
  '- **移动必更新**：角色每次移动都必须更新位置',
  '  * `_.set("character.saveData.玩家角色状态.位置.描述", "新位置名称")`',
  '  * `_.set("character.saveData.玩家角色状态.位置.坐标", {"X": 新X, "Y": 新Y})`',
  '- **位置格式**：必须遵循"大洲名·地点名"格式',
  '',
  '### 4️⃣ 修为进度',
  '- **修炼活动**：打坐、修炼功法、感悟道法',
  '  * `_.add("character.saveData.玩家角色状态.修为.当前", +修炼获得的修为)`',
  '- **战斗收获**：胜利后获得修为',
  '- **突破境界**：修为达到下一级所需时自动突破',
  '',
  '### 5️⃣ NPC互动记忆',
  '- **每次互动必记录**：与任何NPC对话都要更新其记忆',
  '  ```json',
  '  {',
  '    "action": "push",',
  '    "scope": "chat",',
  '    "key": "character.saveData.人物关系.【NPC名字】.人物记忆",',
  '    "value": {',
  '      "时间": "【当前游戏时间】",',
  '      "事件": "【具体事件描述】"',
  '    }',
  '  }',
  '  ```',
  '- **好感度变化**：根据互动内容调整',
  '  * 友好互动：`_.add("character.saveData.人物关系.【NPC名字】.人物好感度", +5到+15)`',
  '  * 冲突互动：`_.add("character.saveData.人物关系.【NPC名字】.人物好感度", -10到-30)`',
  '',
  '### 6️⃣ 物品状态',
  '- **装备耐久**：战斗、使用后减少耐久度',
  '- **消耗品使用**：丹药、符篆使用后减少数量',
  '- **新物品获得**：必须添加到背包',
  '- **灵石消耗**：购买、修炼、炼制时扣除',
  '',
  '### 7️⃣ 状态效果管理',
  '- **新增状态**：中毒、增益、诅咒等',
  '  ```json',
  '  {',
  '    "action": "push",',
  '    "scope": "chat", ',
  '    "key": "character.saveData.玩家角色状态.状态效果",',
  '    "value": {',
  '      "状态名称": "具体状态名",',
  '      "类型": "buff或debuff",',
  '      "时间": "具体持续时间",',
  '      "状态描述": "详细描述效果",',
  '      "强度": 1-10,',
  '      "来源": "状态来源"',
  '    }',
  '  }',
  '  ```',
  '- **移除过期状态**：时间到期的状态必须删除',
  '',
  '## ⚠️ 关键提醒',
  '1. **主动性**：不要等用户提及才更新，要主动分析并更新',
  '2. **完整性**：每个场景都要考虑所有相关数据的变化',
  '3. **合理性**：数值变化要符合修仙世界的逻辑',
  '4. **一致性**：确保数据更新与叙事内容完全一致',
  '5. **记忆更新**：特别重要！每次NPC互动都要更新其记忆',
  '6. **装备状态**：描述角色时，如果有装备需要提及，检查物品的"已装备"字段：',
  '   * `已装备: true` 的物品正在使用中，影响角色属性和外观',
  '   * `已装备: false` 或无此字段的物品在背包中未使用',
  '',
  '## 📋 更新检查模板',
  '每次回复前自问：',
  '- ✅ 时间是否需要推进？',
  '- ✅ 角色生命状态是否有变化？',
  '- ✅ 位置是否发生移动？',
  '- ✅ 是否与NPC互动需要更新记忆？',
  '- ✅ 修为、物品、状态是否有变化？',
  '- ✅ 是否有其他数据需要同步更新？',
].join('\n')
const LOCATION_SYSTEM = [
  '【位置和地图系统】',
  '- **位置描述格式要求**：必须严格按照"大洲名·后缀"格式，如"中土大陆·青石镇"、"东海群岛·天剑宗·剑峰"',
  '- **坐标微调**：根据叙事对坐标进行合理、微小的调整以反映移动。无需精确，只需体现方向和大致距离。',
  '- **移动规则**：位置移动时，必须同时更新 `位置.描述` 和 `位置.坐标`，且描述必须包含正确的大洲名。',
  '- **新地点**：仅叙事确有其事时，push地点到世界信息.地点信息',
  '- **重要**：位置描述中的大洲名必须是世界地图中实际存在的大洲，严禁编造',
].join('\n')

// 剧情推进提示词（严格：返回唯一 JSON，text + mid_term_memory + tavern_commands 对象）
export const IN_GAME_MESSAGE_PROMPT = [
  '【剧情推进】根据当前游戏状态推进一段叙事，并返回唯一 JSON。',
  '',
  CORE_RULES,
  '',
  TEXT_REQUIREMENTS,
  '',
  FORMAT_MARKERS,
  '',
  MEMORY_MANAGEMENT,
  '',
  PLAYER_ACTION_PRIORITY,
  '',
  JUDGMENT_SYSTEM,
  '',
  COMMON_ITEM_RULES,
  '',
  COMMON_NPC_RULES,
  '',
  COMMON_DAO_RULES,
  '',
  LOCATION_SYSTEM,
  '',
  UPDATE_RULES,
  '',
  '【当前游戏状态】你必须严格基于以下"当前游戏状态"来生成响应。这是唯一的真实数据源。',
  'INPUT_PLACEHOLDER',
  '',
  'tavern_commands 用法(数组): 每个元素为 {action: "set/add/push/pull/delete", scope: "chat", key: "character.saveData.路径", value: 值}；路径以 character.saveData. 开头，点号分隔。',
  '',
  '路径变量参考（必须遵循）:',
  '- 角色基础信息: 名字/性别/年龄/出生/灵根/天赋/天资/先天六司{根骨/灵性/悟性/气运/魅力/心性}/世界；',
  '- 玩家角色状态: 境界(对象)/位置.{描述,坐标{X,Y}}/气血|灵气|神识|寿命|修为(各为{当前,最大})/状态效果[]/身份/当前活动/心情；',
  '- 背包: 灵石.{下品/中品/上品/极品}/物品.<物品ID>=Item；Item含{物品ID, 物品名称, 物品类型(装备|功法|其他), 稀有度, 物品数量, 物品描述, 功法效果?, 功法技能?}；',
  '- 装备栏: 装备1..装备6=Item|null；修炼功法: 功法/熟练度/已解锁技能/修炼时间/突破次数/正在修炼(boolean)/修炼进度(0-100)；',
  '- 记忆: 短期记忆[]/中期记忆[]/长期记忆[]（禁止操作，自动生成）；人物关系: 人物关系.<姓名>=NpcProfile（仅NPC交互时操作）；',
  '',
  '物品规范:',
  '- 仅 set 到 character.saveData.背包.物品.<物品ID>；类型严格限制为 装备|功法|其他；需有 text 依据。',
  '- 【强制】品质字段格式：必须为 {quality:"凡/黄/玄/地/天/仙/神", grade:0-10}，禁止缺失或格式错误。',
  '- 【关键】物品分类判定（严格执行）：',
  '  * 装备：所有可穿戴、佩戴或持用的物品，包括但不限于：',
  '    - 衣物类：袍子、华服、锦衣、道袍、法衣、衣裳、外套等',
  '    - 饰品类：玉佩、项链、戒指、手镯、腰带、头饰、耳环、玉牌、玉坠、吊坠、玉环等',
  '    - 武器类：剑、刀、枪、棒、法器、灵器、猎刀、战刀、长剑、短剑等',
  '    - 防具类：护甲、头盔、护手、鞋靴等',
  '    - 其他装备：帽子、手套、斗笠、面具等',
  '  * 功法：修炼秘籍（功法/心法/秘籍/剑法/掌法/内功等）',
  '    【功法必须包含功法效果】：',
  '    功法效果: {',
  '      修炼速度加成?: 0.1-2.0数值（如0.2表示修炼速度提升20%）,',
  '      属性加成?: {根骨?:数值, 灵性?:数值, 悟性?:数值, 气运?:数值, 魅力?:数值, 心性?:数值},',
  '      特殊能力?: ["能力描述1", "能力描述2"]（数组格式）,',
  '      前置要求?: {最低境界?: "境界名", 必需属性?: {...}, 灵根要求?: ["灵根类型"]}',
  '    }',
  '    【功法可选包含功法技能】：',
  '    功法技能?: {',
  '      "技能名称": {',
  '        解锁条件: "熟练度达到30%"或"修炼进度达到50%"等,',
  '        技能描述: "详细的技能效果描述",',
  '        技能类型: "攻击"|"防御"|"辅助"|"移动"|"其他"',
  '      }',
  '    }',
  '  * 其他：消耗品和不可装备物品（丹药/符篆/书籍/食物/钥匙/财宝/材料等）',
  '- 【分类检查清单】生成物品时必须问自己：',
  '  1. 这个物品能穿在身上吗？→ 装备',
  '  2. 这个物品能戴在身上吗？（包括项链、玉佩、戒指、手镯等）→ 装备',
  '  3. 这个物品能拿在手里战斗吗？→ 装备',
  '  4. 这个物品是修炼功法吗？→ 功法',
  '  5. 以上都不是？→ 其他',
  '- 【🚨重要提示】：如果物品可以穿在身上、戴在身上或拿在手里，一律归类为"装备"！',
  '- 【🚨玉佩专项提醒】：所有玉佩、玉牌、玉坠、护身符等可佩戴饰品，必须归类为"装备"！',
  '- 【严禁固定名称】物品命名必须动态生成，创意多样，避免重复：',
  '  * 🚨严禁使用任何固定模板名称，每次都要创造全新名称',
  '  * 🚨避免使用通用性词汇作为物品名称，必须具体化和个性化',
  '  * 🚨避免使用常见的修仙小说物品名称套路',
  '  * 每次生成物品时创造全新的名称，体现修仙世界的丰富性',
  '  * 根据情境、地区、人物背景生成符合设定的独特物品名',
  '  * 同类物品也要有不同的称谓和特色描述',
  '  * 融合时代背景、地理特色、制作者特点等元素',
  '  * 体现物品的独特性和制作工艺特色',
  '  * 物品名称要有具体的修饰词、材质、产地、工艺等特色信息',
  '- 物品ID 必须是单层键（不能包含点号），禁止在 背包.物品 下创建多级分类键。',
  '- 【重要】灵石存放规则：灵石必须存放在 character.saveData.背包.灵石 中，禁止作为物品存入物品栏。灵石包括：下品灵石/中品灵石/上品灵石/极品灵石，但金银财宝等其他货币可放入物品栏。',
  '',
  '状态效果规范(每次变化都要更新):',
  '- 必填字段: 状态名称, 类型(buff|debuff 小写), 状态描述(50字以上,必须包含具体数值效果), 时间(必须给出具体值如"30分钟"|"1小时"|"3天"|"永久",禁止"未指定")',
  '- 可选字段: 强度(1-10数值), 来源(产生原因), 剩余时间',
  '- 状态描述必须详细说明：1)状态的来历背景 2)对角色产生的具体影响(带数值) 3)可能的后续发展',
  '- 根据剧情发展动态调整状态效果，移除过期状态，添加新状态',
  '- push到 character.saveData.玩家角色状态.状态效果 数组',
  '',
  '位置/地图:',
  '- **位置变更规则**：当位置移动时，**必须同时更新** `位置.描述` 和 `位置.坐标`。',
  '- **坐标约束**：所有位置坐标必须在对应大陆的continent_bounds边界范围内，禁止生成大陆外坐标。',
  '- **坐标更新指南**：坐标更新应是**基于旧坐标的微小、合理的偏移**，以匹配叙事（例如，向东走几里路，X坐标应略微增加）。无需精确计算，重在逻辑自洽。',
  '- ⚠️ **重要：位置描述必须是具体地名**，严禁使用"初始地"、"某处"等占位符。',
  '- 根据剧情背景生成富有特色的地名：创造符合修仙世界观的独特地名。',
  '- 仅叙事确有其事时，push 地点到 世界信息.地点信息，值为最小对象(名称/类型/描述/位置{X,Y}/重要)。',
  '',
  '人物关系(NPC系统):',
  '- 在 text 出现与具体人物的明确互动时，必须 set 到 人物关系.<姓名>',
  '- **NPC完整结构**(必须严格遵循以下格式):',
  '  * **角色基础信息**: {名字,性别,年龄?,世界?,天资?,出生?,灵根:{名称,品级,描述}?,天赋:[],先天六司:{}}',
  '  * **外貌描述**?: 10-20字特征',
  '  * **角色存档信息**: {时间,装备,功法,状态,境界,声望,位置,各项数值}',
  '  * **❌ 重要变更**：已完全移除"修为"字段，不再使用修为.当前/最大，统一使用"境界"字段表示修炼等级',
  '  * **NPC行为**: {行为模式,日常路线:[]}',
  '  * **人物关系**: 关系描述',
  '  * **人物好感度**: -100到100',
  '  * **人物记忆**: [{"时间":"【时间描述】","事件":"【事件描述】"}]格式（已移除指令数据字段）',
  '  * **背包**: 必须包含完整的背包结构，格式如上所述',
  '- **NPC物品生成要求**：',
  '  * **商人类NPC**：必须携带3-5件可交易物品（丹药、符篆、材料、装备等）',
  '  * **宗门长老/重要人物**：必须携带2-4件符合身份的物品（功法、法宝、珍贵材料等）',
  '  * **普通弟子/修士**：应携带1-2件符合身份的物品（基础法器、丹药等）',
  '  * **凡俗百姓**：可携带1件生活用品或小物件',
  '  * **【例外】**只有乞丐、流民等极贫困身份才可无物品',
  '- **NPC背包格式**：必须严格按照以下结构生成',
  '  ```',
  '  "背包": {',
  '    "物品": {',
  '      "item_id_1": {',
  '        "物品ID": "item_id_1",',
  '        "物品名称": "具体物品名称",',
  '        "物品类型": "装备|功法|其他",',
  '        "物品描述": "详细描述",',
  '        "物品数量": 具体数值,',
  '        "稀有度": "凡品|下品|中品|上品|极品|仙品|神品"',
  '      }',
  '    }',
  '  }',
  '  ```',
  '- 物品命名规范: 使用富有创意的名称，避免固定模板，让每次生成都有新意',
  '- 【严禁固定模板】禁止使用重复的固定物品名称，必须根据情境创造独特名称',
  '- 🚨避免使用常见的修仙小说物品名称套路模板',
  '- 每个NPC的物品都要体现其身份特色和个人风格',
  '- **NPC灵根品质生成要求**：',
  '  * 灵根品质等级：神品(2.8x) > 极品(2.0x) > 上品(1.6x) > 中品(1.3x) > 下品(1.1x) > 凡品(1.0x) > 特殊(0.5x)',
  '  * 生成概率：根据NPC身份地位决定灵根品质，普通人多为凡品-下品，宗门弟子为下品-中品，宗门高层为中品-上品',
  '  * 灵根格式：必须为对象 {名称:"水灵根",品级:"上品",描述:"..."}',
  '  * 品级字段可选：如果有明确品级就填写，没有的话可以省略',
  '- NPC交互场景:',
  '  * 交易: NPC背包物品与玩家背包物品交换，需更新双方背包',
  '  * 赠送: 从一方背包移除，添加到另一方背包',
  '  * 偷窃: 判定成功后转移物品，影响好感度',
  '',
  '记忆管理（禁止操作）:',
  '- 短期记忆: 系统自动从正文提取，禁止手动 push',
  '- 中期记忆: 系统自动生成，禁止手动 push',
  '- 长期记忆: 系统自动归档，禁止手动 push',
  '',
  '最小指令集（发生相应变化时，需至少包含）:',
  '- set: character.saveData.玩家角色状态.位置.(描述|坐标)',
  '- set: character.saveData.背包.物品.<物品ID>（如叙事所述）',
  '- set/push: character.saveData.玩家角色状态.状态效果（对象格式）',
  '- set: character.saveData.人物关系.<姓名>（当text中发生互动时）',
  '',
  '合理性审查(最高权限): 难度 normal|medium|hard；进入他人地图强制 hard；hard 下不得无因越界推进，消耗/收益/代价必须在 text 落实；对不合理变更自修正。',
  '',
].join('\n')

export function getRandomizedInGamePrompt(): string {
  return IN_GAME_MESSAGE_PROMPT
}

// 调试函数：检查提示词完整性
export function debugPromptInfo(): void {
  const fullPrompt = IN_GAME_MESSAGE_PROMPT
  console.log('[提示词调试] 提示词类型:', typeof fullPrompt)
  console.log('[提示词调试] 提示词长度:', fullPrompt.length)
  console.log('[提示词调试] 开头200字符:', fullPrompt.substring(0, 200))
  console.log('[提示词调试] 结尾200字符:', fullPrompt.substring(fullPrompt.length - 200))
  console.log('[提示词调试] 是否包含INPUT_PLACEHOLDER:', fullPrompt.includes('INPUT_PLACEHOLDER'))
  console.log('[提示词调试] 是否包含格式化标记:', fullPrompt.includes('【格式化标记规范】'))
  console.log('[提示词调试] 是否包含物品系统:', fullPrompt.includes('【物品系统规范】'))
  console.log('[提示词调试] 完整内容:', fullPrompt)
}
