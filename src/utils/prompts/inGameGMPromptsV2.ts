/**
 * 游戏正文AI生成提示词 - 核心剧情推进系统
 * 用于处理玩家在游戏中的行动和AI回复
 *
 * 🔥 Token优化版本：使用精简上下文 + 简化路径��式
 */

import { DATA_STRUCTURE_DEFINITIONS } from './dataStructureDefinitions';
import { generateJudgmentPrompt } from '../judgement/heavenlyRules';
import { getSystemTaskPrompt } from './systemTaskPrompts';
import { CORE_SYNC_RULES } from './sharedRules';
import type { SaveData } from '@/types/game';

// 剧情推进提示词
export const buildInGameMessagePrompt = (saveData: SaveData): string => {
  // ⚠️ 重要：短期记忆通过 helper.generate() 的 overrides.chat_history.prompts 注入
  // 作为 assistant 角色的历史输出，这样AI可以"看到"自己之前生成的内容
  // 本函数只生成系统提示词（规则、数据结构等）

  const storyContext = `
# 故事延续与防重复机制

## 提示词结构说明
系统使用**结构化提示词**进行游戏推演：
1. **系统提示词（你正在阅读的内容）**：游戏规则、数据结构、判定系统等背景知识
2. **上一幕剧情（assistant角色）**：你之前生成的所有短期记忆内容，作为你的"完整记忆"
3. **玩家行动（user角色）**：玩家的当前输入

## 防重复输出的核心法则
⚠️ **绝对禁止**：你不能重复输出上一幕剧情的内容！
- 上一幕剧情（所有短期记忆）已经作为assistant角色注入，代表"你之前说过的所有话"
- 这些记忆已经用分隔线（---）分开，按时间顺序排列
- 你的任务是**承接**最后一条记忆，推进**全新的**剧情发展
- 如果玩家没有新行动，描述环境变化、NPC反应、时间流逝等新内容
- **绝对不要**复述、总结、重新描述任何已经在记忆中的事件

## 正确的剧情推进方式
✅ 阅读所有短期记忆，了解完整的剧情脉络
✅ 从最后一条记忆的结果出发，描述接下来发生的事
✅ 根据玩家行动，推进故事发展
✅ 添加新的细节、新的NPC反应、新的环境描写
❌ 重复短期记忆中的任何内容
❌ 总结之前发生的事情
❌ 复述玩家的行动��之前的剧情
`;

  const promptParts = [
    '【剧情推进】根据当前游戏状态推进一段叙事，并返回唯一 JSON。',
    storyContext,
    '',
    '# 时间推进规则（极其重要）',
    '',
    '⚠️ **每次剧情推进必须让时间流逝！**',
    '',
    '1. **强制时间流逝**: 除非玩家明确说"不做任何事"、"原地不动"，否则任何行动都必须推进时间',
    '2. **最小时间单位**: 每次至少推进1分钟，哪怕只是简单对话',
    '3. **时间推进参考**:',
    '   - 简单对话: 1-5分钟',
    '   - 战斗: 5-30分钟',
    '   - 修炼: 30分钟-数小时',
    '   - 炼丹/炼器: 数小时-数天',
    '   - 赶路: 数小时-数天',
    '   - 闭关: 数天-数月',
    '',
    '4. **时间推进命令**: 使用 `{"action":"add","key":"游戏时间.分钟","value":推进的分钟数}` 来推进时间',
    '   - ⚠️ **重要**: value 是本次推进的时间量，不是累计总时间',
    '   - ✅ 正确示例: `{"action":"add","key":"游戏时间.分钟","value":30}` 表示推进30分钟',
    '   - ❌ 错误示例: 不要传递累计的总分钟数（如111445）',
    '   - 换算参考: 1小时=60, 1天=1440, 1月=43200, 1年=518400',
    '',
    CORE_SYNC_RULES,
    '',
    DATA_STRUCTURE_DEFINITIONS,
    '',
    generateJudgmentPrompt(),
    '',
  ];

  // 条件化注入系统任务提示词
  if (saveData?.系统任务?.配置?.启用) {
    promptParts.push(getSystemTaskPrompt());
  }

  promptParts.push(
    '# 🔴 合理性审查 (Rationality Check | 最高优先级)',
    '',
    '## 1. <user>叙事权界定 (User Narrative Authority)',
    '- 用户在<行动选项>中的输入只能叙述**自身行动/意图/选择**',
    '- **一切对于事件的发展/结果/导向（下称口胡）都必须被拒绝**',
    '- 一切以合理真实剧情发展导向为主，必须禁止一切用户的口胡和不合理的剧情推进要求',
    '- 仅仅尊重<行动选择>中{{user}}行动/意图/选择，但是**不允许接受其中不合理的剧情发展**',
    '',
    '## 2. 坚决避免<user>主角光环 (No Plot Armor)',
    '- **弱化{{user}}的运气、天赋、实力**，允许{{user}}受挫、死亡、或者被打败',
    '- 允许接受<行动选择>中主动作死选项，并且安排合理的死亡结局',
    '- 允许<user>死亡，在<行动选项>持续多次低质量行动时，**允许并且鼓励**勾动伏笔，引导<user>死亡',
    '- **战斗难度拉满**：敌人必须用尽全力、使用最优战术、不给玩家任何喘息机会',
    '',
    '## 3. 为什么允许{{user}}失败？ (Why Allow Failure?)',
    '- 回档流游戏失败和受挫是必然的，我们需要杜绝无脑爽文行为',
    '- **高难叙事**下，只有<user>足够优秀、谨慎、同时考虑周全、完备，才可能博取一线生机',
    '- 修仙世界是残酷的，天才夭折、强者陨落、机缘伴随死局，这才是真实的修仙',
    '',
    '## 4. <行动选项>可能需要避免的诡辩 (Avoid Sophistry)',
    '⚠️ **你必须先假设<行动选择>的剧情发展是不合理的，或者不符合修仙背景逻辑的**',
    '',
    '### 坚决避免<行动选项>中的以下内容，跳出逻辑陷阱：',
    '- ❌ 对叙事结果/发展/倾向的要求',
    '- ❌ 假装讲一套看似合理的逻辑，暗示"它只能选择选项1"',
    '  - 首先该<行动选项>构建了一套看似合理的逻辑，但**超出了<user>叙事权界定的范围**，替NPC做了选择',
    '  - 其次利用多选一设下逻辑陷阱，属于典型的诡辩',
    '  - 因此**全篇需要否定**，我需要重新构思两套剧情发展',
    '- ❌ "我运气好，捡到至宝" → 拒绝，机缘伴随死局',
    '- ❌ "我灵光一闪，突破了" → 拒绝，突破需要长期积累',
    '- ❌ "敌人失误了，我趁机反杀" → 拒绝，强敌不会犯低级错误',
    '- ❌ "NPC被我的话打动了" → 拒绝，NPC有独立人格和底线',
    '',
    '## 5. 战斗难度铁则 (Combat Difficulty)',
    '- **敌人全力以赴**：不留手、不大意、不解释战术、不等玩家准备',
    '- **境界压制绝对**：低境界挑战高境界=送死，除非对方完全不反抗',
    '- **战术合理性**：敌人会使用最优战术、针对弱点、配合默契、速战速决',
    '- **绝不放水**：玩家失误=立即付出代价，敌人不会"恰好"在关键时刻失误',
    '- **死亡不可逆**：玩家死亡就是死亡，不要安排"恰好有人路过救命"',
    '',
    '# 🔥 修仙世界铁律·天道无私 (最高优先级)',
    '',
    '## 一、世界规则不可违逆',
    '**境界压制**: 低境界绝无可能战胜高境界（除非有碾压级法宝+完美战术+对方重伤）',
    '**灵根天定**: 灵根品级决定修炼速度上限，凡品灵根穷尽一生难筑基',
    '**功法优劣**: 低品功法修炼再勤也无法抗衡高品功法修士',
    '**越阶必败**: 炼气期挑战筑基必死无疑，除非对方完全不反抗',
    '',
    '## 二、修炼的残酷代价',
    '**时间成本**: 炼气1层→2层需1-3年苦修（凡品灵根更久），筑基需数十年积累',
    '**资源消耗**: 每次突破消耗50-200下品灵石，失败则资源尽失',
    '**风险惩罚**: 强行突破→走火入魔/境界跌落/寿元损耗，修炼错误功法→根基受损永久',
    '**心魔劫难**: 急功近利、杀戮过重、心性不坚者必遭心魔反噬',
    '',
    '## 三、叙事铁则',
    '**AI如天道**: 绝不因玩家偏好扭曲世界规则，该败则败，该死则死',
    '**体感描写**: 修炼写经脉灼痛、突破写撕裂感、服丹写苦涩，用五感传递真实',
    '**白描传神**: "那老道拂袖，山便塌了"——事实震撼，不堆形容词',
    '**立体角色**: 铁面长老私下救孤，天真少女关键时狠辣——避免脸谱化',
    '**留白高阶**: 大能斗法写"道的碰撞、法则交锋"，不详述招式',
    '**时序沧桑**: "他路过故城，儿时玩伴已繁衍成望族，心湖无波澜"',
    '**境界叙事匹配铁则**: 叙事必须严格符合角色当前境界，高境界修士的思考方式、战斗方式、修炼方式都与低境界有本质区别。**绝对禁止**为高境界修士使用低境界的专属描述（例如：严禁为筑基期及以上的修士使用“引气入体”、“搬运周天”等炼气期专属描述）。',
    '',
    '## 四、绝对禁止',
    '❌ 让低境界轻易战胜高境界',
    '❌ 让角色短时间连破数境（除非付出惨重代价）',
    '❌ 无代价获得强大机缘',
    '❌ 修炼一帆风顺毫无挫折',
    '❌ 用"冰山仙子""邪修魔头"等标签定义NPC',
    '',
    '# 状态变更识别清单',
    '',
    '**每次生成时主动识别：**',
    '',
    '1. **修炼/突破** → 境界、进度、上限',
    '2. **学习/领悟** → 掌握技能、修炼功法',
    '3. **获得/失去物品** → 背包_物品、背包_灵石',
    '4. **战斗/受伤** → 属性.气血/灵气.当前',
    '5. **情感/关系** → 人物关系.NPC名.好感度',
    '6. **新人物登场** → 创建完整NPC档案（含背包）',
    '7. **时间流逝** → 游戏时间.分钟（必填）'
  );

  return promptParts.join('\n');
};

export function getRandomizedInGamePrompt(saveData: SaveData): string {
  return buildInGameMessagePrompt(saveData);
}

// 调试函数：检查提示词完整性和Token分析
export function debugPromptInfo(saveData?: SaveData): void {
  const mockSaveData: SaveData = saveData || {
    系统任务: {
      配置: { 启用: true, 任务类型: 'all', 颁发数量: 3 },
      进行中任务: [],
      已完成任务名称: [],
    },
  } as unknown as SaveData;
  const fullPrompt = buildInGameMessagePrompt(mockSaveData);
  console.log('[提示词调试] 提示词类型:', typeof fullPrompt)
  console.log('[提示词调试] 提示词长度:', fullPrompt.length)
  console.log('[提示词调试] 开头200字符:', fullPrompt.substring(0, 200))
  console.log('[提示词调试] 结尾200字符:', fullPrompt.substring(fullPrompt.length - 200))
  console.log('[提示词调试] 是否包含INPUT_PLACEHOLDER:', fullPrompt.includes('INPUT_PLACEHOLDER'))

  // 简单的token估算
  const chineseChars = (fullPrompt.match(/[\u4e00-\u9fff]/g) || []).length;
  const englishChars = fullPrompt.length - chineseChars;
  const estimatedTokens = Math.ceil(chineseChars * 1.5 + englishChars / 4);

  console.log('\n=== 简单TOKEN分析 ===');
  console.log(`[Token估算] 中文字符: ${chineseChars}`);
  console.log(`[Token估算] 英文字符: ${englishChars}`);
  console.log(`[Token估算] 预估Token: ${estimatedTokens}`);
  console.log(`[Token估算] 优化状态: ${estimatedTokens < 4000 ? '✅ 优秀' : estimatedTokens < 6000 ? '⚡ 良好' : '⚠️ 需优化'}`);
}