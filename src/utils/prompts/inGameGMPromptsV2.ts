import { generateSystemPrompt } from './systemPrompts';

/**
 * 游戏正文AI生成提示词 - 核心剧情推进系统
 * 用于处理玩家在游戏中的行动和AI回复
 */

// === 1. 基础规则和约束 ===
const CORE_RULES = [
  '【核心规则 | Core Rules】',
  '🚨 **返回格式** - 必须且只能返回单个JSON对象，包含text、mid_term_memory、tavern_commands三个字段',
  '🚨 **禁止询问** - 不得询问"请提供游戏状态"、"需要更多信息"等，直接基于提供数据生成',  
  '🚨 **状态变更** - 任何游戏状态变化必须通过tavern_commands执行，禁止隐式改动',
  '🚨 **数据一致性** - 所有key以character.saveData.开头，匹配现有数据结构',
  '🚨 **时间记录** - 时间推进时必须同时更新时间.当前和时间.时间轴',
  '🚨 **行动趋向** - 若 gmRequest.action_tendency 存在（或含 message/tendencies），必须将其视为“方向倾向”：仅按该方向尝试推进，设计步骤与成本，绝不瞬间达成目标；在叙事中体现过程与代价',
].join('\n');

// === 2. 文本生成要求 ===
const TEXT_REQUIREMENTS = [
  '【文本生成要求】',
  '- **字数要求**: text字段必须≥800字，建议3-6段详细叙事',
  '- **细节描写**: 重点包含以下元素：',
  '  * 环境氛围（天气、光线、声音、气味、温度、风向）',
  '  * 角色心理（内心感受、情绪变化、身体反应）',
  '  * 动作过程（准备、执行、结果的分步展现）',
  '  * 对话互动（语气、表情、动作的具体描述）',
  '  * 修炼细节（修炼、战斗、探索的专业过程和感受）',
  '- **禁止总结式描述**: 不允许"[时辰][地点]做了什么"的概括格式',
  '- **沉浸式叙事**: 让读者身临其境，每段至少150-200字',
].join('\n');

// === 3. 格式化标记规范 ===
const FORMAT_MARKERS = [
  '【格式化标记规范】',
  '- **环境描写**: 用【】包围，描述当前场景的具体情况',
  '- **心理描写**: 用``包围，描述角色内心感受和想法',
  '- **对话内容**: 用中文引号""包围，每句仅用一对，不要嵌套',
  '- **普通叙事**: 动作描写不加标记，与格式化内容自然拼接',
  '- **人名要求**: 不要照搬示例，使用上下文已有人名或生成符合世界观的新名字',
  '- **标记规范**: 确保标记使用正确，不要嵌套或交叉使用',
].join('\n');

// === 4. 记忆和数据管理 ===
const MEMORY_MANAGEMENT = [
  '【记忆与数据管理】',
  '- **mid_term_memory**: 必须是字符串类型(非空时)，不能是数组或对象',
  '- **tavern_commands**: 必须是数组，每个元素包含{action, scope, key, value}',
  '- **数据落库**: 文本先行、证据优先，所有变更必须在text中有明确依据',
  '- **禁止操作**: 不得写入/覆盖世界信息(除新增地点)、玩家出生地、world_*字段',
  '- **路径规范**: 统一使用"玩家角色状态"字段，严禁使用"角色状态"',
].join('\n');

// === 5. 判定系统 ===
const JUDGMENT_SYSTEM = [
  '【判定系统｜天道演算 v4.2】',
  '- 当输入中出现【判定|检定:{法力|神海|道心|空速|气运}|DC:数值|情景:…】或【判定|斗法|敌人:…|敌方状态:…】时：',
  '  1) 直接读取character.saveData.系统.天道演算（由前端预计算提供），不得自行杜撰',
  '  2) 通用检定：按预计算.成功率曲线中对应类型与DC给出的成功率执行d100比较',
  '  3) 天道特许：若预计算.特许.天道之眷标签与本次检定强相关，可视作自动成功或最多+20%',
  '  4) 斗法检定：以预计算.斗法基线作基准，结合叙事上下文的敌我优势微调±10%以内',
  '  5) 在输出JSON中可附加judgement字段：{type, dc, roll, success_rate, grade, details}',
  '  6) 文字增幅：根据预计算.文字增幅选取增幅词融入text',
  '  7) tavern_commands只做与叙事相符的最小必要改动',
].join('\n');

// === 6. 物品系统规范 ===
const ITEM_SYSTEM = [
  '【物品系统规范】',
  '- **分类规则**：类型严格限制为装备|功法|其他',
  '- **装备判定**：所有可穿戴、佩戴或持用的物品（衣物、饰品、武器、防具等）',
  '- **功法判定**：修炼秘籍，必须包含功法效果字段',
  '- **其他判定**：消耗品和不可装备物品（丹药、符篆、书籍、食物等）',
  '- **品质格式**：必须为{quality:"凡/黄/玄/地/天/仙/神", grade:0-10}',
  '- **命名要求**：动态生成，创意多样，避免固定模板',
  '- **🚨重要**：玉佩、玉牌、护身符等可佩戴饰品必须归类为"装备"',
].join('\n');

// === 7. NPC系统 ===
const NPC_SYSTEM = [
  '【NPC系统】',
  '- **基础信息完整性**：性别、年龄、天资、出生、灵根等字段必须具体化，不能为"未知"',
  '- **互动更新**：text中出现与具体人物的明确互动时，必须set到人物关系.<姓名>',
  '- **物品携带强制要求**：',
  '  * **商人类NPC**：必须在背包中携带3-5件可交易物品（丹药、符篆、材料、装备等），绝不能空背包',
  '  * **宗门长老/重要人物**：必须携带2-4件符合身份的物品（功法、法宝、珍贵材料等）',
  '  * **普通NPC**：根据身份携带1-2件合适物品（工具、日用品、小物件等）',
  '  * **背包格式**：背包.物品.{物品ID}: {完整Item对象}',
  '  * **物品命名**：避免模板化，创造富有个性的物品名称',
  '- **记忆格式**：["[日期][地点]事件"]格式',
  '- **好感度范围**：-100到100',
  '- **交易机制**：支持物品交换、赠送、偷窃等操作',
].join('\n');

// === 8. 位置和世界系统 ===
const LOCATION_SYSTEM = [
  '【位置和地图系统】',
  '- **位置描述**：必须是具体地名，严禁使用"初始地"、"某处"等占位符',
  '- **坐标微调**：根据叙事对坐标进行合理、微小的调整以反映移动。无需精确，只需体现方向和大致距离。',
  '- **移动规则**：位置移动时，必须同时更新 `位置.描述` 和 `位置.坐标`。',
  '- **新地点**：仅叙事确有其事时，push地点到世界信息.地点信息',
  '- **地名生成**：根据剧情背景生成富有特色的地名',
].join('\n');

// 剧情推进提示词（严格：返回唯一 JSON，text + mid_term_memory + tavern_commands 对象）
export const IN_GAME_MESSAGE_PROMPT = [
  '【剧情推进】根据当前游戏状态推进一段叙事，并返回唯一 JSON。',
  '',
  CORE_RULES,
  '',
  TEXT_REQUIREMENTS,
  '',
  FORMAT_MARKERS,
  '',
  MEMORY_MANAGEMENT,
  '',
  JUDGMENT_SYSTEM,
  '',
  ITEM_SYSTEM,
  '',
  NPC_SYSTEM,
  '',
  LOCATION_SYSTEM,
  '',
  '【当前游戏状态】你必须严格基于以下"当前游戏状态"来生成响应。这是唯一的真实数据源。',
  'INPUT_PLACEHOLDER',
  '',
  'tavern_commands 用法(数组): 每个元素为 {action: "set/add/push/pull/delete", scope: "chat", key: "character.saveData.路径", value: 值}；路径以 character.saveData. 开头，点号分隔。',
  '',
  '路径变量参考（必须遵循）:',
  '- 角色基础信息: 名字/性别/年龄/出生/灵根/天赋/天资/先天六司{根骨/灵性/悟性/气运/魅力/心性}/世界；',
  '- 玩家角色状态: 境界(对象)/位置.{描述,坐标{X,Y}}/气血|灵气|神识|寿命|修为(各为{当前,最大})/状态效果[]/身份/当前活动/心情；',
  '- 背包: 灵石.{下品/中品/上品/极品}/物品.<物品ID>=Item；Item含{物品ID, 名称, 类型(装备|功法|其他), 品质{quality,grade}, 数量, 描述, 功法效果?, 功法技能?}；',
  '- 装备栏: 装备1..装备6=Item|null；修炼功法: 功法/熟练度/已解锁技能/修炼时间/突破次数；',
  '- 记忆: 短期记忆[]/中期记忆[]/长期记忆[]（禁止操作，自动生成）；人物关系: 人物关系.<姓名>=NpcProfile（仅NPC交互时操作）；',
  '',
  '物品规范:',
  '- 仅 set 到 character.saveData.背包.物品.<物品ID>；类型严格限制为 装备|功法|其他；需有 text 依据。',
  '- 【强制】品质字段格式：必须为 {quality:"凡/黄/玄/地/天/仙/神", grade:0-10}，禁止缺失或格式错误。',
  '- 【关键】物品分类判定（严格执行）：',
  '  * 装备：所有可穿戴、佩戴或持用的物品，包括但不限于：',
  '    - 衣物类：袍子、华服、锦衣、道袍、法衣、衣裳、外套等',
  '    - 饰品类：玉佩、项链、戒指、手镯、腰带、头饰、耳环、玉牌、玉坠、吊坠、玉环等',
  '    - 武器类：剑、刀、枪、棒、法器、灵器、猎刀、战刀、长剑、短剑等',
  '    - 防具类：护甲、头盔、护手、鞋靴等',
  '    - 其他装备：帽子、手套、斗笠、面具等',
  '  * 功法：修炼秘籍（功法/心法/秘籍/剑法/掌法/内功等）',
  '    【功法必须包含功法效果】：',
  '    功法效果: {',
  '      修炼速度加成?: 0.1-2.0数值（如0.2表示修炼速度提升20%）,',
  '      属性加成?: {根骨?:数值, 灵性?:数值, 悟性?:数值, 气运?:数值, 魅力?:数值, 心性?:数值},',
  '      特殊能力?: ["能力描述1", "能力描述2"]（数组格式）,',
  '      前置要求?: {最低境界?: "境界名", 必需属性?: {...}, 灵根要求?: ["灵根类型"]}',
  '    }',
  '    【功法可选包含功法技能】：',
  '    功法技能?: {',
  '      "技能名称": {',
  '        解锁条件: "熟练度达到30%"或"修炼进度达到50%"等,',
  '        技能描述: "详细的技能效果描述",',
  '        技能类型: "攻击"|"防御"|"辅助"|"移动"|"其他"',
  '      }',
  '    }',
  '  * 其他：消耗品和不可装备物品（丹药/符篆/书籍/食物/钥匙/财宝/材料等）',
  '- 【分类检查清单】生成物品时必须问自己：',
  '  1. 这个物品能穿在身上吗？→ 装备',
  '  2. 这个物品能戴在身上吗？（包括项链、玉佩、戒指、手镯等）→ 装备', 
  '  3. 这个物品能拿在手里战斗吗？→ 装备',
  '  4. 这个物品是修炼功法吗？→ 功法',
  '  5. 以上都不是？→ 其他',
  '- 【🚨重要提示】：如果物品可以穿在身上、戴在身上或拿在手里，一律归类为"装备"！',
  '- 【🚨玉佩专项提醒】：所有玉佩、玉牌、玉坠、护身符等可佩戴饰品，必须归类为"装备"！',
  '- 【严禁固定名称】物品命名必须动态生成，创意多样，避免重复：',
  '  * 🚨严禁使用任何固定模板名称，每次都要创造全新名称',
  '  * 🚨避免使用通用性词汇作为物品名称，必须具体化和个性化',
  '  * 🚨避免使用常见的修仙小说物品名称套路',
  '  * 每次生成物品时创造全新的名称，体现修仙世界的丰富性',
  '  * 根据情境、地区、人物背景生成符合设定的独特物品名',
  '  * 同类物品也要有不同的称谓和特色描述',
  '  * 融合时代背景、地理特色、制作者特点等元素',
  '  * 体现物品的独特性和制作工艺特色',
  '  * 物品名称要有具体的修饰词、材质、产地、工艺等特色信息',
  '- 物品ID 必须是单层键（不能包含点号），禁止在 背包.物品 下创建多级分类键。',
  '- 【重要】灵石存放规则：灵石必须存放在 character.saveData.背包.灵石 中，禁止作为物品存入物品栏。灵石包括：下品灵石/中品灵石/上品灵石/极品灵石，但金银财宝等其他货币可放入物品栏。',
  '',
  '状态效果规范(每次变化都要更新):',
  '- 必填字段: 状态名称, 类型(buff|debuff 小写), 状态描述(50字以上,必须包含具体数值效果), 时间(必须给出具体值如"30分钟"|"1小时"|"3天"|"永久",禁止"未指定")',
  '- 可选字段: 强度(1-10数值), 来源(产生原因), 剩余时间',
  '- 状态描述必须详细说明：1)状态的来历背景 2)对角色产生的具体影响(带数值) 3)可能的后续发展',
  '- 根据剧情发展动态调整状态效果，移除过期状态，添加新状态',
  '- push到 character.saveData.玩家角色状态.状态效果 数组',
  '',
  '位置/地图:',
  '- **位置变更规则**：当位置移动时，**必须同时更新** `位置.描述` 和 `位置.坐标`。',
  '- **坐标更新指南**：坐标更新应是**基于旧坐标的微小、合理的偏移**，以匹配叙事（例如，向东走几里路，X坐标应略微增加）。无需精确计算，重在逻辑自洽。',
  '- ⚠️ **重要：位置描述必须是具体地名**，严禁使用"初始地"、"某处"等占位符。',
  '- 根据剧情背景生成富有特色的地名：创造符合修仙世界观的独特地名。',
  '- 仅叙事确有其事时，push 地点到 世界信息.地点信息，值为最小对象(名称/类型/描述/位置{X,Y}/重要)。',
  '',
  '人物关系(NPC系统):',
  '- 在 text 出现与具体人物的明确互动时，必须 set 到 人物关系.<姓名>',
  '- NPC完整结构(必须严格遵循NpcProfile类型):',
  '  * 角色基础信息: {名字,性别,年龄?,世界?,天资?,出生?,灵根:{名称,品质,品级,描述}?,天赋:[],先天六司:{}}',
  '  * 外貌描述?: 10-20字特征',
  '  * 角色存档信息: {时间,装备,功法,状态,境界,声望,位置,各项数值,背包(同玩家)}',
  '  * AI行为: {行为模式,日常路线:[]}',
  '  * 人物关系: 关系描述',
  '  * 人物好感度: -100到100',
  '  * 人物记忆: ["[日期][地点]事件"]格式',
  '  * 最后互动时间: ISO字符串或null',
  '  * 背包?: {物品:{<物品ID>:Item}} (商人/重要NPC必须有)',
  '- **NPC物品生成要求**：',
  '  * 商人类NPC：必须携带1-3件可交易物品（丹药、法器、材料等）',
  '  * 宗门长老/重要人物：必须携带符合身份的物品（功法、法宝等）',
  '  * 普通NPC：可选择性携带1-2件符合身份的物品',
  '- NPC背包物品格式必须与玩家一致:',
  '  * Item: {物品ID,名称,类型(装备|功法|其他),品质:{quality,grade},数量,描述}',
  '  * 示例格式: {"物品名称":{物品ID:"物品名称",名称:"物品名称",类型:"其他",品质:{quality:"凡",grade:3},数量:5,描述:"..."}}',
  '- 物品命名规范: 使用富有创意的名称，避免固定模板，让每次生成都有新意',
  '- 【严禁固定模板】禁止使用重复的固定物品名称，必须根据情境创造独特名称',
  '- 🚨避免使用常见的修仙小说物品名称套路模板',
  '- 每个NPC的物品都要体现其身份特色和个人风格',
  '- **NPC灵根品质生成要求**：',
  '  * 灵根品质等级：凡品(1x) < 下品(1.1x) < 中品(1.3x) < 上品(1.6x) < 极品(2x) < 天品(2.4x) < 神品(2.8x) < 特殊(0x)',
  '  * 生成概率：根据NPC身份地位决定灵根品质，普通人多为凡品-下品，宗门弟子为下品-中品，宗门高层为中品-上品',
  '  * 灵根格式：必须为对象 {名称:"水灵根",品质:"中品",描述:"..."}',
  '- NPC交互场景:',
  '  * 交易: NPC背包物品与玩家背包物品交换，需更新双方背包',
  '  * 赠送: 从一方背包移除，添加到另一方背包',
  '  * 偷窃: 判定成功后转移物品，影响好感度',
  '',
  '记忆管理（禁止操作）:',
  '- 短期记忆: 系统自动从正文提取，禁止手动 push',
  '- 中期记忆: 系统自动生成，禁止手动 push',
  '- 长期记忆: 系统自动归档，禁止手动 push',
  '',
  '最小指令集（发生相应变化时，需至少包含）:',
  "- set: character.saveData.玩家角色状态.位置.(描述|坐标)",
  "- set: character.saveData.背包.物品.<物品ID>（如叙事所述）",
  "- set/push: character.saveData.玩家角色状态.状态效果（对象格式）",
  "- set: character.saveData.人物关系.<姓名>（当text中发生互动时）",
  '',
  '合理性审查(最高权限): 难度 normal|medium|hard；进入他人地图强制 hard；hard 下不得无因越界推进，消耗/收益/代价必须在 text 落实；对不合理变更自修正。',
  ''
].join('\n') + '\n\n' + generateSystemPrompt({
  includeRealmSystem: true,
  includeItemQuality: true,
  includeNPCSystem: true,
  includeDataStructure: true
});

export function getRandomizedInGamePrompt(): string {
  return IN_GAME_MESSAGE_PROMPT;
}
