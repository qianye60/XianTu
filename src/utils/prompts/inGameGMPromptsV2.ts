import { generateSystemPrompt } from './systemPrompts';

// 剧情推进提示词（严格：返回唯一 JSON，text + mid_term_memory + tavern_commands 对象）
export const IN_GAME_MESSAGE_PROMPT = [
  '【剧情推进】根据当前游戏状态推进一段叙事，并返回唯一 JSON。',
  '',
  '必须返回字段: text(字符串), mid_term_memory(字符串), tavern_commands(对象)。',
  '格式要求:',
  '- text: 必须是字符串类型，长度≥800字，建议3-6段详细叙事，重点描述：',
  '  * 环境氛围和场景细节（天气、光线、声音、气味、温度、风向等）',
  '  * 角色的内心感受、情绪变化和身体反应的细致描写',
  '  * 动作过程的分步骤详细展现，包括准备、执行、结果',
  '  * 对话和互动的具体内容，包括语气、表情、动作',
  '  * 修炼、战斗、探索等过程的专业细节和感受',
  '  * 禁止使用总结式、概括式描述，必须用具体场景和细节展现',
  '  * 每个段落至少150-200字，用生动的描写让读者身临其境',
  '  【格式化标记要求】:',
  '  * 环境描写用【】包围，如：【夕阳西下，破庙中光影斑驳，空气中弥漫着檀香与尘土的味道】',
  '  * 心理描写用``包围，如：`内心涌起一阵紧张和期待，仿佛命运的转折就在此刻`',
  '  * 对话内容用中文引号“”包围（或半角双引号""），且每句仅用一对，不要嵌套；例如：“<NPC姓名>，这引气丹真的能帮我踏入修行之路吗？”（仅为格式示例，切勿在输出中直接使用示例人名）',
  '  * 不要照搬示例中的人名/地名；请使用上下文已有的人名，或生成符合世界观、随机且不重复的人名',
  '  * 普通叙事和动作描写不加标记，与格式化内容自然拼接',
  '  * 确保标记使用正确，不要嵌套或交叉使用',
  '- mid_term_memory: 中期记忆，必须是字符串类型(非空时)，不能是数组或对象',
  '- tavern_commands: 必须是对象类型，包含set/add/push/pull/delete字段，不能是数组',
  '严格要求:',
  '- 【重要】禁止简短总结：绝不能使用"[时辰][地点]做了什么"的总结格式',
  '- 【重要】必须展开描写：每个动作、每个感受都要用具体的场景来表现',
  '- 【重要】沉浸式叙事：让读者感觉身临其境，而不是在听别人转述',
  '- 文本先行、证据优先：所有变更(位置偏移/地图/背包/属性/机制判定/好感/宗门/环境)必须在 text 中出现明确依据，否则不要生成。',
  '- 禁止写入/覆盖 character.saveData.世界信息(除确有其事新增地点外)、玩家出生地、任意 world_*；禁止整体覆盖 character.saveData。',
  '- 所有路径必须以 character.saveData. 开头；参考输入 reference.chatVariables 的现有结构进行写入，严禁新增平行根路径。',
  '- 统一使用"玩家角色状态"字段，严禁使用"角色状态"作为路径段名。',
  '- tavern_commands 的每条命令必须使用 key 字段（不要使用 path/target），并包含 { action, key, value }（delete 除外）。',
  '',
  '【重要】记忆生成规则：',
  '- 禁止通过 tavern_commands 生成任何记忆相关命令',
  '- 禁止 push 到 character.saveData.记忆.短期记忆 或 character.saveData.记忆.中期记忆',
  '- 禁止 push 到 character.saveData.记忆.长期记忆',
  '- 游戏记忆系统会自动从正文内容中提取和生成记忆',
  '- 只有明确的NPC人物交互时，才可以操作 character.saveData.人物关系',
  '',
  '输入(游戏上下文+参考 JSON):',
  'INPUT_PLACEHOLDER',
  '',
  'tavern_commands 用法(对象): set/add/push/pull/delete；路径以 character.saveData. 开头，点号分隔。',
  '',
  '路径变量参考（必须遵循）:',
  '- 角色基础信息: 名字/性别/年龄/出生/灵根/天赋/天资/先天六司{根骨/灵性/悟性/气运/魅力/心性}/世界；',
  '- 玩家角色状态: 境界(对象)/位置.{描述,坐标{X,Y}}/气血|灵气|神识|寿命|修为(各为{当前,最大})/状态效果[]/身份/当前活动/心情；',
  '- 背包: 灵石.{下品/中品/上品/极品}/物品.<物品ID>=Item；Item含{物品ID, 名称, 类型(法宝|功法|其他), 品质{quality,grade}, 数量, 描述}；',
  '- 装备栏: 法宝1..法宝6=Item|null；修炼功法: 功法/熟练度/已解锁技能/修炼时间/突破次数；',
  '- 记忆: 短期记忆[]/中期记忆[]/长期记忆[]（禁止操作，自动生成）；人物关系: 人物关系.<姓名>=NpcProfile（仅NPC交互时操作）；',
  '',
  '物品规范:',
  '- 仅 set 到 character.saveData.背包.物品.<物品ID>；类型仅 法宝|功法|其他；需有 text 依据。',
  '- 判定规则：',
  '  * 法宝：武器/兵器/法器/灵器/宝物/剑/刀/飞剑/防具/衣物/护甲/布衣/道袍/法衣...',
  '  * 功法：功法/心法/秘籍/法诀/经书/法门/内功/刀法/剑法/要诀/修炼法门...',
  '  * 其他：丹药/消耗品/材料/资源/储物袋/令牌/玉简/灵石/草药/矿石...',
  '- 物品ID 必须是单层键（不能包含点号），禁止在 背包.物品 下创建多级分类键。',
  '',
  '状态效果规范(每次变化都要更新):',
  '- 必填字段: 状态名称, 类型(buff|debuff 小写), 状态描述(50字以上,必须包含具体数值效果), 时间(必须给出具体值如"30分钟"|"1小时"|"3天"|"永久",禁止"未指定")',
  '- 可选字段: 强度(1-10数值), 来源(产生原因), 剩余时间',
  '- 状态描述必须详细说明：1)状态的来历背景 2)对角色产生的具体影响(带数值) 3)可能的后续发展',
  '- 根据剧情发展动态调整状态效果，移除过期状态，添加新状态',
  '- push到 character.saveData.玩家角色状态.状态效果 数组',
  '',
  '位置/地图:',
  '- 常规推进仅 set 位置.坐标(单次偏移≤100) 与 位置.描述（坐标对象必须为 {X,Y}）。',
  '- 仅叙事确有其事时，push 地点到 世界信息.地点信息，值为最小对象(名称/类型/描述/位置{X,Y}/重要)。',
  '',
  '人物关系(NPC系统):',
  '- 在 text 出现与具体人物的明确互动时，必须 set 到 人物关系.<姓名>',
  '- NPC完整结构(必须严格遵循NpcProfile类型):',
  '  * 角色基础信息: {名字,性别,年龄?,世界?,天资?,出生?,灵根?,天赋:[],先天六司:{}}',
  '  * 外貌描述?: 10-20字特征',
  '  * 角色存档信息: {时间,装备,功法,状态,境界,声望,位置,各项数值,背包(同玩家)}',
  '  * AI行为: {行为模式,日常路线:[]}',
  '  * 人物关系: 关系描述',
  '  * 人物好感度: -100到100',
  '  * 人物记忆: ["[日期][地点]事件"]格式',
  '  * 最后互动时间: ISO字符串或null',
  '  * 背包?: {物品:{<物品ID>:Item}} (商人/重要NPC)',
  '- NPC背包物品格式必须与玩家一致:',
  '  * Item: {物品ID,名称,类型(法宝|功法|其他),品质:{quality,grade},数量,描述}',
  '  * 示例: {"引气丹":{物品ID:"引气丹",名称:"引气丹",类型:"其他",品质:{quality:"凡",grade:3},数量:5,描述:"..."}}',
  '- 物品命名规范: 使用简洁名称，如 "引气丹"/"聚灵丹"/"铁剑"/"玄铁剑"',
  '- 禁止使用 "凡下品引气丹" 类似格式，品质和品级在data结构中单独记录',
  '- NPC交互场景:',
  '  * 交易: NPC背包物品与玩家背包物品交换，需更新双方背包',
  '  * 赠送: 从一方背包移除，添加到另一方背包',
  '  * 偷窃: 判定成功后转移物品，影响好感度',
  '',
  '记忆管理（禁止操作）:',
  '- 短期记忆: 系统自动从正文提取，禁止手动 push',
  '- 中期记忆: 系统自动生成，禁止手动 push',
  '- 长期记忆: 系统自动归档，禁止手动 push',
  '',
  '最小指令集（发生相应变化时，需至少包含）:',
  "- set: character.saveData.玩家角色状态.位置.(描述|坐标)",
  "- set: character.saveData.背包.物品.<物品ID>（如叙事所述）",
  "- set/push: character.saveData.玩家角色状态.状态效果（对象格式）",
  "- set: character.saveData.人物关系.<姓名>（当text中发生互动时）",
  '',
  '合理性审查(最高权限): 难度 normal|medium|hard；进入他人地图强制 hard；hard 下不得无因越界推进，消耗/收益/代价必须在 text 落实；对不合理变更自修正。',
  '',
  generateSystemPrompt({
    includeRealmSystem: true,
    includeItemQuality: true,
    includeNPCSystem: true,
    includeDataStructure: true
  })
].join('\n');

export function getRandomizedInGamePrompt(): string {
  return IN_GAME_MESSAGE_PROMPT;
}

export function createSceneSpecificPrompt(
  sceneType: '战斗' | '修炼' | '社交' | '探索' | '传承',

): string {
  const sceneGuidance: Record<string, string> = {
    '战斗': '重点：战斗判定、伤害与状态效果、资源消耗',
    '修炼': '重点：修炼进度、资源投入、瓶颈与收益',
    '社交': '重点：人物关系、好感变化、礼仪与代价',
    '探索': '重点：位置与地图、环境互动、风险与发现',
    '传承': '重点：功法/法宝/传承获取的因果与限制'
  };
  return [IN_GAME_MESSAGE_PROMPT, '', `【场景重点】${sceneGuidance[sceneType]}`].join('\n');
}
