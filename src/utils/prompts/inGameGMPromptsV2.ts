/**
 * 游戏正文AI生成提示词 - 核心剧情推进系统
 * 用于处理玩家在游戏中的行动和AI回复
 */

import {
  COMMON_CORE_RULES,
  COMMON_NARRATIVE_RULES,
  COMMON_NPC_RULES,
  COMMON_ITEM_RULES,
  COMMON_DAO_RULES,
  ENHANCED_TIME_MANAGEMENT,
  ENHANCED_DATA_VALIDATION
} from './commonPromptRules';
import { UNIFIED_PROMPT_BUILDER } from './unifiedPromptSystem';

// === 使用统一规则组件 ===
const CORE_RULES = COMMON_CORE_RULES
const ENHANCED_RULES = ENHANCED_TIME_MANAGEMENT + '\n\n' + ENHANCED_DATA_VALIDATION + '\n\n' + [
  '# 先天六司约束',
  '- 先天六司六项每项范围为0-10；NPC同样遵守。',
  '- 若生成/更新出现超限，必须在 tavern_commands 中写入裁剪后的值（如>10则写入10）。',
  '- 生成/更新前，应读取并遵守 character.saveData.系统.规则 中的限制（例如 属性上限.先天六司.每项上限）。'
].join('\n')
// 直接使用导入的通用组件，不再重新声明

// === 4. 玩家操作处理优先级 ===
const PLAYER_ACTION_PRIORITY = [
  '【玩家操作处理优先级】',
  '⚠️ **执行顺序至关重要**：当收到包含【玩家最近操作】的输入时，必须按以下顺序处理：',
  '',
  '## 🎯 第一优先级：处理玩家具体操作',
  '- **优先响应**：首先基于【玩家最近操作】中列出的具体动作生成回应',
  '- **动作反馈**：必须在叙事中明确体现每个操作的结果和效果',
  '- **数据更新**：根据操作类型更新对应的游戏数据（修为、装备、状态等）',
  '- **即时反馈**：玩家的每个操作都应该得到直接的叙事反馈',
  '',
  '## 📝 第二优先级：回应用户文本输入',
  '- **文本处理**：在处理完具体操作后，再基于用户输入的文本内容继续叙事',
  '- **内容融合**：将用户文本意图与操作结果自然融合到一个连贯的回应中',
  '- **逻辑连贯**：确保操作效果和文本回应在逻辑上连贯一致',
  '',
  '## ✅ 处理示例：',
  '```',
  '用户操作：感悟了《五行调和术》大道',
  '用户文本：我要去市集看看',
  '正确回应：先描述感悟大道的过程和收获，然后自然过渡到前往市集的情节',
  '```',
  '',
  '❌ **严禁**：忽略具体操作，直接回应文本内容',
  '✅ **正确**：先处理操作，再融入文本意图',
].join('\n')

// === 5. 判定系统 ===
const JUDGMENT_SYSTEM = [
  '【天道演算 v5.0】',
  '触发：【判定:{属性}|DC:{数值}】或【斗法|敌人:{名称}】',
  '执行：读取 character.saveData.系统.天道演算 预计算数据',
  '• 通用：按预计算成功率d100投骰，天眷标签相关可+20%',
  '• 斗法：基于预计算基线微调±10%',
  '• 🚨 **输出格式要求**: 判定结果必须用〖〗包围，格式：〖判定结果:成功/失败,骰点:XX,属性:XX〗',
  '• 示例: 〖攻击判定:成功,骰点:15,攻击力:120〗 或 〖修炼判定:失败,骰点:89,灵识:80〗',
].join('\n')

// 使用通用物品系统规则

// [已废弃] NPC_SYSTEM 和 DAO_SYSTEM_RULES 已被迁移到 commonPromptRules.ts 并通过
// COMMON_NPC_RULES 和 COMMON_DAO_RULES 导入使用，旧的常量定义在此移除以保持代码整洁。

// === 9. AI数据更新规则 ===
const UPDATE_RULES = [
  '【AI数据更新规则】',
  '⚠️ **重要提醒**：每次回复都必须分析当前游戏状态，主动更新相关数据！',
  '',
  '## 🔄 **重要数据结构更新** - 必须遵循以下新规则',
  '',
  '### 📦 装备和修炼系统同步',
  '- **装备操作后**：所有装备/卸下操作完成后，必须同步更新装备状态',
  '  * 装备时：更新物品数组中对应物品的"已装备"字段为true。这通常需要找到物品在数组中的索引。例如: `_.set("character.saveData.背包.物品[0].已装备", true)`',
  '  * 卸下时：更新物品数组中对应物品的"已装备"字段为false。',
  '  * 装备栏更新：`_.set("character.saveData.装备栏.装备1", {物品ID: "实际物品ID", 名称: "物品名称"})`',
  '- **修炼功法操作后**：开始/停止修炼功法后，必须同步更新酒馆变量',
  '  * `_.set("character.saveData.修炼功法", 完整的修炼功法数据)`',
  '',
  '### 👥 NPC数据结构规范',
  '- **NPC行为字段**：所有NPC数据中必须使用"NPC行为"字段，不再使用"AI行为"',
  '  * 正确：`"NPC行为": {"行为模式": "...", "日常路线": [...]}`',
  '  * 错误：`"AI行为": {...}` (已废弃)',
  '',
  '### 🌟 必须生成和显示的字段',
  '- **天赋字段**：每个角色都必须有"天赋"字段，没有天赋时填"无"',
  '  * `_.set("character.saveData.角色基础信息.天赋", ["具体天赋"] 或 ["无"])`',
  '- **角色状态数值**：必须确保以下数值存在并更新：',
  '  * 当前气血/最大气血：`_.set("character.saveData.玩家角色状态.气血", {"当前": X, "最大": Y})`',
  '  * 当前灵气/最大灵气：`_.set("character.saveData.玩家角色状态.灵气", {"当前": X, "最大": Y})`',
  '  * 当前神识/最大神识：`_.set("character.saveData.玩家角色状态.神识", {"当前": X, "最大": Y})`',
  '  * 当前寿命/最大寿命：`_.set("character.saveData.玩家角色状态.寿命", {"当前": X, "最大": Y})`',
  '- **灵石显示**：如果角色拥有灵石，必须在适当时机提及和显示',
  '  * 从`character.saveData.背包.灵石`中读取灵石数量',
  '',
  '### 🧠 记忆系统清理',
  '- **移除指令数据**：NPC记忆中不再包含指令数据，只保留时间和事件',
  '  * 正确格式：`[{"时间": "时间描述", "事件": "事件描述"}]`',
  '  * 移除字段：不再使用"指令数据"字段',
  '',
  '## 📊 当前游戏状态获取',
  '你可以通过酒馆变量获取当前完整的游戏状态：',
  '- character.saveData.玩家角色状态 - 角色的实时状态数据',
  '- character.saveData.人物关系 - 所有NPC关系数据',
  '- character.saveData.游戏时间 - 当前游戏时间',
  '- character.saveData.记忆 - 玩家记忆数据',
  '- character.saveData.背包 - 物品和灵石数据',
  '',
  '## 🔄 强制更新检查清单',
  '每次AI回复必须检查以下项目并在tavern_commands中更新：',
  '',
  '### 1️⃣ 时间推进 - 智能时间管理',
  '- **⚠️ 智能推进原则**：根据活动类型合理推进时间',
  '- **需要推进时间的活动**：',
  '  * 移动、战斗、修炼、制作、购物、重要对话',
  '  * 对话交流：重要讨论15-30分钟，深入交流30-60分钟',
  '  * 日常活动：吃饭30分钟-1小时，睡觉6-8小时，洗漱15-30分钟',
  '- **不需要推进时间的活动**：',
  '  * 查看状态、简单问候、快速询问、思考、回忆',
  '- **修炼时间**：根据修炼内容和境界推进，境界越高时间越长',
  '  * 练气期：打坐1-2小时，闭关几天到几周',
  '  * 筑基期：修炼数小时，闭关几周到几个月',
  '  * 金丹期：恢复灵气几天，闭关几个月到几年',
  '  * 元婴期及以上：闭关动辄几年到几十年',
  '- **战斗时间**：小规模战斗几分钟到几小时，大战可能持续数日甚至数月',
  '- **移动时间**：步行、飞行、传送等都要根据距离和方式消耗相应时间',
  '- **购物交易**：浏览物品15-30分钟，复杂交易30-60分钟',
  '- **制作炼制**：炼丹、制符、锻造等技能活动按复杂度消耗几小时到几天',
  '- **休息恢复**：受伤恢复、冥想静心等也需要消耗时间',
  '- **时间更新**：`_.set("character.saveData.游戏时间.小时", 当前小时+推进小时数)`',
  '',
  '### 2️⃣ 生命状态监控',
  '- **气血变化**：战斗受伤、治疗、休息恢复',
  '  * 轻伤：`_.add("character.saveData.玩家角色状态.气血.当前", -10到-30)`',
  '  * 重伤：`_.add("character.saveData.玩家角色状态.气血.当前", -50到-100)`',
  '  * 治疗：`_.add("character.saveData.玩家角色状态.气血.当前", +20到+80)`',
  '- **死亡判定**：当气血降至0或负数时，角色死亡',
  '  * 必须设置死亡标记：`_.set("character.saveData.玩家角色状态.已死亡", true)`',
  '  * 记录死亡时间：`_.set("character.saveData.玩家角色状态.死亡时间", "当前游戏时间")`',
  '  * 记录死亡原因：`_.set("character.saveData.玩家角色状态.死亡原因", "具体原因")`',
  '  * ⚠️ 死亡后游戏无法继续，必须在text中明确说明',
  '- **死亡原因示例**："气血耗尽"、"毒发身亡"、"走火入魔"、"被敌人击杀"',
  '- **灵气消耗**：使用法术、功法时必须消耗',
  '  * 普通法术：`_.add("character.saveData.玩家角色状态.灵气.当前", -5到-20)`',
  '  * 强力法术：`_.add("character.saveData.玩家角色状态.灵气.当前", -30到-100)`',
  '- **神识损耗**：精神攻击、过度思考、炼丹失败',
  '- **寿命变化**：突破境界增加寿命上限，受重伤或诅咒减少',
  '',
  '### 3️⃣ 位置更新',
  '- **移动必更新**：角色每次移动都必须更新位置描述',
  '  * `_.set("character.saveData.玩家角色状态.位置.描述", "新位置名称")`',
  '  * ⚠️ **不要生成或修改坐标**：文字游戏不需要坐标，AI只需更新位置描述',
  '- **位置格式**：必须遵循"大洲名·地点名"格式',
  '',
  '### 4️⃣ 修为进度',
  '- **修炼活动**：打坐、修炼功法、感悟道法',
  '  * `_.add("character.saveData.玩家角色状态.修为.当前", +修炼获得的修为)`',
  '- **战斗收获**：胜利后获得修为',
  '- **突破境界**：修为达到下一级所需时自动突破',
  '',
  '### 5️⃣ NPC互动记忆',
  '- **重要互动才记录**：仅在有意义的对话或事件时更新NPC记忆',
  '  * ✅ 需要记录：初次见面、重要信息交换、情感变化、任务相关',
  '  * ❌ 无需记录：简单问候、重复对话、询问基础信息',
  '  ```json',
  '  {',
  '    "action": "push",',
  '    "scope": "chat",',
  '    "key": "character.saveData.人物关系.【NPC名字】.人物记忆",',
  '    "value": {',
  '      "时间": "【当前游戏时间】",',
  '      "事件": "【具体重要事件描述】"',
  '    }',
  '  }',
  '  ```',
  '- **好感度变化**：仅在有明显态度改变时调整',
  '  * 友好互动：`_.add("character.saveData.人物关系.【NPC名字】.人物好感度", +5到+15)`',
  '  * 冲突互动：`_.add("character.saveData.人物关系.【NPC名字】.人物好感度", -10到-30)`',
  '',
  '### 6️⃣ 物品状态',
  '- **装备耐久**：战斗、使用后减少耐久度',
  '- **消耗品使用**：丹药、符篆使用后减少数量',
  '- **新物品获得**：必须添加到背包',
  '- **灵石消耗**：购买、修炼、炼制时扣除',
  '',
  '### 7️⃣ 状态效果管理',
  '- **新增状态**：中毒、增益、诅咒等',
  '  ```json',
  '  {',
  '    "action": "push",',
  '    "scope": "chat", ',
  '    "key": "character.saveData.玩家角色状态.状态效果",',
  '    "value": {',
  '      "状态名称": "具体状态名",',
  '      "类型": "buff或debuff",',
  '      "时间": "具体持续时间",',
  '      "状态描述": "详细描述效果",',
  '      "强度": 1-10,',
  '      "来源": "状态来源"',
  '    }',
  '  }',
  '  ```',
  '- **移除过期状态**：时间到期的状态必须删除',
  '',
  '## ⚠️ 关键提醒',
  '1. **主动性**：不要等用户提及才更新，要主动分析并更新',
  '2. **完整性**：每个场景都要考虑所有相关数据的变化',
  '3. **合理性**：数值变化要符合修仙世界的逻辑',
  '4. **一致性**：确保数据更新与叙事内容完全一致',
  '5. **记忆更新**：特别重要！每次NPC互动都要更新其记忆',
  '6. **装备状态**：描述角色时，如果有装备需要提及，检查物品的"已装备"字段：',
  '   * `已装备: true` 的物品正在使用中，影响角色属性和外观',
  '   * `已装备: false` 或无此字段的物品在背包中未使用',
  '',
  '## 📋 更新检查模板',
  '每次回复前自问：',
  '- ✅ 时间是否需要推进？',
  '- ✅ 角色生命状态是否有变化？',
  '- ✅ 位置是否发生移动？',
  '- ✅ 是否与NPC互动需要更新记忆？',
  '- ✅ 修为、物品、状态是否有变化？',
  '- ✅ 是否有其他数据需要同步更新？',
].join('\n')
const LOCATION_SYSTEM = [
  '【位置和地图系统】',
  '- **位置描述格式要求**：必须严格按照"大洲名·后缀"格式，如"中土大陆·青石镇"、"东海群岛·天剑宗·剑峰"',
  '- **移动规则**：位置移动时，只需更新 `位置.描述`',
  '- **🚨重要约束**：文字游戏中不需要坐标系统，AI只需关注位置描述',
  '- **🚨位置描述规范**：位置.描述必须是地名，不得填入角色身份、状态或其他描述',
  '- **正确示例**: "大陆名称·xx镇"、"xx大陆·xx宗·外门"等',
  '- **错误示例**: "夺舍老怪"、"修仙者"、"年轻人"等角色描述',
  '- **新地点**：仅叙事确有其事时，push地点到世界信息.地点信息',
  '- **重要**：位置描述中的大洲名必须是世界地图中实际存在的大洲，严禁编造',
].join('\n')

// 剧情推进提示词（严格：返回唯一 JSON，text + mid_term_memory + tavern_commands 对象）
export const IN_GAME_MESSAGE_PROMPT = [
  '【剧情推进】根据当前游戏状态推进一段叙事，并返回唯一 JSON。',
  '',
  UNIFIED_PROMPT_BUILDER.buildGamePrompt('gameplay'),
  '',
  PLAYER_ACTION_PRIORITY,
  '',
  JUDGMENT_SYSTEM,
  '',
  LOCATION_SYSTEM,
  '',
  UPDATE_RULES,
  '',
  '【当前游戏状态】你必须严格基于以下"当前游戏状态"来生成响应。这是唯一的真实数据源。',
  'INPUT_PLACEHOLDER',
  '',
  'tavern_commands 用法(数组): 每个元素为 {action: "set/add/push/pull/delete", scope: "chat", key: "character.saveData.路径", value: 值}；路径以 character.saveData. 开头，点号分隔。',
  '',
  '路径变量参考（必须遵循）:',
  '- 角色基础信息: 名字/性别/年龄/出生/灵根/天赋/天资/先天六司{根骨/灵性/悟性/气运/魅力/心性}/世界；',
  '- 玩家角色状态: 境界(对象)/位置.{描述}/气血|灵气|神识|寿命|修为(各为{当前,最大})/状态效果[]/身份/当前活动/心情；',
  '- 背包: 灵石.{下品/中品/上品/极品}/物品: Item[]；Item是包含{物品ID, 物品名称, ...}的对象数组；',
  '- 装备栏: 装备1..装备6={物品ID:"实际ID",名称:"物品名称"}|null；修炼功法: 功法/熟练度/已解锁技能/修炼时间/突破次数/正在修炼(boolean)/修炼进度(0-100)；',
  '- 记忆: 短期记忆[]/中期记忆[]/长期记忆[]（禁止操作，自动生成）；人物关系: 人物关系.<姓名>=NpcProfile（仅NPC交互时操作）；',
  '',
  '物品规范:',
  '- 【重要】获得新物品时，使用 `add` 操作将完整的 Item 对象添加到 `character.saveData.背包.物品` 数组中。',
  '- 【强制】品质字段格式：必须为 {quality:"凡/黄/玄/地/天/仙/神", grade:0-10}，禁止缺失或格式错误。',
  '- 【🚨关键】装备状态字段：所有装备和功法类物品必须包含"已装备"字段，默认为false：',
  '  * 装备类物品：生成时设置 已装备: false',
  '  * 功法类物品：生成时设置 已装备: false',
  '  * 其他类物品：无需已装备字段',
  '- 【物品ID要求】：每个物品必须有唯一的物品ID字段',
  '- 【关键】物品分类判定（严格执行）：',
  '  * 装备：所有可穿戴、佩戴或持用的物品，包括但不限于：',
  '    - 衣物类：袍子、华服、锦衣、道袍、法衣、衣裳、外套等',
  '    - 饰品类：玉佩、项链、戒指、手镯、腰带、头饰、耳环、玉牌、玉坠、吊坠、玉环等',
  '    - 武器类：剑、刀、枪、棒、法器、灵器、猎刀、战刀、长剑、短剑等',
  '    - 防具类：护甲、头盔、护手、鞋靴等',
  '    - 其他装备：帽子、手套、斗笠、面具等',
  '  * 功法：修炼秘籍（功法/心法/秘籍/剑法/掌法/内功等）',
  '    【功法必须包含功法效果】：',
  '    功法效果: {',
  '      修炼速度加成?: 0.1-2.0数值（如0.2表示修炼速度提升20%）,',
  '      属性加成?: {根骨?:数值, 灵性?:数值, 悟性?:数值, 气运?:数值, 魅力?:数值, 心性?:数值},',
  '      特殊能力?: ["能力描述1", "能力描述2"]（数组格式）,',
  '      前置要求?: {最低境界?: "境界名", 必需属性?: {...}, 灵根要求?: ["灵根类型"]}',
  '    }',
  '    【功法可选包含功法技能】：',
  '    功法技能?: {',
  '      "技能名称": {',
  '        解锁条件: "熟练度达到30%"或"修炼进度达到50%"等,',
  '        技能描述: "详细的技能效果描述",',
  '        技能类型: "攻击"|"防御"|"辅助"|"移动"|"其他"',
  '      }',
  '    }',
  '  * 其他：消耗品和不可装备物品（丹药/符篆/书籍/食物/钥匙/财宝/材料等）',
  '- 【分类检查清单】生成物品时必须问自己：',
  '  1. 这个物品能穿在身上吗？→ 装备',
  '  2. 这个物品能戴在身上吗？（包括项链、玉佩、戒指、手镯等）→ 装备',
  '  3. 这个物品能拿在手里战斗吗？→ 装备',
  '  4. 这个物品是修炼功法吗？→ 功法',
  '  5. 以上都不是？→ 其他',
  '- 【🚨重要提示】：如果物品可以穿在身上、戴在身上或拿在手里，一律归类为"装备"！',
  '- 【🚨玉佩专项提醒】：所有玉佩、玉牌、玉坠、护身符等可佩戴饰品，必须归类为"装备"！',
  '- 【严禁固定名称】物品命名必须动态生成，创意多样，避免重复：',
  '  * 🚨严禁使用任何固定模板名称，每次都要创造全新名称',
  '  * 🚨避免使用通用性词汇作为物品名称，必须具体化和个性化',
  '  * 🚨避免使用常见的修仙小说物品名称套路',
  '  * 每次生成物品时创造全新的名称，体现修仙世界的丰富性',
  '  * 根据情境、地区、人物背景生成符合设定的独特物品名',
  '  * 同类物品也要有不同的称谓和特色描述',
  '  * 融合时代背景、地理特色、制作者特点等元素',
  '  * 体现物品的独特性和制作工艺特色',
  '  * 物品名称要有具体的修饰词、材质、产地、工艺等特色信息',
  '- 物品ID 必须是单层键（不能包含点号），禁止在 背包.物品 下创建多级分类键。',
  '- 【重要】灵石存放规则：灵石必须存放在 character.saveData.背包.灵石 中，禁止作为物品存入物品栏。灵石包括：下品灵石/中品灵石/上品灵石/极品灵石，但金银财宝等其他货币可放入物品栏。',
  '',
  '状态效果规范(每次变化都要更新):',
  '- 必填字段: 状态名称, 类型(buff|debuff 小写), 状态描述(50字以上,必须包含具体数值效果), 时间(必须给出具体值如"30分钟"|"1小时"|"3天"|"永久",禁止"未指定")',
  '- 可选字段: 强度(1-10数值), 来源(产生原因), 剩余时间',
  '- 状态描述必须详细说明：1)状态的来历背景 2)对角色产生的具体影响(带数值) 3)可能的后续发展',
  '- 根据剧情发展动态调整状态效果，移除过期状态，添加新状态',
  '- push到 character.saveData.玩家角色状态.状态效果 数组',
  '',
  '位置/地图:',
  '- **位置变更规则**：当位置移动时，**只更新位置描述**',
  '- ⚠️ **重要：位置描述必须是具体地名**，严禁使用"初始地"、"某处"等占位符。',
  '- 根据剧情背景生成富有特色的地名：创造符合修仙世界观的独特地名。',
  '- 仅叙事确有其事时，push 地点到 世界信息.地点信息，值为最小对象(名称/类型/描述/重要)。',
  '',
  '人物关系(NPC系统):',
  '- 在 text 出现与具体人物的明确互动时，必须 set 到 人物关系.<姓名>',
  '- **NPC完整结构**(必须严格遵循以下格式):',
  '  * **角色基础信息**: {名字,性别,年龄?,世界?,天资?,出生?,灵根:{品级,描述}?,天赋:[],先天六司:{}}',
  '  * **外貌描述**?: 10-20字特征',
  '  * **角色存档信息**: {时间,装备,功法,状态,境界,声望,位置,各项数值}',
  '  * **❌ 重要变更**：已完全移除"修为"字段，不再使用修为.当前/最大，统一使用"境界"字段表示修炼等级',
  '  * **NPC行为**: {行为模式:"具体行为描述",当前模式:"当前在做什么",日常路线:["地点1","地点2"]}',
  '  * **人物关系**: 关系描述',
  '  * **人物好感度**: -100到100',
  '  * **人物记忆**: [{"时间":"【时间描述】","事件":"【事件描述】"}]格式（已移除指令数据字段）',
  '  * **背包**: 必须包含完整的背包结构，格式如上所述',
  '- **NPC行为字段详细要求**：',
  '  * **行为模式**：描述NPC的性格和行为风格（如"温和谦逊"、"傲慢自大"、"沉默寡言"等）',
  '  * **当前模式**：描述NPC当前在做什么（如"打坐修炼"、"整理药材"、"巡视山门"等）',
  '  * **日常路线**：数组格式，列出NPC经常活动的地点（如["药园","炼丹房","市集"]）',
  '  * **示例格式**：',
  '    ```json',
  '    "NPC行为": {',
  '      "行为模式": "严肃认真，做事一丝不苟",',
  '      "当前模式": "在药园中采摘灵草",',
  '      "日常路线": ["药园", "炼丹房", "藏书阁", "自己的洞府"]',
  '    }',
  '    ```',
  '',
  '- **NPC物品生成要求**：',
  '  * **商人类NPC**：必须携带3-5件可交易物品（丹药、符篆、材料、装备等）',
  '  * **宗门长老/重要人物**：必须携带2-4件符合身份的物品（功法、法宝、珍贵材料等）',
  '  * **普通弟子/修士**：应携带1-2件符合身份的物品（基础法器、丹药等）',
  '  * **凡俗百姓**：可携带1件生活用品或小物件',
  '  * **【例外】**只有乞丐、流民等极贫困身份才可无物品',
  '- **NPC背包格式**：必须严格按照以下结构生成 (物品为数组)',
  '  ```json',
  '  "背包": {',
  '    "物品": [',
  '      {',
  '        "物品ID": "item_id_1",',
  '        "物品名称": "具体物品名称",',
  '        "物品类型": "装备|功法|其他",',
  '        "物品描述": "详细描述",',
  '        "物品数量": 1,',
  '        "稀有度": "凡品"',
  '      }',
  '    ]',
  '  }',
  '  ```',
  '- 物品命名规范: 使用富有创意的名称，避免固定模板，让每次生成都有新意',
  '- 【严禁固定模板】禁止使用重复的固定物品名称，必须根据情境创造独特名称',
  '- 🚨避免使用常见的修仙小说物品名称套路模板',
  '- 每个NPC的物品都要体现其身份特色和个人风格',
  '- **NPC灵根品质生成要求**：',
  '  * 灵根品质等级：神品(2.8x) > 极品(2.0x) > 上品(1.6x) > 中品(1.3x) > 下品(1.1x) > 凡品(1.0x) > 特殊(0.5x)',
  '  * 生成概率：根据NPC身份地位决定灵根品质，普通人多为凡品-下品，宗门弟子为下品-中品，宗门高层为中品-上品',
  '  * 🚨**灵根格式强制要求**：必须为对象 {品级:"上品",描述:"详细描述内容"} (不再需要名称字段)',
  '  * 🚨**品级字段必填**：所有NPC灵根都必须包含品级字段，不得省略，从以下选择：凡品/下品/中品/上品/极品/神品/特殊',
  '  * 🚨**描述字段必填**：所有灵根都必须包含描述字段，不得为空，详细说明灵根特性和效果',
  '  * **灵根描述示例**：',
  '    - 火灵根："体内蕴含浓郁火行之力，对火系功法修炼速度有显著提升，火系法术威力更强"',
  '    - 木灵根："天生亲和自然之力，修炼木系功法如鱼得水，恢复类法术效果更佳"',
  '    - 双灵根："同时拥有两种属性的灵根，虽然修炼速度不如单灵根，但法术选择更加多样"',
  '- NPC交互场景:',
  '  * 交易: NPC背包物品与玩家背包物品交换，需更新双方背包',
  '  * 赠送: 从一方背包移除，添加到另一方背包',
  '  * 偷窃: 判定成功后转移物品，影响好感度',
  '',
  '记忆管理（禁止操作）:',
  '- 短期记忆: 系统自动从正文提取，禁止手动 push',
  '- 中期记忆: 系统自动生成，禁止手动 push',
  '- 长期记忆: 系统自动归档，禁止手动 push',
  '',
  '最小指令集（发生相应变化时，需至少包含）:',
  '- set: character.saveData.玩家角色状态.位置.描述',
  '- add: character.saveData.背包.物品, value: Item对象 (获得新物品时)',
  '- set/push: character.saveData.玩家角色状态.状态效果（对象格式）',
  '- set: character.saveData.人物关系.<姓名>（当text中发生互动时）',
  '',
  '合理性审查(最高权限): 难度 normal|medium|hard；进入他人地图强制 hard；hard 下不得无因越界推进，消耗/收益/代价必须在 text 落实；对不合理变更自修正。',
  '',
  '【输出格式要求】必须严格按照以下JSON格式返回响应：',
  '```json',
  '{',
  '  "text": "1000-2000字的详细叙述内容",',
  '  "mid_term_memory": "可选：若发生重要事件变化，提供50-100字的精简总结；否则为空字符串",',
  '  "tavern_commands": [',
  '    {"action": "set/add/push/pull/delete", "scope": "chat", "key": "character.saveData.路径", "value": "值"}',
  '  ]',
  '}',
  '```',
  '',
  '注意：',
  '- text字段：必填，包含完整的游戏叙述',
  '- mid_term_memory字段：可选，仅在有重要变化时填写简短总结',
  '- tavern_commands字段：必填数组，根据剧情变化更新游戏数据',
  '',
].join('\n')

export function getRandomizedInGamePrompt(): string {
  const core = UNIFIED_PROMPT_BUILDER.buildGamePrompt('gameplay')
  const lite = [
    '【剧情推进】根据当前游戏状态推进叙事，并返回唯一 JSON。',
    core,
    '# 重要补充（二次声明）',
    '- 输出唯一 JSON：text, mid_term_memory, tavern_commands',
    '- 所有变更必须通过 tavern_commands 实现',
    '- 每次推进必须更新时间；位置仅写 位置.描述',
    '- 严格遵守 character.saveData.系统.规则 与各对象的 _AI说明/_AI重要提醒',
    '- 禁止修改 记忆（短/中/长期）字段；禁止写入坐标',
    '',
    '【tavern_commands 规范（必须）】',
    '- tavern_commands 是数组；每个元素为：',
    '  {"action": "set|add|push|pull|delete", "scope": "chat", "key": "character.saveData.路径", "value": 值}',
    '- 只允许 action：set/add/push/pull/delete；严禁使用 update_time/update_character 等自定义命令名',
    '- key 必须以 character.saveData. 开头；scope 固定为 chat',
    '- 时间推进：优先 add 到 分钟/小时 字段（必要时自行进位）',
    '示例：',
    '```json',
    '[',
    '  {"action":"add","scope":"chat","key":"character.saveData.游戏时间.分钟","value":5},',
    '  {"action":"add","scope":"chat","key":"character.saveData.人物关系.赵瀚宇.人物好感度","value":-40},',
    '  {"action":"set","scope":"chat","key":"character.saveData.人物关系.林雪岸.角色存档信息.最后出现位置.描述","value":"朝天大陆·玄清宗·听雨小筑"}',
    ']',
    '```',
    '',
    '【当前游戏状态】（JSON）',
    'INPUT_PLACEHOLDER',
    '',
    '【输出格式】必须严格如下：',
    '```json',
    '{ "text": "...", "mid_term_memory": "", "tavern_commands": [] }',
    '```'
  ].join('\n')
  return lite
}

// 调试函数：检查提示词完整性
export function debugPromptInfo(): void {
  const fullPrompt = IN_GAME_MESSAGE_PROMPT
  console.log('[提示词调试] 提示词类型:', typeof fullPrompt)
  console.log('[提示词调试] 提示词长度:', fullPrompt.length)
  console.log('[提示词调试] 开头200字符:', fullPrompt.substring(0, 200))
  console.log('[提示词调试] 结尾200字符:', fullPrompt.substring(fullPrompt.length - 200))
  console.log('[提示词调试] 是否包含INPUT_PLACEHOLDER:', fullPrompt.includes('INPUT_PLACEHOLDER'))
  console.log('[提示词调试] 是否包含格式化标记:', fullPrompt.includes('【格式化标记规范】'))
  console.log('[提示词调试] 是否包含物品系统:', fullPrompt.includes('【物品系统规范】'))
  console.log('[提示词调试] 完整内容:', fullPrompt)
}
