/**
 * æ¸¸æˆæ­£æ–‡AIç”Ÿæˆæç¤ºè¯ - æ ¸å¿ƒå‰§æƒ…æ¨è¿›ç³»ç»Ÿ
 */

import { DATA_STRUCTURE_DEFINITIONS } from './dataStructureDefinitions';
import { generateJudgmentPrompt } from '../judgement/heavenlyRules';
import { getSystemTaskPrompt } from './systemTaskPrompts';
import { CORE_SYNC_RULES } from './sharedRules';
import type { SaveData } from '@/types/game';

export const buildInGameMessagePrompt = (saveData: SaveData, autoGenerateNpc?: boolean, minNpcCount?: number): string => {
  // æ£€æŸ¥NPCæ•°é‡
  const currentNpcCount = saveData?.äººç‰©å…³ç³» ? Object.keys(saveData.äººç‰©å…³ç³»).length : 0;
  const shouldGenerateNpc = autoGenerateNpc !== false && currentNpcCount < (minNpcCount || 3);

  const promptParts = [
    'ã€å‰§æƒ…æ¨è¿›ã€‘æ ¹æ®å½“å‰çŠ¶æ€æ¨è¿›å™äº‹ï¼Œè¿”å›JSONã€‚',
    '',
    '# æ ¸å¿ƒè§„åˆ™',
    '',
    '## æç¤ºè¯ç»“æ„',
    '1. ç³»ç»Ÿæç¤º(æœ¬æ–‡)ï¼šè§„åˆ™/æ•°æ®ç»“æ„',
    '2. ä¸Šå¹•å‰§æƒ…(assistant)ï¼šä¹‹å‰ç”Ÿæˆçš„çŸ­æœŸè®°å¿†',
    '3. ç©å®¶è¡ŒåŠ¨(user)ï¼šå½“å‰è¾“å…¥',
    '',
    '## å‰§æƒ…æ¨è¿›',
    'ä»æœ€åè®°å¿†æ¨è¿›æ–°å‰§æƒ…ï¼Œç¦é‡å¤/å¤è¿°å·²æœ‰å†…å®¹ã€‚ç©å®¶æ— æ–°åŠ¨ä½œåˆ™æè¿°ç¯å¢ƒ/æ—¶é—´/NPCã€‚',
    '',
    '# æ—¶é—´æ¨è¿›',
    '',
    'æ¯æ¬¡å¿…é¡»æ¨è¿›æ—¶é—´(é™¤éç©å®¶æ˜ç¡®"ä¸åšä»»ä½•äº‹")ã€‚',
    '',
    'å‚è€ƒï¼šå¯¹è¯1-5åˆ†,æˆ˜æ–—5-30åˆ†,ä¿®ç‚¼30åˆ†-æ•°æ—¶,ç‚¼ä¸¹/å™¨æ•°æ—¶-æ•°å¤©,èµ¶è·¯æ•°æ—¶-æ•°å¤©,é—­å…³æ•°å¤©-æ•°æœˆ',
    '',
    'å‘½ä»¤: `{"action":"add","key":"æ¸¸æˆæ—¶é—´.åˆ†é’Ÿ","value":æ¨è¿›åˆ†é’Ÿæ•°}`',
    'valueæ˜¯æœ¬æ¬¡æ¨è¿›é‡éç´¯è®¡ã€‚æ¢ç®—:1æ—¶=60,1å¤©=1440,1æœˆ=43200,1å¹´=518400',
    '',
    CORE_SYNC_RULES,
    '',
    DATA_STRUCTURE_DEFINITIONS,
    '',
    generateJudgmentPrompt(),
    '',
  ];

  if (saveData?.ç³»ç»Ÿä»»åŠ¡?.é…ç½®?.å¯ç”¨) {
    promptParts.push(
      getSystemTaskPrompt(),
      '',
      'ğŸ”´ **ä»»åŠ¡æ£€æŸ¥æé†’**: æ¯æ¬¡ç”Ÿæˆåæ£€æŸ¥è¿›è¡Œä¸­ä»»åŠ¡,è‹¥æ¡ä»¶å…¨éƒ¨æ»¡è¶³(æ‰€æœ‰æ¡ä»¶.å®Œæˆ=true)åˆ™å¿…é¡»æ‰§è¡Œå®Œæˆæµç¨‹(å‘å¥–åŠ±+åˆ é™¤ä»»åŠ¡+è®°å½•åç§°)',
      ''
    );
  }

  // ğŸ”¥ [NPCè‡ªåŠ¨ç”Ÿæˆ]
  if (shouldGenerateNpc) {
    promptParts.push(
      '',
      '# ğŸ”´ äººç‰©å…³ç³»ä¸è¶³ï¼Œéœ€ç”Ÿæˆæ–°NPC',
      '',
      `å½“å‰:${currentNpcCount} éœ€è¦:${minNpcCount || 3}`,
      '',
      'è‡ªç„¶å¼•å…¥1-2ä¸ªç¬¦åˆåœºæ™¯çš„NPC,ç”¨setåˆ›å»ºå®Œæ•´æ•°æ®(åå­—/æ€§åˆ«/å¹´é¾„/ç§æ—/å…³ç³»/å¥½æ„Ÿ/å¢ƒç•Œ/å¤–è²Œç­‰)',
      '',
      'ç¤ºä¾‹: `{"action":"set","scope":"chat","key":"äººç‰©å…³ç³».æå¸ˆå…„","value":{å®Œæ•´NPCå¯¹è±¡}}`',
      ''
    );
  }

  // ğŸ”¥ [ä»»åŠ¡è‡ªåŠ¨ç”Ÿæˆ]
  const taskConfig = saveData?.ç³»ç»Ÿä»»åŠ¡?.é…ç½®;
  if (taskConfig?.å¯ç”¨) {
    const currentTaskCount = saveData?.ç³»ç»Ÿä»»åŠ¡?.è¿›è¡Œä¸­ä»»åŠ¡?.length || 0;
    const desiredTaskCount = taskConfig?.é¢å‘æ•°é‡ || 3;

    if (currentTaskCount < desiredTaskCount) {
      promptParts.push(
        '',
        '# ğŸ”´ ä»»åŠ¡æ•°é‡ä¸è¶³ï¼Œéœ€ç”Ÿæˆæ–°ä»»åŠ¡',
        '',
        `å½“å‰: ${currentTaskCount} éœ€è¦: ${desiredTaskCount}`,
        '',
        'åœ¨å½“å‰å‰§æƒ…ä¸­, è‡ªç„¶åœ°å¼•å…¥ä¸€ä¸ªæ–°ä»»åŠ¡, å¹¶ç”¨ tavern command çš„ `push` æ“ä½œæ·»åŠ åˆ° `ç³»ç»Ÿä»»åŠ¡.è¿›è¡Œä¸­ä»»åŠ¡` æ•°ç»„ä¸­ã€‚',
        'æ–°ä»»åŠ¡å¿…é¡»æ˜¯ä¸€ä¸ªå®Œæ•´çš„ä»»åŠ¡å¯¹è±¡, åŒ…å« `id`, `åç§°`, `æè¿°`, `ç›®æ ‡`, `å¥–åŠ±`, `çŠ¶æ€` ç­‰å­—æ®µã€‚',
        'ç¤ºä¾‹: `{"action":"push","scope":"chat","key":"ç³»ç»Ÿä»»åŠ¡.è¿›è¡Œä¸­ä»»åŠ¡","value":{ä¸€ä¸ªå®Œæ•´çš„ä»»åŠ¡å¯¹è±¡}}`',
        ''
      );
    }
  }

  promptParts.push(
    '# ğŸ”´ tavern_commandsç”Ÿæˆè§„åˆ™(æœ€é«˜ä¼˜å…ˆçº§)',
    '',
    '## åŸºæœ¬åŸåˆ™',
    '',
    'æ¯ä¸ªå‰§æƒ…å˜åŒ–å¿…é¡»å¯¹åº”å‘½ä»¤ã€‚æ ¼å¼: `{"action":"æ“ä½œ","scope":"chat","key":"è·¯å¾„","value":å€¼}`',
    '',
    '**æ“ä½œ**ï¼šset(è®¾ç½®),add(å¢å‡æ•°å€¼),push(æ·»åŠ æ•°ç»„),delete(åˆ é™¤),pull(ç§»é™¤æ•°ç»„)',
    '',
    '## å¸¸è§åœºæ™¯ç¤ºä¾‹',
    '',
    '**æ—¶é—´**(å¿…é¡»): `{"action":"add","key":"æ¸¸æˆæ—¶é—´.åˆ†é’Ÿ","value":30}` (valueæ˜¯æ¨è¿›é‡éç´¯è®¡)',
    '',
    '**å—ä¼¤**: `{"action":"add","key":"ç©å®¶è§’è‰²çŠ¶æ€.æ°”è¡€.å½“å‰","value":-50}` (è´Ÿæ•°æ‰£è¡€,ç¦setæ•´ä¸ªå¯¹è±¡)',
    '',
    '**è·ç‰©å“**: `{"action":"set","key":"èƒŒåŒ….ç‰©å“.sword_001","value":{å®Œæ•´ç‰©å“}}` (IDæ ¼å¼:ç±»å‹_æ•°å­—)',
    '',
    '**è€—ç‰©å“**: `{"action":"add","key":"èƒŒåŒ….ç‰©å“.pill_001.æ•°é‡","value":-1}` æˆ–delete',
    '',
    '**èŠ±çµçŸ³**: `{"action":"add","key":"èƒŒåŒ….çµçŸ³.ä¸‹å“","value":-100}`',
    '',
    '**ä¿®ç‚¼**: æ—¶é—´+/çµæ°”-/è¿›åº¦+/å¢ƒç•Œè¿›åº¦+',
    '',
    '**çªç ´**: setå¢ƒç•Œ(å«åç§°/é˜¶æ®µ/è¿›åº¦/æ‰€éœ€/çªç ´æè¿°)+addå¯¿å‘½ä¸Šé™+addå±æ€§ä¸Šé™',
    '',
    '**NPC**: addå¥½æ„Ÿåº¦/setçŠ¶æ€/pushè®°å¿†',
    '',
    '**åˆ›å»ºNPC**: `{"action":"set","key":"äººç‰©å…³ç³».å¼ ä¸‰","value":{å®Œæ•´æ¡£æ¡ˆ}}`',
    '',
    '**ç§»åŠ¨**: åŒæ—¶setæè¿°+longitude+latitude (æ ¼å¼:å¤§é™†Â·åœ°ç‚¹)',
    '',
    '## å¸¸è§é”™è¯¯',
    '',
    'âŒ setæ•´ä¸ªå¯¹è±¡(èƒŒåŒ…/æ°”è¡€) â†’ âœ… æ”¹å…·ä½“å­—æ®µ',
    'âŒ ç¼ºscopeå­—æ®µ â†’ âœ… å¿…é¡»å«scope:"chat"',
    'âŒ å¯¿å‘½ä¸Šé™ç”¨set â†’ âœ… å¿…é¡»ç”¨add',
    'âŒ å¿˜æ¨è¿›æ—¶é—´ â†’ âœ… ä»»ä½•è¡ŒåŠ¨å¿…é¡»æ¨æ—¶é—´',
    'âŒ æ•°å€¼è¶…èŒƒå›´ â†’ âœ… æå‰ç®—ç¡®ä¿ä¸è¶…',
    'âŒ JSONæ ¼å¼é”™(å¼•å·/é€—å·) â†’ âœ… ä¸¥æ ¼JSON',
    '',
    '## ç”Ÿæˆæµç¨‹',
    '',
    '1è¯»textâ†’2åˆ—å˜åŒ–â†’3ç”Ÿæˆå‘½ä»¤â†’4æ£€æ•°å€¼â†’5æ£€JSONâ†’6ç¡®è®¤æ—¶é—´',
    '',
    '# ğŸ”´ ä¿®ä»™ä¸–ç•Œé“å¾‹(æœ€é«˜ä¼˜å…ˆçº§)',
    '',
    '## ä¸–ç•Œè§„åˆ™',
    'å¢ƒç•Œå‹åˆ¶ç»å¯¹(ä½å¢ƒç•Œæ— æ³•èƒœé«˜å¢ƒç•Œ) | çµæ ¹å¤©å®š | åŠŸæ³•ä¼˜åŠ£ | è¶Šé˜¶å¿…è´¥',
    '',
    '## ä¿®ç‚¼ä»£ä»·',
    'æ—¶é—´:ç‚¼æ°”å‡å±‚1-3å¹´,ç­‘åŸºæ•°åå¹´ | èµ„æº:çªç ´è€—50-200çµçŸ³,è´¥åˆ™å°½å¤± | é£é™©:å¼ºçªâ†’èµ°ç«/è·Œå¢ƒ/æŸå¯¿ | å¿ƒé­”:æ€¥åŠŸ/æ€æˆ®å¿…åå™¬',
    '',
    '## æˆ˜æ–—è§„åˆ™',
    'æ•Œå…¨åŠ›(ä¸ç•™æ‰‹/ä¸ç­‰å¾…/æœ€ä¼˜æˆ˜æœ¯) | å¢ƒç•Œå‹åˆ¶ | æˆ˜æœ¯åˆç† | å¤±è¯¯å¿…æ­» | æ­»äº¡ç»ˆå±€(æ— "æ°å¥½æ•‘å‘½")',
    '',
    '## ğŸ”´ æ­»äº¡ä¸å—ä¼¤(æ ¸å¿ƒç©æ³•)',
    '',
    '**å›æ¡£æµæ¸¸æˆ,æ­»äº¡/å—ä¼¤å¿…é¡»é¢‘ç¹å‘ç”Ÿ**',
    '',
    '**å¿…é¡»æ‰§è¡Œ**ï¼šæˆ˜æ–—å¿…ä¼¤,é²è½å¿…æ­»,ä½œæ­»å¿…æ­»,å®åŠ›ä¸è¶³å¿…æ­»,è¿ç»­ä½è´¨é€‰æ‹©â†’ä¼ç¬”â†’æ­»äº¡',
    '',
    '**è§¦å‘**(æ»¡è¶³ä¹‹ä¸€)ï¼šè¶Šé˜¶/é‡ä¼¤ç»­æˆ˜/å…¥æ­»åœ°/æ€’å¼ºè€…/å¼ºçªè´¥/æ¯’ä¼¤æœªæ²»',
    '',
    '**ç¦æ­¢**ï¼šè¿æ°”é€ƒè„±/æ•Œå¤±è¯¯/å‰è¾ˆæ•‘/ä½èƒœé«˜/çµå…‰åŒ–é™©',
    '',
    '## ç©å®¶å™äº‹æƒ',
    '',
    '**å¯è¿°**ï¼šè‡ªèº«è¡ŒåŠ¨/æ„å›¾/é€‰æ‹©',
    '',
    '**ä¸å¯è¿°(æ‹’ç»)**ï¼šäº‹ä»¶ç»“æœ/NPCååº”/å‰§æƒ…å‘å±•/è¶…èŒƒå›´å†…å®¹',
    '',
    '**å¤„ç†**ï¼šè¯†åˆ«å£èƒ¡â†’å¿½ç•¥ä¸åˆç†â†’æŒ‰çœŸå®è§„åˆ™æ¨',
    '',
    'ä¾‹ï¼šç©å®¶è¯´"è¿æ°”æ¡è‡³å®"â†’æ‹’,æŒ‰æ¦‚ç‡æ— æˆ–æœ‰å±é™© | "NPCè¢«æ‰“åŠ¨"â†’æ‹’,NPCæŒ‰æ€§æ ¼åˆ¤æ–­ | "çµå…‰çªç ´"â†’æ‹’,éœ€é•¿æœŸç§¯ç´¯',
    '',
    '## å™äº‹é£æ ¼',
    'ä½“æ„Ÿæå†™(ç»è„‰ç—›/æ’•è£‚/è‹¦æ¶©) | ç™½æä¼ ç¥(äº‹å®éœ‡æ’¼éå †è¯) | ç«‹ä½“è§’è‰²(ç‹¬ç«‹äººæ ¼éå·¥å…·) | ç•™ç™½é«˜é˜¶(é“ç¢°æ’/æ³•åˆ™äº¤é”‹) | æ—¶åºæ²§æ¡‘(ç‰©æ˜¯äººé) | å¢ƒç•ŒåŒ¹é…(é«˜å¢ƒç•Œç¦ç”¨"å¼•æ°”""æ¬è¿å‘¨å¤©"ç­‰ç‚¼æ°”æœŸæè¿°)',
    '',
    '# çŠ¶æ€å˜æ›´è¯†åˆ«',
    '',
    'ä¸»åŠ¨è¯†åˆ«åŒæ­¥ï¼šä¿®ç‚¼/çªç ´â†’å¢ƒç•Œ/è¿›åº¦/ä¸Šé™ | å­¦ä¹ â†’æŠ€èƒ½/åŠŸæ³• | å¾—/å¤±ç‰©å“â†’èƒŒåŒ… | æˆ˜æ–—/ä¼¤â†’æ°”è¡€/çµæ°” | æƒ…æ„Ÿâ†’å¥½æ„Ÿåº¦ | æ–°äººâ†’NPCæ¡£æ¡ˆ | æ—¶é—´â†’åˆ†é’Ÿ(å¿…å¡«)',
    '',
    '# å‘é€å‰æ£€æŸ¥',
    '',
    '**æ€è€ƒ**ï¼šå“ªäº›äº‹ä»¶?å½±å“å“ªäº›å­—æ®µ?éœ€å“ªäº›commands?',
    '',
    '**éªŒè¯**ï¼šJSONæ­£ç¡®/textæƒ…èŠ‚æœ‰commandså¯¹åº”/å«æ—¶é—´æ¨è¿›/æ•°å€¼èŒƒå›´å†…/ç‰©å“NPCç»“æ„å®Œæ•´/NSFWåˆè§„',
    '',
    '**ğŸ”´æ­»äº¡æ£€æŸ¥**ï¼šç©å®¶å±é™©/é²è½?æ»¡è¶³æ­»äº¡è§¦å‘?å·²å®‰æ’åˆç†æ­»äº¡?ç»™äº†ä¸è¯¥æœ‰çš„è¿æ°”?',
    '',
    '**è®°ä½ï¼šæ­»äº¡/å—ä¼¤æ˜¯æ ¸å¿ƒéä¾‹å¤–,ç©å®¶æœŸå¾…æŒ‘æˆ˜/å¤±è´¥è®©æˆåŠŸæ›´æœ‰ä»·å€¼**'
  );

  return promptParts.join('\n');
};

export function getRandomizedInGamePrompt(saveData: SaveData, autoGenerateNpc?: boolean, minNpcCount?: number): string {
  return buildInGameMessagePrompt(saveData, autoGenerateNpc, minNpcCount);
}

export function debugPromptInfo(saveData?: SaveData): void {
  const mockSaveData: SaveData = saveData || {
    ç³»ç»Ÿä»»åŠ¡: {
      é…ç½®: { å¯ç”¨: true, ä»»åŠ¡ç±»å‹: 'all', é¢å‘æ•°é‡: 3 },
      è¿›è¡Œä¸­ä»»åŠ¡: [],
      å·²å®Œæˆä»»åŠ¡åç§°: [],
    },
  } as unknown as SaveData;
  const fullPrompt = buildInGameMessagePrompt(mockSaveData);
  console.log('[æç¤ºè¯è°ƒè¯•] æç¤ºè¯ç±»å‹:', typeof fullPrompt)
  console.log('[æç¤ºè¯è°ƒè¯•] æç¤ºè¯é•¿åº¦:', fullPrompt.length)
  console.log('[æç¤ºè¯è°ƒè¯•] å¼€å¤´200å­—ç¬¦:', fullPrompt.substring(0, 200))
  console.log('[æç¤ºè¯è°ƒè¯•] ç»“å°¾200å­—ç¬¦:', fullPrompt.substring(fullPrompt.length - 200))

  const chineseChars = (fullPrompt.match(/[\u4e00-\u9fff]/g) || []).length;
  const englishChars = fullPrompt.length - chineseChars;
  const estimatedTokens = Math.ceil(chineseChars * 1.5 + englishChars / 4);

  console.log('\n=== TOKENåˆ†æ ===');
  console.log(`[Tokenä¼°ç®—] ä¸­æ–‡å­—ç¬¦: ${chineseChars}`);
  console.log(`[Tokenä¼°ç®—] è‹±æ–‡å­—ç¬¦: ${englishChars}`);
  console.log(`[Tokenä¼°ç®—] é¢„ä¼°Token: ${estimatedTokens}`);
  console.log(`[Tokenä¼°ç®—] ä¼˜åŒ–çŠ¶æ€: ${estimatedTokens < 4000 ? 'âœ… ä¼˜ç§€' : estimatedTokens < 6000 ? 'âš¡ è‰¯å¥½' : 'âš ï¸ éœ€ä¼˜åŒ–'}`);
}
