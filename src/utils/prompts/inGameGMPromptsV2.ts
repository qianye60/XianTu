/**
 * æ¸¸æˆæ­£æ–‡AIç”Ÿæˆæç¤ºè¯ - æ ¸å¿ƒå‰§æƒ…æ¨è¿›ç³»ç»Ÿ
 */

import { DATA_STRUCTURE_DEFINITIONS } from './dataStructureDefinitions';
import { generateJudgmentPrompt } from '../judgement/heavenlyRules';
import { getSystemTaskPrompt } from './systemTaskPrompts';
import { CORE_SYNC_RULES } from './sharedRules';
import { buildCompactState, formatStateForAI } from '../aiContextBuilder';
import type { SaveData } from '@/types/game';

export const buildInGameMessagePrompt = (saveData: SaveData, autoGenerateNpc?: boolean, minNpcCount?: number): string => {
  // æ£€æŸ¥NPCæ•°é‡
  const currentNpcCount = saveData?.äººç‰©å…³ç³» ? Object.keys(saveData.äººç‰©å…³ç³»).length : 0;
  const shouldGenerateNpc = autoGenerateNpc !== false && currentNpcCount < (minNpcCount || 3);

  const promptParts = [
    'ã€å‰§æƒ…æ¨è¿›ã€‘æ ¹æ®å½“å‰çŠ¶æ€æ¨è¿›å™äº‹ï¼Œè¿”å›JSONã€‚',
    '',
    '# æ ¸å¿ƒè§„åˆ™',
    '',
    '## æç¤ºè¯ç»“æ„',
    '1. ç³»ç»Ÿæç¤º(æœ¬æ–‡)ï¼šè§„åˆ™/æ•°æ®ç»“æ„',
    '2. ä¸Šå¹•å‰§æƒ…(assistant)ï¼šä¹‹å‰ç”Ÿæˆçš„çŸ­æœŸè®°å¿†',
    '3. ç©å®¶è¡ŒåŠ¨(user)ï¼šå½“å‰è¾“å…¥',
    '',
    '## å‰§æƒ…æ¨è¿›',
    'ä»æœ€åè®°å¿†æ¨è¿›æ–°å‰§æƒ…ï¼Œç¦é‡å¤/å¤è¿°å·²æœ‰å†…å®¹ã€‚ç©å®¶æ— æ–°åŠ¨ä½œåˆ™æè¿°ç¯å¢ƒ/æ—¶é—´/NPCã€‚',
    '',
    '# æ—¶é—´æ¨è¿›',
    '',
    'æ¯æ¬¡å¿…é¡»æ¨è¿›æ—¶é—´(é™¤éç©å®¶æ˜ç¡®"ä¸åšä»»ä½•äº‹")ã€‚',
    '',
    'å‚è€ƒï¼šå¯¹è¯1-5åˆ†,æˆ˜æ–—5-30åˆ†,ä¿®ç‚¼30åˆ†-æ•°æ—¶,ç‚¼ä¸¹/å™¨æ•°æ—¶-æ•°å¤©,èµ¶è·¯æ•°æ—¶-æ•°å¤©,é—­å…³æ•°å¤©-æ•°æœˆ',
    '',
    'å‘½ä»¤: `{"action":"add","key":"æ¸¸æˆæ—¶é—´.åˆ†é’Ÿ","value":æ¨è¿›åˆ†é’Ÿæ•°}`',
    'valueæ˜¯æœ¬æ¬¡æ¨è¿›é‡éç´¯è®¡ã€‚æ¢ç®—:1æ—¶=60,1å¤©=1440,1æœˆ=43200,1å¹´=518400',
    '',
    CORE_SYNC_RULES,
    '',
    DATA_STRUCTURE_DEFINITIONS,
    '',
    generateJudgmentPrompt(),
    '',
  ];

  if (saveData?.ç³»ç»Ÿä»»åŠ¡?.é…ç½®?.å¯ç”¨) {
    promptParts.push(
      getSystemTaskPrompt(),
      '',
      'ğŸ”´ **ä»»åŠ¡æ£€æŸ¥æé†’**: æ¯æ¬¡ç”Ÿæˆåæ£€æŸ¥è¿›è¡Œä¸­ä»»åŠ¡,è‹¥æ¡ä»¶å…¨éƒ¨æ»¡è¶³(æ‰€æœ‰æ¡ä»¶.å®Œæˆ=true)åˆ™å¿…é¡»æ‰§è¡Œå®Œæˆæµç¨‹(å‘å¥–åŠ±+åˆ é™¤ä»»åŠ¡+è®°å½•åç§°)',
      ''
    );
  }

  // ğŸ”¥ [NPCè‡ªåŠ¨ç”Ÿæˆ]
  if (shouldGenerateNpc) {
    promptParts.push(
      '',
      '========== ã€ç´§æ€¥ã€‘äººç‰©å…³ç³»ä¸è¶³ï¼Œéœ€ç”Ÿæˆæ–°NPC ==========',
      '',
      `ã€å½“å‰çŠ¶æ€ã€‘NPCæ•°é‡: ${currentNpcCount} | æœ€ä½è¦æ±‚: ${minNpcCount || 3}`,
      '',
      'ã€ç”Ÿæˆè¦æ±‚ã€‘',
      '1. è‡ªç„¶å¼•å…¥1-2ä¸ªç¬¦åˆå½“å‰åœºæ™¯çš„NPC',
      '2. ä½¿ç”¨setæ“ä½œåˆ›å»ºå®Œæ•´NPCæ¡£æ¡ˆ',
      '3. å¿…å¡«å­—æ®µï¼šåå­—/æ€§åˆ«/å¹´é¾„/å‡ºç”Ÿæ—¥æœŸ/ç§æ—/å‡ºç”Ÿ/å¤–è²Œ/æ€§æ ¼/å¢ƒç•Œ/çµæ ¹/å¤©èµ‹/å…­å¸/å…³ç³»/å¥½æ„Ÿåº¦/ä½ç½®/èƒŒåŒ…ç­‰',
      '4. ã€é‡è¦-NSFWæ£€æŸ¥ã€‘è‹¥ç³»ç»Ÿ.nsfwMode=trueï¼Œå¿…é¡»æ£€æŸ¥æ€§åˆ«è¿‡æ»¤ï¼š',
      '   - nsfwGenderFilter="all" â†’ æ‰€æœ‰NPCéƒ½ç”Ÿæˆç§å¯†ä¿¡æ¯',
      '   - nsfwGenderFilter="female" â†’ ä»…å¥³æ€§NPCç”Ÿæˆç§å¯†ä¿¡æ¯',
      '   - nsfwGenderFilter="male" â†’ ä»…ç”·æ€§NPCç”Ÿæˆç§å¯†ä¿¡æ¯',
      '   ç§å¯†ä¿¡æ¯å¿…é¡»åŒ…å«14ä¸ªå¿…å¡«å­—æ®µï¼Œä¸å¾—çœç•¥',
      '',
      'ã€æ“ä½œç¤ºä¾‹ã€‘',
      '\`{"action":"set","scope":"chat","key":"äººç‰©å…³ç³».æå¸ˆå…„","value":{å®Œæ•´NPCå¯¹è±¡}}\`',
      '',
      'ã€æ³¨æ„äº‹é¡¹ã€‘',
      '- NPCå¢ƒç•Œåªæœ‰2ä¸ªå­—æ®µï¼šåç§° å’Œ é˜¶æ®µï¼ˆä¸è¦æ·»åŠ å½“å‰è¿›åº¦ç­‰å­—æ®µï¼‰',
      '- ç§å¯†ä¿¡æ¯å¿…é¡»åŒ…å«å…¨éƒ¨14ä¸ªå¿…å¡«å­—æ®µï¼Œä¸å¾—ä½¿ç”¨å ä½ç¬¦æˆ–"å¾…è¡¥å……"',
      ''
    );
  }

  // ğŸ”¥ [ä»»åŠ¡è‡ªåŠ¨ç”Ÿæˆ]
  const taskConfig = saveData?.ç³»ç»Ÿä»»åŠ¡?.é…ç½®;
  if (taskConfig?.å¯ç”¨) {
    const currentTaskCount = saveData?.ç³»ç»Ÿä»»åŠ¡?.è¿›è¡Œä¸­ä»»åŠ¡?.length || 0;
    const desiredTaskCount = taskConfig?.é¢å‘æ•°é‡ || 3;

    if (currentTaskCount < desiredTaskCount) {
      promptParts.push(
        '',
        '# ğŸ”´ ä»»åŠ¡æ•°é‡ä¸è¶³ï¼Œéœ€ç”Ÿæˆæ–°ä»»åŠ¡',
        '',
        `å½“å‰: ${currentTaskCount} éœ€è¦: ${desiredTaskCount}`,
        '',
        'åœ¨å½“å‰å‰§æƒ…ä¸­, è‡ªç„¶åœ°å¼•å…¥ä¸€ä¸ªæ–°ä»»åŠ¡, å¹¶ç”¨ tavern command çš„ `push` æ“ä½œæ·»åŠ åˆ° `ç³»ç»Ÿä»»åŠ¡.è¿›è¡Œä¸­ä»»åŠ¡` æ•°ç»„ä¸­ã€‚',
        'æ–°ä»»åŠ¡å¿…é¡»æ˜¯ä¸€ä¸ªå®Œæ•´çš„ä»»åŠ¡å¯¹è±¡, åŒ…å« `id`, `åç§°`, `æè¿°`, `ç›®æ ‡`, `å¥–åŠ±`, `çŠ¶æ€` ç­‰å­—æ®µã€‚',
        'ç¤ºä¾‹: `{"action":"push","scope":"chat","key":"ç³»ç»Ÿä»»åŠ¡.è¿›è¡Œä¸­ä»»åŠ¡","value":{ä¸€ä¸ªå®Œæ•´çš„ä»»åŠ¡å¯¹è±¡}}`',
        ''
      );
    }
  }

  promptParts.push(
    '# ğŸ”´ tavern_commandsç”Ÿæˆè§„åˆ™(æœ€é«˜ä¼˜å…ˆçº§)',
    '',
    '## åŸºæœ¬åŸåˆ™',
    '',
    'æ¯ä¸ªå‰§æƒ…å˜åŒ–å¿…é¡»å¯¹åº”å‘½ä»¤ã€‚æ ¼å¼: `{"action":"æ“ä½œ","scope":"chat","key":"è·¯å¾„","value":å€¼}`',
    '',
    '**æ“ä½œ**ï¼šset(è®¾ç½®),add(å¢å‡æ•°å€¼),push(æ·»åŠ æ•°ç»„),delete(åˆ é™¤),pull(ç§»é™¤æ•°ç»„)',
    '',
    '## å¸¸è§åœºæ™¯ç¤ºä¾‹',
    '',
    '**æ—¶é—´**(å¿…é¡»): `{"action":"add","key":"æ¸¸æˆæ—¶é—´.åˆ†é’Ÿ","value":30}` (valueæ˜¯æ¨è¿›é‡éç´¯è®¡)',
    '',
    '**å—ä¼¤**: `{"action":"add","key":"ç©å®¶è§’è‰²çŠ¶æ€.æ°”è¡€.å½“å‰","value":-50}` (è´Ÿæ•°æ‰£è¡€,ç¦setæ•´ä¸ªå¯¹è±¡)',
    '',
    '**è·ç‰©å“**: `{"action":"set","key":"èƒŒåŒ….ç‰©å“.sword_001","value":{å®Œæ•´ç‰©å“}}` (IDæ ¼å¼:ç±»å‹_æ•°å­—)',
    '',
    '**è€—ç‰©å“**: `{"action":"add","key":"èƒŒåŒ….ç‰©å“.pill_001.æ•°é‡","value":-1}` æˆ–delete',
    '',
    '**èŠ±çµçŸ³**: `{"action":"add","key":"èƒŒåŒ….çµçŸ³.ä¸‹å“","value":-100}`',
    '',
    '**ä¿®ç‚¼**: `{"action":"add","key":"æ¸¸æˆæ—¶é—´.åˆ†é’Ÿ","value":180}`,`{"action":"add","key":"ç©å®¶è§’è‰²çŠ¶æ€.å¢ƒç•Œ.å½“å‰è¿›åº¦","value":10}`',
    '',
    '**çªç ´**(ä¾‹ç‚¼æ°”â†’ç­‘åŸº): ',
    '  `{"action":"add","key":"æ¸¸æˆæ—¶é—´.åˆ†é’Ÿ","value":60}`,',
    '  `{"action":"set","key":"ç©å®¶è§’è‰²çŠ¶æ€.å¢ƒç•Œ.åç§°","value":"ç­‘åŸº"}`,',
    '  `{"action":"set","key":"ç©å®¶è§’è‰²çŠ¶æ€.å¢ƒç•Œ.é˜¶æ®µ","value":"åˆæœŸ"}`,',
    '  `{"action":"set","key":"ç©å®¶è§’è‰²çŠ¶æ€.å¢ƒç•Œ.å½“å‰è¿›åº¦","value":0}`,',
    '  `{"action":"set","key":"ç©å®¶è§’è‰²çŠ¶æ€.å¢ƒç•Œ.ä¸‹ä¸€çº§æ‰€éœ€","value":200}`,',
    '  `{"action":"set","key":"ç©å®¶è§’è‰²çŠ¶æ€.å¢ƒç•Œ.çªç ´æè¿°","value":"å€Ÿæ··å…ƒçœŸæ°”å‡èšé“å°"}`,',
    '  `{"action":"add","key":"ç©å®¶è§’è‰²çŠ¶æ€.æ°”è¡€.ä¸Šé™","value":500}`,',
    '  `{"action":"add","key":"ç©å®¶è§’è‰²çŠ¶æ€.çµæ°”.ä¸Šé™","value":500}`,',
    '  `{"action":"add","key":"ç©å®¶è§’è‰²çŠ¶æ€.å¯¿å‘½.ä¸Šé™","value":130}`',
    '',
    '**NPC**: addå¥½æ„Ÿåº¦/setçŠ¶æ€/pushè®°å¿†',
    '',
    '**åˆ›å»ºNPC**: `{"action":"set","key":"äººç‰©å…³ç³».å¼ ä¸‰","value":{å®Œæ•´æ¡£æ¡ˆ}}`',
    '  ã€NSFWæ£€æŸ¥ã€‘åˆ›å»ºNPCæ—¶å¿…é¡»æ£€æŸ¥ï¼š',
    '  1. ç³»ç»Ÿ.nsfwModeæ˜¯å¦ä¸ºtrueï¼Ÿ',
    '  2. å½“å‰NPCæ€§åˆ«æ˜¯å¦ç¬¦åˆnsfwGenderFilterï¼Ÿ',
    '     - filter="all" â†’ ä»»ä½•æ€§åˆ«éƒ½ç”Ÿæˆ',
    '     - filter="female" â†’ ä»…æ€§åˆ«="å¥³"æ—¶ç”Ÿæˆ',
    '     - filter="male" â†’ ä»…æ€§åˆ«="ç”·"æ—¶ç”Ÿæˆ',
    '  3. è‹¥ç¬¦åˆï¼Œå¿…é¡»åœ¨valueä¸­åŒ…å«å®Œæ•´çš„ç§å¯†ä¿¡æ¯å¯¹è±¡ï¼ˆ14ä¸ªå¿…å¡«å­—æ®µï¼‰',
    '',
    '**ç§»åŠ¨**: åŒæ—¶set ç©å®¶è§’è‰²çŠ¶æ€.ä½ç½®.æè¿° + ç©å®¶è§’è‰²çŠ¶æ€.ä½ç½®.longitude + ç©å®¶è§’è‰²çŠ¶æ€.ä½ç½®.latitude (æ ¼å¼:å¤§é™†Â·åœ°ç‚¹)',
    '',
    '**å¤§é“æ„Ÿæ‚Ÿ**: `{"action":"set","key":"ä¸‰åƒå¤§é“.å¤§é“åˆ—è¡¨.å‰‘é“","value":{"é“å":"å‰‘é“","æè¿°":"...","æ˜¯å¦è§£é”":true,"å½“å‰é˜¶æ®µ":0,"å½“å‰ç»éªŒ":0,"æ€»ç»éªŒ":0,"é˜¶æ®µåˆ—è¡¨":[...]}}`',
    '  æˆ–å¢åŠ ç»éªŒ: `{"action":"add","key":"ä¸‰åƒå¤§é“.å¤§é“åˆ—è¡¨.å‰‘é“.å½“å‰ç»éªŒ","value":100}`',
    '',
    '**åŠ å…¥å®—é—¨/æ”¹å˜èº«ä»½**: å¿…é¡»åŒæ—¶æ›´æ–°æ‰€æœ‰åŒé—¨NPCçš„"ä¸ç©å®¶å…³ç³»"å­—æ®µ',
    '  ç¤ºä¾‹: ç©å®¶åŠ å…¥"å¤©å‰‘å®—"åï¼Œè¯¥å®—æ‰€æœ‰NPCçš„å…³ç³»éƒ½åº”ä»"é™Œç”Ÿäºº"æ”¹ä¸º"åŒé—¨å¸ˆå…„å¼Ÿ"',
    '  `{"action":"set","key":"äººç‰©å…³ç³».æå¸ˆå…„.ä¸ç©å®¶å…³ç³»","value":"åŒé—¨å¸ˆå…„"}` (æ ¹æ®å¥½æ„Ÿåº¦å¯ä»¥æ˜¯"åŒé—¨"/"å¸ˆå…„"/"å¸ˆå¼Ÿ"/"æŒšå‹"ç­‰)',
    '',
    '**å…³ç³»å˜åŒ–**: æ ¹æ®å‰§æƒ…å’Œå¥½æ„Ÿåº¦ä¸»åŠ¨æ›´æ–°"ä¸ç©å®¶å…³ç³»"æ ‡ç­¾',
    '  - å¥½æ„Ÿåº¦0-20: "é™Œç”Ÿäºº"/"è·¯äºº"/"é™Œè·¯"',
    '  - å¥½æ„Ÿåº¦20-40: "ç›¸è¯†"/"è®¤è¯†"/"ç‚¹å¤´ä¹‹äº¤"',
    '  - å¥½æ„Ÿåº¦40-60: "æœ‹å‹"/"ç†Ÿäºº"/"åŒé—¨"',
    '  - å¥½æ„Ÿåº¦60-80: "å¥½å‹"/"æŒšå‹"/"çŸ¥å·±"/"å¸ˆå¾’"',
    '  - å¥½æ„Ÿåº¦80-100: "å¯†å‹"/"é“ä¾£"/"è‡³äº¤"/"ç”Ÿæ­»ä¹‹äº¤"',
    '  ç¤ºä¾‹: `{"action":"set","key":"äººç‰©å…³ç³».æå¸ˆå…„.ä¸ç©å®¶å…³ç³»","value":"åŒé—¨å¸ˆå…„"}` (ç©å®¶åŠ å…¥å®—é—¨å)',
    '  ç¤ºä¾‹: `{"action":"set","key":"äººç‰©å…³ç³».å¼ ä¸‰.ä¸ç©å®¶å…³ç³»","value":"æœ‹å‹"}` (å¥½æ„Ÿåº¦40æ—¶)',
    '',
    '## å¸¸è§é”™è¯¯',
    '',
    'âŒ setæ•´ä¸ªå¯¹è±¡(èƒŒåŒ…/æ°”è¡€) â†’ âœ… æ”¹å…·ä½“å­—æ®µ',
    'âŒ ç¼ºscopeå­—æ®µ â†’ âœ… å¿…é¡»å«scope:"chat"',
    'âŒ å¯¿å‘½ä¸Šé™ç”¨set â†’ âœ… å¿…é¡»ç”¨add',
    'âŒ å¿˜æ¨è¿›æ—¶é—´ â†’ âœ… ä»»ä½•è¡ŒåŠ¨å¿…é¡»æ¨æ—¶é—´',
    'âŒ æ•°å€¼è¶…èŒƒå›´ â†’ âœ… æå‰ç®—ç¡®ä¿ä¸è¶…',
    'âŒ JSONæ ¼å¼é”™(å¼•å·/é€—å·) â†’ âœ… ä¸¥æ ¼JSON',
    '',
    '## ç”Ÿæˆæµç¨‹',
    '',
    '1è¯»textâ†’2åˆ—å˜åŒ–â†’3ç”Ÿæˆå‘½ä»¤â†’4æ£€æ•°å€¼â†’5æ£€JSONâ†’6ç¡®è®¤æ—¶é—´',
    '',
    '# ğŸ”´ ä¸–ç•Œæ³•åˆ™é“å¾‹(æœ€é«˜ä¼˜å…ˆçº§)',
    '',
    '## åŠ›é‡ä½“ç³»',
    'å¢ƒç•Œå‹åˆ¶ç»å¯¹(ä½å¢ƒç•Œæ— æ³•èƒœé«˜å¢ƒç•Œ) | åŠ›é‡æºæ³‰å¤©å®š(çµæ ¹/è¡€è„‰/å¤©èµ‹) | åŠŸæ³•ä¼˜åŠ£å†³å®šä¸Šé™ | è¶Šé˜¶å¿…è´¥',
    '',
    '## æ—¶é—´æ²§æ¡‘(æ ¸å¿ƒæ³•åˆ™-ä¸å¯è¿èƒŒ)',
    '**ä¿®è¡Œ=æ—¶é—´çš„å †ç Œï¼Œæ²¡æœ‰æ·å¾„**',
    '',
    'ç‚¼æ°”æœŸ(åˆæœŸ/ä¸­æœŸ/åæœŸ/åœ†æ»¡/æå¢ƒ): æ¯é˜¶æ®µ1-3å¹´ï¼Œæ€»è®¡5-15å¹´',
    'ç­‘åŸºæœŸ: çªç ´éœ€5-20å¹´ç§¯ç´¯ï¼ŒæˆåŠŸç‡<30%ï¼Œå¤±è´¥æŸå¯¿10-30å¹´',
    'é‡‘ä¸¹æœŸ: çªç ´éœ€30-80å¹´ç§¯ç´¯ï¼ŒæˆåŠŸç‡<10%ï¼Œå¤±è´¥å¿…æ­»æˆ–è·Œå¢ƒ',
    'å…ƒå©´æœŸ: ç™¾å¹´èµ·æ­¥ï¼Œåƒå¹´æœªå¿…æˆ',
    'åŒ–ç¥åŠä»¥ä¸Š: åŠ¨è¾„æ•°ç™¾ä¸Šåƒå¹´é—­å…³ï¼Œå‡ºå…³æ—¶å‡¡äººç‹æœå·²å†ç»æ•°ä»£å…´è¡°',
    '',
    '**é—­å…³å¸¸æ€**: é«˜é˜¶ä¿®å£«ä¸€æ¬¡é—­å…³=ç™¾å¹´ï¼Œé†’æ¥æ—¶æ•…äººçš†é€ã€ç‰©æ˜¯äººé',
    '**å¯¿å‘½æœ‰é™**: ç‚¼æ°”80-150å¹´ï¼Œç­‘åŸº200-300å¹´ï¼Œé‡‘ä¸¹500-800å¹´ï¼Œæ¯æ¬¡çªç ´å¤±è´¥æ‰£å¯¿',
    '**æ—¶é—´æ¨è¿›**: ä»»ä½•ä¿®ç‚¼å¿…é¡»æ¨è¿›åˆç†æ—¶é—´ï¼Œç¦æ­¢"ä¸€æ—¥ç­‘åŸº"ã€"æ•°æœˆé‡‘ä¸¹"ç­‰è¿èƒŒæ³•åˆ™çš„è®¾å®š',
    '',
    '## ä¿®ç‚¼ä»£ä»·',
    'èµ„æº: çªç ´éœ€å¤§é‡çµçŸ³/ä¸¹è¯ï¼Œå¤±è´¥åˆ™å…¨éƒ¨æŸå¤± | é£é™©: å¼ºè¡Œçªç ´â†’èµ°ç«å…¥é­”/è·Œå¢ƒ/æŸå¯¿ | å¿ƒé­”: æ€¥åŠŸè¿‘åˆ©/æ»¥æ€æ— è¾œå¿…é­åå™¬',
    '',
    '## æˆ˜æ–—è§„åˆ™',
    'æ•Œäººå…¨åŠ›ä»¥èµ´(ä¸ç•™æ‰‹/ä¸ç­‰å¾…/ä½¿ç”¨æœ€ä¼˜æˆ˜æœ¯) | å¢ƒç•Œå‹åˆ¶æ— æ³•æŠµæŠ— | æˆ˜æœ¯å¿…é¡»åˆç† | å¤±è¯¯å¿…æ­» | æ­»äº¡ç»ˆå±€(æ— "æ°å¥½æœ‰äººæ•‘")',
    '',
    '## ğŸ”´ æ­»äº¡ä¸å—ä¼¤(æ ¸å¿ƒç©æ³•)',
    '',
    '**å›æ¡£æµæ¸¸æˆ,æ­»äº¡/å—ä¼¤å¿…é¡»é¢‘ç¹å‘ç”Ÿ**',
    '',
    '**å¿…é¡»æ‰§è¡Œ**: æˆ˜æ–—å¿…å—ä¼¤ï¼Œé²è½å¿…æ­»ï¼Œä½œæ­»å¿…æ­»ï¼Œå®åŠ›ä¸è¶³å¿…æ­»ï¼Œè¿ç»­ä½è´¨é€‰æ‹©â†’åŸ‹ä¼ç¬”â†’æ­»äº¡',
    '',
    '**è§¦å‘æ¡ä»¶**(æ»¡è¶³ä¹‹ä¸€): è¶Šé˜¶æˆ˜æ–—/é‡ä¼¤ç»§ç»­æˆ˜æ–—/è¿›å…¥ç»åœ°/æ¿€æ€’å¼ºè€…/å¼ºè¡Œçªç ´å¤±è´¥/ä¸­æ¯’æœªæ²»',
    '',
    '**ä¸¥ç¦**: é è¿æ°”é€ƒè„±/æ•Œäººå¤±è¯¯/å‰è¾ˆçªç„¶å‡ºæ‰‹ç›¸æ•‘/ä½å¢ƒç•Œèƒœé«˜å¢ƒç•Œ/çµå…‰ä¸€é—ªåŒ–é™©ä¸ºå¤·',
    '',
    '## ç©å®¶å™äº‹æƒé™',
    '',
    '**å…è®¸æè¿°**: è‡ªèº«è¡ŒåŠ¨/æ„å›¾/é€‰æ‹©/å†…å¿ƒæƒ³æ³•',
    '',
    '**ä¸å…è®¸æè¿°(å¿…é¡»æ‹’ç»)**: äº‹ä»¶ç»“æœ/NPCååº”/å‰§æƒ…å‘å±•/è¶…å‡ºèƒ½åŠ›èŒƒå›´çš„å†…å®¹',
    '',
    '**å¤„ç†æ–¹å¼**: è¯†åˆ«ä¸åˆç†æè¿°â†’å¿½ç•¥è¿è§„å†…å®¹â†’æŒ‰çœŸå®è§„åˆ™æ¨è¿›',
    '',
    'ä¾‹: ç©å®¶è¯´"è¿æ°”æ¡åˆ°è‡³å®"â†’æ‹’ç»ï¼ŒæŒ‰æ¦‚ç‡è¦ä¹ˆæ²¡æœ‰è¦ä¹ˆæœ‰å±é™© | "NPCè¢«æˆ‘æ‰“åŠ¨"â†’æ‹’ç»ï¼ŒNPCæŒ‰æ€§æ ¼ç‹¬ç«‹åˆ¤æ–­ | "çµå…‰ä¸€é—ªçªç ´"â†’æ‹’ç»ï¼Œçªç ´éœ€è¦é•¿æœŸç§¯ç´¯',
    '',
    '## å™äº‹é£æ ¼',
    'ä½“æ„Ÿæå†™(ç»è„‰ç—›/æ’•è£‚/è‹¦æ¶©) | ç™½æä¼ ç¥(äº‹å®éœ‡æ’¼éå †è¯) | ç«‹ä½“è§’è‰²(ç‹¬ç«‹äººæ ¼éå·¥å…·) | ç•™ç™½é«˜é˜¶(é“ç¢°æ’/æ³•åˆ™äº¤é”‹) | æ—¶åºæ²§æ¡‘(ç‰©æ˜¯äººé) | å¢ƒç•ŒåŒ¹é…(é«˜å¢ƒç•Œç¦ç”¨"å¼•æ°”""æ¬è¿å‘¨å¤©"ç­‰ç‚¼æ°”æœŸæè¿°)',
    '',
    '# çŠ¶æ€å˜æ›´è¯†åˆ«',
    '',
    'ä¸»åŠ¨è¯†åˆ«åŒæ­¥ï¼šä¿®ç‚¼/çªç ´â†’å¢ƒç•Œ/è¿›åº¦/ä¸Šé™ | å­¦ä¹ â†’æŠ€èƒ½/åŠŸæ³• | å¾—/å¤±ç‰©å“â†’èƒŒåŒ… | æˆ˜æ–—/ä¼¤â†’æ°”è¡€/çµæ°” | æƒ…æ„Ÿâ†’å¥½æ„Ÿåº¦ | æ–°äººâ†’NPCæ¡£æ¡ˆ | æ—¶é—´â†’åˆ†é’Ÿ(å¿…å¡«)',
    '',
    '# å‘é€å‰æ£€æŸ¥',
    '',
    '**æ€è€ƒ**ï¼šå“ªäº›äº‹ä»¶?å½±å“å“ªäº›å­—æ®µ?éœ€å“ªäº›commands?',
    '',
    '**éªŒè¯**ï¼šJSONæ­£ç¡®/textæƒ…èŠ‚æœ‰commandså¯¹åº”/å«æ—¶é—´æ¨è¿›/æ•°å€¼èŒƒå›´å†…/ç‰©å“NPCç»“æ„å®Œæ•´/NSFWåˆè§„',
    '',
    '**ğŸ”´çªç ´æ£€æŸ¥**ï¼štextæè¿°å¢ƒç•Œçªç ´?å¿…é¡»æœ‰setå¢ƒç•Œå‘½ä»¤(å«åç§°/é˜¶æ®µ/è¿›åº¦/æ‰€éœ€/çªç ´æè¿°)+addå¯¿å‘½ä¸Šé™+addå±æ€§ä¸Šé™',
    '',
    '**ğŸ”´æ­»äº¡æ£€æŸ¥**ï¼šç©å®¶å±é™©/é²è½?æ»¡è¶³æ­»äº¡è§¦å‘?å·²å®‰æ’åˆç†æ­»äº¡?ç»™äº†ä¸è¯¥æœ‰çš„è¿æ°”?',
    '',
    '**è®°ä½ï¼šæ­»äº¡/å—ä¼¤æ˜¯æ ¸å¿ƒéä¾‹å¤–,ç©å®¶æœŸå¾…æŒ‘æˆ˜/å¤±è´¥è®©æˆåŠŸæ›´æœ‰ä»·å€¼**'
  );

  // ğŸ”¥ [æ–°æ¶æ„] å°†ç²¾ç®€çš„æ¸¸æˆçŠ¶æ€ä½œä¸ºpromptçš„ä¸€éƒ¨åˆ†ä¼ é€’ç»™AI
  // ä¸å†ä¾èµ–é…’é¦†å˜é‡å­˜å‚¨ï¼Œç›´æ¥åœ¨promptä¸­æä¾›å½“å‰çŠ¶æ€
  const compactState = buildCompactState(saveData);
  const stateText = formatStateForAI(compactState);

  promptParts.push(
    '',
    '# === å½“å‰æ¸¸æˆçŠ¶æ€ ===',
    '',
    stateText,
    ''
  );

  return promptParts.join('\n');
};

export function getRandomizedInGamePrompt(saveData: SaveData, autoGenerateNpc?: boolean, minNpcCount?: number): string {
  return buildInGameMessagePrompt(saveData, autoGenerateNpc, minNpcCount);
}

export function debugPromptInfo(saveData?: SaveData): void {
  const mockSaveData: SaveData = saveData || {
    ç³»ç»Ÿä»»åŠ¡: {
      é…ç½®: { å¯ç”¨: true, ä»»åŠ¡ç±»å‹: 'all', é¢å‘æ•°é‡: 3 },
      è¿›è¡Œä¸­ä»»åŠ¡: [],
      å·²å®Œæˆä»»åŠ¡åç§°: [],
    },
  } as unknown as SaveData;
  const fullPrompt = buildInGameMessagePrompt(mockSaveData);
  console.log('[æç¤ºè¯è°ƒè¯•] æç¤ºè¯ç±»å‹:', typeof fullPrompt)
  console.log('[æç¤ºè¯è°ƒè¯•] æç¤ºè¯é•¿åº¦:', fullPrompt.length)
  console.log('[æç¤ºè¯è°ƒè¯•] å¼€å¤´200å­—ç¬¦:', fullPrompt.substring(0, 200))
  console.log('[æç¤ºè¯è°ƒè¯•] ç»“å°¾200å­—ç¬¦:', fullPrompt.substring(fullPrompt.length - 200))

  const chineseChars = (fullPrompt.match(/[\u4e00-\u9fff]/g) || []).length;
  const englishChars = fullPrompt.length - chineseChars;
  const estimatedTokens = Math.ceil(chineseChars * 1.5 + englishChars / 4);

  console.log('\n=== TOKENåˆ†æ ===');
  console.log(`[Tokenä¼°ç®—] ä¸­æ–‡å­—ç¬¦: ${chineseChars}`);
  console.log(`[Tokenä¼°ç®—] è‹±æ–‡å­—ç¬¦: ${englishChars}`);
  console.log(`[Tokenä¼°ç®—] é¢„ä¼°Token: ${estimatedTokens}`);
  console.log(`[Tokenä¼°ç®—] ä¼˜åŒ–çŠ¶æ€: ${estimatedTokens < 4000 ? 'âœ… ä¼˜ç§€' : estimatedTokens < 6000 ? 'âš¡ è‰¯å¥½' : 'âš ï¸ éœ€ä¼˜åŒ–'}`);
}
