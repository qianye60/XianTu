import { generateSystemPrompt } from './systemPrompts';

// 剧情推进提示词（严格：返回唯一 JSON，text + mid_term_memory + tavern_commands 对象）
export const IN_GAME_MESSAGE_PROMPT = [
  '【剧情推进】根据当前游戏状态推进一段叙事，并返回唯一 JSON。',
  '',
  // Critical rules (bilingual, concise, non-duplicated)
  '【关键规则 | Critical Rules】',
  '🚨 **必须且只能返回JSON** - 不得有任何解释、对话、说明或其他文字',
  '🚨 **禁止询问** - 不得询问"请提供游戏状态"或"需要更多信息"',  
  '🚨 **直接执行** - 基于提供的输入数据直接生成故事和指令',
  '- 必须返回唯一 JSON: text, mid_term_memory, tavern_commands.  Return a single JSON with these fields.',
  '- 禁止隐式改动；任何状态变化必须通过 tavern_commands 执行。  No implicit changes — apply ALL state via tavern_commands.',
  '- 若时间推进，必须命令写入 character.saveData.时间（set 时间.当前，push 时间.时间轴）。  Time changes must be recorded with commands.',
  '- 与角色对话或采取行动后，必须写入/更新"记忆"。  After dialogue or actions, memory must be added/updated.',
  '- 所有 key 以 character.saveData. 开头并匹配既有结构；不确定时使用保守表述。  All keys start with character.saveData.',
  '',
  '必须返回字段: text(字符串), mid_term_memory(字符串), tavern_commands(数组)。',
  '格式要求:',
  '- text: 必须是字符串类型，长度≥800字，建议3-6段详细叙事，重点描述：',
  '  * 环境氛围和场景细节（天气、光线、声音、气味、温度、风向等）',
  '  * 角色的内心感受、情绪变化和身体反应的细致描写',
  '  * 动作过程的分步骤详细展现，包括准备、执行、结果',
  '  * 对话和互动的具体内容，包括语气、表情、动作',
  '  * 修炼、战斗、探索等过程的专业细节和感受',
  '  * 禁止使用总结式、概括式描述，必须用具体场景和细节展现',
  '  * 每个段落至少150-200字，用生动的描写让读者身临其境',
  '  【格式化标记要求】:',
  '  * 环境描写用【】包围，根据当前场景的具体情况进行描述',
  '  * 心理描写用``包围，描述角色的内心感受和想法',
  '  * 对话内容用中文引号""包围（或半角双引号""），且每句仅用一对，不要嵌套',
  '  * 不要照搬示例中的人名/地名；请使用上下文已有的人名，或生成符合世界观、随机且不重复的人名',
  '  * 普通叙事和动作描写不加标记，与格式化内容自然拼接',
  '  * 确保标记使用正确，不要嵌套或交叉使用',
  '- mid_term_memory: 中期记忆，必须是字符串类型(非空时)，不能是数组或对象',
  '- tavern_commands: 必须是数组类型，每个元素包含 { action, scope, key, value } 字段',
  '严格要求:',
  '- 【重要】禁止简短总结：绝不能使用"[时辰][地点]做了什么"的总结格式',
  '- 【重要】必须展开描写：每个动作、每个感受都要用具体的场景来表现',
  '- 【重要】沉浸式叙事：让读者感觉身临其境，而不是在听别人转述',
  '- 文本先行、证据优先：所有变更(位置/地图/背包/属性/判定/好感/宗门/环境/时间)必须在 text 中出现明确依据，否则不要生成。',
  '- 禁止写入/覆盖 character.saveData.世界信息(除确有其事新增地点外)、玩家出生地、任意 world_*；禁止整体覆盖 character.saveData。',
  '- 所有路径必须以 character.saveData. 开头；参考输入 current_game_state 的现有结构进行写入，严禁新增平行根路径。',
  '- 统一使用"玩家角色状态"字段，严禁使用"角色状态"作为路径段名。',
  '- tavern_commands 的每条命令必须使用 key 字段（不要使用 path/target），并包含 { action, key, value }（delete 除外）。',
  '- 不要将计算/判定过程写入 character.saveData；仅把最终结果（数值变化/状态/时间）用 tavern_commands 落库；如需解释请写在 text。',
  '',
  '【判定系统｜天道演算 v4.2】',
  '- 当输入中出现【判定|检定:{法力|神海|道心|空速|气运}|DC:数值|情景:…】或【判定|斗法|敌人:…|敌方状态:…】时：',
  '  1) 直接读取 character.saveData.系统.天道演算（由前端预计算提供），不得自行杜撰；',
  '  2) 通用检定：按 预计算.成功率曲线 中对应类型与DC给出的成功率执行 d100 比较（1-3为【天眷】大成，98-100为【反噬】大败）；',
  '  3) 天道特许：若 预计算.特许.天道之眷标签 与本次检定强相关，可视作自动成功或最多+20%（仍需封顶≤98%）；',
  '  4) 斗法检定：以 预计算.斗法基线（命中/闪避/暴击/伤害系数/豁免强度）作基准，结合叙事上下文的敌我优势微调±10%以内；',
  '  5) 在输出 JSON 中额外附加 judgement 字段（可选）：{ type, dc, roll, success_rate, grade, details }，text 必须体现过程与因果；',
  '  6) 文字增幅：根据 预计算.文字增幅 选取增幅词（天眷/完胜/险胜/失手/反噬）融入 text；',
  '  7) tavern_commands 只做与叙事相符的最小必要改动（如：资源消耗、状态效果、位置微调等）。',
  '',
  '【重要】记忆与时间规则（记忆必须命令落库 | Memory MUST be written via commands）',
  '- 与角色对话或采取行动后，必须在 tavern_commands 中新增或更新与本轮相关的“记忆”。',
  '- 有新事实：push 到 character.saveData.记忆.短期记忆 或 中期记忆；无新事实：push 短期记忆="确认：无变化（理由）"。',
  '- 时间发生变化：set character.saveData.时间.当前 + push character.saveData.时间.时间轴={时间,事件,原因}。',
  '- 人物互动发生变化时，可操作 character.saveData.人物关系.<姓名>（保持结构一致）。',
  '',
  '【通用能力面板】系统为你预计算了角色在各种潜在行动中的能力指标。当玩家执行某个行动时，你必须参考此面板中对应的成功率/效率等数值，并结合随机性来判定最终结果。',
  '例如，如果玩家尝试炼丹，请参考 `derived.potential_actions.alchemy.success_chance` 的值作为基础成功率。',
  '',
  '【当前游戏状态】你必须严格基于以下“当前游戏状态”来生成响应。这是唯一的真实数据源。',
  'INPUT_PLACEHOLDER',
  '',
  'tavern_commands 用法(数组): 每个元素为 {action: "set/add/push/pull/delete", scope: "chat", key: "character.saveData.路径", value: 值}；路径以 character.saveData. 开头，点号分隔。',
  '',
  '路径变量参考（必须遵循）:',
  '- 角色基础信息: 名字/性别/年龄/出生/灵根/天赋/天资/先天六司{根骨/灵性/悟性/气运/魅力/心性}/世界；',
  '- 玩家角色状态: 境界(对象)/位置.{描述,坐标{X,Y}}/气血|灵气|神识|寿命|修为(各为{当前,最大})/状态效果[]/身份/当前活动/心情；',
  '- 背包: 灵石.{下品/中品/上品/极品}/物品.<物品ID>=Item；Item含{物品ID, 名称, 类型(装备|功法|其他), 品质{quality,grade}, 数量, 描述}；',
  '- 装备栏: 装备1..装备6=Item|null；修炼功法: 功法/熟练度/已解锁技能/修炼时间/突破次数；',
  '- 记忆: 短期记忆[]/中期记忆[]/长期记忆[]（禁止操作，自动生成）；人物关系: 人物关系.<姓名>=NpcProfile（仅NPC交互时操作）；',
  '',
  '物品规范:',
  '- 仅 set 到 character.saveData.背包.物品.<物品ID>；类型严格限制为 装备|功法|其他；需有 text 依据。',
  '- 【强制】品质字段格式：必须为 {quality:"凡/黄/玄/地/天/仙/神", grade:0-10}，禁止缺失或格式错误。',
  '- 【关键】物品分类判定（严格执行）：',
  '  * 装备：所有可穿戴、佩戴或持用的物品，包括但不限于：',
  '    - 衣物类：袍子、华服、锦衣、道袍、法衣、衣裳、外套等',
  '    - 饰品类：玉佩、项链、戒指、手镯、腰带、头饰、耳环等',
  '    - 武器类：剑、刀、枪、棒、法器、灵器、猎刀、战刀、长剑、短剑等',
  '    - 防具类：护甲、头盔、护手、鞋靴等',
  '    - 其他装备：帽子、手套、斗笠、面具等',
  '  * 功法：修炼秘籍（功法/心法/秘籍/剑法/掌法/内功等）',
  '  * 其他：消耗品和不可装备物品（丹药/符篆/书籍/食物/钥匙/财宝/材料等）',
  '- 【分类检查清单】生成物品时必须问自己：',
  '  1. 这个物品能穿在身上吗？→ 装备',
  '  2. 这个物品能戴在身上吗？→ 装备', 
  '  3. 这个物品能拿在手里战斗吗？→ 装备',
  '  4. 这个物品是修炼功法吗？→ 功法',
  '  5. 以上都不是？→ 其他',
  '- 【重要提示】：如果物品可以穿在身上、戴在身上或拿在手里，一律归类为"装备"！',
  '- 【严禁固定名称】物品命名必须动态生成，创意多样，避免重复：',
  '  * 严禁使用任何固定模板名称，每次都要创造全新名称',
  '  * 每次生成物品时创造全新的名称，体现修仙世界的丰富性',
  '  * 根据情境、地区、人物背景生成符合设定的独特物品名',
  '  * 同类物品也要有不同的称谓和特色描述',
  '- 物品ID 必须是单层键（不能包含点号），禁止在 背包.物品 下创建多级分类键。',
  '- 【重要】灵石存放规则：灵石必须存放在 character.saveData.背包.灵石 中，禁止作为物品存入物品栏。灵石包括：下品灵石/中品灵石/上品灵石/极品灵石，但金银财宝等其他货币可放入物品栏。',
  '',
  '状态效果规范(每次变化都要更新):',
  '- 必填字段: 状态名称, 类型(buff|debuff 小写), 状态描述(50字以上,必须包含具体数值效果), 时间(必须给出具体值如"30分钟"|"1小时"|"3天"|"永久",禁止"未指定")',
  '- 可选字段: 强度(1-10数值), 来源(产生原因), 剩余时间',
  '- 状态描述必须详细说明：1)状态的来历背景 2)对角色产生的具体影响(带数值) 3)可能的后续发展',
  '- 根据剧情发展动态调整状态效果，移除过期状态，添加新状态',
  '- push到 character.saveData.玩家角色状态.状态效果 数组',
  '',
  '位置/地图:',
  '- 常规推进仅 set 位置.坐标(单次偏移≤100) 与 位置.描述（坐标对象必须为 {X,Y}）。',
  '- 仅叙事确有其事时，push 地点到 世界信息.地点信息，值为最小对象(名称/类型/描述/位置{X,Y}/重要)。',
  '',
  '人物关系(NPC系统):',
  '- 在 text 出现与具体人物的明确互动时，必须 set 到 人物关系.<姓名>',
  '- NPC完整结构(必须严格遵循NpcProfile类型):',
  '  * 角色基础信息: {名字,性别,年龄?,世界?,天资?,出生?,灵根?,天赋:[],先天六司:{}}',
  '  * 外貌描述?: 10-20字特征',
  '  * 角色存档信息: {时间,装备,功法,状态,境界,声望,位置,各项数值,背包(同玩家)}',
  '  * AI行为: {行为模式,日常路线:[]}',
  '  * 人物关系: 关系描述',
  '  * 人物好感度: -100到100',
  '  * 人物记忆: ["[日期][地点]事件"]格式',
  '  * 最后互动时间: ISO字符串或null',
  '  * 背包?: {物品:{<物品ID>:Item}} (商人/重要NPC)',
  '- NPC背包物品格式必须与玩家一致:',
  '  * Item: {物品ID,名称,类型(装备|功法|其他),品质:{quality,grade},数量,描述}',
  '  * 示例格式: {"物品名称":{物品ID:"物品名称",名称:"物品名称",类型:"其他",品质:{quality:"凡",grade:3},数量:5,描述:"..."}}',
  '- 物品命名规范: 使用富有创意的名称，避免固定模板，让每次生成都有新意',
  '- 【严禁固定模板】禁止使用重复的固定物品名称，必须根据情境创造独特名称',
  '- NPC交互场景:',
  '  * 交易: NPC背包物品与玩家背包物品交换，需更新双方背包',
  '  * 赠送: 从一方背包移除，添加到另一方背包',
  '  * 偷窃: 判定成功后转移物品，影响好感度',
  '',
  '记忆管理（禁止操作）:',
  '- 短期记忆: 系统自动从正文提取，禁止手动 push',
  '- 中期记忆: 系统自动生成，禁止手动 push',
  '- 长期记忆: 系统自动归档，禁止手动 push',
  '',
  '最小指令集（发生相应变化时，需至少包含）:',
  "- set: character.saveData.玩家角色状态.位置.(描述|坐标)",
  "- set: character.saveData.背包.物品.<物品ID>（如叙事所述）",
  "- set/push: character.saveData.玩家角色状态.状态效果（对象格式）",
  "- set: character.saveData.人物关系.<姓名>（当text中发生互动时）",
  '',
  '合理性审查(最高权限): 难度 normal|medium|hard；进入他人地图强制 hard；hard 下不得无因越界推进，消耗/收益/代价必须在 text 落实；对不合理变更自修正。',
  '',
  generateSystemPrompt({
    includeRealmSystem: true,
    includeItemQuality: true,
    includeNPCSystem: true,
    includeDataStructure: true
  })
].join('\n');

export function getRandomizedInGamePrompt(): string {
  return IN_GAME_MESSAGE_PROMPT;
}

