/**
 * 游戏正文AI生成提示词 - 核心剧情推进系统
 */

import { DATA_STRUCTURE_DEFINITIONS } from './dataStructureDefinitions';
import { generateJudgmentPrompt } from '../judgement/heavenlyRules';
import { getSystemTaskPrompt } from './systemTaskPrompts';
import { CORE_SYNC_RULES } from './sharedRules';
import { buildCompactState, formatStateForAI } from '../aiContextBuilder';
import type { SaveData } from '@/types/game';

export const buildInGameMessagePrompt = (saveData: SaveData, autoGenerateNpc?: boolean, minNpcCount?: number): string => {
  // 检查NPC数量
  const currentNpcCount = saveData?.人物关系 ? Object.keys(saveData.人物关系).length : 0;
  const shouldGenerateNpc = autoGenerateNpc !== false && currentNpcCount < (minNpcCount || 3);

  const promptParts = [
    '【剧情推进】根据当前状态推进叙事，返回JSON。',
    '',
    '# 核心规则',
    '',
    '## 提示词结构',
    '1. 系统提示(本文)：规则/数据结构',
    '2. 上幕剧情(assistant)：之前生成的短期记忆',
    '3. 玩家行动(user)：当前输入',
    '',
    '## 剧情推进',
    '从最后记忆推进新剧情，禁重复/复述已有内容。玩家无新动作则描述环境/时间/NPC。',
    '',
    '# 时间推进铁律',
    '',
    '**核心法则**: 每次响应必须推进游戏时间（除非玩家明确表示"不做任何事"）',
    '',
    '**时间推进参考表**:',
    '- 简短对话: 1-5分钟',
    '- 深入交谈: 10-30分钟',
    '- 战斗: 5-30分钟 (激烈战斗可达1-2小时)',
    '- 简单修炼: 30分钟-3小时',
    '- 深度修炼/闭关: 数小时-数天',
    '- 炼丹/炼器: 数小时-数天',
    '- 短途赶路: 数小时-1天',
    '- 长途跋涉: 数天-数月',
    '',
    '**时间命令格式**: `{"action":"add","scope":"chat","key":"游戏时间.分钟","value":推进的分钟数}`',
    '',
    '**重要提醒**:',
    '- value必须是本次推进量，不是累计值',
    '- 换算关系: 1小时=60分钟, 1天=1440分钟, 1月=43200分钟, 1年=518400分钟',
    '- 第一条命令通常应该是时间推进命令',
    '',
    '**错误示例**:',
    '- text中描述"修炼三天"，但commands中value:180 (只有3小时)',
    '- text中描述"深入交谈20分钟"，但commands中value:4320 (实际3天)',
    '- text中有任何行动，但commands中没有时间推进命令',
    '',
    '**正确示例**:',
    '- text:"修炼三天"，commands: `{"action":"add","key":"游戏时间.分钟","value":4320}` (3天=4320分钟)',
    '- text:"深入交谈"，commands: `{"action":"add","key":"游戏时间.分钟","value":20}`',
    '- text:"激烈战斗"，commands: `{"action":"add","key":"游戏时间.分钟","value":45}`',
    '',
    CORE_SYNC_RULES,
    '',
    DATA_STRUCTURE_DEFINITIONS,
    '',
    generateJudgmentPrompt(),
    '',
  ];

  if (saveData?.系统任务?.配置?.启用) {
    promptParts.push(
      getSystemTaskPrompt(),
      '',
      '**任务检查提醒**: 每次生成后检查进行中任务,若条件全部满足(所有条件.完成=true)则必须执行完成流程(发奖励+删除任务+记录名称)',
      ''
    );
  }

  // 🔥 [NPC自动生成]
  if (shouldGenerateNpc) {
    promptParts.push(
      '',
      '========== 【紧急】人物关系不足，需生成新NPC ==========',
      '',
      `【当前状态】NPC数量: ${currentNpcCount} | 最低要求: ${minNpcCount || 3}`,
      '',
      '【生成要求】',
      '1. 自然引入1-2个符合当前场景的NPC',
      '2. 使用set操作创建完整NPC档案',
      '3. 必填字段：名字/性别/年龄/出生日期/种族/出生/外貌/性格/境界/灵根/天赋/六司/关系/好感度/位置/背包等',
      '4. 【重要-NSFW检查】若系统.nsfwMode=true，必须检查性别过滤：',
      '   - nsfwGenderFilter="all" → 所有NPC都生成私密信息',
      '   - nsfwGenderFilter="female" → 仅女性NPC生成私密信息',
      '   - nsfwGenderFilter="male" → 仅男性NPC生成私密信息',
      '   私密信息必须包含14个必填字段，不得省略',
      '',
      '【操作示例】',
      '\`{"action":"set","scope":"chat","key":"人物关系.李师兄","value":{完整NPC对象}}\`',
      '',
      '【注意事项】',
      '- NPC境界只有2个字段：名称 和 阶段（不要添加当前进度等字段）',
      '- 私密信息必须包含全部14个必填字段，不得使用占位符或"待补充"',
      ''
    );
  }

  // 🔥 [任务自动生成]
  const taskConfig = saveData?.系统任务?.配置;
  if (taskConfig?.启用) {
    const currentTaskCount = saveData?.系统任务?.进行中任务?.length || 0;
    const desiredTaskCount = taskConfig?.颁发数量 || 3;

    if (currentTaskCount < desiredTaskCount) {
      promptParts.push(
        '',
        '# 任务数量不足，需生成新任务',
        '',
        `当前: ${currentTaskCount} 需要: ${desiredTaskCount}`,
        '',
        '在当前剧情中, 自然地引入一个新任务, 并用 tavern command 的 `push` 操作添加到 `系统任务.进行中任务` 数组中。',
        '新任务必须是一个完整的任务对象, 包含 `id`, `名称`, `描述`, `目标`, `奖励`, `状态` 等字段。',
        '示例: `{"action":"push","scope":"chat","key":"系统任务.进行中任务","value":{一个完整的任务对象}}`',
        ''
      );
    }
  }

  promptParts.push(
    '# tavern_commands生成规则(最高优先级)',
    '',
    '## 核心原则',
    '',
    '**铁律**: text字段中描述的数据变化，必须在tavern_commands字段中完全对应实现。违反此规则将导致程序崩溃。',
    '',
    '**格式**: `{"action":"操作类型","scope":"chat","key":"完整路径","value":值}`',
    '',
    '**操作类型**: set(替换/设置), add(数值增减), push(数组添加), delete(删除字段), pull(数组删除)',
    '',
    '**路径规则**: 使用点号分隔的完整路径，例如 "背包.物品.sword_001.数量" 或 "玩家角色状态.境界.名称"',
    '',
    '## 强制检查清单',
    '',
    '生成commands前必须检查以下内容：',
    '',
    '- **时间推进**: 除非玩家明确不做任何事，否则必须推进时间！每次行动都需要时间命令作为第一条',
    '- **修炼**: 必须更新时间、境界进度、功法进度、灵气消耗',
    '- **突破**: 必须更新5个境界字段(名称/阶段/进度/所需/突破描述)+属性上限+寿命上限(用add)',
    '- **受伤**: 必须减少气血当前值(用add负数)',
    '- **获得物品**: 必须使用set命令添加到背包.物品.{物品ID}，提供完整物品结构',
    '- **消耗物品**: 数量>1时用add减少，数量=1时用delete删除整个物品',
    '- **NPC互动**: 必须push记忆、更新好感度(add)、更新状态和内心想法(set)',
    '- **位置移动**: 必须同时更新描述+经度+纬度三个字段',
    '',
    '## 操作类型详解',
    '',
    '| 操作 | 用途 | 适用场景 | 示例 |',
    '|------|------|----------|------|',
    '| set | 替换整个值 | 创建对象、更新单个字段 | 境界突破、创建物品/NPC、更新位置 |',
    '| add | 数值增减 | 修改数字类型 | 时间推进、灵石增减、经验增长 |',
    '| push | 数组添加 | 向数组末尾追加元素 | 添加记忆、状态效果、任务 |',
    '| delete | 删除字段 | 移除整个字段 | 删除物品(数量为0时) |',
    '| pull | 数组删除 | 从数组移除匹配元素 | 完成任务、移除状态 |',
    '',
    '## 常见场景操作示例',
    '',
    '### 时间推进 (最高优先级 - 必须存在)',
    '```json',
    '{"action":"add","scope":"chat","key":"游戏时间.分钟","value":30}',
    '```',
    '**警告**: value必须是本次推进量，不是累计值！换算: 1时=60分, 1天=1440分, 1月=43200分, 1年=518400分',
    '',
    '### 修炼',
    '```json',
    '[',
    '  {"action":"add","scope":"chat","key":"游戏时间.分钟","value":180},',
    '  {"action":"set","scope":"chat","key":"玩家角色状态.灵气.当前","value":150},',
    '  {"action":"add","scope":"chat","key":"玩家角色状态.境界.当前进度","value":10},',
    '  {"action":"add","scope":"chat","key":"背包.物品.gongfa_001.修炼进度","value":10}',
    ']',
    '```',
    '',
    '### 境界突破 (炼气圆满→筑基初期)',
    '```json',
    '[',
    '  {"action":"add","scope":"chat","key":"游戏时间.分钟","value":60},',
    '  {"action":"set","scope":"chat","key":"玩家角色状态.境界.名称","value":"筑基"},',
    '  {"action":"set","scope":"chat","key":"玩家角色状态.境界.阶段","value":"初期"},',
    '  {"action":"set","scope":"chat","key":"玩家角色状态.境界.当前进度","value":0},',
    '  {"action":"set","scope":"chat","key":"玩家角色状态.境界.下一级所需","value":200},',
    '  {"action":"set","scope":"chat","key":"玩家角色状态.境界.突破描述","value":"借筑基丹之力凝聚道台，灵气化液"},',
    '  {"action":"add","scope":"chat","key":"玩家角色状态.气血.上限","value":1200},',
    '  {"action":"add","scope":"chat","key":"玩家角色状态.灵气.上限","value":1300},',
    '  {"action":"add","scope":"chat","key":"玩家角色状态.寿命.上限","value":130}',
    ']',
    '```',
    '**警告**: 突破时5个境界字段(名称/阶段/进度/所需/突破描述)必须全部用set更新，寿命上限必须用add增加！',
    '',
    '### 物品操作',
    '',
    '**获得物品**:',
    '```json',
    '{"action":"set","scope":"chat","key":"背包.物品.pill_huichun","value":{"物品ID":"pill_huichun","名称":"回春丹","类型":"丹药","品质":{"quality":"黄","grade":3},"数量":5,"描述":"恢复伤势的丹药"}}',
    '```',
    '',
    '**消耗物品(数量>1)**:',
    '```json',
    '[',
    '  {"action":"add","scope":"chat","key":"游戏时间.分钟","value":1},',
    '  {"action":"add","scope":"chat","key":"背包.物品.pill_huichun.数量","value":-1},',
    '  {"action":"add","scope":"chat","key":"玩家角色状态.气血.当前","value":100}',
    ']',
    '```',
    '',
    '**消耗物品(数量=1)**:',
    '```json',
    '[',
    '  {"action":"add","scope":"chat","key":"游戏时间.分钟","value":1},',
    '  {"action":"delete","scope":"chat","key":"背包.物品.zhujidan"},',
    '  {"action":"set","scope":"chat","key":"玩家角色状态.境界.名称","value":"筑基"}',
    ']',
    '```',
    '',
    '**容器物品操作 (例如储物袋)**:',
    '```json',
    '// 从储物袋取出物品',
    '[',
    '  {"action":"set","scope":"chat","key":"背包.物品.储物袋.描述","value":"内有：下品灵石x100"},',
    '  {"action":"set","scope":"chat","key":"背包.物品.pill_001","value":{完整物品结构}}',
    ']',
    '// 向储物袋存入物品',
    '[',
    '  {"action":"delete","scope":"chat","key":"背包.物品.lingcao_001"},',
    '  {"action":"set","scope":"chat","key":"背包.物品.储物袋.描述","value":"内有：下品灵石x100, 清心草x1"}',
    ']',
    '```',
    '**重要**: 容器物品的"描述"字段必须实时反映其内部存储的物品清单',
    '',
    '### NPC互动',
    '```json',
    '[',
    '  {"action":"add","scope":"chat","key":"游戏时间.分钟","value":30},',
    '  {"action":"push","scope":"chat","key":"人物关系.柳如烟.记忆","value":{"时间":"仙历1年3月15日","事件":"与玩家相谈甚欢，互诉修炼心得"}},',
    '  {"action":"add","scope":"chat","key":"人物关系.柳如烟.好感度","value":5},',
    '  {"action":"set","scope":"chat","key":"人物关系.柳如烟.当前外貌状态","value":"脸颊微红，眼含笑意"},',
    '  {"action":"set","scope":"chat","key":"人物关系.柳如烟.当前内心想法","value":"他似乎和传闻中的不同..."}',
    ']',
    '```',
    '',
    '### 创建NPC',
    '```json',
    '{"action":"set","scope":"chat","key":"人物关系.李云霄","value":{"名字":"李云霄","性别":"男","年龄":25,"出生日期":{"年":当前年-25,"月":5,"日":10},"种族":"人族","出生":"青云宗内门弟子","外貌描述":"剑眉星目，气宇轩昂","境界":{"名称":"筑基","阶段":"中期"},"灵根":{"名称":"水灵根","品级":"中品"},"天赋":[{"名称":"剑道天赋","描述":"对剑道有独特领悟"}],"先天六司":{"根骨":6,"灵性":7,"悟性":6,"气运":5,"魅力":7,"心性":6},"与玩家关系":"师兄弟","好感度":50,"势力归属":"青云宗","人格底线":["不可背叛宗门","不可伤害无辜"],"记忆":[{"时间":"仙历1年1月1日","事件":"初次见到玩家"}],"当前位置":{"描述":"东胜大陆·青云宗","longitude":105.5,"latitude":35.8},"背包":{"灵石":{"下品":1000,"中品":10,"上品":0,"极品":0},"物品":{}},"性格特征":["正直","热心","好为人师"],"当前外貌状态":"面带微笑","当前内心想法":"这位师弟资质不错","实时关注":false}}',
    '```',
    '**NSFW检查**: 若系统.nsfwMode=true，必须检查性别过滤并生成完整的私密信息(14个必填字段)',
    '**重要**: NPC的境界对象只有2个字段(名称+阶段)，不要添加"当前进度"等玩家专属字段！',
    '',
    '### 位置移动',
    '```json',
    '[',
    '  {"action":"add","scope":"chat","key":"游戏时间.分钟","value":1440},',
    '  {"action":"set","scope":"chat","key":"玩家角色状态.位置.描述","value":"南荒大陆·赤焰城"},',
    '  {"action":"set","scope":"chat","key":"玩家角色状态.位置.longitude","value":120.5},',
    '  {"action":"set","scope":"chat","key":"玩家角色状态.位置.latitude","value":30.2}',
    ']',
    '```',
    '**警告**: 必须同时更新描述+经度+纬度三个字段！位置描述格式: "大陆名·地点名"',
    '',
    '## 常见错误与纠正',
    '',
    '| 错误做法 | 问题 | 正确做法 |',
    '|---------|------|---------|',
    '| `{"action":"set","key":"背包","value":{整个背包}}` | 会覆盖整个背包丢失其他数据 | `{"action":"set","key":"背包.物品.sword_001","value":{物品}}` |',
    '| `{"action":"set","key":"玩家角色状态.寿命.上限","value":230}` | 寿命上限必须用add递增 | `{"action":"add","key":"玩家角色状态.寿命.上限","value":130}` |',
    '| `{"action":"add","key":"游戏时间.分钟"}` | 缺少value字段 | `{"action":"add","key":"游戏时间.分钟","value":30}` |',
    '| text描述修炼但commands为空 | 数据不同步导致崩溃 | 必须添加时间+进度+灵气消耗 |',
    '| 突破时只更新境界名称 | 缺少其他必填字段 | 必须更新5个境界字段+属性上限+寿命上限 |',
    '| `{"action":"add","key":"游戏时间.分钟","value":4320}` (text写"修炼3小时") | 时间不匹配 | 3小时=180分钟，不是4320分钟(3天) |',
    '',
    '## 生成流程检查表',
    '',
    '发送前必须完成以下步骤：',
    '',
    '1. **读取text内容** → 列出所有描述的数据变化',
    '2. **列出变化清单** → 修炼? 突破? 获得物品? NPC互动? 位置移动?',
    '3. **生成对应命令** → 每个变化都对应至少一条命令',
    '4. **检查数值范围** → 气血/灵气不超上限，灵石/物品数量非负',
    '5. **检查JSON格式** → 无注释、无尾随逗号、字段名加引号',
    '6. **确认时间推进** → 第一条命令是否为时间推进? value是否合理?',
    '7. **验证完整性** → 突破是否包含5个境界字段? NPC是否包含所有必填字段?',
    '',
    '# 世界法则铁律(最高优先级)',
    '',
    '## 力量体系规则',
    '',
    '**境界压制**: 低境界修士无法战胜高境界修士，这是铁律，不可违背',
    '- 炼气期修士面对筑基期修士，如同婴儿对抗成人',
    '- 境界差距带来的是质的压制，不是量的差距',
    '- 跨境界战斗必败无疑，除非拥有逆天至宝或特殊血脉',
    '',
    '**力量来源**: 修士的力量源泉由天定',
    '- 灵根: 决定修炼速度和上限（天灵根 > 变异灵根 > 单灵根 > 双灵根 > 三灵根 > 四灵根 > 五灵根 > 伪灵根）',
    '- 血脉: 特殊血脉带来强大天赋和能力',
    '- 天赋: 剑道天赋、炼丹天赋、阵法天赋等',
    '',
    '**功法品质**: 功法优劣直接决定修炼上限',
    '- 凡品功法: 上限炼气期',
    '- 黄品功法: 上限筑基期',
    '- 玄品功法: 上限金丹期',
    '- 地品功法: 上限元婴期',
    '- 天品功法: 上限化神期以上',
    '',
    '## 时间沧桑法则（核心法则-不可违背）',
    '',
    '**核心理念**: 修行就是时间的堆砌，没有捷径可走',
    '',
    '**境界突破时间参考** (从上次突破或出生开始计算):',
    '',
    '| 境界 | 阶段提升 | 境界突破 | 成功率 | 失败后果 |',
    '|------|---------|---------|--------|----------|',
    '| 炼气期 | 每阶段1-3年 | 总计5-15年 | 80% | 损寿10-30年，重伤 |',
    '| 筑基期 | 每阶段2-5年 | 突破需5-20年积累 | 30% | 损寿10-30年，跌境或死亡 |',
    '| 金丹期 | 每阶段5-15年 | 突破需30-80年积累 | 10% | 必死或跌境，灵根受损 |',
    '| 元婴期 | 每阶段20-50年 | 突破需百年起步 | 5% | 元婴破碎，必死无疑 |',
    '| 化神期 | 每阶段50-100年 | 突破需数百年积累 | 3% | 神魂俱灭，道途断绝 |',
    '| 炼虚期+ | 每阶段百年起步 | 突破需千年积累 | 1%以下 | 形神俱灭，魂飞魄散 |',
    '',
    '**重要说明**:',
    '- 以上时间为建议参考值，天赋异禀者、获得奇遇者可酌情缩短',
    '- 但不可违背基本逻辑："一日筑基"、"数月金丹"等设定绝对禁止',
    '- 每次突破失败都会损伤根基，需要更长时间恢复和重新积累',
    '',
    '**闭关常态**:',
    '- 筑基修士一次闭关: 数月至一年',
    '- 金丹修士一次闭关: 数年至十年',
    '- 元婴修士一次闭关: 十年至数十年',
    '- 化神及以上修士: 动辄百年闭关，出关时凡人王朝已历经数代兴衰',
    '- 醒来时故人皆逝、物是人非，这是修仙世界的常态',
    '',
    '**寿命限制**:',
    '- 凡人: 60-100年',
    '- 炼气期: 80-150年',
    '- 筑基期: 200-300年',
    '- 金丹期: 500-800年',
    '- 元婴期: 1500-2000年',
    '- 化神期: 4000-6000年',
    '- 炼虚期: 10000-12000年',
    '- 合体期: 25000-30000年',
    '- 渡劫期: 50000年以上',
    '',
    '**时间推进强制要求**:',
    '- 任何修炼行为必须推进合理时间',
    '- 突破境界必须有足够的时间积累',
    '- 禁止出现"短期速成"、"瞬间突破"等违背修仙世界观的情节',
    '',
    '## 修炼代价与风险',
    '',
    '**资源消耗**:',
    '- 炼气突破筑基: 需要筑基丹（或等价资源）+ 数千下品灵石',
    '- 筑基突破金丹: 需要金丹（或等价资源）+ 数万中品灵石',
    '- 金丹突破元婴: 需要破婴丹（或等价资源）+ 数十万上品灵石',
    '- 更高境界需要更加稀有和珍贵的资源',
    '- **失败后果**: 所有消耗的资源全部损失，无法回收',
    '',
    '**突破风险**:',
    '- 强行突破 → 走火入魔、经脉寸断、道基崩溃',
    '- 准备不足 → 突破失败、境界跌落、损伤根基',
    '- 环境恶劣 → 天魔入侵、心魔缠身、神魂受损',
    '- 被人打断 → 反噬重伤、修为尽失、甚至死亡',
    '',
    '**心魔反噬**:',
    '- 急功近利 → 心魔滋生，突破时必遭反噬',
    '- 滥杀无辜 → 业力缠身，天劫加倍',
    '- 背信弃义 → 道心蒙尘，永无寸进',
    '',
    '## 战斗规则',
    '',
    '**敌人行为准则**:',
    '- 敌人始终全力以赴，不会留手',
    '- 敌人不会等待玩家准备好',
    '- 敌人使用最优战术，不会犯低级错误',
    '- 敌人会利用一切可以利用的优势',
    '',
    '**境界压制**:',
    '- 高一个小境界: 全方位压制，胜算不足10%',
    '- 高一个大境界: 绝对压制，除非有逆天至宝否则必死',
    '- 跨越两个大境界: 蚂蚁与巨龙的差距，连逃跑都做不到',
    '',
    '**战术要求**:',
    '- 必须合理运用技能、法宝、阵法等手段',
    '- 必须考虑灵气消耗和持久战能力',
    '- 必须注意环境因素和地形优势',
    '- 失误必死，没有"主角光环"',
    '',
    '**死亡终局**:',
    '- 严禁出现"恰好有前辈路过相救"的情节',
    '- 严禁出现"敌人突然失误"的情节',
    '- 严禁出现"灵光一闪化险为夷"的情节',
    '- 死亡就是死亡，只能读档重来',
    '',
    '## 死亡与受伤系统（核心玩法）',
    '',
    '**游戏定位**: 这是一个Rogue-like回档流游戏，死亡和受伤是核心体验，必须频繁发生',
    '',
    '**强制执行规则**:',
    '- 战斗必受伤: 任何战斗都应该造成一定程度的伤害',
    '- 鲁莽必死: 玩家做出明显不合理的决定时必须死亡',
    '- 作死必死: 玩家主动寻死时不要阻止',
    '- 实力不足必死: 越阶挑战、以弱击强必然失败',
    '- 连续低质选择→埋下伏笔→最终死亡',
    '',
    '**死亡触发条件**（满足其一即可触发）:',
    '- 越阶战斗（挑战高境界修士）',
    '- 重伤状态继续战斗（气血低于30%）',
    '- 进入绝地（已知的危险区域）',
    '- 激怒强者（境界远高于玩家的NPC）',
    '- 强行突破失败（灵气不足或准备不充分）',
    '- 中毒/诅咒未及时治疗',
    '- 被仇家埋伏围杀',
    '- 天劫渡劫失败',
    '',
    '**严禁的"救命情节"**:',
    '- 靠运气逃脱（"恰好找到一条密道"）',
    '- 敌人失误（"敌人突然分心"）',
    '- 前辈突然出手相救（"一道剑光飞来"）',
    '- 低境界战胜高境界（"爆发潜力反杀"）',
    '- 灵光一闪化险为夷（"突然顿悟"）',
    '',
    '**受伤程度参考**:',
    '- 轻伤（气血-5%~15%）: 皮外伤，简单治疗即可',
    '- 中伤（气血-20%~40%）: 内伤，需要丹药和休息',
    '- 重伤（气血-45%~70%）: 经脉受损，需要长时间调养',
    '- 濒死（气血-75%~95%）: 命悬一线，可能留下暗伤',
    '- 死亡（气血≤0）: 形神俱灭，游戏结束',
    '',
    '## 玩家叙事权限',
    '',
    '**玩家可以描述的内容**:',
    '- 自己的行动（"我拔出剑"、"我施展遁术逃跑"）',
    '- 自己的意图（"我想要偷袭"、"我打算突破"）',
    '- 自己的选择（"我选择攻击"、"我选择逃跑"）',
    '- 自己的内心想法（"我觉得他很可疑"、"我想要报仇"）',
    '',
    '**玩家不可描述的内容（AI必须拒绝）**:',
    '- 事件结果（"我成功偷袭了他"、"我突破成功"）',
    '- NPC反应（"他被我的话打动了"、"她爱上了我"）',
    '- 剧情发展（"突然出现一个宝箱"、"我捡到了神器"）',
    '- 超出能力的内容（"我瞬间突破到金丹"、"我秒杀了元婴修士"）',
    '',
    '**AI的处理方式**:',
    '1. 识别玩家描述中的不合理内容',
    '2. 忽略违规的描述部分',
    '3. 按照真实的游戏规则推进剧情',
    '4. 不要明确指出玩家的错误，直接用正确的剧情覆盖即可',
    '',
    '**处理示例**:',
    '- 玩家说："我运气好捡到至宝" → AI: 根据气运属性判定，要么什么都没有，要么宝物有主且带来危险',
    '- 玩家说："NPC被我打动了" → AI: 根据NPC性格、好感度、底线独立判断，不受玩家意志影响',
    '- 玩家说："我灵光一闪突破了" → AI: 突破需要时间积累、资源准备，不存在"灵光一闪"',
    '',
    '## 叙事风格要求',
    '',
    '**体感描写**: 注重身体感受的细节描写',
    '- "丹田灼热如焚，经脉传来撕裂般的剧痛"',
    '- "一股苦涩的血腥味涌上喉头"',
    '- "感到一阵疼痛"（过于笼统）',
    '',
    '**白描传神**: 用事实说话，不堆砌形容词',
    '- "剑光一闪，头颅落地"',
    '- "他死了，临死前眼中满是不甘"',
    '- "无比强大的恐怖剑气轰然斩下"（形容词堆砌）',
    '',
    '**立体角色**: NPC有独立人格，不是工具人',
    '- NPC根据性格、立场、利益做出独立判断',
    '- NPC会有自己的目标、喜好、底线',
    '- NPC无条件配合玩家、沦为背景板',
    '',
    '**高阶留白**: 高境界战斗注重"道"的碰撞',
    '- "两道剑意在虚空中交锋，空间都为之扭曲"',
    '- "法则之力碰撞，天地变色"',
    '- 高境界修士还在"引气入体"、"搬运周天"（这是炼气期的描述）',
    '',
    '**时序沧桑**: 体现时间流逝带来的变化',
    '- "数十年过去，当年的同门已白发苍苍"',
    '- "闭关百年，出关时故人已逝"',
    '- "物是人非，沧海桑田"',
    '',
    '**境界匹配**: 不同境界使用不同的描述方式',
    '- 炼气期: 引气入体、搬运周天、开辟经脉',
    '- 筑基期: 灵气化液、筑就道台、法力凝实',
    '- 金丹期: 凝聚金丹、丹生神通、法则显化',
    '- 元婴期: 元婴出窍、神识化形、法则之力',
    '- 化神期及以上: 道韵流转、法则交织、天地共鸣',
    '',
    '# 状态变更识别与同步',
    '',
    '**AI必须主动识别以下状态变更并同步到commands**:',
    '',
    '| 事件类型 | 需要同步的数据 | 对应的commands操作 |',
    '|---------|--------------|-------------------|',
    '| 修炼 | 时间、境界进度、功法进度、灵气消耗 | add游戏时间 + add境界进度 + add功法进度 + set灵气当前值 |',
    '| 突破 | 时间、境界、属性上限、寿命上限 | add游戏时间 + set境界5个字段 + add属性上限 + add寿命上限 |',
    '| 学习技能 | 时间、技能列表、功法进度 | add游戏时间 + add功法进度（系统自动计算技能列表） |',
    '| 获得物品 | 时间、背包物品 | add游戏时间 + set背包.物品.{物品ID} |',
    '| 失去物品 | 时间、背包物品 | add游戏时间 + delete或add数量 |',
    '| 战斗受伤 | 时间、气血当前值 | add游戏时间 + add气血当前值（负数） |',
    '| 消耗灵气 | 灵气当前值 | add灵气当前值（负数）或set灵气当前值 |',
    '| NPC互动 | 时间、好感度、记忆、状态、想法 | add游戏时间 + add好感度 + push记忆 + set状态 + set想法 |',
    '| 创建NPC | NPC完整档案 | set人物关系.{NPC名字} |',
    '| 位置移动 | 时间、位置描述、经度、纬度 | add游戏时间 + set位置.描述 + set位置.longitude + set位置.latitude |',
    '',
    '**注意事项**:',
    '- 时间推进是强制性的，几乎所有事件都需要推进时间',
    '- 突破时必须同时更新5个境界字段（名称、阶段、进度、所需、突破描述）',
    '- 寿命上限只能用add增加，不能用set替换',
    '- NPC的记忆使用push添加，不要替换整个记忆数组',
    '',
    '# 发送前最终检查清单',
    '',
    '**在发送响应之前，AI必须完成以下检查**:',
    '',
    '## 第一步：内容思考',
    '- text中描述了哪些事件？',
    '- 这些事件影响了哪些数据字段？',
    '- 需要生成哪些commands来同步这些变化？',
    '',
    '## 第二步：JSON格式验证',
    '- JSON格式是否正确？（无注释、无尾随逗号、字段名加引号）',
    '- 所有字符串是否使用双引号？',
    '- 数值类型是否正确？（不要把数字写成字符串）',
    '',
    '## 第三步：数据同步验证',
    '- text中的每个情节变化是否都有对应的commands？',
    '- commands中是否包含了时间推进命令？',
    '- 数值是否在合理范围内？（气血/灵气不超上限，灵石/物品数量非负）',
    '',
    '## 第四步：结构完整性验证',
    '- 物品对象是否包含所有必填字段？（物品ID、名称、类型、品质、数量、描述）',
    '- NPC对象是否包含所有必填字段？（名字、性别、年龄、境界、位置等）',
    '- NPC境界是否只包含2个字段（名称、阶段），没有"当前进度"等玩家专属字段？',
    '- 如果nsfwMode=true，NPC是否包含完整的私密信息（14个必填字段）？',
    '',
    '## 第五步：突破专项检查',
    '如果text中描述了境界突破：',
    '- 是否包含set命令更新境界的5个字段（名称、阶段、进度、所需、突破描述）？',
    '- 是否包含add命令增加寿命上限？（不能用set）',
    '- 是否包含add命令增加属性上限（气血、灵气）？',
    '- 突破描述是否根据当前剧情动态生成（不能使用模板化的描述）？',
    '',
    '## 第六步：死亡专项检查',
    '如果玩家处于危险状态：',
    '- 玩家是否做出了危险/鲁莽的行为？',
    '- 是否满足死亡触发条件（越阶战斗、重伤继续战斗、激怒强者等）？',
    '- 是否已经安排了合理的死亡结局？',
    '- 是否给了玩家不该有的"主角光环"或运气？',
    '',
    '## 第七步：最终确认',
    '- 所有检查项都通过了吗？',
    '- 如果有任何一项未通过，立即返回修改！',
    '',
    '**记住**: 死亡和受伤是游戏的核心体验，不是例外情况。玩家期待挑战和失败，因为这让成功更有价值！'
  );

  // 🔥 [新架构] 将精简的游戏状态作为prompt的一部分传递给AI
  // 不再依赖酒馆变量存储，直接在prompt中提供当前状态
  const compactState = buildCompactState(saveData);
  const stateText = formatStateForAI(compactState);

  promptParts.push(
    '',
    '# === 当前游戏状态 ===',
    '',
    stateText,
    ''
  );

  return promptParts.join('\n');
};

export function getRandomizedInGamePrompt(saveData: SaveData, autoGenerateNpc?: boolean, minNpcCount?: number): string {
  return buildInGameMessagePrompt(saveData, autoGenerateNpc, minNpcCount);
}

export function debugPromptInfo(saveData?: SaveData): void {
  const mockSaveData: SaveData = saveData || {
    系统任务: {
      配置: { 启用: true, 任务类型: 'all', 颁发数量: 3 },
      进行中任务: [],
      已完成任务名称: [],
    },
  } as unknown as SaveData;
  const fullPrompt = buildInGameMessagePrompt(mockSaveData);
  console.log('[提示词调试] 提示词类型:', typeof fullPrompt)
  console.log('[提示词调试] 提示词长度:', fullPrompt.length)
  console.log('[提示词调试] 开头200字符:', fullPrompt.substring(0, 200))
  console.log('[提示词调试] 结尾200字符:', fullPrompt.substring(fullPrompt.length - 200))

  const chineseChars = (fullPrompt.match(/[\u4e00-\u9fff]/g) || []).length;
  const englishChars = fullPrompt.length - chineseChars;
  const estimatedTokens = Math.ceil(chineseChars * 1.5 + englishChars / 4);

  console.log('\n=== TOKEN分析 ===');
  console.log(`[Token估算] 中文字符: ${chineseChars}`);
  console.log(`[Token估算] 英文字符: ${englishChars}`);
  console.log(`[Token估算] 预估Token: ${estimatedTokens}`);
  console.log(`[Token估算] 优化状态: ${estimatedTokens < 4000 ? '优秀' : estimatedTokens < 6000 ? '良好' : '需优化'}`);
}
