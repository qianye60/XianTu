/**
 * @fileoverview Game Master 提示词模块
 * 包含角色初始化和游戏进行中的各种AI提示词
 */

/**
 * 构建动态的角色初始化提示词
 * @param userSelections 用户选择的角色信息
 * @returns 完整的初始化提示词
 */
export function buildInitialMessagePrompt(userSelections: {
  name: string;
  gender: string;
  world: string;
  talentTier: string;
  origin: string;
  spiritRoot: string;
  talents: string[];
  attributes: {
    根骨: number;
    灵性: number;
    悟性: number;
    气运: number;
    魅力: number;
    心性: number;
  };
}): string {
  return [
    '【角色初始化完成 - 开始修仙之旅】',
    '',
    '## ⚠️ 用户已确定的角色信息（严禁修改）',
    `- **姓名**: ${userSelections.name}`,
    `- **性别**: ${userSelections.gender}`,
    `- **世界**: ${userSelections.world}`,
    `- **天资**: ${userSelections.talentTier}`,
    `- **出身**: ${userSelections.origin}`,
    `- **灵根**: ${userSelections.spiritRoot}`,
    `- **天赋**: ${userSelections.talents.join('、')}`,
    `- **先天六司**: 根骨${userSelections.attributes.根骨} 灵性${userSelections.attributes.灵性} 悟性${userSelections.attributes.悟性} 气运${userSelections.attributes.气运} 魅力${userSelections.attributes.魅力} 心性${userSelections.attributes.心性}`,
    '',
    '## 📖 叙事规则',
    '- **第一人称叙事**：所有故事必须以第一人称视角进行，用第一人称代词"我"作为{{user}}的代称',
    '- **角色第三人称**：所有NPC和其他角色使用第三人称代称',
    '- **示例**："我看到师父走了过来"而不是"李逍遥看到师父走了过来"或"你看到师父走了过来"',
    '',
    '## 🔍 角色信息一致性验证',
    '- 每次生成内容前必须核对用户的姓名、性别、属性与上述信息完全一致',
    '- 严禁在故事中改变用户的基础信息',
    '- 所有角色关系描述都必须使用用户的真实名字',
    '',
    '## 🌟 初始化任务',
    '请根据用户已选择的角色设定，生成修仙世界的开场故事：',
    '',
    '⚠️ **文本要求：生成丰富详细的叙述内容，字数不少于800字**',
    '',
    '1. **详细环境描述**（至少200字）：',
    '   - 详细描述角色所在的初始环境和位置',
    '   - 描绘周围的景色、建筑、气氛等感官细节',
    '   - 结合出身背景创造合适的开场场景',
    '   - 描述当前的时间、天气、季节等背景要素',
    '',
    '2. **角色状态初始化**（至少150字）：',
    '   - 设置符合凡人境界的基础属性（气血、灵气、神识、寿命）',
    `   - 根据已选择的天赋"${userSelections.talents.join('、')}"解锁相应的大道或能力`,
    '   - 初始化基础装备和物品',
    '   - 详细描述角色的身体感受和内在变化',
    '   - 解释天赋觉醒的过程和感受',
    '',
    '3. **人脉关系生成**（至少200字）：',
    '   - 根据出身背景创造合理的家庭关系或师门关系',
    '   - 生成2-3个重要的NPC角色，每个角色都要有详细的外貌、性格描述',
    '   - 建立初始的人际关系网络',
    '   - 描述与这些重要人物的互动场景和对话',
    '   - 展现这些关系对角色未来发展的影响',
    '',
    '4. **大道系统初始化**（至少100字）：',
    `   - 根据已选择的天赋"${userSelections.talents.join('、')}"自然解锁对应大道`,
    '   - ⚠️ 重要：解锁的大道必须与天赋设定相符，且必须同时设置完整的大道进度数据',
    '   - 详细描述大道觉醒时的玄妙感受和异象',
    '',
    '5. **剧情铺垫和引子**（至少150字）：',
    '   - 设置一个吸引人的开场事件或机缘',
    '   - 暗示未来可能的发展方向和挑战',
    '   - 营造修仙世界的神秘氛围',
    '   - 给出角色当前可以选择的行动方向',
    '',
    '## 🔄 重要规则回顾',
    '- 绝对禁止修改用户已选择的任何设定',
    '- 必须使用第一人称"我"进行叙事',
    '- 生成的所有内容必须与用户选择保持完全一致',
    '- NPC称呼玩家时使用具体名字而不是"你"',
    '',
    '## 🚨 严格响应格式要求',
    '⚠️ **必须且只能返回JSON** - 不得有任何解释、对话、说明或其他文字',
    '⚠️ **禁止询问** - 不得询问"请提供游戏状态"或"需要更多信息"',
    '⚠️ **直接执行** - 基于提供的输入数据直接生成故事和指令',
    '',
    '## 📋 必须返回的JSON格式',
    '```json',
    '{',
    '  "text": "【第一人称叙述的开场故事，必须包含：详细环境描述200字+角色状态感受150字+人物关系互动200字+大道觉醒100字+剧情铺垫150字，总计不少于800字】",',
    '  "mid_term_memory": "【关键记忆点：包含重要的人物、地点、事件信息，50-100字】",',
    '  "tavern_commands": [',
    '    {',
    '      "action": "set",',
    '      "scope": "chat",',
    '      "key": "character.saveData.字段路径",',
    '      "value": "具体值"',
    '      // set指令：设置具体值',
    '    },',
    '    {',
    '      "action": "add",',
    '      "scope": "chat",',
    '      "key": "character.saveData.数值字段",',
    '      "value": 数值',
    '      // add指令：数值增减',
    '    }',
    '  ]',
    '}',
    '```',
    '',
    '## ✍️ 文本创作指导',
    '- **叙述风格**：生动详细，富有画面感和代入感',
    '- **细节描述**：多用感官细节（视觉、听觉、嗅觉、触觉）',
    '- **人物塑造**：每个NPC都要有鲜明的特点和独特的说话方式',
    '- **环境营造**：充分利用修仙世界的玄幻元素',
    '- **情感渲染**：描述角色的内心活动和情感变化',
    '- **悬念设置**：在文本结尾留下钩子，引发玩家的好奇心',
    '',
    '## 📝 文本创作示例要求',
    '**环境描述示例风格**：',
    '"清晨的薄雾还未完全散去，我站在青石铺就的庭院中，周围古朴的建筑在晨光中显得格外静谧。远山如黛，近水含烟，空气中弥漫着淡淡的桂花香气和晨露的清新。微风轻拂过脸颊，带来一丝凉意..."',
    '',
    '**人物互动示例风格**：',
    '"父亲李文渊缓缓走来，他身形高大，眉宇间透着一股书卷气，温和的目光中却闪烁着睿智的光芒。\'逍遥，今日感觉如何？\'他的声音低沉而温暖，仿佛有种莫名的安抚力量。我能感受到他话语中的关切..."',
    '',
    '**内心感受示例风格**：',
    '"一股奇异的暖流从丹田处涌起，缓缓流淌至四肢百骸。这种感觉前所未有，仿佛有无形的力量在体内觉醒。我的感知变得异常敏锐，能够清晰地听到远处鸟儿振翅的声音，甚至能感受到空气中灵气的流动..."',
    '',
    '## 📊 输入数据',
    '```json',
    'INPUT_PLACEHOLDER',
    '```',
    '',
    '请基于以上用户选择和规则，生成精彩的修仙世界开局！',
    '  // 数值基线：character_creation.derived_stats 为前端预计算的初始化基线（不含"修为"），AI需参考并据此落库；后续变化用 tavern_commands 正常改动',
    '  // 计算/推导过程不要写入存档（character.saveData）；如需说明请写在text，存档只保存最终数值',
    '',
  ].join('\n');
}

/**
 * 静态的初始消息提示词（备用）
 */
export const INITIAL_MESSAGE_PROMPT = [
  '【背景与家庭约束】',
  '- 非玩家明确选择"孤儿出身"时，默认应当拥有家庭或亲属（父母/监护人、兄弟姐妹/家族）',
  '- 禁止无依据安排"云游道人/路过高人收养"等桥段；如确需设置，必须由输入上下文明确提出',
  '- 如果设置家庭关系，需要：',
  '  1) 在text中补充至少1位亲属的具体信息（称谓、性格或特征、相处关系片段）',
  '  2) 在tavern_commands.set中写入character.saveData.人物关系.<姓名>（最小NpcProfile结构，含"角色基础信息+人物关系+人物好感度"）',
  '- 未经明确要求，避免安排"父母双亡/天降奇遇强行收养"等过度戏剧化设定',
  '',
  '【叙事视角与用户名称规则】',
  '- **叙事视角强制要求**：故事必须以第一人称视角进行，用第一人称代词"我"作为{{user}}的代称，角色使用第三人称代称',
  '- **示例**："我看到师父走了过来"而不是"李逍遥看到师父走了过来"或"你看到师父走了过来"',
  '- **重要提醒**：在生成角色关系和描述时，必须使用输入数据中提供的具体用户名字，绝对禁止使用"玩家"这个通用称呼',
  '- 所有角色关系描述（"人物关系"字段）都应该明确使用用户的真实名字',
  '- 例如：如果用户名是"李逍遥"，则应写"与李逍遥相依为命的姐姐"而不是"与玩家相依为命的姐姐"',
  '- 在text叙事中的对话和描述也要使用具体的用户名字，营造个人化的游戏体验',
  '',
  '【角色信息一致性严格要求】',
  '- **性别一致性**：根据输入数据中的用户性别（男/女/双性）来生成合适的角色关系，严禁在故事中改变用户性别',
  '- **名字一致性**：必须始终使用输入数据中确定的用户名字，任何情况下都不得更改或替换',
  '- **属性一致性**：用户的天资、出生背景、灵根类型、天赋等创建时选择的所有属性都不可更改',
  '- 考虑性别在角色关系中的影响，如兄弟姐妹关系、恋爱关系等',
  '- 确保生成的NPC性别和关系符合设定的逻辑性',
  '- **验证机制**：在生成故事前，必须核对用户的基础信息（姓名、性别、属性）与输入数据完全一致',
  '',
  '【初始化任务】为"修仙游戏"生成开场叙事并返回唯一JSON',
].join('\n');

/**
 * 完整的数据结构说明（用于AI参考）
 */
export const COMPLETE_DATA_STRUCTURE = [
  '## 完整数据结构说明',
  '',
  '### 玩家角色状态',
  '```json',
  '{',
  '  "境界": {',
  '    "等级": 0,',
  '    "名称": "境界名称", // 如"凡人"、"炼气"、"筑基"',
  '    "当前进度": 0, // 当前修为值',
  '    "下一级所需": 0,',
  '    "突破描述": "境界描述文本"',
  '    // AI说明: 凡人阶段无"第X层"概念；只有当【下一级所需】>0时才应推进【当前进度】',
  '    // AI修改规则: 仅在剧情有依据时 set 数值；禁止随意拉满或设置默认值',
  '  },',
  '  "声望": 0,',
  '  "位置": {',
  '    "描述": "位置描述",',
  '    "坐标": { "X": 0, "Y": 0 }',
  '  },',
  '  "气血": {',
  '    "当前": 100,',
  '    "最大": 100',
  '    // AI修改规则: 仅在事件明确影响下变更；禁止设置100/80/10等默认值充数',
  '  },',
  '  "灵气": {',
  '    "当前": 0,',
  '    "最大": 50',
  '    // AI修改规则: 仅在事件明确影响下变更；禁止设置默认值充数',
  '  },',
  '  "神识": {',
  '    "当前": 30,',
  '    "最大": 30',
  '    // AI修改规则: 仅在事件明确影响下变更；禁止设置默认值充数',
  '  },',
  '  "寿命": {',
  '    "当前": 16,',
  '    "最大": 80',
  '    // AI说明: 年龄和最大寿命',
  '    // AI修改规则: 年龄随时间推进增长，最大寿命根据境界提升而增加',
  '  },',
  '  "修为": {',
  '    "当前": 0,',
  '    "最大": 10',
  '    // AI修改规则: 仅在修炼、战斗、感悟等事件中增加；禁止设置默认值充数',
  '  },',
  '  "状态效果": [',
  '    {',
  '      "状态名称": "状态名",',
  '      "类型": "buff",',
  '      "时间": "持续时间",',
  '      "状态描述": "效果描述",',
  '      "强度": 5,',
  '      "来源": "来源说明",',
  '      "剩余时间": "3天", // 与时间字段保持一致',
  '      // AI说明: 状态效果必须包含完整描述与明确的持续时间（分钟/小时/天/永久）',
  '      // AI修改规则: 使用 push 追加新状态；到期后可 delete 或更新剩余时间',
  '    }',
  '  ]',
  '}',
  '```',
  '',
  '### 装备栏',
  '```json',
  '{',
  '  "装备1": null, // 初始无装备',
  '  "装备2": null,',
  '  "装备3": null,',
  '  "装备4": null,',
  '  "装备5": null,',
  '  "装备6": null',
  '  // AI修改规则: 使用 set 写入完整物品对象或null；装备的物品必须是装备类型',
  '}',
  '```',
  '',
  '### 三千大道系统',
  '```json',
  '{',
  '  "已解锁大道": ["大道名称"],',
  '  "大道进度": {',
  '    "大道名称": {',
  '      "道名": "具体名称",',
  '      "当前阶段": 0,',
  '      "当前经验": 0,',
  '      "总经验": 0,',
  '      "是否解锁": true',
  '      // AI说明: 大道进度为数值驱动；仅基于剧情/系统规则增加经验与阶段',
  '      // AI修改规则: 禁止擅自越级；经验值只能递增，不能减少',
  '    }',
  '  },',
  '  "大道路径定义": {}, // 系统自动维护，不要修改',
  '  // AI说明: 大道系统由天赋决定初始解锁，后续通过感悟、机缘等解锁新大道',
  '  // AI修改规则: 新大道需要通过 push 到已解锁大道，同时必须 set 对应的完整大道进度对象',
  '  // ⚠️ 重要：解锁大道时必须同时创建完整的大道进度数据，不允许只添加大道名称而不设置进度',
  '}',
  '```',
  '',
  '### 背包系统',
  '```json',
  '{',
  '  "灵石": {',
  '    "下品": 0,',
  '    "中品": 0,',
  '    "上品": 0,',
  '    "极品": 0',
  '  },',
  '  "物品": {',
  '    "物品ID": {',
  '      "物品ID": "唯一标识",',
  '      "名称": "物品名称",',
  '      "类型": "其他", // 只能是：装备、功法、其他',
  '      "品质": {',
  '        "quality": "凡",',
  '        "grade": 3, // 0-10，品级',
  '      },',
  '      "数量": 1,',
  '      "描述": "物品描述"',
  '      // 更多字段根据类型而定',
  '      // AI说明: 物品类型仅限 装备/功法/其他；功法可含【功法效果+功法技能】，装备可含【装备增幅】',
  '      // AI修改规则: 用 set 写入完整物品对象；禁止写入不完整结构或未知类型',
  '      // 【强制】品质字段必须包含quality和grade，格式：{quality:"凡/黄/玄/地/天/仙/神", grade:0-10}',
  '    }',
  '  }',
  '}',
  '```',
  '',
  '### 人物关系',
  '```json',
  '{',
  '  "NPC名字": {',
  '    "角色基础信息": {',
  '      "名字": "NPC名字",',
  '      "性别": "男/女",',
  '      "年龄": 25,',
  '      "世界": "世界名",',
  '      "天资": "普通",',
  '      "出生": "出身背景",',
  '      "灵根": "灵根类型",',
  '      "天赋": ["天赋列表"],',
  '      "先天六司": {',
  '        "根骨": 8, "灵性": 7, "悟性": 9,',
  '        "气运": 6, "魅力": 8, "心性": 7',
  '        // AI说明: NPC的先天六司可由AI生成；但玩家角色的【角色基础信息.先天六司】严禁修改',
  '        // AI修改规则: 生成NPC时根据其身份背景合理设定数值',
  '      }',
  '    },',
  '    "外貌描述": "简单外貌描述",',
  '    "AI行为": {',
  '      "行为模式": "NPC行为特征",',
  '      "日常路线": []',
  '    },',
  '    "人物关系": "与玩家的关系描述",',
  '    "人物好感度": 50,',
  '    "人物记忆": ["记忆条目"],',
  '    "最后互动时间": null',
  '    // AI说明: NPC记忆格式与玩家记忆格式保持一致',
  '    // AI修改规则: 每次互动后 push 新记忆条目',
  '  },',
  '  "背包": { // 商人NPC需要',
  '    "物品": {}',
  '  }',
  '}',
  '```',
  '',
  '### 宗门系统',
  '```json',
  '{',
  '  "availableSects": [],',
  '  "sectRelationships": {},',
  '  "sectHistory": []',
  '  // AI修改规则: 加入宗门时更新相关字段；宗门任务和贡献影响关系值',
  '}',
  '```',
  '',
  '### 记忆系统',
  '```json',
  '{',
  '  "短期记忆": ["最近事件"],',
  '  "中期记忆": ["重要事件总结"],',
  '  "长期记忆": ["核心记忆"]',
  '  // ⚠️ 重要：记忆系统由前端自动管理',
  '  // AI重要提示: 禁止在tavern_commands中操作任何记忆相关字段',
  '}',
  '```',
  '',
  '### 游戏时间',
  '```json',
  '{',
  '  "年": 1000,',
  '  "月": 1,',
  '  "日": 1,',
  '  "小时": 0,',
  '  "分钟": 0',
  '  // AI说明: 游戏时间仅在闭关/修炼/探险等明确消耗的行为中推进',
  '}',
  '```',
  '',
  '### 修炼功法',
  '```json',
  '{',
  '  "功法": null, // 初始无功法',
  '  "熟练度": 0,',
  '  "已解锁技能": [],',
  '  "修炼时间": 0,',
  '  "突破次数": 0',
  '  // AI说明: 修炼功法中的【功法】为完整功法对象（参考物品功法结构）',
  '}',
  '```',
  '',
  '### 角色基础信息',
  '```json',
  '{',
  '  "名字": "用户名字",',
  '  "性别": "男/女",',
  '  "年龄": 16,',
  '  "世界": "世界名称",',
  '  "天资": "天资等级",',
  '  "出生": "出身背景",',
  '  "灵根": "灵根类型",',
  '  "天赋": ["天赋列表"],',
  '  "先天六司": {',
  '    "根骨": 10, "灵性": 8, "悟性": 9,',
  '    "气运": 7, "魅力": 6, "心性": 8',
  '    // AI重要警告: 玩家角色的【先天六司】严禁修改，这是角色创建时确定的固定属性',
  '  }',
  '  // AI说明: 出生/灵根仅在玩家选择"随机"时可具体化',
  '}',
  '```',
  '',
  '世界信息: {}, // 系统维护，不要修改',
  '// AI总体说明: 这是完整的酒馆数据结构，包含所有游戏状态信息',
].join('\n');

/**
 * Tavern Commands 使用说明
 */
export const TAVERN_COMMANDS_GUIDE = [
  '## Tavern Commands 使用指南',
  '',
  '### 基本格式',
  '```json',
  '{',
  '  "tavern_commands": [',
  '    {',
  '      "action": "set",',
  '      "scope": "chat",',
  '      "key": "character.saveData.字段路径",',
  '      "value": "具体值"',
  '      // set指令：设置具体值',
  '    },',
  '    {',
  '      "action": "add",',
  '      "scope": "chat",',
  '      "key": "character.saveData.数值字段",',
  '      "value": 10',
  '      // add指令：数值增减',
  '    }',
  '  ]',
  '}',
  '```',
  '',
  '### 重要规则',
  '- 所有路径必须以 character.saveData. 开头',
  '- 使用 set 设置完整对象或具体值',
  '- 使用 add 进行数值增减',
  '- 使用 push 添加数组元素',
  '- 使用 delete 删除字段',
  '- 禁止在tavern_commands中操作任何记忆相关字段',
  '- 记忆系统完全由前端管理',
  '- 系统会自动从 text 内容中提取生成记忆',
  '- 只专注于状态、物品、位置、NPC关系的变更',
].join('\n');