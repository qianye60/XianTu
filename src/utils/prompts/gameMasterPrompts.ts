import { generateSystemPrompt } from './systemPrompts';

// 初始化提示词（严格：返回唯一 JSON，text + mid_term_memory + tavern_commands 对象）
export const INITIAL_MESSAGE_PROMPT = [
  '【背景与家庭约束】',
  '- 非玩家明确选择“孤儿出身”时，默认应当拥有家庭或亲属（父母/监护人/兄弟姐妹/家族）。',
  '- 禁止无依据安排“云游道人/路过高人收养”等桥段；如确需设置，必须由输入上下文明确提出。',
  '- 当出身为家族/世家/平民/商贾/猎户/书香门第/官宦/农家/手艺人等时：',
  '  1) 在 text 中补充至少1位亲属的具体信息（称谓、性格或特征、相处关系片段）；',
  '  2) 在 tavern_commands.set 中写入 character.saveData.人物关系.<姓名>（最小NpcProfile结构，含“角色基础信息+人物关系+人物好感度”）。',
  '- 未经明确要求，避免安排“父母双亡/天降奇遇强行收养”等过度戏剧化设定。',
  '【初始化任务】为"修仙游戏"生成开场叙事并返回唯一 JSON。',
  '',
  '## 完整数据结构参考（character.saveData 的完整结构，包含AI提示和修改规则）:',
  '```javascript',
  'character.saveData = {',
  '  玩家角色状态: {',
  '    境界: {',
  '      等级: 0, // 0-8，对应凡人到渡劫',
  '      名称: "境界名称", // 如"凡人"、"炼气"、"筑基"等',
  '      当前进度: 0, // 当前修为值',
  '      下一级所需: 100, // 突破所需修为',
  '      突破描述: "突破条件的描述文字",',
  '      // AI说明: 凡人阶段无"第X层"概念；只有当【下一级所需】>0时才应推进【当前进度】',
  '      // AI修改规则: 仅在剧情有依据时 set 数值；禁止随意拉满或设置默认值',
  '    },',
  '    声望: 0, // 初始声望值，一般0-100',
  '    位置: {',
  '      描述: "当前所在地点名称",',
  '      坐标: { X: 100, Y: 200 } // 根据世界地图坐标',
  '    },',
  '    气血: { ',
  '      当前: 100, ',
  '      最大: 100,',
  '      // AI说明: 根据境界计算，max可为0（未知）。当max=0时必须保持current=0；不得出现current>max',
  '      // AI修改规则: 仅在事件明确影响下变更；禁止设置100/80/10等默认值充数',
  '    },',
  '    灵气: { ',
  '      当前: 0, ',
  '      最大: 100,',
  '      // AI说明: 根据境界计算，max可为0（未知）。当max=0时必须保持current=0；不得出现current>max',
  '      // AI修改规则: 仅在事件明确影响下变更；禁止设置默认值充数',
  '    },',
  '    神识: { ',
  '      当前: 10, ',
  '      最大: 10,',
  '      // AI说明: 根据境界计算，max可为0（未知）。当max=0时必须保持current=0；不得出现current>max',
  '      // AI修改规则: 仅在事件明确影响下变更；禁止设置默认值充数',
  '    },',
  '    寿命: { ',
  '      当前: 18, ',
  '      最大: 80,',
  '      // AI说明: 年龄和最大寿命',
  '      // AI修改规则: 年龄随时间推进增长，最大寿命根据境界提升而增加',
  '    },',
  '    修为: { ',
  '      当前: 0, ',
  '      最大: 100,',
  '      // AI说明: 修为经验值，max可为0（未知）。当max=0时必须保持current=0；不得出现current>max',
  '      // AI修改规则: 仅在修炼、战斗、感悟等事件中增加；禁止设置默认值充数',
  '    },',
  '    状态效果: [',
  '      {',
  '        状态名称: "状态的名称，如初窥门径、灵气涌动等",',
  '        类型: "buff", // 必须是 "buff" 或 "debuff"（小写）',
  '        时间: "3天", // 必须给出具体时间：如"30分钟"、"1小时"、"3天"、"永久"',
  '        状态描述: "详细描述状态效果，必须50字以上，包含效果来源、具体影响（带数值）、持续时间等信息",',
  '        强度: 3, // 1-10的数值，表示效果强度',
  '        来源: "产生状态的原因，如引气入体、服用丹药等",',
  '        剩余时间: "3天", // 与时间字段保持一致',
  '        // AI说明: 状态效果必须包含完整描述与明确的持续时间（分钟/小时/天/永久）',
  '        // AI修改规则: 使用 push 追加新状态；到期后可 delete 或更新剩余时间',
  '      }',
  '    ],',
  '  },',
  '  装备栏: {',
  '    法宝1: null, // 初始无装备',
  '    法宝2: null,',
  '    法宝3: null,',
  '    法宝4: null,',
  '    法宝5: null,',
  '    法宝6: null,',
  '    // AI说明: 装备栏槽位仅接受完整物品对象或 null；严禁写入字符串"null"',
  '    // AI修改规则: 使用 set 写入完整物品对象或 null；装备的物品必须是法宝类型',
  '  },',
  '  三千大道: {',
  '    已解锁大道: ["根据天赋解锁的大道名称"],',
  '    大道进度: {',
  '      "大道名称": {',
  '        道名: "大道名称",',
  '        当前阶段: 0,',
  '        当前经验: 0,',
  '        总经验: 0,',
  '        是否解锁: true,',
  '        // AI说明: 大道进度为数值驱动；仅基于剧情/系统规则增加经验与阶段',
  '        // AI修改规则: 禁止擅自越级；经验值只能递增，不能减少',
  '      }',
  '    },',
  '    大道路径定义: {}, // 系统自动维护，不要修改',
  '    // AI说明: 大道系统由天赋决定初始解锁，后续通过感悟、机缘等解锁新大道',
  '    // AI修改规则: 新大道需要通过 push 到已解锁大道，同时 set 对应的大道进度对象',
  '  },',
  '  背包: {',
  '    灵石: {',
  '      下品: 10, // 初始灵石数量',
  '      中品: 0,',
  '      上品: 0,',
  '      极品: 0,',
  '      // AI说明: 灵石是修仙世界的通用货币，1上品=100中品=10000下品',
  '      // AI修改规则: 使用 add 增减数量；交易时需确保数量充足',
  '    },',
  '    物品: {',
  '      "物品ID（如引气丹）": {',
  '        物品ID: "物品的唯一标识",',
  '        名称: "物品名称",',
  '        类型: "其他", // 只能是：法宝、功法、其他',
  '        品质: { ',
  '          quality: "凡", // 凡、黄、玄、地、天、仙、神',
  '          grade: 3, // 0-10，品级',
  '          // AI说明: 品质决定物品价值和效果强度',
  '        },',
  '        数量: 3,',
  '        描述: "物品的详细描述文字",',
  '        使用效果: "使用后的效果描述（可选）",',
  '        // AI说明: 物品类型仅限 法宝/功法/其他；功法可含【功法效果/功法技能】，法宝可含【装备增幅】',
  '        // AI修改规则: 仅 set 写入完整物品对象；禁止写入不完整结构或未知类型',
  '      }',
  '    }',
  '  },',
  '  人物关系: {',
  '    "NPC名字": {',
  '      角色基础信息: {',
  '        名字: "NPC的名字",',
  '        性别: "男或女",',
  '        年龄: 45, // NPC年龄',
  '        世界: "世界名称",',
  '        天资: "天资等级",',
  '        出生: "出生地",',
  '        灵根: "灵根类型或无",',
  '        天赋: [], // 天赋列表',
  '        先天六司: { ',
  '          根骨: 5, // 0-10',
  '          灵性: 5, // 0-10',
  '          悟性: 5, // 0-10',
  '          气运: 5, // 0-10',
  '          魅力: 5, // 0-10',
  '          心性: 5,  // 0-10',
  '          // AI说明: NPC的先天六司可由AI生成；但玩家角色的【角色基础信息.先天六司】严禁修改',
  '          // AI修改规则: 生成NPC时根据其身份背景合理设定数值',
  '        }',
  '      },',
  '      外貌描述: "10-20字的外貌特征描述",',
  '      AI行为: {',
  '        行为模式: "行为模式类型",',
  '        日常路线: []',
  '      },',
  '      人物关系: "与玩家的关系描述",',
  '      人物好感度: 0, // -100到100',
  '      人物记忆: [',
  '        "[甲子年冬月初一][地点]事件描述",',
  '        // AI说明: NPC记忆格式与玩家记忆格式保持一致',
  '        // AI修改规则: 每次互动后 push 新记忆条目',
  '      ],',
  '      最后互动时间: "2024-01-01T08:00:00Z",',
  '      背包: { // 商人NPC需要',
  '        物品: {',
  '          "物品ID": {',
  '            物品ID: "物品ID",',
  '            名称: "物品名称",',
  '            类型: "其他",',
  '            品质: { quality: "凡", grade: 3 },',
  '            数量: 20,',
  '            描述: "物品描述",',
  '            // AI说明: 商人NPC的背包物品可用于交易',
  '            // AI修改规则: 交易时使用 add 修改数量或 delete 移除物品',
  '          }',
  '        }',
  '      }',
  '    }',
  '  },',
  '  宗门系统: {',
  '    availableSects: [],',
  '    sectRelationships: {},',
  '    sectHistory: [],',
  '    // AI说明: 宗门系统记录玩家与各宗门的关系和历史',
  '    // AI修改规则: 加入宗门时更新相关字段；宗门任务和贡献影响关系值',
  '  },',
  '  记忆: {',
  '    短期记忆: [',
  '      "[时辰][地点]事件描述",',
  '      // AI说明: 记忆由系统自动管理；AI 禁止直接写入/修改任何 记忆.* 字段',
  '      // AI修改规则: 系统会自动从 text 内容中提取生成记忆，AI不要操作',
  '    ],',
  '    中期记忆: [',
  '      "[日期]重要事件总结",',
  '      // AI说明: 中期记忆保存重要事件的总结',
  '      // AI修改规则: 系统自动管理，AI禁止操作',
  '    ],',
  '    长期记忆: [],',
  '    // AI重要提示: 禁止在 tavern_commands 中操作任何记忆相关字段',
  '  },',
  '  游戏时间: {',
  '    年: 1,',
  '    月: 1,',
  '    日: 1,',
  '    小时: 8,',
  '    分钟: 0,',
  '    // AI说明: 游戏时间仅在闭关/修炼/探险等明确消耗的行为中推进',
  '    // AI修改规则: 使用 add 推进时间；注意月份12进位，日期30进位',
  '  },',
  '  修炼功法: {',
  '    功法: null, // 初始无功法',
  '    熟练度: 0,',
  '    已解锁技能: [],',
  '    修炼时间: 0,',
  '    突破次数: 0,',
  '    // AI说明: 修炼功法中的【功法】为完整功法对象（参考物品-功法结构）',
  '    // AI修改规则: 熟练度/修炼时间/突破次数按事件推进；技能解锁需要达到熟练度要求',
  '  },',
  '  角色基础信息: {',
  '    名字: "玩家角色名字",',
  '    性别: "性别",',
  '    年龄: 18, // 根据设定生成',
  '    世界: "世界名称",',
  '    天资: "天资等级",',
  '    出生: "出生背景",',
  '    灵根: "灵根类型",',
  '    天赋: ["天赋1", "天赋2"],',
  '    先天六司: {',
  '      根骨: 5, // 0-10',
  '      灵性: 5, // 0-10',
  '      悟性: 5, // 0-10',
  '      气运: 5, // 0-10',
  '      魅力: 5, // 0-10',
  '      心性: 5,  // 0-10',
  '      // AI重要警告: 玩家角色的【先天六司】严禁修改，这是角色创建时确定的固定属性',
  '      // AI修改规则: 绝对禁止对玩家的先天六司进行任何 set/add/push/pull 操作',
  '    },',
  '    // AI说明: 出生/灵根仅在玩家选择"随机"时可具体化',
  '  },',
  '  世界信息: {}, // 系统维护，不要修改',
  '  // AI总体说明: 这是完整的酒馆数据结构，包含所有游戏状态信息',
  '  // AI使用指南: 通过 tavern_commands 的 set/add/push/pull/delete 操作修改数据',
  '}',
  '```',
  '',
  '## 必须返回的JSON格式:',
  '```json',
  '{',
  '  "text": "叙事文本内容，必须≥1000字，包含详细的环境描写、内心感受、动作细节、对话内容等具体场景。格式化要求：环境描写用【】，心理描写用``，对话用\"\"",',
  '  "mid_term_memory": "对初始场景的总结，50-100字",',
  '  "tavern_commands": {',
  '    "set": {',
  '      // set指令：设置具体值',
  '    },',
  '    "add": {',
  '      // add指令：数值增减',
  '    },',
  '    "push": [',
  '      // push指令：向数组添加元素（禁止操作记忆相关字段）',
  '    ],',
  '    "pull": [],',
  '    "delete": []',
  '  }',
  '}',
  '```',
  '',
  '## 重要的记忆规则:',
  '- 禁止在 tavern_commands 中操作任何记忆相关字段',
  '- 禁止 push 到 记忆.短期记忆、记忆.中期记忆、记忆.长期记忆',
  '- 系统会自动从 text 内容中提取生成记忆',
  '- 只专注于状态、物品、位置、NPC关系的变更',
  '',
  '## 重要的指令示例:',
  '',
  '### 添加状态效果（push到数组）:',
  '```json',
  '{',
  '  "push": [',
  '    {',
  '      "key": "character.saveData.玩家角色状态.状态效果",',
  '      "value": {',
  '        "状态名称": "初窥门径",',
  '        "类型": "buff",',
  '        "时间": "7天",',
  '        "状态描述": "刚刚踏入修行之路，灵台初开，对天地灵气的感知力提升20%，修炼速度增加15%，但经脉尚未完全打通，容易走火入魔",',
  '        "强度": 3,',
  '        "来源": "初次引气入体",',
  '        "剩余时间": "7天"',
  '      }',
  '    }',
  '  ]',
  '}',
  '```',
  '',
  '### 设置位置:',
  '```json',
  '{',
  '  "set": {',
  '    "character.saveData.玩家角色状态.位置.描述": "青云山下小村",',
  '    "character.saveData.玩家角色状态.位置.坐标": { "X": 120, "Y": 350 }',
  '  }',
  '}',
  '```',
  '',
  '### 添加物品:',
  '```json',
  '{',
  '  "set": {',
  '    "character.saveData.背包.物品.引气丹": {',
  '      "物品ID": "引气丹",',
  '      "名称": "引气丹",',
  '      "类型": "其他",',
  '      "品质": { "quality": "凡", "grade": 3 },',
  '      "数量": 3,',
  '      "描述": "最基础的修炼丹药，可以帮助初学者引气入体"',
  '    }',
  '  }',
  '}',
  '```',
  '',
  '### 添加NPC:',
  '```json',
  '{',
  '  "set": {',
  '    "character.saveData.人物关系.村长": {',
  '      "角色基础信息": {',
  '        "名字": "村长",',
  '        "性别": "男",',
  '        "年龄": 60,',
  '        "先天六司": { "根骨": 3, "灵性": 2, "悟性": 5, "气运": 4, "魅力": 6, "心性": 7 }',
  '      },',
  '      "外貌描述": "白发苍苍的老者",',
  '      "人物关系": "村庄长老",',
  '      "人物好感度": 30,',
  '      "人物记忆": ["[初春][村中]赠送引气丹"],',
  '      "最后互动时间": "2024-01-01T08:00:00Z"',
  '    }',
  '  }',
  '}',
  '```',
  '',
  '## 核心规则:',
  '1. 所有路径必须以 character.saveData. 开头',
  '2. 状态效果必须包含完整的描述（50字以上）和具体时间，禁止"未指定"',
  '3. 物品类型只能是：法宝、功法、其他；其中【装备/可穿戴或可持用（武器、衣物、鞋帽、饰品、腰带、工具如旧锄头、木棍等）一律标注 类型: 法宝】；书籍/口诀/心法/秘籍等归为“功法”；消耗品/材料/杂物归为“其他”；严禁把衣物、锄头等装备标成“其他”',
  '4. 所有生成的内容必须在text叙事中有对应描述',
  '5. 记忆格式：短期"[时辰][地点]事件"，中期"[日期]总结"',
  '6. 严禁修改角色先天属性：禁止对 "角色基础信息.先天六司.*" 进行任何 set/add/push/pull 操作',
  '7. 严禁为数值字段填充任意默认值；若未知或无数据，请返回0或不设置对应字段（不要擅自设置100、80等默认值）',
  '',
  '## 输入数据（系统会替换此处）:',
  'INPUT_PLACEHOLDER',
  '',
  generateSystemPrompt({
    includeRealmSystem: true,
    includeItemQuality: true,
    includeStatusEffect: true,
    includeNPCSystem: true,
    includeDataStructure: true
  })
].join('\n');
