/**
 * @fileoverview Game Master 提示词模块
 * 包含角色初始化和游戏进行中的各种AI提示词
 */

import {
  COMMON_CORE_RULES,
  COMMON_TEXT_REQUIREMENTS,
  COMMON_FORMAT_MARKERS,
  COMMON_NPC_RULES,
  COMMON_ITEM_RULES,
  COMMON_DAO_RULES,
  COMMON_CHARACTER_PROTECTION,
  COMMON_MEMORY_RULES,
  CHARACTER_INITIALIZATION_RULES
} from './commonPromptRules';

/**
 * 构建动态的角色初始化提示词
 * @param userSelections 用户选择的角色信息
 * @returns 完整的初始化提示词
 */
export function buildInitialMessagePrompt(userSelections: {
  name: string;
  gender: string;
  world: string;
  talentTier: string;
  origin: string;
  spiritRoot: string;
  talents: string[];
  attributes: {
    根骨: number;
    灵性: number;
    悟性: number;
    气运: number;
    魅力: number;
    心性: number;
  };
}): string {
  return [
    '【角色初始化完成 - 开始修仙之旅】',
    '',
    '## ⚠️ 用户已确定的角色信息（严禁修改）',
    `- **姓名**: ${userSelections.name}`,
    `- **性别**: ${userSelections.gender}`,
    `- **世界**: ${userSelections.world}`,
    `- **天资**: ${userSelections.talentTier}`,
    `- **出身**: ${userSelections.origin}`,
    `- **灵根**: ${userSelections.spiritRoot}`,
    `- **天赋**: ${userSelections.talents.join('、')}`,
    `- **先天六司**: 根骨${userSelections.attributes.根骨} 灵性${userSelections.attributes.灵性} 悟性${userSelections.attributes.悟性} 气运${userSelections.attributes.气运} 魅力${userSelections.attributes.魅力} 心性${userSelections.attributes.心性}`,
    '',
    DYNAMIC_GAME_DATA_PROMPT,
    '',
    COMMON_CHARACTER_PROTECTION,
    '',
    '## 🌟 初始化任务',
    '请根据用户已选择的角色设定，生成修仙世界的开场故事：',
    '',
    '⚠️ **文本要求：生成丰富详细的叙述内容，字数不少于800字**',
    '',
    '1. **详细环境描述**（至少200字）：',
    '   - 详细描述角色所在的初始环境和位置',
    '   - ⚠️ **重要：必须生成具体的地名和位置**，严禁使用"初始地"等占位符',
    '   - 根据出身背景创造合适的富有特色的地名，体现地方特色',
    '   - ⚠️ **位置设置规则**：位置.描述字段应为简短地名（如"青石镇"），详细环境描述写在text中',
    '   - 位置必须包含完整的描述和坐标信息',
    '   - 位置生成格式：必须严格按照"大洲名·后缀"格式，如"中土大陆·青石镇"、"东海群岛·天剑宗·剑峰"，不要只给城镇名',
    '   - 描绘周围的景色、建筑、气氛等感官细节',
    '   - 结合出身背景创造合适的开场场景',
    '   - 描述当前的时间、天气、季节等背景要素',
    '',
    '2. **角色状态初始化**（至少150字）：',
    '   - 设置符合凡人境界的基础属性（气血、灵气、神识、寿命）',
    `   - 根据已选择的天赋"${userSelections.talents.join('、')}"解锁相应的大道或能力`,
    '   - **初始化物品装备**：根据角色背景随机生成合适的起始物品',
    '   - ⚠️ **物品生成要求**：',
    '   - 数量必须随机：每次生成1-6个不等的物品，禁止固定生成4个',
    '   - 内容必须多样：根据出身、家境、地域生成不同类型物品',
    '   - 严禁固定模板：禁止总是生成"干粮、布衣、木剑、铜钱"等固定组合',
    '   - 创造性命名：每个物品都要有独特的名称和描述',
    '   - 详细描述角色的身体感受和内在变化',
    '   - 解释天赋觉醒的过程和感受',
    '',
    '3. **人脉关系生成**（至少200字）：',
    '   - 根据出身背景创造合理的家庭关系或师门关系',
    '   - 生成2-3个重要的NPC角色，每个角色都要有详细的外貌、性格描述',
    '   - ⚠️ **重要：NPC必须有完整的基础信息**',
    '   - NPC的性别、年龄必须明确指定，不能为"未知"',
    '   - NPC的灵根、天资必须有具体设定',
    '   - 建立初始的人际关系网络',
    '   - 描述与这些重要人物的互动场景和对话',
    '   - 展现这些关系对角色未来发展的影响',
    '   - **指令要求**：为每个在故事中创建的NPC，生成一条对应的 `tavern_commands` `set` 指令，用于创建 `character.saveData.人物关系`。',
    '',
    '4. **大道系统初始化**（至少100字）：',
    `   - 根据已选择的天赋"${userSelections.talents.join('、')}"自然解锁对应大道`,
    '   - ⚠️ 重要：解锁的大道必须与天赋设定相符，且必须同时设置完整的大道进度数据',
    '   - 详细描述大道觉醒时的玄妙感受和异象',
    '',
    '5. **剧情铺垫和引子**（至少150字）：',
    '   - 设置一个吸引人的开场事件或机缘',
    '   - 暗示未来可能的发展方向和挑战',
    '   - 营造修仙世界的神秘氛围',
    '   - 给出角色当前可以选择的行动方向',
    '',
    CHARACTER_INITIALIZATION_RULES,
    '',
    '## 🚨 严格响应格式要求',
    COMMON_CORE_RULES,
    '',
    COMMON_TEXT_REQUIREMENTS,
    '',
    COMMON_FORMAT_MARKERS,
    '',
    COMMON_MEMORY_RULES,
    '',
    COMMON_ITEM_RULES,
    '',
    COMMON_NPC_RULES,
    '',
    COMMON_DAO_RULES,
    '',
    '## 📋 必须返回的JSON格式',
    '```json',
    '{',
    '  "text": "【第一人称叙述的开场故事，必须包含：详细环境描述200字+角色状态感受150字+人物关系互动200字+大道觉醒100字+剧情铺垫150字，总计不少于800字】",',
    '  "mid_term_memory": "【关键记忆点：包含重要的人物、地点、事件信息，50-100字】",',
    '  "tavern_commands": [',
    '    {',
    '      "action": "set",',
    '      "scope": "chat",',
    '      "key": "character.saveData.玩家角色状态.位置",',
    '      "value": { "描述": "【简短地名，如：青石镇】", "坐标": { "X": 1500, "Y": 1050 } }',
    '    },',
    '    {',
    '      "action": "set",',
    '      "scope": "chat",',
    '      "key": "character.saveData.人物关系.【NPC姓名或称谓】",',
    '      "value": {',
    '        "角色基础信息": { "名字": "【NPC姓名】", "性别": "男", "年龄": 45, "世界": "【世界名】", "天资": "中人之姿", "出生": "官宦世家", "灵根": "无", "天赋": [], "先天六司": {"根骨":5,"灵性":6,"悟性":7,"气运":8,"魅力":7,"心性":8} },',
    '        "外貌描述": "【根据故事生成的描述】",',
    '        "角色存档信息": {',
    '          "时间": "【当前游戏时间】",',
    '          "装备": {},',
    '          "功法": { "主修功法": null, "已学技能": [] },',
    '          "状态": [],',
    '          "境界": 0,',
    '          "声望": 0,',
    '          "位置": { "描述": "【初始位置】", "坐标": { "X": 0, "Y": 0 } },',
    '          "当前气血": 100, "最大气血": 100,',
    '          "当前灵气": 50, "最大灵气": 50,',
    '          "当前神识": 30, "最大神识": 30,',
    '          "当前寿命": 20, "最大寿命": 100',
    '        },',
    '        "NPC行为": { "行为模式": "日常生活", "日常路线": [] },',
    '        "人物关系": "【与主角的关系，如：父亲】",',
    '        "人物好感度": 70,',
    '        "人物记忆": [{"时间": "【游戏内时间描述】", "事件": "【初次见面的核心记忆】", "指令数据": []}],',
    '        "背包": {',
    '          "灵石": { "下品": 0, "中品": 0, "上品": 0, "极品": 0 },',
    '          "物品": {}',
    '        },',
    '        "特殊标记": []',
    '      }',
    '    }',
    '  ]',
    '}',
    '```',
    '',
    '## 📊 输入数据',
    '```json',
    'INPUT_PLACEHOLDER',
    '```',
    '',
    '请基于以上用户选择和规则，生成精彩的修仙世界开局！',
    '  // 数值基线：character_creation.derived_stats 为前端预计算的初始化基线（不含"修为"），AI需参考并据此落库；后续变化用 tavern_commands 正常改动',
    '  // 计算/推导过程不要写入存档（character.saveData）；如需说明请写在text，存档只保存最终数值',
    '',
  ].join('\n');
}

/**
 * 静态的初始消息提示词（备用）
 * @deprecated 推荐使用 buildInitialMessagePrompt 函数
 */
export const INITIAL_MESSAGE_PROMPT = [
  '【背景与家庭约束】',
  '- 非玩家明确选择"孤儿出身"时，默认应当拥有家庭或亲属（父母/监护人、兄弟姐妹/家族）',
  '- 禁止无依据安排"云游道人/路过高人收养"等桥段；如确需设置，必须由输入上下文明确提出',
  '- 如果设置家庭关系，需要：',
  '  1) 在text中补充至少1位亲属的具体信息（称谓、性格或特征、相处关系片段）',
  '  2) 在tavern_commands.set中写入character.saveData.人物关系.<姓名>（最小NpcProfile结构，含"角色基础信息+人物关系+人物好感度"）',
  '- 未经明确要求，避免安排"父母双亡/天降奇遇强行收养"等过度戏剧化设定',
  '',
  COMMON_CHARACTER_PROTECTION,
  '',
  '【初始化任务】为"修仙游戏"生成开场叙事并返回唯一JSON',
].join('\n');

/**
 * 完整的数据结构说明（用于AI参考）
 */
export const COMPLETE_DATA_STRUCTURE = [
  '## 完整数据结构说明',
  '',
  '### 玩家角色状态',
  '```json',
  '{',
  '  "境界": {',
  '    "等级": 0,',
  '    "名称": "境界名称", // 如"凡人"、"炼气"、"筑基"',
  '    "当前进度": 0, // 当前修为值',
  '    "下一级所需": 0,',
  '    "突破描述": "境界描述文本"',
  '    // AI说明: 凡人阶段无"第X层"概念；只有当【下一级所需】>0时才应推进【当前进度】',
  '    // AI修改规则: 仅在剧情有依据时 set 数值；禁止随意拉满或设置默认值',
  '  },',
  '  "声望": 0,',
  '  "位置": {',
  '    "描述": "位置描述",',
  '    "坐标": { "X": 0, "Y": 0 }',
  '  },',
  '  "气血": {',
  '    "当前": 100,',
  '    "最大": 100',
  '    // AI修改规则: 仅在事件明确影响下变更；禁止设置100/80/10等默认值充数',
  '  },',
  '  "灵气": {',
  '    "当前": 0,',
  '    "最大": 50',
  '    // AI修改规则: 仅在事件明确影响下变更；禁止设置默认值充数',
  '  },',
  '  "神识": {',
  '    "当前": 30,',
  '    "最大": 30',
  '    // AI修改规则: 仅在事件明确影响下变更；禁止设置默认值充数',
  '  },',
  '  "寿命": {',
  '    "当前": 16,',
  '    "最大": 80',
  '    // AI说明: 年龄和最大寿命',
  '    // AI修改规则: 年龄随时间推进增长，最大寿命根据境界提升而增加',
  '  },',
  '  "修为": {',
  '    "当前": 0,',
  '    "最大": 10',
  '    // AI修改规则: 仅在修炼、战斗、感悟等事件中增加；禁止设置默认值充数',
  '  },',
  '  "状态效果": [',
  '    {',
  '      "状态名称": "状态名",',
  '      "类型": "buff",',
  '      "时间": "持续时间",',
  '      "状态描述": "效果描述",',
  '      "强度": 5,',
  '      "来源": "来源说明",',
  '      "剩余时间": "3天", // 与时间字段保持一致',
  '      // AI说明: 状态效果必须包含完整描述与明确的持续时间（分钟/小时/天/永久）',
  '      // AI修改规则: 使用 push 追加新状态；到期后可 delete 或更新剩余时间',
  '    }',
  '  ]',
  '}',
  '```',
  '',
  '### 装备栏',
  '```json',
  '{',
  '  "装备1": null, // 初始无装备',
  '  "装备2": null,',
  '  "装备3": null,',
  '  "装备4": null,',
  '  "装备5": null,',
  '  "装备6": null',
  '  // AI修改规则: 使用 set 写入完整物品对象或null；装备的物品必须是装备类型',
  '}',
  '```',
  '',
  '### 三千大道系统',
  '```json',
  '{',
  '  "已解锁大道": ["大道名称"],',
  '  "大道进度": {',
  '    "大道名称": {',
  '      "道名": "具体名称",',
  '      "当前阶段": 0,',
  '      "当前经验": 0,',
  '      "总经验": 0,',
  '      "是否解锁": true',
  '      // AI说明: 大道进度为数值驱动；仅基于剧情/系统规则增加经验与阶段',
  '      // AI修改规则: 禁止擅自越级；经验值只能递增，不能减少',
  '    }',
  '  },',
  '  "大道路径定义": {}, // 系统自动维护，不要修改',
  '  // AI说明: 大道系统由天赋决定初始解锁，后续通过感悟、机缘等解锁新大道',
  '  // AI修改规则: 新大道需要通过 push 到已解锁大道，同时必须 set 对应的完整大道进度对象',
  '  // ⚠️ 重要：解锁大道时必须同时创建完整的大道进度数据，不允许只添加大道名称而不设置进度',
  '}',
  '```',
  '',
  '### 背包系统',
  '```json',
  '{',
  '  "灵石": {',
  '    "下品": 0,',
  '    "中品": 0,',
  '    "上品": 0,',
  '    "极品": 0',
  '  },',
  '  "物品": {',
  '    "物品ID": {',
  '      "物品ID": "唯一标识",',
  '      "物品名称": "物品名称",',
  '      "物品类型": "其他", // 只能是：装备、功法、其他',
  '      "稀有度": "凡品", // 凡品、下品、中品、上品、极品、仙品、神品',
  '      "物品数量": 1,',
  '      "物品描述": "物品描述"',
  '      // 更多字段根据类型而定',
  '      // AI说明: 物品类型仅限 装备/功法/其他；功法可含【功法效果+功法技能】，装备可含【装备增幅】',
  '      // 🚨分类规则：可穿戴/佩戴/持用物品（包括各类饰品、衣物、武器等）必须归类为"装备"',
  '      // AI修改规则: 用 set 写入完整物品对象；禁止写入不完整结构或未知类型',
  '      // 【强制】品质字段必须包含quality和grade，格式：{quality:"凡/黄/玄/地/天/仙/神", grade:0-10}',
  '      // 【重要】物品生成随机性要求：',
  '      //   - 数量：每次生成1-6个物品，绝不固定',
  '      //   - 内容：根据角色背景差异化生成，避免千篇一律',
  '      //   - 名称：每个物品必须有独特创意的名称',
  '      //   - 严禁：总是生成相同的固定物品组合',
  '    }',
  '  }',
  '}',
  '```',
  '',
  '### 人物关系',
  '```json',
  '{',
  '  "NPC名字": {',
  '    "角色基础信息": {',
  '      "名字": "NPC名字",',
  '      "性别": "男/女", // 【必填】具体性别，不能为"未知"',
  '      "年龄": 25,',
  '      "世界": "世界名",',
  '      "天资": "凡夫俗子/中人之姿/天生灵秀/等具体天资名称", // 【必填】具体天资，不能为"未知"或"普通"',
  '      "出生": "世家子弟/平民百姓/山野村夫/等具体出身", // 【必填】具体出身背景，不能为"未知"',
  '      "灵根": {"名称":"具体灵根类型","品质":"凡品/下品/中品/上品/极品/仙品/神品/特殊","描述":"灵根描述"}, // 【必填】灵根对象格式',
  '      "天赋": ["天赋列表"],',
  '      "先天六司": {',
  '        "根骨": 8, "灵性": 7, "悟性": 9,',
  '        "气运": 6, "魅力": 8, "心性": 7',
  '        // AI说明: NPC的先天六司可由AI生成；但玩家角色的【角色基础信息.先天六司】严禁修改',
  '        // AI修改规则: 生成NPC时根据其身份背景合理设定数值',
  '      }',
  '    },',
  '    "外貌描述": "简单外貌描述",',
  '    "NPC行为": {',
  '      "行为模式": "NPC行为特征",',
  '      "日常路线": []',
  '    },',
  '    "人物关系": "与玩家的关系描述",',
  '    "人物好感度": 50,',
  '    "人物记忆": [{"时间": "时间描述", "事件": "事件内容", "指令数据": []}],',
  '    // AI说明: NPC记忆格式为时间·事件·指令数据对象数组',
  '    // AI修改规则: 每次互动后 push 新记忆对象 {时间, 事件, 指令数据}，指令数据为本次操作的tavern_commands',
  '  },',
  '  "背包": { // 【重要】商人类NPC和重要NPC必须有物品',
  '    "物品": {',
  '      "示例物品ID": {',
  '        "物品ID": "示例物品ID",',
  '        "物品名称": "具体物品名称",',
  '        "物品类型": "装备/功法/其他",',
  '        "稀有度": "凡品",',
  '        "物品数量": 1,',
  '        "物品描述": "物品描述"',
  '      }',
  '    }',
  '  }',
  '}',
  '```',
  '',
  '### 宗门系统',
  '```json',
  '{',
  '  "availableSects": [],',
  '  "sectRelationships": {},',
  '  "sectHistory": []',
  '  // AI修改规则: 加入宗门时更新相关字段；宗门任务和贡献影响关系值',
  '}',
  '```',
  '',
  '### 记忆系统',
  '```json',
  '{',
  '  "短期记忆": ["最近事件"],',
  '  "中期记忆": ["重要事件总结"],',
  '  "长期记忆": ["核心记忆"]',
  '  // ⚠️ 重要：记忆系统由前端自动管理',
  '  // AI重要提示: 禁止在tavern_commands中操作任何记忆相关字段',
  '}',
  '```',
  '',
  '### 游戏时间',
  '```json',
  '{',
  '  "年": 1000,',
  '  "月": 1,',
  '  "日": 1,',
  '  "小时": 0,',
  '  "分钟": 0',
  '  // AI说明: 游戏时间仅在闭关/修炼/探险等明确消耗的行为中推进',
  '}',
  '```',
  '',
  '### 修炼功法',
  '```json',
  '{',
  '  "功法": null, // 初始无功法',
  '  "熟练度": 0,',
  '  "已解锁技能": [],',
  '  "修炼时间": 0,',
  '  "突破次数": 0,',
  '  "正在修炼": false, // 是否正在修炼状态',
  '  "修炼进度": 0 // 修炼进度(0-100)',
  '  // AI说明: 修炼功法中的【功法】为完整功法对象（参考物品功法结构）',
  '}',
  '```',
  '',
  '### 角色基础信息',
  '```json',
  '{',
  '  "名字": "用户名字",',
  '  "性别": "男/女", // 【玩家】固定字段，不可修改',
  '  "年龄": 年龄数字,',
  '  "世界": "世界名称",',
  '  "天资": "具体天资名称", // 【玩家】固定字段，不可修改',
  '  "出生": "具体出身背景", // 【玩家】固定字段，不可修改',
  '  "灵根": {',
  '    "名称": "灵根类型（如：火灵根、雷灵根，不含品级前缀）", // 【玩家】固定字段，不可修改',
  '    "品级": "上品/中品/下品/极品/神品/特殊/凡品" // 【玩家】固定字段，不可修改',
  '  },',
  '  "天赋": ["天赋列表"],',
  '  "先天六司": {',
  '    "根骨": 10, "灵性": 8, "悟性": 9,',
  '    "气运": 7, "魅力": 6, "心性": 8',
  '    // AI重要警告: 玩家角色的【先天六司】严禁修改，这是角色创建时确定的固定属性',
  '  }',
  '  // AI说明: 出生/灵根仅在玩家选择"随机"时可具体化',
  '  // AI重要提醒: 随机生成灵根时，"名称"字段不应包含品级前缀（如"火灵根"而非"上品火灵根"），品级信息单独存储在"品级"字段',
  '}',
  '```',
  '',
  '世界信息: {}, // 系统维护，不要修改',
  '// AI总体说明: 这是完整的酒馆数据结构，包含所有游戏状态信息',
].join('\n');

/**
 * Tavern Commands 使用说明
 */
export const TAVERN_COMMANDS_GUIDE = [
  '## Tavern Commands 使用指南',
  '',
  '### 基本格式',
  '```json',
  '{',
  '  "tavern_commands": [',
  '    {',
  '      "action": "set",',
  '      "scope": "chat",',
  '      "key": "character.saveData.字段路径",',
  '      "value": "具体值"',
  '      // set指令：设置具体值',
  '    },',
  '    {',
  '      "action": "add",',
  '      "scope": "chat",',
  '      "key": "character.saveData.数值字段",',
  '      "value": 10',
  '      // add指令：数值增减',
  '    }',
  '  ]',
  '}',
  '```',
  '',
  '### 重要规则',
  '- 所有路径必须以 character.saveData. 开头',
  '- 使用 set 设置完整对象或具体值',
  '- 使用 add 进行数值增减',
  '- 使用 push 添加数组元素',
  '- 使用 delete 删除字段',
  '- 禁止在tavern_commands中操作任何记忆相关字段',
  '- 记忆系统完全由前端管理',
  '- 系统会自动从 text 内容中提取生成记忆',
  '- 只专注于状态、物品、位置、NPC关系的变更',
].join('\n');

/**
 * 简化的游戏数据说明提示词
 * 让AI直接读取酒馆变量而不是依赖固定模板
 */
export const DYNAMIC_GAME_DATA_PROMPT = [
  '## 📊 游戏数据获取说明',
  '',
  '你可以直接访问酒馆聊天变量中的完整游戏数据，包括：',
  '- **character.saveData.角色基础信息**: 角色的基本信息（姓名、性别、世界、天资、出身、灵根、天赋、先天六司等）',
  '- **character.saveData.玩家角色状态**: 角色的当前状态（境界、属性、位置、资源等）',
  '- **character.saveData.世界信息**: 完整的世界背景、势力、地点信息',
  '- **character.saveData.记忆**: 短期、中期、长期记忆和NPC关系',
  '- **其他变量**: 背包、人物关系、三千大道系统等',
  '',
  '## 🚫 重要约束',
  '- **角色基础信息**中的姓名、性别、先天六司等字段严禁修改',
  '- **灵根数据结构**: 灵根为对象格式 {名称: "纯净类型名", 品级: "具体品级", 描述: "描述"}',
  '- **灵根修炼速度**: 完整的灵根对象存储在角色基础信息.灵根详情中，包含base_multiplier等数值',
  '- **随机灵根生成**: 名称不含品级前缀（如"火灵根"而非"上品火灵根"）',
  '',
  '## 🎮 操作指南',
  '使用tavern_commands来修改游戏数据，支持的操作：',
  '- set: 设置变量值',
  '- add: 数值加法',
  '- push: 数组添加',
  '- pull: 数组移除',
  '- delete: 删除变量',
  '',
  '请根据实际的酒馆变量数据来进行游戏叙事和数据操作，而不是依赖固定的数据模板。',
  '当需要获取灵根修炼速度等信息时，请从角色基础信息.灵根详情中获取完整的SpiritRoot对象。',
].join('\n');
