/**
 * 统一提示词模板系统 - 数据结构规范
 * 为AI提供明确的数据格式要求，确保生成的数据符合前端组件预期
 */

// 导入现有规则
import {
  COMMON_CORE_RULES,
  COMMON_NARRATIVE_RULES,
  COMMON_DATA_MANIPULATION_RULES,
  ENHANCED_TIME_MANAGEMENT,
  ENHANCED_DATA_VALIDATION,
  COMMON_NPC_RULES,
  COMMON_ITEM_RULES,
  COMMON_DAO_RULES,
  CHARACTER_INITIALIZATION_RULES
} from './commonPromptRules';

// =================================================================
// # 核心数据结构模板
// =================================================================

export const DATA_STRUCTURE_TEMPLATES = `
# 数据结构模板和规范

## 1. NPC完整数据模板

**每个NPC必须严格按照以下格式创建**：

\`\`\`json
{
  "角色基础信息": {
    "名字": "姓名字符串",
    "性别": "男或女", 
    "年龄": 数字(如25),
    "世界": "世界名称字符串",
    "天资": "天资描述字符串",
    "出生": "出身描述字符串",
    "灵根": {
      "名称": "灵根名称字符串",
      "品级": "凡品或下品或中品或上品或极品或神品或特殊",
      "描述": "灵根详细描述字符串"
    },
    "天赋": ["天赋名称1", "天赋名称2"],
    "先天六司": {
      "根骨": 数字,
      "灵性": 数字,
      "悟性": 数字,
      "气运": 数字,
      "魅力": 数字,
      "心性": 数字
    }
  },
  "外貌描述": "详细外貌描述字符串",
  "角色存档信息": {
    "时间": "时间描述字符串",
    "装备": {},
    "功法": {
      "主修功法": "功法名称字符串或null",
      "已学技能": ["技能1", "技能2"]
    },
    "状态": [],
    "境界": 数字(1代表练气，2代表筑基，3代表金丹，4代表元婴，5代表化神),
    "声望": 数字,
    "最后出现位置": {
      "描述": "层级地理位置，格式为'大陆名·区域名·具体地点'或'大陆名·宗门名'，请根据世界设定生成合适的地名"
    },
    "当前气血": 数字, "最大气血": 数字,
    "当前灵气": 数字, "最大灵气": 数字,
    "当前神识": 数字, "最大神识": 数字,
    "当前寿命": 数字, "最大寿命": 数字
  },
  "NPC行为": {
    "行为模式": "详细性格和行为描述字符串",
    "日常路线": [
      {
        "时间": "时间段字符串",
        "位置": "层级地理位置，格式为'大陆名·区域名·具体地点'，请根据世界设定生成",
        "行为": "行为描述字符串"
      }
    ]
  },
  "人物关系": "关系描述字符串",
  "人物好感度": 数字(0到100),
  "人物记忆": [
    {
      "时间": "记忆时间字符串",
      "事件": "事件描述字符串"
    }
  ],
  "背包": {
    "灵石": {
      "下品": 数字,
      "中品": 数字,
      "上品": 数字,
      "极品": 数字
    },
    "物品": []
  },
  "实时关注": true或false
}
\`\`\`

## 2. 物品数据模板

**每个物品必须按照以下格式**：

\`\`\`json
{
  "物品ID": "唯一标识字符串",
  "名称": "物品名称字符串",
  "类型": "装备或功法或其他",
  "品质": {
    "quality": "凡或黄或玄或地或天或仙或神",
    "grade": 数字(0到10)
  },
  "数量": 数字,
  "已装备": false,
  "描述": "物品描述字符串",
  "可叠加": true或false
}
\`\`\`

## 3. 状态效果模板

**每个状态效果必须包含**：

\`\`\`json
{
  "状态名称": "状态名称字符串",
  "类型": "buff或debuff",
  "时间": "持续时间字符串",
  "状态描述": "效果描述字符串",
  "强度": 数字,
  "来源": "来源描述字符串",
  "剩余时间": "剩余时间字符串"
}
\`\`\`

## 4. 境界数据模板

**玩家境界信息必须包含完整字段(严格按照TypeScript接口)**：

\`\`\`json
{
  "等级": 数字(1=练气，2=筑基，3=金丹，4=元婴，5=化神，6=炼虚，7=合体，8=渡劫),
  "名称": "境界名称字符串(练气|筑基|金丹|元婴|化神|炼虚|合体|渡劫)",
  "当前进度": 数字(当前境界内的修炼进度),
  "下一级所需": 数字(突破到下一境界所需的进度),
  "突破描述": "突破条件和要求的详细描述字符串",
  "子阶段": "初期|中期|后期|圆满|极境",
  "修为倍率": 数字(修炼获得修为的倍率，如1.5表示150%),
  "寿命增加": 数字(该境界提供的额外寿命)
}
\`\`\`

**NPC境界信息是简单数字(按照TypeScript接口)**：

\`\`\`json
{
  "境界": 数字(1=练气，2=筑基，3=金丹，4=元婴，5=化神，6=炼虚，7=合体，8=渡劫)
}
\`\`\`

**修为进度已经整合到境界信息中**：

\`\`\`json
{
  "境界": {
    "等级": 数字(1=练气，2=筑基，3=金丹，4=元婴，5=化神，6=炼虚，7=合体，8=渡劫),
    "名称": "境界名称字符串(练气|筑基|金丹|元婴|化神|炼虚|合体|渡劫)",
    "当前进度": 数字(当前境界内的修炼进度),
    "下一级所需": 数字(突破到下一境界所需的进度),
    "突破描述": "突破条件和要求的详细描述字符串"
  }
}
\`\`\`

## 5. 位置信息模板

**玩家和NPC的位置信息必须使用层级地理格式**：

\`\`\`json
{
  "位置": {
    "描述": "层级地理位置，格式为'大陆名·区域名·具体地点'或'大陆名·宗门名'，请根据世界设定生成合适的地名"
  }
}
\`\`\`

**禁止使用的格式**：
- ❌ "初始地"、"某大陆"、"某地"等模糊描述
- ❌ "位置生成失败"等错误状态
- ❌ 不包含"·"分隔符的平铺位置名

**正确格式示例**：
- ✅ "某大陆·某宗门"
- ✅ "某大陆·某州·某镇"
- ✅ "某大陆·某山脉"
- ✅ "某大陆·某州·某都城"

## 6. 游戏时间模板

**游戏时间必须包含所有字段**：

\`\`\`json
{
  "年": 数字,
  "月": 数字(1到12),
  "日": 数字(1到30),
  "小时": 数字(0到23),
  "分钟": 数字(0到59)
}
\`\`\`

## 7. 数据类型严格要求

1. **数字字段**：年龄、境界、好感度、属性值、时间等必须是纯数字，不能是字符串
2. **字符串字段**：名字、描述、关系等必须是有意义的文本，不能是"未知"
3. **布尔字段**：实时关注、已装备等必须是true或false，不能是字符串
4. **数组字段**：天赋、技能、记忆等必须是数组格式，即使为空也要写成[]
5. **对象字段**：灵根、背包等必须包含所有必要的子字段

## 8. 禁止事项

❌ **严禁使用的错误格式**：
- 境界: "化神" (错误，应该是完整对象格式)
- 境界.等级: "5" (错误，应该是数字5)
- 年龄: "未知" (错误，应该是数字)
- 灵根: "废灵根" (错误，应该是对象)
- 灵根: {"类型": "天品"} (错误，应该用"品级")

✅ **正确格式**：
- 境界: {"等级": 5, "名称": "化神", "当前进度": 1500, "下一级所需": 10000, "突破描述": "需领悟化神真意", "子阶段": "初期", "修为倍率": 3.0, "寿命增加": 500}
- 修为: {"当前": 1500, "最大": 10000}
- 年龄: 25 (数字)
- 灵根: {"名称": "废灵根", "品级": "凡品", "描述": "..."}

## 9. 验证检查清单

生成任何数据前，请检查：
1. 所有数字字段都是数字类型
2. **玩家**境界信息包含完整的8个字段(等级、名称、当前进度、下一级所需、突破描述、子阶段、修为倍率、寿命增加)
3. **NPC**境界信息是简单数字(1=练气，2=筑基等)
4. 修为进度已整合到境界对象中(当前进度/下一级所需)
5. 所有必要字段都存在
6. 灵根对象包含名称、品级、描述三个字段
7. 背包包含灵石对象和物品数组
8. NPC行为包含行为模式和日常路线
9. **位置信息**使用层级地理格式(如"大陆·州郡·城镇")，禁用"初始地"等模糊描述
10. 没有使用"未知"等占位符
`.trim();

// =================================================================
// # 统一的提示词构建器
// =================================================================

export const UNIFIED_PROMPT_BUILDER = {
  /**
   * 构建完整的游戏提示词
   */
  buildGamePrompt: (promptType: 'initialization' | 'gameplay' | 'npc_update') => {
    // 为了降低运行时提示词长度：
    // - 初始化使用精简规则（移除详细的数据模板）
    // - 剧情推进/更新时使用最精简规则
    const baseRules = (() => {
      if (promptType === 'gameplay' || promptType === 'npc_update') {
        // 精简版规则：避免与 system.rules.bundle 重复
        return [
          '# 运行规则（精简）',
          '- ⚠️ 先创建后修改：所有数据必须先存在才能修改',
          '- 严格遵守存档中各对象的 _AI说明/_AI重要提醒，与 character.saveData.系统.规则。',
          '- 所有变更通过 tavern_commands 实现；输出唯一 JSON（text/mid_term_memory/tavern_commands）。',
          '- 读取并遵守 先天六司上限与其他系统限制（见系统.规则）。'
        ].join('\n');
      }
      // initialization 使用精简规则，不再加载庞大的数据模板
      return [
        COMMON_CORE_RULES,
        COMMON_NARRATIVE_RULES,
        COMMON_DATA_MANIPULATION_RULES,
        // DATA_STRUCTURE_TEMPLATES, // 移除庞大的数据模板
        ENHANCED_TIME_MANAGEMENT,
        ENHANCED_DATA_VALIDATION,
        '# 先天六司约束\n- 先天六司六项每项范围为0-10；NPC同样遵守。\n- 若生成/更新出现超限，必须在 tavern_commands 中写入裁剪后的值（如>10则写入10）。\n- 生成/更新前，应读取并遵守 character.saveData.系统.规则 中的限制（例如 属性上限.先天六司.每项上限）。',
        // COMMON_NPC_RULES, // 移除详细NPC规则
        // COMMON_ITEM_RULES, // 移除详细物品规则
        // COMMON_DAO_RULES // 移除详细大道规则
      ].join('\n\n');
    })();

    const specificRules = {
      initialization: [
        // CHARACTER_INITIALIZATION_RULES, // 移除冗长的初始化规则
        '# 角色初始化要点',
        '- ⚠️ 先创建后修改：只创建新的NPC/物品/大道，不修改已有数据',
        '- 严禁修改角色基础信息（姓名、性别、年龄、先天六司等）',
        '- 必须生成具体的层级地理位置',
        '- 创建1-3个初始NPC和2-5件初始物品',
        '',
        '\n# ⚠️【关键提醒：严格输出格式要求】⚠️',
        '❌ 严禁使用任何非标准字段名，如：command, set_value, add_item, add_npc 等',
        '✅ 只能使用标准字段：action, scope, key, value',
        '❌ 严禁使用自定义action名称',
        '✅ 只能使用：set, add, push, pull, delete',
        '',
        '\n# 【输出格式（初始化专用，必须严格遵守）】',
        '⚠️ 重要：必须使用标准的 action/scope/key/value 格式，不得使用 command 等别名',
        '- 仅输出一个 JSON 对象，不要输出多余文本；建议使用 ```json 代码块包裹。',
        '- 顶层字段：',
        '  - text: string（1500-3000字详细叙事）',
        '  - mid_term_memory: string（可为空字符串）',
        '  - tavern_commands: TavernCommand[]（严格的命令数组）',
        '\n# 【tavern_commands 规范（必须严格遵守）】',
        '⚠️ 格式要求：每个命令对象必须包含且仅包含以下4个字段：',
        '  {"action":"标准动作","scope":"chat","key":"character.saveData.路径","value":值}',
        '',
        '✅ 允许的 action 值（只能使用这5个）：',
        '  - "set"   : 设置值',
        '  - "add"   : 数值相加',
        '  - "push"  : 向数组添加元素',
        '  - "pull"  : 从数组移除元素',
        '  - "delete": 删除字段',
        '',
        '❌ 禁止使用的字段名：',
        '  - command（必须用action）',
        '  - operation（必须用action）',
        '  - type（必须用action）',
        '  - path（必须用key）',
        '',
        '❌ 禁止使用的action值：',
        '  - set_value, set_player_data（必须用set）',
        '  - add_item, add_npc（必须用push或set）',
        '  - update_time, update_character（必须用set或add）',
        '',
        '- scope 固定为 "chat"',
        '- key 必须以 "character.saveData." 开头',
        '- 时间推进：优先对 分钟/小时 使用 add（必要时自行进位）',
        '\n# 【标准示例（严格按此格式）】',
        '```json',
        '{',
        '  "text": "......",',
        '  "mid_term_memory": "",',
        '  "tavern_commands": [',
        '    {"action":"set","scope":"chat","key":"character.saveData.玩家角色状态.位置.描述","value":"[根据世界设定生成：大陆名·区域名·地点名]"},',
        '    {"action":"add","scope":"chat","key":"character.saveData.游戏时间.分钟","value":10},',
        '    {"action":"push","scope":"chat","key":"character.saveData.玩家角色状态.状态效果","value":{"状态名称":"病中虚弱","类型":"debuff","时间":"3天","状态描述":"气血与行动力下降"}},',
        '    {"action":"set","scope":"chat","key":"character.saveData.人物关系.石头","value":{"角色基础信息":{"名字":"石头"}}}',
        '  ]',
        '}',
        '```',
        '\n# 【格式自检清单（提交前必须逐项确认）】',
        '1) ✅ 顶层仅有 text/mid_term_memory/tavern_commands 三个字段',
        '2) ✅ tavern_commands 中每个对象都包含 action/scope/key/value 四个字段',
        '3) ✅ action 值只使用 set/add/push/pull/delete 中的一个',
        '4) ✅ scope 值固定为 "chat"',
        '5) ✅ key 以 "character.saveData." 开头',
        '6) ✅ 没有使用 command, set_value, add_item 等禁用字段名',
        '7) ✅ 位置只写 位置.描述（不写坐标）',
        '8) ✅ 未写入任何"未知/随机/占位符"等字样',
        '9) ✅ 开场物品/人物/NPC/大道写入符合各自结构要求',
        '10) ✅ 先天六司未被修改',
        '11) ✅ 遵循"先创建后修改"原则，只创建新的NPC/物品/大道数据',
        '12) ✅ 内容和路径与玩家选择一致、语义合理、无自相矛盾'
      ].join('\n'),
      gameplay: '# 游戏进行中的特殊规则\n\n⚠️ **先创建后修改原则**：\n- 修改NPC数据前，该NPC必须已存在于人物关系中\n- 修改物品数量前，该物品必须已存在于背包中\n- 修改大道进度前，该大道必须已解锁\n- 只能对已存在的数据路径进行操作\n\n1. 每次回应必须推进故事情节\n2. 必须更新游戏时间\n3. 玩家行动必须有明确结果',
      npc_update: '# NPC更新规则\n\n1. 更新相关NPC状态\n2. 记录重要互动\n3. 调整好感度'
    };

    return baseRules + '\n\n' + specificRules[promptType];
  }
};
