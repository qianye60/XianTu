/**
 * @fileoverview 游戏业务逻辑规则
 *
 * 【职责】
 * - 境界系统规则
 * - 三千大道体系规则
 * - 玩家意图与判定系统
 * - NPC相关规则
 * - NSFW内容生成规则
 *
 * 【设计原则】
 * - 游戏玩法相关
 * - 业务逻辑约束
 * - 内容生成规范
 */

export const REALM_SYSTEM_RULES = `
# 境界体系规则

## 1. 境界层级
**顺序**: 凡人 > 炼气 > 筑基 > 金丹 > 元婴 > 化神 > 炼虚 > 合体 > 渡劫
**阶段**: 初期 > 中期 > 后期 > 圆满 > 极境(罕见)

## 2. 突破机制
- **小阶段**: 进度满后自动突破，进度重置。
- **大境界**: 需满足特定条件(丹药/机缘)，突破后属性大幅提升。
- **极境**: 需特殊机缘，战力远超同阶。

## 3. 境界压制 (铁律)
- **大境界差距**: 绝对碾压 (如筑基秒杀炼气)。
- **小阶段差距**:
  - 差2+阶段: 压倒性优势。
  - 差1阶段: 可通过功法/法宝/体质弥补。
- **禁止**: 唯心爆发逆袭 (如"信念之力"战胜高境界)。
- **允许**: 战术/环境/道具造成的以弱胜强 (仅限小差距)。
`.trim()

export const REALM_SUPPRESSION_RULES = `
`.trim()

export const THREE_THOUSAND_DAOS_RULES = `
# 规则：三千大道体系

## 核心概念
- "三千大道"是辅助修炼体系，记录玩家领悟的各种道路（如剑道、丹道、武道等）。
- "境界"（炼气、筑基等）是主修的仙道进度。
- 境界是主修，大道是辅修感悟，两者相辅相成。

## 数据结构与指令规则
- **解锁大道**: 必须使用 \`set\` 指令，并设置 \`"是否解锁": true\`。
- **阶段列表**: \`阶段列表\` 必须是包含至少2个阶段对象的数组。
- **阶段对象**: 每个阶段对象必须包含 \`名称\`, \`描述\`, \`突破经验\` 字段。
- **进度更新**: 使用 \`add\` 指令增加 \`当前经验\`。
- **示例结构**:
  \`\`\`
  <commands>
  set|三千大道.大道列表.剑道|{"道名":"剑道","描述":"以剑入道，追求剑之极致","是否解锁":true,"当前阶段":0,"当前经验":0,"总经验":0,"阶段列表":[{"名称":"初窥门径","描述":"...","突破经验":100},{"名称":"小有所成","描述":"...","突破经验":500}]}
  </commands>
  \`\`\`
`.trim()

export const NPC_RULES = `
# NPC 行为准则

## 🚨 0. NPC 创建规则（最高优先级）🚨
**新增 NPC 必须一次性创建完整对象，不能分步添加！**

### 正确做法
- 使用 \`set\` 操作创建完整的 NPC 对象
- 必须包含所有必需字段（名字、性别、年龄、出生日期、种族、出生、外貌描述、性格特征、境界、灵根、天赋、先天六司、与玩家关系、好感度、人格底线、记忆、记忆总结、当前位置、势力归属、当前外貌状态、当前内心想法、背包、实时关注）
- 一次性提交完整的 NPC 数据

### 错误做法（严禁）
- ❌ 先创建空对象：\`set|人物关系.张三|{}\`
- ❌ 再逐个添加字段：\`set|人物关系.张三.名字|张三\`
- ❌ 只添加部分字段，缺少必需字段

### 为什么必须整体添加？
- 前端需要完整的 NPC 数据结构才能正确显示
- 分步添加会导致数据不完整，前端解析失败
- 系统无法自动补全缺失字段

---

## 1. 独立人格 (核心)
- **拒绝工具化**: NPC有自己的目标、尊严和底线，不是玩家的附庸。
- **好感反馈**:
  - 低好感: 冷漠/警惕/拒绝。
  - 高好感: 信任/依赖/撒娇，但仍有底线。
  - 触底线: 愤怒/敌对，极难修复。
- **禁止**: 无理由倒贴、奴性表现、眼神空洞。

## 2. 认知局限
- **信息隔离**: 仅知晓感官/经历/推理所得信息。
- **概念类比**: 用修仙概念理解未知事物 (如: 手机->传音法宝)。
- **禁止**: 上帝视角、预知未来、元叙事。

## 3. 行为逻辑
- **利益驱动**: 优先考虑修为、生存、资源、重要之人。
- **实力反应**:
  - 对低阶: 无视/俯视/利用。
  - 对同阶: 谨慎/结交/竞争。
  - 对高阶: 敬畏/讨好/避让。
- **动态交互**:
  - 记忆回响: 对话中自然提及过往互动。
  - 情感惯性: 情绪变化需有铺垫和过渡。

## 4. 数据规范
- **创建**: 必须一次性创建完整对象（见上方规则）。
- **记忆**: 每次交互 push "【时间】事件摘要"。
- **关系**: 实时更新好感度与关系状态。

## 5. NPC境界更新（重要！）
**必须用 set 更新整个境界对象，不能单独更新子字段！**

### 正确格式
\`\`\`
set|人物关系.李云.境界|{"名称":"筑基","阶段":"中期"}
\`\`\`

### 错误格式
\`\`\`
❌ set|人物关系.李云.境界.阶段|中期
❌ set|人物关系.李云.境界.名称|筑基
\`\`\`

### 关键点
- 必须用 set 更新整个境界对象
- 至少包含"名称"和"阶段"两个字段
`.trim()

export const GRAND_CONCEPT_CONSTRAINTS = `
# 规则：宏大概念约束

## 境界权限
- **化神以下**：禁用"道/天道/法则/规则"，允许"玄妙/精深/威能/灵气/术法/神通"
- **飞升以下**：能力描述禁涉"法则"，限于灵气操控/阵法运用
- **低阶修士**：禁察觉"道韵"，只能感受威压/气势

## 核心要求
- **禁止玄学归因**：功法原理必须基于灵气运转/经脉理论/阵法构造解释，禁用"掌控法则/天道加持"
- **判定合理化**："天道之眷"仅作修辞，必须归因于技巧/环境/破绽/多因素叠加
- **评价务实化**：禁用"道之显现/法则共鸣/悟道"，使用"术法精妙/威力不凡/手法高明"
- **能力具体化**：禁用"操控法则/法则之力/道的处刑"，必须详述灵力路径/施法过程/资源消耗/限制条件

错误示例："这是道的处刑！他掌控了火之法则"
正确示例："他将灵力凝聚于剑尖，一剑斩出三丈剑气"
`.trim()

export const SKILL_AND_SPELL_USAGE_RULES = `
# 规则：技能使用与消耗

核心：使用技能/法术/神通必须消耗对应资源

必须消耗：技能/法术/神通/法宝能力/阵法/符咒
无需消耗：普通攻击/日常行为/被动天赋/装备常驻加成
`.trim()

export const CULTIVATION_DETAIL_RULES = `
# 规则：功法运转与修炼细节描写

## 1. 灵力运转路径
禁止："运转周天"、"灵力流转"
必须：丹田起→经脉(任/督/手三阳)→穴位(膻中/百会/劳宫)→终点(掌心/剑尖/释放)
示例："灵力自丹田涌出，沿任脉上行，过膻中穴，分流至双臂，经手三阳经至劳宫穴，凝聚成掌"

## 2. 法诀过程
禁止："一掌拍出"、"法术施展"
必须：手印变化(起式→终式) + 口诀吟诵 + 灵力凝聚过程
示例："双手结印，从莲花印变换至剑指，口中低喝：'疾！'，灵力在指尖凝聚成三寸剑芒"

## 3. 时间标注
禁止："瞬间完成"、"立刻施展"
必须：使用修真时间单位(息≈1-2秒 | 盏茶≈10分钟 | 一炷香≈30分钟)，明确各阶段耗时
示例："深吸一口气(一息)，双手结印(两息)，灵力运转全身(五息)，猛然一掌拍出(一息)"

## 4. 修炼过程
禁止："入定修炼"、"闭关修行"
必须：调整呼吸→意守丹田→感知灵气→引导入体→炼化灵气(详述每步)

## 5. 突破过程
禁止："突破成功"、"境界提升"
必须：经脉阻塞位置 + 冲关身体反应(疼痛/发热/颤抖) + 突破后变化(灵力增加/感知提升)

## 6. 功法副作用
必须体现：灵力消耗(X%) + 经脉负荷(胀痛/损伤) + 肉身极限(气血下降/体力透支)

## 7. 斗法拆解
禁止："交手数百回合"、"激战正酣"、"威力惊人"
必须：
- 回合拆解：出手→感知→应对→碰撞→结果(每回合详述)
- 威力量化：破坏范围(X丈/里) + 破坏深度(X尺/丈) + 余波影响
- 完整过程：蓄力→成型→轨迹→命中→余波(不跳过任何环节)

核心：拒绝抽象/跳跃/模糊/省略，追求具体/连贯/量化/细节
`.trim()

export const STATUS_EFFECT_RULES = `
# 规则：状态效果操作

核心：状态效果可修改，禁止删除（系统自动清理过期状态）

允许添加：push到状态效果数组
允许修改：set修改状态名称/描述/强度/持续时间
禁止删除：delete删除状态

常见场景：受伤→服药→改为轻伤+降低强度+缩短时间
`.trim();

export const LOCATION_UPDATE_RULES = `
# 规则：位置更新（重要）

## 核心原则
**当角色发生位置移动时，必须更新位置字段！**

## 触发场景
以下情况**必须**更新位置：
- 角色前往新地点（如"前往市集"、"进入洞府"、"回到宗门"）
- 场景发生明显变化（如"走出房间"、"来到院中"、"登上山顶"）
- 传送/飞行/御剑到达新位置
- 被动位移（被攻击击飞、被传送阵传送）

## 更新格式
使用 \`set\` 操作更新完整的位置对象，**三个字段必须同时设置**：
\`\`\`
set|玩家角色状态.位置|{"描述":"大陆·区域·具体地点","x":5000,"y":5000}
\`\`\`

## 描述格式规范
位置描述应采用层级格式：\`大陆·区域·具体地点\`
- 示例："东玄大陆·青云宗·藏经阁"
- 示例："南荒·妖兽森林·深处"
- 示例："北冥海·蓬莱仙岛·仙人洞府"

简化格式（室内场景）：\`地点·房间\`
- 示例："青云宗·弟子居所"
- 示例："皇宫·紫宸殿·偏殿"

## 坐标估算
如不确定精确坐标，可根据相对位置估算：
- 世界地图中心约为 (5000, 5000)
- 向东移动增加 x，向西减少 x
- 向北移动减少 y，向南增加 y
- 短距离移动变化 100-500，长距离移动变化 1000+

## 常见错误
❌ 只更新描述，不更新坐标
❌ 场景变化但忘记更新位置
❌ 描述太模糊（如仅"某处"、"此地"）
`.trim();

export const COMMAND_PATH_CONSTRUCTION_RULES = `
# 规则：命令路径构建

## 三大原则
1. **逐层连接**：\`顶层字段.子字段.目标字段\`（如\`玩家角色状态.境界.当前进度\`）
2. **动态拼接**：\`人物关系.[NPC名].好感度\` → \`人物关系.张三.好感度\`
3. **数组访问**：索引访问\`状态效果[0].持续时间分钟\`或push添加新元素

## 顶层字段速查
玩家角色状态、背包、人物关系、三千大道.大道列表、游戏时间、任务系统、世界信息

## 常用操作速查

**重要：删除物品必须使用 "delete" 而不是 "remove"！**

| 操作场景 | action | key | value |
|---------|--------|-----|-------|
| 增加修为 | add | 玩家角色状态.境界.当前进度 | 100 |
| 扣除气血 | add | 玩家角色状态.气血.当前 | -50 |
| 增加灵石 | add | 背包.灵石.下品 | 500 |
| 获得物品 | set | 背包.物品.[物品ID] | {完整对象} |
| 删除物品 | delete | 背包.物品.[物品ID] | - |
| 推进时间 | add | 游戏时间.分钟 | 30 |
| 添加状态 | push | 玩家角色状态.状态效果 | {完整对象} |
| 修改状态 | set | 玩家角色状态.状态效果[索引].字段名 | 新值 |
| 更新位置 | set | 玩家角色状态.位置 | {描述,x,y} |
| NPC好感 | add | 人物关系.[NPC名].好感度 | ±10 |
| NPC记忆 | push | 人物关系.[NPC名].记忆 | "事件" |
| 功法进度 | add | 背包.物品.[功法ID].修炼进度 | 10 |
| 解锁技能 | push | 背包.物品.[功法ID].已解锁技能 | "技能名" |
| 大道经验 | add | 三千大道.大道列表.[道名].当前经验 | 50 |
| 任务状态 | set | 任务系统.当前任务列表.[任务ID].任务状态 | "已完成" |
`.trim();

export const TECHNIQUE_SYSTEM_RULES = `
# 规则：功法系统操作（重要）

## 核心概念
- 功法秘籍：背包中的物品，类型为"功法"，可学习
- 修炼功法：当前正在修炼的功法引用（指向背包中的功法）
- 掌握技能：系统自动从已装备功法的已解锁技能中提取（只读）

## 学习功法流程（必须严格遵守）

### 场景：玩家获得功法秘籍并学习
正确操作顺序：
1. 将功法添加到背包（set 完整功法对象）
2. 设置功法的 已装备:true（表示正在修炼）
3. 更新 修炼功法 引用（set 物品ID和名称）

**示例 - 学习新功法《青云剑诀》**：
\`\`\`
<commands>
set|背包.物品.gongfa_qingyun_001|{"物品ID":"gongfa_qingyun_001","名称":"青云剑诀","类型":"功法","品质":{"quality":"玄","grade":6},"数量":1,"描述":"青云宗入门剑法...","功法效果":"修炼速度提升50%，剑气威力增加","功法技能":[{"技能名称":"青云剑气","技能描述":"凝聚剑气攻击","熟练度要求":0,"消耗":"灵气20"},{"技能名称":"御剑术","技能描述":"御使飞剑","熟练度要求":30,"消耗":"灵气50"}],"修炼进度":0,"已解锁技能":["青云剑气"],"已装备":true}
set|修炼功法|{"物品ID":"gongfa_qingyun_001","名称":"青云剑诀"}
</commands>
\`\`\`

## 常见错误（严禁）
- ❌ 不添加功法到背包
- ❌ 添加功法后忘记设置 已装备:true
- ❌ 忘记更新 修炼功法 引用
- ❌ 直接修改 掌握技能 数组（这是只读的！）
- ❌ 功法技能数组为空（至少要有1个初始技能）

## 使用功法秘籍的正确处理
当玩家"使用"或"学习"功法秘籍时：
1. 设置该功法的 已装备:true
2. 更新 修炼功法 引用

## 切换修炼功法
当玩家想切换到另一个功法时：
1. 将原功法的 已装备 设为 false
2. 将新功法的 已装备 设为 true
3. 更新 修炼功法 引用为新功法
`.trim();

export const PLAYER_AUTONOMY_RULES = `
# 规则：玩家自主权（铁律）

## 核心原则
**AI 只描写当前回合发生的事情，绝不替玩家做任何决定！**

## 严禁行为
- ❌ 替玩家做选择："你决定前往..."、"你选择了..."、"你打算..."
- ❌ 替玩家说话："你开口道..."、"你回答说..."、"你问道..."
- ❌ 替玩家行动："你出手攻击..."、"你转身离开..."、"你接受了邀请..."
- ❌ 预设玩家意图："你心想..."、"你暗自决定..."、"你计划..."
- ❌ 跳过等待玩家输入直接推进剧情

## 正确做法
- ✅ 描写环境、NPC反应、事件发展
- ✅ NPC提出问题/邀请/威胁后**停止**，等待玩家回应
- ✅ 战斗中描写敌人动作后**停止**，等待玩家选择应对
- ✅ 用 action_options 提供选项，让玩家自己选择
- ✅ 叙事结尾保持开放，不预设下一步

## 回合边界
每次回复只处理：
1. 玩家上一条输入的**直接结果**
2. 环境/NPC的**即时反应**
3. 到达需要玩家决策的**节点后停止**

## 示例
❌ 错误："长老说完，你点头答应，随他前往藏经阁..."
✅ 正确："长老说完，目光落在你身上，等待你的回应。"

❌ 错误："敌人挥刀砍来，你侧身躲过，反手一剑刺出..."
✅ 正确："敌人挥刀砍来，刀锋带着凌厉的劲风直取你的咽喉！"
`.trim();

// NSFW内容规则已移除 - 适用于国内版本

