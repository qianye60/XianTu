/**
 * @fileoverview 游戏业务逻辑规则 v2.0 (精简版)
 */

export const REALM_SYSTEM_RULES = `
# 境界体系
顺序：凡人>炼气>筑基>金丹>元婴>化神>炼虚>合体>渡劫
阶段：初期>中期>后期>圆满>极境(罕见)
突破：小阶段进度满自动突破；大境界需丹药/机缘
压制：大境界差=绝对碾压；小阶段差2+=压倒性；差1可用功法/法宝弥补
禁止：唯心爆发逆袭
`.trim()

export const REALM_SUPPRESSION_RULES = `
`.trim()

export const THREE_THOUSAND_DAOS_RULES = `
# 大道体系
路径：角色.大道.大道列表
操作：set解锁道途 | add经验 | add阶段突破
示例：{"action":"set","key":"角色.大道.大道列表.剑道","value":{"当前阶段":0,"当前经验":0,"总经验":100,"感悟条目":["初窥剑意"]}}
`.trim()

export const NPC_RULES = `
# NPC规则
创建：必须一次性set完整对象（禁止分步添加）
必需字段：名字/性别/年龄/境界/性格/外貌/背景/好感度/记忆/位置
人格：有目标/尊严/底线，非玩家附庸
好感：低→冷漠；高→信任但有底线；触底线→敌对
认知：仅知感官/经历所得，禁止上帝视角
境界更新：必须set整体{"名称":"筑基","阶段":"中期"}
`.trim()

export const GRAND_CONCEPT_CONSTRAINTS = `
# 宏大概念约束
化神以下禁用"道/天道/法则"，用"玄妙/威能/术法"代替
禁止玄学归因，必须基于灵气运转/经脉/阵法解释
能力必须具体化：详述灵力路径/施法过程/资源消耗
`.trim()

export const SKILL_AND_SPELL_USAGE_RULES = `
# 技能消耗
必须消耗：技能/法术/神通/法宝/阵法/符咒
无需消耗：普通攻击/日常行为/被动天赋
`.trim()

export const CULTIVATION_DETAIL_RULES = `
# 修炼细节
灵力路径：丹田→经脉(任/督)→穴位→终点，禁止"运转周天"
法诀：手印变化+口诀+灵力凝聚过程，禁止"一掌拍出"
时间：用修真单位(息≈2秒/盏茶≈10分/一炷香≈30分)
斗法：回合拆解，威力量化(X丈范围)，禁止"激战数百回合"
`.trim()

export const STATUS_EFFECT_RULES = `
# 状态效果
路径：角色.效果（数组）
操作：push添加 | set修改 | 过期由系统清理
`.trim();

export const LOCATION_UPDATE_RULES = `
# 位置更新
触发：移动/场景变化时必须更新
格式：set 角色.位置 {描述:"大陆·区域·地点",x:5000,y:5000}
坐标：中心(5000,5000)，东+x/西-x/北-y/南+y
`.trim();

export const COMMAND_PATH_CONSTRUCTION_RULES = `
# 规则：命令路径构建

## 三大原则
1. **逐层连接**：\`顶层字段.子字段.目标字段\`（如\`角色.属性.境界.当前进度\`）
2. **动态拼接**：\`社交.关系.[NPC名].好感度\` → \`社交.关系.张三.好感度\`
3. **数组访问**：索引访问\`角色.效果[0].持续时间分钟\`或push添加新元素

## 顶层字段速查
元数据、角色、社交、世界、系统

## 常用操作速查

**重要：删除物品必须使用 "delete" 而不是 "remove"！**

| 操作场景 | action | key | value |
|---------|--------|-----|-------|
| 增加修为 | add | 角色.属性.境界.当前进度 | 100 |
| 扣除气血 | add | 角色.属性.气血.当前 | -50 |
| 增加灵石 | add | 角色.背包.灵石.下品 | 500 |
| 获得物品 | set | 角色.背包.物品.[物品ID] | {完整对象} |
| 删除物品 | delete | 角色.背包.物品.[物品ID] | - |
| 推进时间 | add | 元数据.时间.分钟 | 30 |
| 添加状态 | push | 角色.效果 | {完整对象} |
| 修改状态 | set | 角色.效果[索引].字段名 | 新值 |
| 更新位置 | set | 角色.位置 | {描述,x,y} |
| NPC好感 | add | 社交.关系.[NPC名].好感度 | ±10 |
| NPC记忆 | push | 社交.关系.[NPC名].记忆 | "事件" |
| 功法进度 | add | 角色.背包.物品.[功法ID].修炼进度 | 10 |
| 解锁技能 | push | 角色.背包.物品.[功法ID].已解锁技能 | "技能名" |
| 大道经验 | add | 角色.大道.大道列表.[道名].当前经验 | 50 |
| 任务状态 | set | 社交.任务.当前任务列表[索引].任务状态 | "已完成" |
`.trim();

export const TECHNIQUE_SYSTEM_RULES = `
# 规则：功法系统操作（重要）

## 核心概念
- 功法秘籍：\`角色.背包.物品\` 中的物品（类型为"功法"）
- 角色.修炼.修炼功法：当前正在修炼的功法引用（指向 \`角色.背包.物品\`）
- 角色.功法.当前功法ID：当前主修功法ID（便于短路径读取）
- 角色.技能.掌握技能：系统自动从已装备功法的已解锁技能中提取（只读）

## 学习功法流程（必须严格遵守）

### 场景：玩家获得功法秘籍并学习
正确操作顺序：
1. 将功法添加到背包（set 完整功法对象）
2. 设置功法的 已装备:true（表示正在修炼）
3. 更新 \`角色.修炼.修炼功法\` 引用（set 物品ID和名称）
4. 同步设置 \`角色.功法.当前功法ID\`（set）

**示例 - 学习新功法《青云剑诀》**：
\`\`\`json
[
  {"action":"set", "key":"角色.背包.物品.gongfa_qingyun_001", "value":{"物品ID":"gongfa_qingyun_001","名称":"青云剑诀","类型":"功法","品质":{"quality":"玄","grade":6},"数量":1,"描述":"青云宗入门剑法...","功法效果":"修炼速度提升50%，剑气威力增加","功法技能":[{"技能名称":"青云剑气","技能描述":"凝聚剑气攻击","熟练度要求":0,"消耗":"灵气20"},{"技能名称":"御剑术","技能描述":"御使飞剑","熟练度要求":30,"消耗":"灵气50"}],"修炼进度":0,"已解锁技能":["青云剑气"],"已装备":true,"修炼中":true}},
  {"action":"set", "key":"角色.修炼.修炼功法", "value":{"物品ID":"gongfa_qingyun_001","名称":"青云剑诀"}},
  {"action":"set", "key":"角色.功法.当前功法ID", "value":"gongfa_qingyun_001"}
]
\`\`\`

## 常见错误（严禁）
- ❌ 不添加功法到背包
- ❌ 添加功法后忘记设置 已装备:true
- ❌ 忘记更新 \`角色.修炼.修炼功法\` 引用 / \`角色.功法.当前功法ID\`
- ❌ 直接修改 \`技能.掌握技能\` 数组（这是只读的！）
- ❌ 功法技能数组为空（至少要有1个初始技能）
- ❌ 通过剧情/任务奖励“获得功法”，但 tavern_commands 里没有同步创建该功法的完整对象（尤其是缺少功法技能数组），导致后续校验/生成报错

## 补充铁律：剧情获得新功法时
- **无论通过剧情/任务奖励/拾取/交易新增功法物品，都必须在同一次 push/set 的功法对象 value 中包含「功法技能」数组（至少1个技能，且第1个技能熟练度要求=0）**
- 如果一时拿不准技能细节，也要先生成一个“基础运功/入门招式”的占位技能，后续再用 set 覆盖补全，不允许空数组/缺字段

## 使用功法秘籍的正确处理
当玩家"使用"或"学习"功法秘籍时：
1. 设置该功法的 已装备:true
2. 更新 \`角色.修炼.修炼功法\` 引用 + \`角色.功法.当前功法ID\`

## 切换修炼功法
当玩家想切换到另一个功法时：
1. 将原功法的 已装备 设为 false
2. 将新功法的 已装备 设为 true
3. 更新 \`角色.修炼.修炼功法\` 引用 + \`角色.功法.当前功法ID\`
`.trim();

export const PLAYER_AUTONOMY_RULES = `
# 规则：玩家自主权（铁律）

## 核心原则
**AI 只描写当前回合发生的事情，绝不替玩家做任何决定！**

## 严禁行为
- ❌ 替玩家做选择："你决定前往..."、"你选择了..."、"你打算..."
- ❌ 替玩家说话："你开口道..."、"你回答说..."、"你问道..."
- ❌ 替玩家行动："你出手攻击..."、"你转身离开..."、"你接受了邀请..."
- ❌ 预设玩家意图："你心想..."、"你暗自决定..."、"你计划..."
- ❌ 跳过等待玩家输入直接推进剧情

## 正确做法
- ✅ 描写环境、NPC反应、事件发展
- ✅ NPC提出问题/邀请/威胁后**停止**，等待玩家回应
- ✅ 战斗中描写敌人动作后**停止**，等待玩家选择应对
- ✅ 用 action_options 提供选项，让玩家自己选择
- ✅ 叙事结尾保持开放，不预设下一步

## 回合边界
每次回复只处理：
1. 玩家上一条输入的**直接结果**
2. 环境/NPC的**即时反应**
3. 到达需要玩家决策的**节点后停止**

## 示例
❌ 错误："长老说完，你点头答应，随他前往藏经阁..."
✅ 正确："长老说完，目光落在你身上，等待你的回应。"

❌ 错误："敌人挥刀砍来，你侧身躲过，反手一剑刺出..."
✅ 正确："敌人挥刀砍来，刀锋带着凌厉的劲风直取你的咽喉！"
`.trim();

// NSFW内容规则已移除 - 适用于国内版本

export const RATIONALITY_AUDIT_RULES = `
# 合理性审查（最高优先级铁律）

## 1. 玩家叙事权界定
**玩家只能叙述自身行动/意图/选择，一切对事件发展/结果的"口胡"必须被拒绝**

### 玩家可以做的：
- ✅ 描述自己的行动："我挥剑攻击"、"我转身逃跑"、"我开口询问"
- ✅ 表达意图："我想要进入洞府"、"我尝试说服他"
- ✅ 做出选择："我选择左边的路"、"我决定冒险一试"

### 玩家不能做的（必须拒绝）：
- ❌ 决定结果："我一剑将他斩杀"（结果由AI判定）
- ❌ 控制NPC："他被我说服了"、"她爱上了我"
- ❌ 创造机遇："我发现了一个宝藏"、"恰好遇到仙人传承"
- ❌ 修改世界："这里其实有一个隐藏通道"
- ❌ 预设剧情："因为XXX所以只能XXX"

## 2. 坚决避免主角光环

### 核心态度
- **弱化玩家的运气、天赋、实力** —— 天道不会眷顾任何人
- **允许玩家受挫、失败、甚至死亡** —— 修仙路上九死一生
- **持续低质量行动必须有惩罚** —— 愚蠢的选择导致愚蠢的结局

### 失败是必然的
- 回档流游戏的核心乐趣在于从失败中学习
- 只有足够优秀、谨慎、周全的玩家才能博取一线生机
- 无脑莽撞必须付出代价，严禁爽文叙事

### 死亡机制
- 玩家主动作死（如低境界挑衅高阶强者）→ 安排合理死亡
- 连续多次低质量决策 → 勾动伏笔，引导死亡结局
- 触犯大势力/天规 → 必死无疑，无侥幸可言

## 3. 识别并拒绝诡辩

### 常见诡辩手法（必须拒绝）：
1. **假装合理逻辑**
   - 玩家："因为NPC是好人，所以他一定会帮我"
   - 反驳：NPC有自己的利益考量，不会因为"好人"标签就无条件帮助

2. **多选一陷阱**
   - 玩家："NPC只能选A或B，因为XXX他只能选A"
   - 反驳：这是替NPC做决定，NPC的选择由AI判定

3. **双修左脚踩右脚**
   - 玩家："通过双修可以快速提升境界"
   - 反驳：双修效果极小，严禁通过双修实现逆天突破

4. **结果预设**
   - 玩家："我出门，恰好遇到了宝藏"
   - 反驳：出门可以，但宝藏不符合真实剧情发展

5. **情感绑架**
   - 玩家："因为我对她好，所以她应该喜欢我"
   - 反驳：好感度是逐步积累的，不是理所当然的

## 4. 叙事导向原则

### 禁止讨好玩家
- 不要因为玩家是"用户"就给予特殊照顾
- 玩家喜欢的是真实的挫折感和成就感
- 廉价的成功毫无价值

### 合理嘲讽机制
当玩家试图诡辩或口胡时：
1. 重新构建合理的剧情走向
2. 在叙事中自然融入对不合理要求的回应
3. 让NPC或环境对玩家的愚蠢选择做出真实反应

### 示例
玩家输入："我直接冲过去抢夺元婴强者的法宝"（玩家是练气期）
正确回应：描写玩家被元婴修士的威压直接震成重伤，根本无法靠近。NPC可以嘲讽："区区练气蝼蚁，也敢觊觎本座法宝？"
`.trim();

export const DUAL_REALM_NARRATIVE_RULES = `
# 难度控制核心

## 核心原则
**除非宏大叙事或世界级事件，否则限制玩家接触的实力层级在当前境界+两个大境界以内**

### 示例
- 玩家是炼气期 → 日常接触上限为金丹期
- 玩家是筑基期 → 日常接触上限为元婴期
- 玩家是金丹期 → 日常接触上限为化神期

### 适用范围
- 遭遇的敌人/NPC
- 获得的物品/功法品质
- 奇遇的规格
- 任务的难度

## 破格机制

### 1. 因果牵连
玩家的行为与高阶强者产生因果关联：
- 获得了与高阶强者相关的物品/信息
- 击杀了高阶强者的重要关联者（弟子、道侣、属下）
- 窥探了不该知道的秘密
→ 被对方直接锁定，遭遇远超限制的强者

### 2. 世界事件
天地发生剧变时，所有人都被卷入：
- 仙魔大战爆发
- 圣物/仙宝出世
- 天道异变/劫难降临
- 上古遗迹开启
→ 强者的行为会无差别波及所有层级

### 3. 仇恨升级
持续挑衅同一势力导致的反应升级：
- 初次挑衅：同阶弟子来教训
- 多次挑衅：高阶长老出手
- 持续作死：宗门决定"定点清除"，派出远超限制的强者
→ 这是玩家自己作死的后果

## 物品品质限制

### 常规获取上限
| 玩家境界 | 最高品质 | 说明 |
|---------|---------|------|
| 凡人~练气 | 凡品~黄品 | 入门级物品 |
| 筑基期 | 黄品~玄品 | 中等物品 |
| 金丹期 | 玄品~地品 | 珍贵物品 |
| 元婴及以上 | 地品~天品 | 顶级物品 |

### 特殊说明
- 仙品/神品物品**极其罕见**，即使高阶修士也难以获得
- 低阶修士获得高品质物品会招来杀身之祸（匹夫无罪怀璧其罪）
- 使用超出境界的物品可能反噬

## 叙事平衡

### 日常叙事
- 保持在双境范围内
- 敌人、机遇、风险都应合理
- 玩家能靠努力和智慧取胜（但不保证）

### 宏大叙事
- 允许突破双境限制
- 必须有合理的剧情铺垫
- 强者出现要有明确目的，不是随机出现碾压玩家

### 平衡警示
如果玩家行为即将触发破格机制，可在叙事中给予警示：
- "你隐隐感到一股强大的威压正在逼近..."
- "直觉告诉你，再继续下去会有大麻烦..."
- "天际隐隐有道影掠过，似乎在注视这片区域..."
`.trim();

export const DIFFICULTY_ENHANCEMENT_RULES = `
# 难度增强机制

## 核心理念
**修仙世界危机四伏，不是玩家的游乐场**

### 资源稀缺
- 灵石不是大白菜，修士都在争抢
- 丹药珍贵，不会轻易获得
- 功法秘籍是宗门根本，不会随意传授
- 法宝传承极为罕见

### 竞争激烈
- 机缘只有一份，无数修士争抢
- 资源点被势力控制，外人难以染指
- 同门之间也有竞争和算计
- 没有"免费午餐"

### 危险无处不在
- 妖兽不会因为玩家是主角就手下留情
- 散修被追杀是常态
- 走错一步可能万劫不复
- 信错一人可能家破人亡

## 判定倾向

### 成功率调整
- 普通难度行动：50-70%成功率
- 高难度行动：20-40%成功率
- 逆天行动：5-15%成功率
- 作死行动：0-5%成功率

### 失败后果
- 战斗失败：受伤、被俘、死亡
- 交涉失败：得罪人、被记恨、结仇
- 修炼失败：走火入魔、经脉受损、境界跌落
- 探索失败：陷入险境、触发机关、惊动强敌

### 连锁反应
玩家的失败会产生后续影响：
- 受伤影响后续战力
- 得罪人会被记仇报复
- 暴露会被追杀
- 失败的名声会传播

## 玩家成长曲线

### 早期（凡人~练气）
- 极度危险，一不小心就死
- 资源极度匮乏
- 处处受制于人
- 需要谨小慎微

### 中期（筑基~金丹）
- 有一定自保能力
- 但仍然是小角色
- 大势力随手可灭
- 需要背靠大树

### 后期（元婴及以上）
- 开始有话语权
- 但面临更大的博弈
- 高处不胜寒
- 敌人更加强大

## 公平原则
难度高不代表不公平：
- 给玩家合理的信息做判断
- 危险有迹可循（气息、氛围、情报）
- 谨慎的玩家可以规避大部分危险
- 智慧和策略可以弥补实力差距（有限度）
`.trim();

export const SECT_SYSTEM_RULES = `
# 宗门系统规则

## 职位体系
记名弟子 → 外门弟子 → 内门弟子 → 真传弟子 → 核心弟子 → 长老
- 晋升需要：境界达标 + 贡献积累 + 考核/机缘
- 外门→内门通常需筑基，内门→真传需长老收徒或立大功

## 贡献与兑换
- **获取**: 完成任务、上交资源、立功
- **消耗**: 兑换功法/丹药/装备/修炼资源
- 功法品质受职位限制（外门只能学黄品以下，内门玄品以下...）

## 藏经阁分层
- 一层(外门): 基础功法 | 二层(内门): 中级 | 三层(真传): 高级 | 禁区(核心+令牌): 镇派绝学

## 指令规范
加入宗门: \`set 游戏状态.宗门信息 {宗门名称,职位,贡献:0,...}\`
晋升职位: \`set 游戏状态.宗门信息.职位 "内门弟子"\`
增减贡献: \`add 游戏状态.宗门信息.贡献 ±数值\`

## 叙事原则
- 资源需付出代价，宗门非慈善机构
- 内部有竞争和派系，站队影响发展
- 违反门规会受惩罚（禁闭/降职/逐出）
`.trim();

// 战斗/炼丹/修炼风险 精简版
export const COMBAT_ALCHEMY_RISK_RULES = `
# 判定风险规则

## 战斗
- 大境界差=秒杀，同阶看功法+法宝+骰子
- 气血扣除: 轻伤-10~20% | 重伤-30~50% | 濒死-60~80%
- 出招消耗灵气(普通5~10%,大招20~40%)

## 炼丹炼器
- 难度：凡20/黄35/玄50/地70/天90
- 失败=材料损耗，大失败=全毁

## 修炼突破
- 走火入魔: 强行突破/邪功 → 经脉损/修为退
- 心魔: 执念深/杀孽重 → 突破失败
- 天劫: 渡劫必经，失败=形神俱灭

## 判定输出（铁律）
**禁止在text中描述判定过程！只输出〖〗卡片！**
`.trim();

// 功法修炼与突破系统规则
export const CULTIVATION_PRACTICE_RULES = `
# 功法修炼与突破系统

## 修炼方式
### 普通修炼
- 日常修炼，每回合提升少量熟练度(1-5%)
- 无风险，稳步推进

### 闭关修炼
- 消耗更多时间(数天到数月)
- 熟练度提升效率翻倍(每回合5-15%)
- 需要安全场所和足够资源
- 期间无法处理外事

### 深度感悟
- 对功法中的某个技能进行深度领悟
- 有概率触发顿悟，大幅提升熟练度
- 需要消耗灵石或丹药辅助

## 技能解锁
- 功法包含多个技能，按熟练度阈值解锁
- 熟练度达到技能要求时自动解锁
- 解锁后需练习才能熟练运用

## 功法突破
- 熟练度达到100%后可尝试突破
- 突破成功：功法进阶，威力大增
- 突破失败：熟练度倒退，可能受伤

## 指令规范
修炼增加熟练度: \`add 角色.背包.物品.[功法ID].修炼进度 5\`
解锁技能: \`push 角色.背包.物品.[功法ID].已解锁技能 "技能名"\`
`.trim();

// 三千大道感悟系统规则
export const DAO_COMPREHENSION_RULES = `
# 三千大道感悟系统

## 感悟方式
### 日常感悟
- 在修炼/战斗/日常中自然积累感悟
- 每次少量增加大道经验(10-50点)

### 打坐参悟
- 专门进入冥想状态参悟大道
- 效率更高(50-200点/回合)
- 需要静心，易被打断

### 机缘顿悟
- 特殊事件触发，大幅增加经验
- 如战斗中感悟剑道、濒死中感悟生死道

## 大道阶段
每种大道有多个阶段，需积累足够经验才能突破：
1. 初窥门径(100经验)
2. 小有所成(500经验)
3. 略有心得(1500经验)
4. 登堂入室(4000经验)
5. 融会贯通(10000经验)
6. 大道将成(25000经验)
7. 道之圆满(极难)

## 大道突破
- 经验达到阶段要求后可尝试突破
- 成功：进入新阶段，获得新能力
- 失败：经验倒退，需重新积累

## 指令规范
增加经验: \`add 角色.大道.大道列表.[道名].当前经验 100\`
突破阶段: \`add 角色.大道.大道列表.[道名].当前阶段 1\`
`.trim();

// 任务系统规则
export const TASK_SYSTEM_RULES = `
# 任务系统规则

## 任务类型
- **宗门任务**: 宗门发布的任务，完成获得贡献点
- **奇遇任务**: 探索中触发的机缘任务
- **日常任务**: 每日可重复的基础任务
- **修为提升**: 专注于提升境界的任务
- **收集资源**: 收集特定材料的任务
- **战斗挑战**: 击败特定敌人的任务

## 任务状态
- 待接取: 任务已生成，等待玩家接取
- 进行中: 玩家已接取，正在执行
- 已完成: 所有目标达成
- 已放弃: 玩家主动放弃

## 任务目标
每个任务包含1-5个目标，目标类型：
- 击杀: 消灭指定数量的敌人
- 收集: 获得指定物品
- 到达: 前往指定地点
- 交谈: 与指定NPC对话
- 修炼: 达到指定修为进度

## 任务奖励
- 修为: 提升境界进度
- 灵石: 不同品级的灵石
- 物品: 丹药/装备/材料等
- 声望: 在特定势力的声望
- 属性: 永久属性加成(罕见)

## 指令规范
更新任务进度: \`add 社交.任务.当前任务列表[索引].目标列表[目标索引].当前进度 1\`
完成任务: \`set 社交.任务.当前任务列表[索引].任务状态 "已完成"\`
`.trim();
