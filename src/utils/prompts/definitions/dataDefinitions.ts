/**
 * @fileoverview SaveData数据结构定义
 *
 * 【职责】
 * - 定义精简版SaveData数据结构（AI实际接收的数据）
 * - 提供数据结构示例
 * - 说明字段类型和约束
 *
 * 【设计原则】
 * - 纯数据结构定义
 * - 不包含操作规则
 * - 作为数据字典使用
 *
 * 【精简版存档说明】
 * AI接收的是精简版存档，不包含以下字段：
 * - 元数据：只保留"时间"，移除版本号/存档ID/存档名/游戏版本/创建时间/更新时间/游戏时长秒
 * - 社交.记忆：只保留中期记忆和长期记忆，短期记忆通过inject单独发送，隐式中期记忆不发送
 * - 系统：整个域不发送（配置/设置/缓存/行动队列/历史/扩展/联机）
 */

const CHARACTER_STRUCTURE = `
## 1. 角色（V3：角色.*）

### 1.1 身份（Mostly Read-only，路径：\`角色.身份\`）
- 名字: string (只读)
- 性别: "男"|"女"|"其他" (只读)
- 年龄: number (自动计算，禁改)
- 出生日期: {年, 月, 日, 小时?, 分钟?} (只读)
- 世界: string (只读)
- 种族: string (默认"人族")
- 天资: string (只读)
- 出生: string|{名称, 描述} (只读)
- 灵根: string|{名称, 品级, 描述, 属性[], 修炼加成} (只读)
- 天赋: [{名称, 描述}] (只读)
- 先天六司: {根骨, 灵性, 悟性, 气运, 魅力, 心性} (只读，1-10，对修炼/战斗加成占比70%)
- 后天六司: {根骨, 灵性, 悟性, 气运, 魅力, 心性} (可修改，用add，每项上限20，单次增加1-3点，对加成占比30%)
  - 获取方式：装备增幅、天赋效果、服用丹药、机缘奇遇(最多+5)、大道感悟、境界突破
  - 等价原则：先天1点 ≈ 后天2.33点效果

### 1.2 属性（Modifiable，路径：\`角色.属性\`）
- 境界: {名称, 阶段, 当前进度, 下一级所需, 突破描述} (用set更新整个对象，突破时必须更新突破描述)
- 声望: number (用add)
- 气血: {当前, 上限} (当前用add，上限突破时用add)
- 灵气: {当前, 上限} (当前用add，上限突破时用add)
- 神识: {当前, 上限} (当前用add，上限突破时用add)
- 寿命: {当前, 上限} (当前自动增加，上限突破时用add)

### 1.3 位置（路径：\`角色.位置\`）
- 位置: {描述:"大陆·地点", x, y, 灵气浓度} (用set更新整个对象)
  - 描述: string (必填，格式"大陆·区域·地点")
  - x: number (横坐标，范围 0-10000)
  - y: number (纵坐标，范围 0-10000)
  - 灵气浓度: number (必填，1-100，影响修炼速度)
    - 1-20: 灵气稀薄（凡间城镇、荒野）
    - 21-40: 灵气普通（普通修炼场所）
    - 41-60: 灵气充沛（宗门福地、灵脉附近）
    - 61-80: 灵气浓郁（秘境、洞府核心）
    - 81-100: 灵气极盛（仙迹、上古遗址）

### 1.4 效果（buff/debuff，数组；路径：\`角色.效果\`）
- 效果: [{状态名称, 类型:"buff"|"debuff", 生成时间, 持续时间分钟, 状态描述, 强度?, 来源?}]
  - 只能用 push 添加；过期由系统清理
  - **生成时间字段必填**：使用当前 \`元数据.时间\` 的完整对象，格式：{年, 月, 日, 小时, 分钟}
  - 示例：{"action":"push","key":"角色.效果","value":{"状态名称":"灵气充盈","类型":"buff","生成时间":{"年":1000,"月":3,"日":15,"小时":10,"分钟":30},"持续时间分钟":120,"状态描述":"灵气恢复速度提升50%","强度":50}}

### 1.5 装备（Equipment，路径：\`角色.装备\`）
- 装备1: string|null (装备ID或null)
- 装备2: string|null
- 装备3: string|null
- 装备4: string|null
- 装备5: string|null
- 装备6: string|null

### 1.6 法身（NSFW/酒馆端；路径：\`角色.身体\`）
仅当 **系统配置.nsfwMode=true** 且为酒馆端时，才会生成/更新。

- 身高?: number (cm)
- 体重?: number (kg)
- 体脂率?: number (%)
- 三围?: {胸围:number, 腰围:number, 臀围:number}
- 外观特征?: string[]
- 敏感点?: string[]
- 开发度?: {部位名称: number} (0-100)
- 纹身与印记?: string[]
- 胸部描述?: string
- 私处描述?: string
- 生殖器描述?: string
- 部位?: object (预留)
- 部位开发?: object (预留；用于变量面板/扩展系统写入)
`

const DAO_STRUCTURE = `
## 2. 大道（Modifiable，路径：\`角色.大道\`）
- 大道列表: {道名: DaoData对象}

### DaoData对象必需字段
- 道名: string (如"剑道"、"丹道")
- 描述: string (大道描述)
- 阶段列表: DaoStage[] (大道的所有阶段定义，数组)
- 是否解锁: boolean (是否已解锁此道)
- 当前阶段: number (阶段索引，0为"入门")
- 当前经验: number (当前经验值)
- 总经验: number (总累计经验)

### DaoStage对象字段
- 阶段名: string (如"入门"、"小成"、"大成"等)
- 需求经验: number
- 感悟条目?: string[] (阶段感悟)
- 突破需求?: string (突破条件描述)

路径示例：
- set \`角色.大道.大道列表.剑道\` {"道名":"剑道","描述":"以剑入道","阶段列表":[{"阶段名":"入门","需求经验":100}],"是否解锁":true,"当前阶段":0,"当前经验":0,"总经验":0}
- add \`角色.大道.大道列表.剑道.当前经验\` 100
`

const INVENTORY_STRUCTURE = `
## 3. 背包与物品 (路径：角色.背包)

### 3.1 背包结构
- 灵石: {下品: number, 中品: number, 上品: number, 极品: number} (用add增减)
- 物品: {物品ID: Item对象} (用set添加完整对象，用delete删除)

### 3.2 物品通用字段（所有类型必需）
- 物品ID: string (格式: {类型}_时间戳_随机数，如 equip_1704067200000_abc123)
- 名称: string (物品名称)
- 类型: "装备"|"功法"|"丹药"|"材料"|"其他"
- 品质: {quality: "凡"|"黄"|"玄"|"地"|"天"|"仙"|"神", grade: 0-10}
- 数量: number (默认1)
- 描述: string (物品描述)

### 3.3 装备类型特有字段
- 装备增幅?: {
    后天六司?: {根骨?, 灵性?, 悟性?, 气运?, 魅力?, 心性?},
    气血上限?: number,
    灵气上限?: number,
    神识上限?: number
  }
- 特殊效果?: string (如"攻击附带火焰伤害")
- 已装备: boolean (是否已装备到角色.装备槽位)

### 3.4 功法类型特有字段
- 功法效果: string (功法总体效果描述)
- 功法技能: [{
    技能名称: string,
    技能描述: string,
    熟练度要求: number (0-100，达到此进度解锁),
    消耗?: string (如"灵气50")
  }]
- 修炼进度: number (0-100)
- 已解锁技能: string[] (已解锁的技能名称列表)
- 已装备: boolean

### 3.5 丹药/材料/其他类型
- 使用效果?: string (丹药效果描述)
- 稀有度?: string (材料稀有程度)

### 3.6 功法修炼规则
- 修炼进度路径：角色.背包.物品.{功法ID}.修炼进度
- 已解锁技能路径：角色.背包.物品.{功法ID}.已解锁技能
- 操作示例：
  - add 角色.背包.物品.gongfa_001.修炼进度 10
  - 当修炼进度达到技能的熟练度要求时，系统自动解锁技能

### 3.7 掌握技能（只读）
角色.技能.掌握技能 由系统自动从已装备功法的已解锁技能中提取，AI严禁直接修改此字段。
`

const RELATIONS_STRUCTURE = `
## 4. 关系（路径：社交.关系）

### 4.1 NPC创建规则
**必须一次性set完整NPC对象，禁止分步添加！**

必需字段：名字/性别/出生日期/境界/属性/与玩家关系/好感度/当前位置.描述/当前外貌状态/当前内心想法/记忆[]/背包/实时关注

### 4.2 NPC数据结构
- 名字: string (NPC唯一标识)
- 性别: "男"|"女"|"其他"
- 种族: string (默认"人族")
- 出生: string (出身背景)
- 年龄: number (系统自动计算，禁止手动设置)
- 出生日期: {年: number, 月: number, 日: number}
- 外貌描述: string (外貌特征描述)
- 性格特征: string[] (性格标签数组)
- 境界: {名称: string, 阶段: string} (用set更新整个对象)
- 灵根: {名称: string, 品级: string}
- 天赋: [{名称: string, 描述: string}]
- 先天六司: {根骨: number, 灵性: number, 悟性: number, 气运: number, 魅力: number, 心性: number}
- 属性: {气血: {当前, 上限}, 灵气: {当前, 上限}, 神识: {当前, 上限}, 寿元上限: number}
  - 气血/灵气/神识的当前值用add修改，上限在突破时用add
  - 寿元上限在突破时用add增加，当前年龄由出生日期自动计算
- 与玩家关系: string (如"陌生人"/"朋友"/"师徒"/"道侣"/"仇敌")
- 好感度: number (-100~100，用add修改)
- 人格底线: string[] (NPC绝不会做的事)
- 记忆: string[] (NPC对玩家的记忆)
- 记忆总结: string[] (记忆的总结)
- 当前位置: {描述: string, x?: number, y?: number}
- 势力归属: string (所属宗门/势力)
- 当前外貌状态: string (当前穿着、表情等)
- 当前内心想法: string (NPC此刻的想法)
- 背包: {灵石: {下品, 中品, 上品, 极品}, 物品: {}}
- 实时关注: boolean (若为true，即使NPC不在玩家身边，每回合也要推演并更新其动态：位置、状态、内心想法等)
- 私密信息?: PrivacyProfile (NSFW模式专用)

### 4.3 NPC创建示例（正确做法）
\`\`\`json
{"action":"set","key":"社交.关系.林婉儿","value":{
  "名字":"林婉儿",
  "性别":"女",
  "种族":"人族",
  "出生":"青云宗内门弟子",
  "出生日期":{"年":985,"月":3,"日":15},
  "外貌描述":"身着淡蓝色道袍，容貌清丽，眉眼间带着几分英气",
  "性格特征":["温婉","聪慧","坚韧"],
  "境界":{"名称":"筑基","阶段":"中期"},
  "灵根":{"名称":"水灵根","品级":"上品"},
  "天赋":[{"名称":"水系亲和","描述":"对水系功法领悟力极强"}],
  "先天六司":{"根骨":6,"灵性":8,"悟性":7,"气运":5,"魅力":8,"心性":7},
  "属性":{"气血":{"当前":1200,"上限":1200},"灵气":{"当前":1500,"上限":1500},"神识":{"当前":600,"上限":600},"寿元上限":200},
  "与玩家关系":"同门师妹",
  "好感度":30,
  "人格底线":["不会背叛宗门","不会伤害无辜"],
  "记忆":["初次见面于宗门大殿"],
  "记忆总结":[],
  "当前位置":{"描述":"青云宗·练功房"},
  "势力归属":"青云宗",
  "当前外貌状态":"正在打坐修炼，神情专注",
  "当前内心想法":"这位新来的师兄看起来资质不错",
  "背包":{"灵石":{"下品":100,"中品":10,"上品":0,"极品":0},"物品":{}},
  "实时关注":true
}}
\`\`\`

### 4.4 NPC更新操作
- 好感度变化：add \`社交.关系.林婉儿.好感度\` 10
- 添加记忆：push \`社交.关系.林婉儿.记忆\` "一起击退了妖兽"
- 更新状态：set \`社交.关系.林婉儿.当前外貌状态\` "面带微笑"
- 更新想法：set \`社交.关系.林婉儿.当前内心想法\` "他比我想象的更可靠"
- 境界突破：set \`社交.关系.林婉儿.境界\` {"名称":"筑基","阶段":"后期"}
- 气血变化：add \`社交.关系.林婉儿.属性.气血.当前\` -100
- 寿元上限增加：add \`社交.关系.林婉儿.属性.寿元上限\` 100

### 4.5 NSFW：PrivacyProfile（路径：社交.关系.{NPC名}.私密信息）
仅NSFW模式可用：
- 是否为处女: boolean
- 性格倾向/性取向/当前性状态/体液分泌状态: string
- 身体部位: [{部位名称, 敏感度:0-100, 开发度:0-100, 特征描述}]
- 性癖好/性伴侣名单/特殊体质: string[]
- 性渴望程度/性交总次数: number
`

const MEMORY_STRUCTURE = `
## 5. 记忆 (Read-only，路径：社交.记忆)
AI严禁通过tavern_commands修改记忆。记忆由系统根据响应JSON中的mid_term_memory字段自动处理。
- 中期记忆: [string]
- 长期记忆: [string]
`

const WORLD_INFO_STRUCTURE = `
## 6. 世界（路径：世界.信息；联机模式通常只读）

### 6.1 势力信息 (可修改)
路径: 世界.信息.势力信息[索引]
- 名称: string (势力名称)
- 类型: string (如"宗门"/"世家"/"散修联盟")
- 等级: string (势力等级)
- 位置: string (势力所在地)
- 描述: string (势力描述)
- 特色: string[] (势力特色)
- 加入条件: string[] (加入要求)
- 加入好处: string[] (加入后的好处)
- 与玩家关系: "敌对"|"中立"|"友好" (用set修改)
- 声望值: number (用add修改，-100~100)
- 成员数量: {
    总数: number,
    按境界: {境界名: number}, // 如 {"练气":500,"筑基":200,"金丹":50}
    按职位: {职位名: number}  // 如 {"外门弟子":400,"内门弟子":200,"长老":20}
  } (用set更新)
- 领导层: {宗主: string, 宗主修为: string, 综合战力: string} (用set更新)

### 6.2 势力操作示例
- 声望变化：add \`世界.信息.势力信息[0].声望值\` 20
- 关系变化：set \`世界.信息.势力信息[0].与玩家关系\` "友好"

### 6.3 地点信息 (可修改)
路径: 世界.信息.地点信息
- 用push添加新地点：
\`\`\`json
{"action":"push","key":"世界.信息.地点信息","value":{
  "名称":"幽冥洞府",
  "类型":"秘境",
  "位置":"青云山脉深处",
  "coordinates":{"x":3500,"y":7200},
  "描述":"一处上古修士遗留的洞府，内有机缘与危险并存",
  "安全等级":"危险",
  "开放状态":"已发现"
}}
\`\`\`
`

const GAME_STATE_STRUCTURE = `
## 7. 时间与宗门

### 7.1 时间（路径：元数据.时间）
- 年: number (当前年份)
- 月: number (1-12)
- 日: number (1-31)
- 小时: number (0-23)
- 分钟: number (0-59)
- 时间推进：用 add \`元数据.时间.分钟\` 推进，系统自动进位
- 示例：add \`元数据.时间.分钟\` 60 (推进1小时)

### 7.2 宗门系统（路径：社交.宗门）
开局时玩家未加入宗门时 社交.宗门 应为 null。

**加入宗门时**：set 社交.宗门 完整对象，包含：
- 版本: number
- 当前宗门: string (宗门名称)
- 成员信息: {职位, 贡献点, 加入时间}
- 宗门档案: {宗门名: WorldFaction对象}
- 宗门成员: {宗门名: string[]}
- 宗门藏经阁: {宗门名: 功法物品[]}
- 宗门贡献商店: {宗门名: 商品[]}

**藏经阁/贡献商店**：玩家首次访问时动态生成
- 路径：社交.宗门.宗门藏经阁.[宗门名] 或 社交.宗门.宗门贡献商店.[宗门名]
- 藏经阁功法 4-6 个，贡献商店物品 5-8 个
- 内容符合宗门特色，品质分布合理
- cost定价参考：凡80/黄200/玄500/地900/天1500

### 7.3 宗门操作示例
- 贡献点变化：add \`社交.宗门.成员信息.贡献点\` 100
- 职位晋升：set \`社交.宗门.成员信息.职位\` "内门弟子"
`

const EVENT_SYSTEM_STRUCTURE = `
## 8. 事件系统（路径：社交.事件）

### 8.1 事件记录
路径: 社交.事件.事件记录 (数组，用push添加新事件)

### 8.2 事件对象结构 (GameEvent)
- 事件ID: string (格式: event_时间戳_随机数，如 event_1704067200000_abc123)
- 事件名称: string (简短的事件标题)
- 事件类型: string (可选值：)
  - "宗门大战" - 宗门间的大规模冲突
  - "世界变革" - 影响整个世界的重大变化
  - "异宝降世" - 珍贵宝物出现
  - "秘境现世" - 秘境开启
  - "人物风波" - 重要人物相关事件
- 事件描述: string (详细描述，包含地点、涉及势力/人物、直接后果)
- 影响等级: "轻微"|"中等"|"重大"|"灾难" (可选)
- 影响范围: string (如"青云宗周边"/"整个东洲") (可选)
- 相关人物: string[] (涉及的NPC名字) (可选)
- 事件来源: "随机"|"玩家影响"|"系统"
- 发生时间: {年: number, 月: number, 日: number, 小时: number, 分钟: number} (必填)

### 8.3 事件创建示例
\`\`\`json
{"action":"push","key":"社交.事件.事件记录","value":{
  "事件ID":"event_1704067200000_xyz789",
  "事件名称":"青云宗遭袭",
  "事件类型":"宗门大战",
  "事件描述":"魔道势力突袭青云宗山门，双方激战三日，青云宗损失惨重但最终击退来敌",
  "影响等级":"重大",
  "影响范围":"青云山脉",
  "相关人物":["青云宗主","魔道长老"],
  "事件来源":"系统",
  "发生时间":{"年":1000,"月":6,"日":15,"小时":12,"分钟":0}
}}
\`\`\`
`

export const SAVE_DATA_STRUCTURE = `
# 【数据结构定义】精简版SaveData

> 你收到的是精简版存档：元数据只有时间，社交.记忆只有中期和长期，系统域不发送

${CHARACTER_STRUCTURE}
${DAO_STRUCTURE}
${INVENTORY_STRUCTURE}
${RELATIONS_STRUCTURE}
${MEMORY_STRUCTURE}
${WORLD_INFO_STRUCTURE}
${GAME_STATE_STRUCTURE}
${EVENT_SYSTEM_STRUCTURE}
`.trim()

export const DATA_STRUCTURE_EXAMPLES = ``

export function stripNsfwContent(input: string): string {
  return input
    .split('\n')
    .filter((line) => !/nsfw|私密信息|身体部位开发|法身|角色\.身体|privacy/i.test(line))
    .join('\n')
    .trim();
}

export function getSaveDataStructureForEnv(isTavern: boolean): string {
  if (isTavern) return SAVE_DATA_STRUCTURE;
  return stripNsfwContent(SAVE_DATA_STRUCTURE);
}
