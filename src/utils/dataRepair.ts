/**
 * æ•°æ®ä¿®å¤å’Œæ¸…æ´—å·¥å…·
 *
 * åŠŸèƒ½:
 * - ä¿®å¤AIè¿”å›çš„ä¸å®Œæ•´æˆ–é”™è¯¯çš„å­˜æ¡£æ•°æ®
 * - å¡«å……ç¼ºå¤±çš„å¿…éœ€å­—æ®µ
 * - éªŒè¯å¹¶ä¿®æ­£æ•°æ®ç±»å‹å’ŒèŒƒå›´
 *
 * è¢«ä»¥ä¸‹æ–‡ä»¶å¼•ç”¨:
 * - src/stores/characterStore.ts
 */

import type { SaveData, Item, NpcProfile, GameTime, Realm, QuestType } from '@/types/game';
import type { GradeType } from '@/data/itemQuality';
import { cloneDeep } from 'lodash';

/**
 * ä¿®å¤å¹¶æ¸…æ´—å­˜æ¡£æ•°æ®ï¼Œç¡®ä¿æ‰€æœ‰å¿…éœ€å­—æ®µå­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®
 */
export function repairSaveData(saveData: SaveData | null | undefined): SaveData {
  console.log('[æ•°æ®ä¿®å¤] å¼€å§‹ä¿®å¤å­˜æ¡£æ•°æ®');

  if (!saveData || typeof saveData !== 'object') {
    console.error('[æ•°æ®ä¿®å¤] âŒ å­˜æ¡£æ•°æ®ä¸ºç©ºæˆ–æ— æ•ˆï¼Œåˆ›å»ºé»˜è®¤å­˜æ¡£');
    return createMinimalSaveData();
  }

  const repaired = cloneDeep(saveData);

  // 1. ä¿®å¤è§’è‰²åŸºç¡€ä¿¡æ¯
  if (!repaired.è§’è‰²åŸºç¡€ä¿¡æ¯ || typeof repaired.è§’è‰²åŸºç¡€ä¿¡æ¯ !== 'object') {
    console.warn('[æ•°æ®ä¿®å¤] è§’è‰²åŸºç¡€ä¿¡æ¯ç¼ºå¤±ï¼Œåˆ›å»ºé»˜è®¤å€¼');
    repaired.è§’è‰²åŸºç¡€ä¿¡æ¯ = {
      åå­—: 'æ— åä¿®å£«',
      æ€§åˆ«: 'ç”·',
      å‡ºç”Ÿæ—¥æœŸ: { å¹´: 982, æœˆ: 1, æ—¥: 1 },
      ä¸–ç•Œ: 'æœå¤©å¤§é™†' as any,
      å¤©èµ„: 'å‡¡äºº' as any,
      å‡ºç”Ÿ: 'æ•£ä¿®',
      çµæ ¹: 'äº”è¡Œæ‚çµæ ¹',
      å¤©èµ‹: [],
      å…ˆå¤©å…­å¸: { æ ¹éª¨: 5, çµæ€§: 5, æ‚Ÿæ€§: 5, æ°”è¿: 5, é­…åŠ›: 5, å¿ƒæ€§: 5 },
      åå¤©å…­å¸: { æ ¹éª¨: 0, çµæ€§: 0, æ‚Ÿæ€§: 0, æ°”è¿: 0, é­…åŠ›: 0, å¿ƒæ€§: 0 }
    };
  } else {
    // ç¡®ä¿å¿…éœ€å­—æ®µå­˜åœ¨
    repaired.è§’è‰²åŸºç¡€ä¿¡æ¯.åå­— = repaired.è§’è‰²åŸºç¡€ä¿¡æ¯.åå­— || 'æ— åä¿®å£«';
    repaired.è§’è‰²åŸºç¡€ä¿¡æ¯.æ€§åˆ« = repaired.è§’è‰²åŸºç¡€ä¿¡æ¯.æ€§åˆ« || 'ç”·';
    repaired.è§’è‰²åŸºç¡€ä¿¡æ¯.ä¸–ç•Œ = repaired.è§’è‰²åŸºç¡€ä¿¡æ¯.ä¸–ç•Œ || 'æœå¤©å¤§é™†';

    // ç¡®ä¿å‡ºç”Ÿæ—¥æœŸå­—æ®µå­˜åœ¨
    if (!repaired.è§’è‰²åŸºç¡€ä¿¡æ¯.å‡ºç”Ÿæ—¥æœŸ) {
      repaired.è§’è‰²åŸºç¡€ä¿¡æ¯.å‡ºç”Ÿæ—¥æœŸ = { å¹´: 982, æœˆ: 1, æ—¥: 1 };
    }

    // ä¿®å¤å…ˆå¤©å…­å¸
    if (!repaired.è§’è‰²åŸºç¡€ä¿¡æ¯.å…ˆå¤©å…­å¸ || typeof repaired.è§’è‰²åŸºç¡€ä¿¡æ¯.å…ˆå¤©å…­å¸ !== 'object') {
      repaired.è§’è‰²åŸºç¡€ä¿¡æ¯.å…ˆå¤©å…­å¸ = { æ ¹éª¨: 5, çµæ€§: 5, æ‚Ÿæ€§: 5, æ°”è¿: 5, é­…åŠ›: 5, å¿ƒæ€§: 5 };
    } else {
      const attrs = repaired.è§’è‰²åŸºç¡€ä¿¡æ¯.å…ˆå¤©å…­å¸;
      attrs.æ ¹éª¨ = validateNumber(attrs.æ ¹éª¨, 0, 10, 5);
      attrs.çµæ€§ = validateNumber(attrs.çµæ€§, 0, 10, 5);
      attrs.æ‚Ÿæ€§ = validateNumber(attrs.æ‚Ÿæ€§, 0, 10, 5);
      attrs.æ°”è¿ = validateNumber(attrs.æ°”è¿, 0, 10, 5);
      attrs.é­…åŠ› = validateNumber(attrs.é­…åŠ›, 0, 10, 5);
      attrs.å¿ƒæ€§ = validateNumber(attrs.å¿ƒæ€§, 0, 10, 5);
    }

    // ä¿®å¤åå¤©å…­å¸
    if (!repaired.è§’è‰²åŸºç¡€ä¿¡æ¯.åå¤©å…­å¸ || typeof repaired.è§’è‰²åŸºç¡€ä¿¡æ¯.åå¤©å…­å¸ !== 'object') {
      repaired.è§’è‰²åŸºç¡€ä¿¡æ¯.åå¤©å…­å¸ = { æ ¹éª¨: 0, çµæ€§: 0, æ‚Ÿæ€§: 0, æ°”è¿: 0, é­…åŠ›: 0, å¿ƒæ€§: 0 };
    }
  }

  // 2. ä¿®å¤ç©å®¶è§’è‰²çŠ¶æ€
  if (!repaired.ç©å®¶è§’è‰²çŠ¶æ€ || typeof repaired.ç©å®¶è§’è‰²çŠ¶æ€ !== 'object') {
    console.warn('[æ•°æ®ä¿®å¤] ç©å®¶è§’è‰²çŠ¶æ€ç¼ºå¤±ï¼Œåˆ›å»ºé»˜è®¤å€¼');
    repaired.ç©å®¶è§’è‰²çŠ¶æ€ = createDefaultPlayerStatus();
  } else {
    // ä¿®å¤å¢ƒç•Œ
    repaired.ç©å®¶è§’è‰²çŠ¶æ€.å¢ƒç•Œ = repairRealm(repaired.ç©å®¶è§’è‰²çŠ¶æ€.å¢ƒç•Œ);

    // ä¿®å¤å±æ€§
    repaired.ç©å®¶è§’è‰²çŠ¶æ€.æ°”è¡€ = repairValuePair(repaired.ç©å®¶è§’è‰²çŠ¶æ€.æ°”è¡€, 100, 100);
    repaired.ç©å®¶è§’è‰²çŠ¶æ€.çµæ°” = repairValuePair(repaired.ç©å®¶è§’è‰²çŠ¶æ€.çµæ°”, 50, 50);
    repaired.ç©å®¶è§’è‰²çŠ¶æ€.ç¥è¯† = repairValuePair(repaired.ç©å®¶è§’è‰²çŠ¶æ€.ç¥è¯†, 30, 30);
    repaired.ç©å®¶è§’è‰²çŠ¶æ€.å¯¿å‘½ = repairValuePair(repaired.ç©å®¶è§’è‰²çŠ¶æ€.å¯¿å‘½, 18, 80);

    // ä¿®å¤ä½ç½®
    if (!repaired.ç©å®¶è§’è‰²çŠ¶æ€.ä½ç½® || typeof repaired.ç©å®¶è§’è‰²çŠ¶æ€.ä½ç½® !== 'object') {
      repaired.ç©å®¶è§’è‰²çŠ¶æ€.ä½ç½® = { æè¿°: 'æœå¤©å¤§é™†Â·æ— åä¹‹åœ°' };
    } else if (!repaired.ç©å®¶è§’è‰²çŠ¶æ€.ä½ç½®.æè¿°) {
      repaired.ç©å®¶è§’è‰²çŠ¶æ€.ä½ç½®.æè¿° = 'æœå¤©å¤§é™†Â·æ— åä¹‹åœ°';
    }

    // ä¿®å¤çŠ¶æ€æ•ˆæœ
    if (!Array.isArray(repaired.ç©å®¶è§’è‰²çŠ¶æ€.çŠ¶æ€æ•ˆæœ)) {
      repaired.ç©å®¶è§’è‰²çŠ¶æ€.çŠ¶æ€æ•ˆæœ = [];
    }

    // ä¿®å¤å£°æœ›
    repaired.ç©å®¶è§’è‰²çŠ¶æ€.å£°æœ› = validateNumber(repaired.ç©å®¶è§’è‰²çŠ¶æ€.å£°æœ›, 0, 999999, 0);
  }

  // 3. ä¿®å¤è£…å¤‡æ 
  if (!repaired.è£…å¤‡æ  || typeof repaired.è£…å¤‡æ  !== 'object') {
    repaired.è£…å¤‡æ  = { è£…å¤‡1: null, è£…å¤‡2: null, è£…å¤‡3: null, è£…å¤‡4: null, è£…å¤‡5: null, è£…å¤‡6: null };
  }

  // 4. ä¿®å¤èƒŒåŒ…
  if (!repaired.èƒŒåŒ… || typeof repaired.èƒŒåŒ… !== 'object') {
    repaired.èƒŒåŒ… = {
      çµçŸ³: { ä¸‹å“: 0, ä¸­å“: 0, ä¸Šå“: 0, æå“: 0 },
      ç‰©å“: {}
    };
  } else {
    // ä¿®å¤çµçŸ³
    if (!repaired.èƒŒåŒ….çµçŸ³ || typeof repaired.èƒŒåŒ….çµçŸ³ !== 'object') {
      repaired.èƒŒåŒ….çµçŸ³ = { ä¸‹å“: 0, ä¸­å“: 0, ä¸Šå“: 0, æå“: 0 };
    } else {
      repaired.èƒŒåŒ….çµçŸ³.ä¸‹å“ = validateNumber(repaired.èƒŒåŒ….çµçŸ³.ä¸‹å“, 0, 999999999, 0);
      repaired.èƒŒåŒ….çµçŸ³.ä¸­å“ = validateNumber(repaired.èƒŒåŒ….çµçŸ³.ä¸­å“, 0, 999999999, 0);
      repaired.èƒŒåŒ….çµçŸ³.ä¸Šå“ = validateNumber(repaired.èƒŒåŒ….çµçŸ³.ä¸Šå“, 0, 999999999, 0);
      repaired.èƒŒåŒ….çµçŸ³.æå“ = validateNumber(repaired.èƒŒåŒ….çµçŸ³.æå“, 0, 999999999, 0);
    }

    // ä¿®å¤ç‰©å“
    if (!repaired.èƒŒåŒ….ç‰©å“ || typeof repaired.èƒŒåŒ….ç‰©å“ !== 'object') {
      repaired.èƒŒåŒ….ç‰©å“ = {};
    } else {
      // æ¸…ç†æ— æ•ˆç‰©å“
      const validItems: Record<string, Item> = {};
      for (const [id, item] of Object.entries(repaired.èƒŒåŒ….ç‰©å“)) {
        if (item && typeof item === 'object' && item.åç§°) {
          validItems[id] = repairItem(item as Item);
        }
      }
      repaired.èƒŒåŒ….ç‰©å“ = validItems;
    }
  }

  // 5. ä¿®å¤äººç‰©å…³ç³»
  if (!repaired.äººç‰©å…³ç³» || typeof repaired.äººç‰©å…³ç³» !== 'object') {
    repaired.äººç‰©å…³ç³» = {};
  } else {
    // æ¸…ç†æ— æ•ˆNPC
    const validNpcs: Record<string, NpcProfile> = {};
    for (const [name, npc] of Object.entries(repaired.äººç‰©å…³ç³»)) {
      if (npc && typeof npc === 'object' && (npc as any).åå­—) {
        validNpcs[name] = repairNpc(npc as NpcProfile);
      }
    }
    repaired.äººç‰©å…³ç³» = validNpcs;
  }

  // 6. ä¿®å¤è®°å¿†
  if (!repaired.è®°å¿† || typeof repaired.è®°å¿† !== 'object') {
    repaired.è®°å¿† = { çŸ­æœŸè®°å¿†: [], ä¸­æœŸè®°å¿†: [], é•¿æœŸè®°å¿†: [] };
  } else {
    repaired.è®°å¿†.çŸ­æœŸè®°å¿† = Array.isArray(repaired.è®°å¿†.çŸ­æœŸè®°å¿†) ? repaired.è®°å¿†.çŸ­æœŸè®°å¿† : [];
    repaired.è®°å¿†.ä¸­æœŸè®°å¿† = Array.isArray(repaired.è®°å¿†.ä¸­æœŸè®°å¿†) ? repaired.è®°å¿†.ä¸­æœŸè®°å¿† : [];
    repaired.è®°å¿†.é•¿æœŸè®°å¿† = Array.isArray(repaired.è®°å¿†.é•¿æœŸè®°å¿†) ? repaired.è®°å¿†.é•¿æœŸè®°å¿† : [];
  }

  // 7. ä¿®å¤æ¸¸æˆæ—¶é—´
  repaired.æ¸¸æˆæ—¶é—´ = repairGameTime(repaired.æ¸¸æˆæ—¶é—´);

  // 8. ä¿®å¤ä¸‰åƒå¤§é“
  if (!repaired.ä¸‰åƒå¤§é“ || typeof repaired.ä¸‰åƒå¤§é“ !== 'object' || !repaired.ä¸‰åƒå¤§é“.å¤§é“åˆ—è¡¨) {
    repaired.ä¸‰åƒå¤§é“ = { å¤§é“åˆ—è¡¨: {} };
  }

  // 9. ä¿®å¤ä¿®ç‚¼åŠŸæ³•å¼•ç”¨
  if (repaired.ä¿®ç‚¼åŠŸæ³• && typeof repaired.ä¿®ç‚¼åŠŸæ³• === 'object') {
    const technique = repaired.ä¿®ç‚¼åŠŸæ³• as any;

    // æ£€æŸ¥å¼•ç”¨å¯¹è±¡æ˜¯å¦æœ‰æ•ˆ
    if (!technique.ç‰©å“ID) {
      console.warn('[æ•°æ®ä¿®å¤] ä¿®ç‚¼åŠŸæ³•ç¼ºå°‘ç‰©å“IDï¼Œæ¸…ç©º');
      repaired.ä¿®ç‚¼åŠŸæ³• = null;
    } else {
      // éªŒè¯å¼•ç”¨çš„ç‰©å“æ˜¯å¦å­˜åœ¨äºèƒŒåŒ…ä¸­
      const referencedItem = repaired.èƒŒåŒ…?.ç‰©å“?.[technique.ç‰©å“ID];
      if (!referencedItem) {
        console.warn('[æ•°æ®ä¿®å¤] ä¿®ç‚¼åŠŸæ³•å¼•ç”¨çš„ç‰©å“ä¸å­˜åœ¨äºèƒŒåŒ…ï¼Œæ¸…ç©ºå¼•ç”¨');
        repaired.ä¿®ç‚¼åŠŸæ³• = null;
      } else if (referencedItem.ç±»å‹ !== 'åŠŸæ³•') {
        console.warn('[æ•°æ®ä¿®å¤] ä¿®ç‚¼åŠŸæ³•å¼•ç”¨çš„ç‰©å“ä¸æ˜¯åŠŸæ³•ç±»å‹ï¼Œæ¸…ç©ºå¼•ç”¨');
        repaired.ä¿®ç‚¼åŠŸæ³• = null;
      } else {
        // ç¡®ä¿åç§°ä¸èƒŒåŒ…ä¸­çš„ç‰©å“ä¸€è‡´
        if (!technique.åç§° || technique.åç§° !== referencedItem.åç§°) {
          console.log('[æ•°æ®ä¿®å¤] åŒæ­¥ä¿®ç‚¼åŠŸæ³•åç§°ä¸èƒŒåŒ…ç‰©å“');
          technique.åç§° = referencedItem.åç§°;
        }
      }
    }
  }

  // 10. ä¿®å¤æŒæ¡æŠ€èƒ½
  if (!Array.isArray(repaired.æŒæ¡æŠ€èƒ½)) {
    repaired.æŒæ¡æŠ€èƒ½ = [];
  }


  console.log('[æ•°æ®ä¿®å¤] âœ… å­˜æ¡£æ•°æ®ä¿®å¤å®Œæˆ');
  return repaired;
}

/**
 * æ ¹æ®å¢ƒç•Œå’Œé˜¶æ®µç”Ÿæˆä¿®ä»™å°è¯´é£æ ¼çš„çªç ´æè¿°
 */
function getDefaultBreakthroughDescription(realmName?: string, stage?: string): string {
  const name = realmName || 'å‡¡äºº';
  const currentStage = stage || '';

  // å‡¡äººå¢ƒç•Œ
  if (name === 'å‡¡äºº') {
    return 'å¼•æ°”å…¥ä½“ï¼Œæ„Ÿæ‚Ÿå¤©åœ°çµæ°”ï¼Œè¸ä¸Šä¿®ä»™ç¬¬ä¸€æ­¥';
  }

  // å®šä¹‰å„å¢ƒç•Œçš„çªç ´æè¿°
  const realmDescriptions: Record<string, Record<string, string>> = {
    'ç»ƒæ°”': {
      'åˆæœŸ': 'å‡èšä¸¹ç”°çµæ°”ï¼Œæ‰“é€šä»»ç£äºŒè„‰ï¼Œå†²å‡»ç»ƒæ°”ä¸­æœŸ',
      'ä¸­æœŸ': 'æ‹“å®½ç»è„‰ï¼Œæå‡çµæ°”å®¹é‡ï¼Œå†²å‡»ç»ƒæ°”åæœŸ',
      'åæœŸ': 'å‡å®æ ¹åŸºï¼Œæ„Ÿæ‚Ÿå¤©åœ°æ³•åˆ™ï¼Œå†²å‡»ç»ƒæ°”åœ†æ»¡',
      'åœ†æ»¡': 'çµæ°”è´¯é€šå‘¨å¤©ï¼Œå‡ç»ƒçµæ ¹æœ¬æºï¼Œå‡†å¤‡ç­‘åŸº',
      '': 'æ¬è¿å‘¨å¤©ï¼Œå‡èšçµæ°”ï¼Œå¤¯å®ç»ƒæ°”æ ¹åŸº'
    },
    'ç­‘åŸº': {
      'åˆæœŸ': 'å‡èšé“å°ï¼Œå°†çµæ°”å‹ç¼©å‡å®ï¼Œå†²å‡»ç­‘åŸºä¸­æœŸ',
      'ä¸­æœŸ': 'ç¨³å›ºé“åŸºï¼Œæ‰©å……ä¸¹ç”°å®¹é‡ï¼Œå†²å‡»ç­‘åŸºåæœŸ',
      'åæœŸ': 'æ„Ÿæ‚Ÿå¤©åœ°æ³•åˆ™ï¼Œå‡ç»ƒé‡‘ä¸¹é›å½¢ï¼Œå†²å‡»ç­‘åŸºåœ†æ»¡',
      'åœ†æ»¡': 'é“åŸºåœ†æ»¡ï¼Œç ´è€Œåç«‹ï¼Œå°†çµæ°”å‡èšæˆé‡‘ä¸¹',
      '': 'å¤¯å®é“åŸºï¼Œå‹ç¼©çµæ°”ï¼Œæå‡ç­‘åŸºå¢ƒç•Œ'
    },
    'é‡‘ä¸¹': {
      'åˆæœŸ': 'å‡å®é‡‘ä¸¹ï¼Œåˆ»ç”»ç¬¦æ–‡ï¼Œå†²å‡»é‡‘ä¸¹ä¸­æœŸ',
      'ä¸­æœŸ': 'æ·¬ç‚¼é‡‘ä¸¹ï¼Œé¢†æ‚Ÿé“éŸµï¼Œå†²å‡»é‡‘ä¸¹åæœŸ',
      'åæœŸ': 'é‡‘ä¸¹å¤§æˆï¼Œè•´å…»å…ƒç¥ï¼Œå†²å‡»é‡‘ä¸¹åœ†æ»¡',
      'åœ†æ»¡': 'ç ´ä¸¹æˆå©´ï¼Œå…ƒç¥å‡ºçªï¼Œè¸å…¥å…ƒå©´å¢ƒç•Œ',
      '': 'æ·¬ç‚¼é‡‘ä¸¹æœ¬æºï¼Œåˆ»ç”»å¤©åœ°ç¬¦æ–‡ï¼Œæå‡é‡‘ä¸¹å“è´¨'
    },
    'å…ƒå©´': {
      'åˆæœŸ': 'ç¨³å›ºå…ƒå©´ï¼Œå‡ç»ƒç¥é­‚ï¼Œå†²å‡»å…ƒå©´ä¸­æœŸ',
      'ä¸­æœŸ': 'å…ƒå©´å£®å¤§ï¼Œæ„Ÿæ‚Ÿå¤§é“ï¼Œå†²å‡»å…ƒå©´åæœŸ',
      'åæœŸ': 'å…ƒå©´å¤§æˆï¼Œå‡ç»ƒå…ƒç¥ï¼Œå†²å‡»å…ƒå©´åœ†æ»¡',
      'åœ†æ»¡': 'å…ƒç¥èœ•å˜ï¼Œè‚‰èº«æˆåœ£ï¼Œå‡†å¤‡åŒ–ç¥',
      '': 'å£®å¤§å…ƒå©´ï¼Œæ·¬ç‚¼ç¥é­‚ï¼Œæå‡å…ƒå©´å¢ƒç•Œ'
    },
    'åŒ–ç¥': {
      'åˆæœŸ': 'ç¥é­‚åˆä¸€ï¼Œé¢†æ‚Ÿæ³•åˆ™ï¼Œå†²å‡»åŒ–ç¥ä¸­æœŸ',
      'ä¸­æœŸ': 'å‡èšç¥æ ¼ï¼Œå‚æ‚Ÿå¤©é“ï¼Œå†²å‡»åŒ–ç¥åæœŸ',
      'åæœŸ': 'ç¥æ ¼å¤§æˆï¼Œèåˆæ³•åˆ™ï¼Œå†²å‡»åŒ–ç¥åœ†æ»¡',
      'åœ†æ»¡': 'ç‚¼è™šåˆé“ï¼Œè‚‰èº«ä¸ç­ï¼Œå‡†å¤‡çªç ´ç‚¼è™š',
      '': 'æ„Ÿæ‚Ÿå¤§é“æ³•åˆ™ï¼Œå‡ç»ƒç¥æ ¼ï¼Œæå‡åŒ–ç¥å¢ƒç•Œ'
    },
    'ç‚¼è™š': {
      'åˆæœŸ': 'ç‚¼è™šåŒ–å®ï¼Œè™šç©ºå‡å½¢ï¼Œå†²å‡»ç‚¼è™šä¸­æœŸ',
      'ä¸­æœŸ': 'è™šå®åˆä¸€ï¼Œå‚æ‚Ÿç©ºé—´æ³•åˆ™ï¼Œå†²å‡»ç‚¼è™šåæœŸ',
      'åæœŸ': 'æ’•è£‚è™šç©ºï¼ŒæŒæ§ç©ºé—´ï¼Œå†²å‡»ç‚¼è™šåœ†æ»¡',
      'åœ†æ»¡': 'è™šç©ºå¤§æˆï¼Œä¸å¤©åœ°åˆä¸€ï¼Œå‡†å¤‡æ¸¡åŠ«',
      '': 'ç‚¼åŒ–è™šç©ºä¹‹åŠ›ï¼Œæ„Ÿæ‚Ÿç©ºé—´å¥¥ä¹‰ï¼Œæå‡ç‚¼è™šå¢ƒç•Œ'
    },
    'åˆä½“': {
      'åˆæœŸ': 'å¤©äººåˆä¸€ï¼Œä¸å¤©åœ°å…±é¸£ï¼Œå†²å‡»åˆä½“ä¸­æœŸ',
      'ä¸­æœŸ': 'é¢†æ‚Ÿå¤©é“ï¼ŒæŒæ§å¤©åœ°ä¹‹åŠ›ï¼Œå†²å‡»åˆä½“åæœŸ',
      'åæœŸ': 'å¤©åœ°è®¤å¯ï¼Œæ³•åˆ™åŠ èº«ï¼Œå†²å‡»åˆä½“åœ†æ»¡',
      'åœ†æ»¡': 'ä¸é“åˆçœŸï¼Œå¤©åŠ«å°†è‡³ï¼Œå‡†å¤‡æ¸¡åŠ«é£å‡',
      '': 'æ„Ÿæ‚Ÿå¤©åœ°å¤§é“ï¼Œä¸å¤©åœ°å…±é¸£ï¼Œæå‡åˆä½“å¢ƒç•Œ'
    },
    'å¤§ä¹˜': {
      'åˆæœŸ': 'å¤§é“åœ†æ»¡ï¼Œæ³•åˆ™å…¥ä½“ï¼Œå†²å‡»å¤§ä¹˜ä¸­æœŸ',
      'ä¸­æœŸ': 'å¤©é“è®¤å¯ï¼Œå‚æ‚Ÿä»™é“ï¼Œå†²å‡»å¤§ä¹˜åæœŸ',
      'åæœŸ': 'ä»™éŸµåˆç°ï¼Œå‡†å¤‡æ¸¡åŠ«ï¼Œå†²å‡»å¤§ä¹˜åœ†æ»¡',
      'åœ†æ»¡': 'æ¸¡ä¹ä¹å¤©åŠ«ï¼Œé£å‡ä»™ç•Œï¼Œè¶…è„±å‡¡å°˜',
      '': 'æ„Ÿæ‚Ÿä»™é“å¥¥ä¹‰ï¼Œå‡ç»ƒä»™ä½“ï¼Œå‡†å¤‡é£å‡'
    }
  };

  // è·å–å¯¹åº”å¢ƒç•Œçš„æè¿°
  const stageDescriptions = realmDescriptions[name];
  if (stageDescriptions) {
    return stageDescriptions[currentStage] || stageDescriptions[''] || `æ„Ÿæ‚Ÿ${name}å¢ƒç•Œå¥¥ä¹‰ï¼Œæå‡ä¿®ä¸ºå¢ƒç•Œ`;
  }

  // æœªçŸ¥å¢ƒç•Œçš„é€šç”¨æè¿°
  const genericDescriptions: Record<string, string> = {
    'åˆæœŸ': `å‡ç»ƒ${name}åˆæœŸæ ¹åŸºï¼Œå†²å‡»${name}ä¸­æœŸ`,
    'ä¸­æœŸ': `ç¨³å›º${name}ä¸­æœŸä¿®ä¸ºï¼Œå†²å‡»${name}åæœŸ`,
    'åæœŸ': `åœ†æ»¡${name}åæœŸå¢ƒç•Œï¼Œå†²å‡»${name}åœ†æ»¡`,
    'åœ†æ»¡': `${name}åœ†æ»¡å¤§æˆï¼Œå‡†å¤‡çªç ´ä¸‹ä¸€å¢ƒç•Œ`,
    '': `æ„Ÿæ‚Ÿ${name}å¢ƒç•Œå¥¥ä¹‰ï¼Œæå‡ä¿®ä¸º`
  };

  return genericDescriptions[currentStage] || `æ„Ÿæ‚Ÿ${name}å¢ƒç•Œï¼Œæå‡ä¿®ä¸º`;
}

/**
 * ä¿®å¤å¢ƒç•Œæ•°æ®
 */
function repairRealm(realm: any): Realm {
  if (!realm || typeof realm !== 'object') {
    return {
      åç§°: "å‡¡äºº",
      é˜¶æ®µ: "",
      å½“å‰è¿›åº¦: 0,
      ä¸‹ä¸€çº§æ‰€éœ€: 100,
      çªç ´æè¿°: 'å¼•æ°”å…¥ä½“ï¼Œæ„Ÿæ‚Ÿå¤©åœ°çµæ°”ï¼Œè¸ä¸Šä¿®ä»™ç¬¬ä¸€æ­¥'
    };
  }

  // ğŸ”¥ ä¿®å¤ï¼šä¿ç•™åŸæœ‰å¢ƒç•Œæ•°æ®ï¼Œåªè¡¥å……ç¼ºå¤±å­—æ®µ
  const name = realm.åç§° || "å‡¡äºº";
  const stage = realm.é˜¶æ®µ !== undefined ? realm.é˜¶æ®µ : "";
  const progress = validateNumber(realm.å½“å‰è¿›åº¦, 0, 999999999, 0);
  const required = validateNumber(realm.ä¸‹ä¸€çº§æ‰€éœ€, 1, 999999999, 100);

  return {
    åç§°: name,
    é˜¶æ®µ: stage,
    å½“å‰è¿›åº¦: progress,
    ä¸‹ä¸€çº§æ‰€éœ€: required,
    çªç ´æè¿°: realm.çªç ´æè¿° || getDefaultBreakthroughDescription(name, stage)
  };
}

/**
 * ä¿®å¤ValuePairæ•°æ®
 */
function repairValuePair(pair: any, defaultCurrent: number, defaultMax: number): { å½“å‰: number; ä¸Šé™: number } {
  if (!pair || typeof pair !== 'object') {
    return { å½“å‰: defaultCurrent, ä¸Šé™: defaultMax };
  }

  const current = validateNumber(pair.å½“å‰, 0, 999999999, defaultCurrent);
  const max = validateNumber(pair.ä¸Šé™, 1, 999999999, defaultMax);

  return {
    å½“å‰: Math.min(current, max), // ç¡®ä¿å½“å‰å€¼ä¸è¶…è¿‡ä¸Šé™
    ä¸Šé™: max
  };
}

/**
 * ä¿®å¤æ¸¸æˆæ—¶é—´
 */
function repairGameTime(time: any): GameTime {
  if (!time || typeof time !== 'object') {
    return { å¹´: 1000, æœˆ: 1, æ—¥: 1, å°æ—¶: 8, åˆ†é’Ÿ: 0 };
  }

  return {
    å¹´: validateNumber(time.å¹´, 1, 999999, 1000),
    æœˆ: validateNumber(time.æœˆ, 1, 12, 1),
    æ—¥: validateNumber(time.æ—¥, 1, 30, 1),
    å°æ—¶: validateNumber(time.å°æ—¶, 0, 23, 8),
    åˆ†é’Ÿ: validateNumber(time.åˆ†é’Ÿ, 0, 59, 0)
  };
}

/**
 * ä¿®å¤ç‰©å“æ•°æ®
 */
function repairItem(item: Item): Item {
  const repaired = { ...item };

  // ç¡®ä¿åŸºç¡€å­—æ®µ
  repaired.ç‰©å“ID = repaired.ç‰©å“ID || `item_${Date.now()}`;
  repaired.åç§° = repaired.åç§° || 'æœªå‘½åç‰©å“';
  repaired.æ•°é‡ = validateNumber(repaired.æ•°é‡, 1, 999999, 1);

  // ä¿®å¤å“è´¨
  if (!repaired.å“è´¨ || typeof repaired.å“è´¨ !== 'object') {
    repaired.å“è´¨ = { quality: 'å‡¡', grade: 1 };
  } else {
    const validQualities = ['å‡¡', 'é»„', 'ç„', 'åœ°', 'å¤©', 'ä»™', 'ç¥'];
    if (!validQualities.includes(repaired.å“è´¨.quality)) {
      repaired.å“è´¨.quality = 'å‡¡';
    }
    repaired.å“è´¨.grade = validateNumber(repaired.å“è´¨.grade, 0, 10, 1) as GradeType;
  }

  // ç¡®ä¿ç±»å‹æœ‰æ•ˆ
  const validTypes = ['è£…å¤‡', 'åŠŸæ³•', 'å…¶ä»–'];
  if (!validTypes.includes(repaired.ç±»å‹)) {
    repaired.ç±»å‹ = 'å…¶ä»–';
  }

  return repaired;
}

/**
 * ä¿®å¤NPCæ•°æ®
 */
function repairNpc(npc: NpcProfile): NpcProfile {
  const repaired = { ...npc };

  // ç¡®ä¿åŸºç¡€å­—æ®µ
  repaired.åå­— = repaired.åå­— || 'æ— å';
  repaired.æ€§åˆ« = repaired.æ€§åˆ« || 'ç”·';

  // å¹´é¾„å·²è‡ªåŠ¨ä»å‡ºç”Ÿæ—¥æœŸè®¡ç®—,åˆ é™¤å¹´é¾„å­—æ®µ

  // ä¿®å¤å¢ƒç•Œ
  repaired.å¢ƒç•Œ = repairRealm(repaired.å¢ƒç•Œ);

  // ä¿®å¤å…ˆå¤©å…­å¸
  if (!repaired.å…ˆå¤©å…­å¸ || typeof repaired.å…ˆå¤©å…­å¸ !== 'object') {
    repaired.å…ˆå¤©å…­å¸ = { æ ¹éª¨: 5, çµæ€§: 5, æ‚Ÿæ€§: 5, æ°”è¿: 5, é­…åŠ›: 5, å¿ƒæ€§: 5 };
  }

  // ä¿®å¤ä½ç½®
  if (!repaired.å½“å‰ä½ç½® || typeof repaired.å½“å‰ä½ç½® !== 'object') {
    repaired.å½“å‰ä½ç½® = { æè¿°: 'æœå¤©å¤§é™†Â·æ— åä¹‹åœ°' };
  } else if (!repaired.å½“å‰ä½ç½®.æè¿°) {
    repaired.å½“å‰ä½ç½®.æè¿° = 'æœå¤©å¤§é™†Â·æ— åä¹‹åœ°';
  }

  // ä¿®å¤å¥½æ„Ÿåº¦
  repaired.å¥½æ„Ÿåº¦ = validateNumber(repaired.å¥½æ„Ÿåº¦, -100, 100, 0);

  // ä¿®å¤è®°å¿†
  if (!Array.isArray(repaired.è®°å¿†)) {
    repaired.è®°å¿† = [];
  }

  // ä¿®å¤èƒŒåŒ…
  if (!repaired.èƒŒåŒ… || typeof repaired.èƒŒåŒ… !== 'object') {
    repaired.èƒŒåŒ… = {
      çµçŸ³: { ä¸‹å“: 0, ä¸­å“: 0, ä¸Šå“: 0, æå“: 0 },
      ç‰©å“: {}
    };
  }

  return repaired;
}

/**
 * éªŒè¯æ•°å­—ï¼Œç¡®ä¿åœ¨èŒƒå›´å†…
 */
function validateNumber(value: any, min: number, max: number, defaultValue: number): number {
  if (typeof value === 'number' && !isNaN(value)) {
    return Math.max(min, Math.min(max, value));
  }
  if (typeof value === 'string') {
    const parsed = parseFloat(value);
    if (!isNaN(parsed)) {
      return Math.max(min, Math.min(max, parsed));
    }
  }
  return defaultValue;
}

/**
 * åˆ›å»ºé»˜è®¤ç©å®¶çŠ¶æ€
 */
function createDefaultPlayerStatus() {
  return {
    å¢ƒç•Œ: {
      åç§°: 'å‡¡äºº',
      é˜¶æ®µ: '',
      å½“å‰è¿›åº¦: 0,
      ä¸‹ä¸€çº§æ‰€éœ€: 100,
      çªç ´æè¿°: 'å¼•æ°”å…¥ä½“ï¼Œæ„Ÿæ‚Ÿå¤©åœ°çµæ°”ï¼Œè¸ä¸Šä¿®ä»™ç¬¬ä¸€æ­¥'
    },
    å£°æœ›: 0,
    ä½ç½®: { æè¿°: 'æœå¤©å¤§é™†Â·æ— åä¹‹åœ°' },
    æ°”è¡€: { å½“å‰: 100, ä¸Šé™: 100 },
    çµæ°”: { å½“å‰: 50, ä¸Šé™: 50 },
    ç¥è¯†: { å½“å‰: 30, ä¸Šé™: 30 },
    å¯¿å‘½: { å½“å‰: 18, ä¸Šé™: 80 },
    çŠ¶æ€æ•ˆæœ: []
  };
}

/**
 * åˆ›å»ºæœ€å°å¯ç”¨å­˜æ¡£
 */
function createMinimalSaveData(): SaveData {
  return {
    è§’è‰²åŸºç¡€ä¿¡æ¯: {
      åå­—: 'æ— åä¿®å£«',
      æ€§åˆ«: 'ç”·',
      å‡ºç”Ÿæ—¥æœŸ: { å¹´: 982, æœˆ: 1, æ—¥: 1 },
      ä¸–ç•Œ: 'æœå¤©å¤§é™†' as any,
      å¤©èµ„: 'å‡¡äºº' as any,
      å‡ºç”Ÿ: 'æ•£ä¿®',
      çµæ ¹: 'äº”è¡Œæ‚çµæ ¹',
      å¤©èµ‹: [],
      å…ˆå¤©å…­å¸: { æ ¹éª¨: 5, çµæ€§: 5, æ‚Ÿæ€§: 5, æ°”è¿: 5, é­…åŠ›: 5, å¿ƒæ€§: 5 },
      åå¤©å…­å¸: { æ ¹éª¨: 0, çµæ€§: 0, æ‚Ÿæ€§: 0, æ°”è¿: 0, é­…åŠ›: 0, å¿ƒæ€§: 0 }
    },
    ç©å®¶è§’è‰²çŠ¶æ€: createDefaultPlayerStatus(),
    è£…å¤‡æ : { è£…å¤‡1: null, è£…å¤‡2: null, è£…å¤‡3: null, è£…å¤‡4: null, è£…å¤‡5: null, è£…å¤‡6: null },
    ä¸‰åƒå¤§é“: { å¤§é“åˆ—è¡¨: {} },
    èƒŒåŒ…: {
      çµçŸ³: { ä¸‹å“: 0, ä¸­å“: 0, ä¸Šå“: 0, æå“: 0 },
      ç‰©å“: {}
    },
    äººç‰©å…³ç³»: {},
    ä»»åŠ¡ç³»ç»Ÿ: {
      é…ç½®: {
        å¯ç”¨ç³»ç»Ÿä»»åŠ¡: false,
        ç³»ç»Ÿä»»åŠ¡ç±»å‹: 'ä¿®ä»™è¾…åŠ©ç³»ç»Ÿ',
        ç³»ç»Ÿä»»åŠ¡æç¤ºè¯: '',
        è‡ªåŠ¨åˆ·æ–°: false,
        é»˜è®¤ä»»åŠ¡æ•°é‡: 3
      },
      å½“å‰ä»»åŠ¡åˆ—è¡¨: [],
      å·²å®Œæˆä»»åŠ¡: [],
      ä»»åŠ¡ç»Ÿè®¡: {
        å®Œæˆæ€»æ•°: 0,
        å„ç±»å‹å®Œæˆ: {} as Record<QuestType, number>
      }
    },
    è®°å¿†: {
      çŸ­æœŸè®°å¿†: [],
      ä¸­æœŸè®°å¿†: [],
      é•¿æœŸè®°å¿†: []
    },
    æ¸¸æˆæ—¶é—´: { å¹´: 1000, æœˆ: 1, æ—¥: 1, å°æ—¶: 8, åˆ†é’Ÿ: 0 },
    ä¿®ç‚¼åŠŸæ³•: null,
    æŒæ¡æŠ€èƒ½: []
  };
}
