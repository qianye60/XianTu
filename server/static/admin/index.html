<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§é“æœå¤© - ä»™å®˜ç®¡ç†åå°</title>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --primary: #3a5f7d;
            --primary-light: #4a6f8d;
            --success: #2d7a2d;
            --warning: #cc8400;
            --danger: #c5382e;
            --text: #2c3e50;
            --text-light: #7f8c8d;
            --border: #e0e6ed;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text);
        }

        /* ç™»å½•ç•Œé¢ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            width: 100%;
            max-width: 400px;
        }

        .login-title {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary);
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            background: white;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--text-light);
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .error-message {
            color: var(--danger);
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        /* ä¸»ç•Œé¢ */
        .main-container {
            display: none;
            min-height: 100vh;
        }

        .header {
            background: var(--card-bg);
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-title {
            color: var(--primary);
            font-size: 24px;
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-info {
            font-weight: 500;
            color: var(--text);
        }

        /* æ ‡ç­¾é¡µ */
        .tabs-container {
            padding: 20px;
        }

        .tabs-nav {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 20px;
            border: none;
            background: rgba(255, 255, 255, 0.7);
            color: var(--text);
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .tab-btn:hover {
            transform: translateY(-2px);
        }

        /* å†…å®¹åŒºåŸŸ */
        .tab-content {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .table th,
        .table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .table th {
            background: var(--primary);
            color: white;
            font-weight: 500;
        }

        .table tr:hover {
            background: rgba(58, 95, 125, 0.05);
        }

        .table tr:last-child td {
            border-bottom: none;
        }

        /* çŠ¶æ€æ ‡ç­¾ */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: rgba(45, 122, 45, 0.1);
            color: var(--success);
        }

        .status-banned {
            background: rgba(197, 56, 46, 0.1);
            color: var(--danger);
        }

        /* æ“ä½œæŒ‰é’® */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            color: white;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .action-btn.edit {
            background: var(--warning);
        }

        .action-btn.delete {
            background: var(--danger);
        }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: var(--primary);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* åŠ è½½å’Œç©ºçŠ¶æ€ */
        .loading,
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--text);
        }

        /* éšè—ç±» */
        .hidden {
            display: none !important;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .tabs-nav {
                flex-direction: column;
            }

            .tab-content {
                padding: 15px;
            }

            .table-container {
                font-size: 12px;
            }

            .action-buttons {
                flex-direction: column;
                gap: 4px;
            }
        }
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <h1 class="login-title">ğŸ® ä»™å®˜ç™»å½•</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">ä»™å®˜é“å·</label>
                    <input type="text" id="username" class="form-input" placeholder="è¯·è¾“å…¥æ‚¨çš„é“å·" required>
                </div>
                <div class="form-group">
                    <label class="form-label">é€šè¡Œå‡­è¯</label>
                    <input type="password" id="password" class="form-input" placeholder="è¯·è¾“å…¥é€šè¡Œå‡­è¯" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">ç™»å½•å¤©å®«</button>
                <div id="loginError" class="error-message hidden"></div>
            </form>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="mainContainer" class="main-container">
        <header class="header">
            <h1 class="header-title">å¤§é“æœå¤© - ä»™å®˜ç®¡ç†åå°</h1>
            <div class="header-actions">
                <span id="userInfo" class="user-info"></span>
                <button id="changePasswordBtn" class="btn btn-sm btn-warning">ğŸ” ä¿®æ”¹å¯†ç </button>
                <button id="refreshBtn" class="btn btn-sm btn-primary">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                <button id="logoutBtn" class="btn btn-sm btn-danger">ğŸ‘¤ é€€å‡ºç™»å½•</button>
            </div>
        </header>

        <div class="tabs-container">
            <nav class="tabs-nav">
                <button class="tab-btn active" data-tab="players">ç©å®¶ç®¡ç†</button>
                <button class="tab-btn" data-tab="characters">è§’è‰²ç®¡ç†</button>
                <button class="tab-btn" data-tab="ban_records">å°å·ç®¡ç†</button>
                <button class="tab-btn" data-tab="appeals">ç”³è¯‰ç®¡ç†</button>
                <button class="tab-btn" data-tab="admins">ä»™å®˜ç®¡ç†</button>
                <button class="tab-btn" data-tab="worlds">ä¸–ç•Œç®¡ç†</button>
                <button class="tab-btn" data-tab="origins">å‡ºèº«ç®¡ç†</button>
                <button class="tab-btn" data-tab="talents">å¤©èµ‹ç®¡ç†</button>
                <button class="tab-btn" data-tab="talent_tiers">å¤©èµ„ç®¡ç†</button>
                <button class="tab-btn" data-tab="spirit_roots">çµæ ¹ç®¡ç†</button>
                <button class="tab-btn" data-tab="codes">å…‘æ¢ç ç®¡ç†</button>
            </nav>

            <div class="tab-content">
                <div class="table-header">
                    <div class="table-actions">
                        <button id="addItemBtn" class="btn btn-success hidden">â• æ·»åŠ </button>
                    </div>
                </div>
                <div id="tableContainer">
                    <!-- åŠ¨æ€å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹è´¦æˆ·ä¿¡æ¯æ¨¡æ€æ¡† -->
    <div id="changePasswordModal" class="modal-overlay hidden">
        <div class="modal">
            <h3>ğŸ” ä¿®æ”¹è´¦æˆ·ä¿¡æ¯</h3>
            <form id="changePasswordForm">
                <div class="form-group">
                    <label class="form-label">ä»™å®˜é“å·</label>
                    <input type="text" id="currentUserName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">å½“å‰å¯†ç ï¼ˆä¿®æ”¹ä¿¡æ¯æ—¶å¿…å¡«ï¼‰</label>
                    <input type="password" id="currentPassword" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">æ–°å¯†ç ï¼ˆç•™ç©ºä¸ä¿®æ”¹ï¼‰</label>
                    <input type="password" id="newPassword" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">ç¡®è®¤æ–°å¯†ç </label>
                    <input type="password" id="confirmPassword" class="form-input">
                </div>
                <div id="changePasswordError" class="error-message hidden"></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideChangePasswordModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ç¡®è®¤ä¿®æ”¹</button>
                </div>
            </form>
        </div>
    </div>

    <!-- é€šç”¨ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="editModal" class="modal-overlay hidden">
        <div class="modal">
            <h3 id="editModalTitle">ç¼–è¾‘</h3>
            <form id="editForm">
                <div id="editFormFields"></div>
                <div id="editError" class="error-message hidden"></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideEditModal()">å–æ¶ˆ</button>
                    <button type="submit" id="editModalSubmitBtn" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å°å·æ¨¡æ€æ¡† -->
    <div id="banModal" class="modal-overlay hidden">
        <div class="modal">
            <h3>ğŸš« å°ç¦ç©å®¶</h3>
            <form id="banForm">
                <div class="form-group">
                    <label class="form-label">ç©å®¶ID</label>
                    <input type="number" id="banPlayerId" class="form-input" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">ç©å®¶åç§°</label>
                    <input type="text" id="banPlayerName" class="form-input" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">å°å·ç±»å‹</label>
                    <select id="banType" class="form-select" required>
                        <option value="temporary">ä¸´æ—¶å°å·</option>
                        <option value="permanent">æ°¸ä¹…å°å·</option>
                    </select>
                </div>
                <div class="form-group" id="banEndTimeGroup">
                    <label class="form-label">å°å·ç»“æŸæ—¶é—´</label>
                    <input type="datetime-local" id="banEndTime" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">å°å·åŸå› </label>
                    <textarea id="banReason" class="form-input" rows="4" placeholder="è¯·è¯¦ç»†è¯´æ˜å°å·åŸå› ..." required></textarea>
                </div>
                <div id="banError" class="error-message hidden"></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideBanModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-danger">ç¡®è®¤å°å·</button>
                </div>
            </form>
        </div>
    </div>

    <!-- è§’è‰²è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="characterModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 800px;">
            <h3 id="characterModalTitle">è§’è‰²è¯¦æƒ…</h3>
            <div id="characterDetails"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideCharacterModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let authToken = localStorage.getItem('admin_token');
        let currentUser = null;
        let currentTab = 'players';
        let currentEditItem = null;
        const API_BASE = '/api/v1';

        // DOM å…ƒç´ 
        const loginContainer = document.getElementById('loginContainer');
        const mainContainer = document.getElementById('mainContainer');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const userInfo = document.getElementById('userInfo');
        const tableContainer = document.getElementById('tableContainer');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            if (authToken) {
                verifyToken();
            } else {
                showLogin();
            }

            // äº‹ä»¶ç›‘å¬
            loginForm.addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('refreshBtn').addEventListener('click', refreshCurrentTab);
            document.getElementById('changePasswordBtn').addEventListener('click', showChangePasswordModal);
            document.getElementById('addItemBtn').addEventListener('click', showAddItemModal);

            // æ ‡ç­¾é¡µåˆ‡æ¢
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // ä¿®æ”¹å¯†ç è¡¨å•
            document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);
            
            // ç¼–è¾‘è¡¨å•
            document.getElementById('editForm').addEventListener('submit', handleEditSubmit);
            
            // å°å·è¡¨å•
            document.getElementById('banForm').addEventListener('submit', handleBanSubmit);
            
            // ç›‘å¬å°å·ç±»å‹å˜åŒ–
            document.getElementById('banType').addEventListener('change', function() {
                const endTimeGroup = document.getElementById('banEndTimeGroup');
                if (this.value === 'permanent') {
                    endTimeGroup.style.display = 'none';
                } else {
                    endTimeGroup.style.display = 'block';
                }
            });
        });

        // æ˜¾ç¤ºç™»å½•ç•Œé¢
        function showLogin() {
            loginContainer.classList.remove('hidden');
            mainContainer.style.display = 'none';
        }

        // æ˜¾ç¤ºä¸»ç•Œé¢
        function showMain() {
            loginContainer.classList.add('hidden');
            mainContainer.style.display = 'block';
            userInfo.textContent = `æ¬¢è¿ï¼Œ${currentUser.user_name} ä»™å®˜ (${currentUser.role === 'super_admin' ? 'è¶…çº§ç®¡ç†å‘˜' : 'æ™®é€šç®¡ç†å‘˜'})`;
            loadTabData(currentTab);
        }

        // éªŒè¯token
        async function verifyToken() {
            try {
                const response = await fetch(`${API_BASE}/admin/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    currentUser = await response.json();
                    showMain();
                } else {
                    throw new Error('Tokenæ— æ•ˆ');
                }
            } catch (error) {
                console.error('TokenéªŒè¯å¤±è´¥:', error);
                localStorage.removeItem('admin_token');
                authToken = null;
                showLogin();
            }
        }

        // å¤„ç†ç™»å½•
        async function handleLogin(e) {
            e.preventDefault();
            hideError();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE}/admin/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.access_token;
                    localStorage.setItem('admin_token', authToken);
                    
                    // è·å–ç”¨æˆ·ä¿¡æ¯
                    const userResponse = await fetch(`${API_BASE}/admin/me`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    currentUser = await userResponse.json();
                    showMain();
                    hideError();
                } else {
                    showError(data.detail || 'ç™»å½•å¤±è´¥');
                }
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                showError('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨');
            }
        }

        // å¤„ç†ç™»å‡º
        function handleLogout() {
            localStorage.removeItem('admin_token');
            authToken = null;
            currentUser = null;
            showLogin();
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            loginError.textContent = message;
            loginError.classList.remove('hidden');
        }

        // éšè—é”™è¯¯ä¿¡æ¯
        function hideError() {
            loginError.classList.add('hidden');
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            currentTab = tabName;
            
            // æ›´æ–°æ ‡ç­¾é¡µæ ·å¼
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // æ˜¾ç¤º/éšè—æ·»åŠ æŒ‰é’®
            const addBtn = document.getElementById('addItemBtn');
            const canAdd = (tabName === 'admins' && currentUser?.role === 'super_admin') ||
                          (tabName === 'codes' && (currentUser?.role === 'super_admin' || currentUser?.role === 'admin')) ||
                          (tabName === 'talents' && currentUser?.role === 'super_admin') ||
                          (tabName === 'talent_tiers' && currentUser?.role === 'super_admin') ||
                          (tabName === 'players' && currentUser?.role === 'super_admin') ||
                          (tabName === 'worlds' && currentUser?.role === 'super_admin') ||
                          (tabName === 'origins' && currentUser?.role === 'super_admin') ||
                          (tabName === 'spirit_roots' && currentUser?.role === 'super_admin') ||
                          (tabName === 'characters' && currentUser?.role === 'super_admin') ||
                          (tabName === 'ban_records' && currentUser?.role === 'super_admin');
            
            if (canAdd) {
                addBtn.classList.remove('hidden');
                // æ›´æ–°æŒ‰é’®æ–‡æœ¬
                if (tabName === 'ban_records') {
                    addBtn.textContent = 'ğŸš« å°ç¦ç©å®¶';
                } else if (tabName === 'characters') {
                    addBtn.textContent = 'ğŸ‘¤ åˆ›å»ºè§’è‰²';
                } else {
                    addBtn.textContent = 'â• æ·»åŠ ';
                }
            } else {
                addBtn.classList.add('hidden');
            }
            
            loadTabData(tabName);
        }

        // åˆ·æ–°å½“å‰æ ‡ç­¾é¡µ
        function refreshCurrentTab() {
            loadTabData(currentTab);
        }

        // åŠ è½½æ ‡ç­¾é¡µæ•°æ®
        async function loadTabData(tabName) {
            showLoading();

            if (!authToken) {
                console.error("æ— æˆæƒä»¤ç‰Œï¼Œæ— æ³•åŠ è½½æ•°æ®ã€‚");
                showTableError("æˆæƒå·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•ã€‚");
                // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´åå¼ºåˆ¶ç™»å‡º
                setTimeout(handleLogout, 1500);
                return;
            }

            try {
                let endpoint, columns, formatRow;

                switch(tabName) {
                    case 'players':
                        endpoint = '/users/';
                        columns = ['ID', 'ç”¨æˆ·å', 'åˆ›å»ºæ—¶é—´', 'çŠ¶æ€', 'è§’è‰²æ•°é‡', 'æ“ä½œ'];
                        formatRow = (item) => {
                            const canEdit = currentUser?.role === 'super_admin';
                            const canBan = currentUser?.role === 'super_admin';
                            let actions = '';
                            if (canEdit) {
                                actions += `<button class="action-btn edit" onclick="editItem('${tabName}', ${item.id})">ç¼–è¾‘</button>`;
                            }
                            if (canBan && !item.is_banned) {
                                actions += `<button class="action-btn delete" onclick="banPlayer(${item.id}, '${item.user_name}')">å°å·</button>`;
                            }
                            if (canBan && item.is_banned) {
                                actions += `<button class="action-btn" style="background: var(--success)" onclick="unbanPlayer(${item.id}, '${item.user_name}')">è§£å°</button>`;
                            }
                            return [
                                item.id,
                                item.user_name,
                                new Date(item.created_at).toLocaleString('zh-CN'),
                                `<span class="status-badge ${item.is_banned ? 'status-banned' : 'status-active'}">${item.is_banned ? 'å·²å°ç¦' : 'æ­£å¸¸'}</span>`,
                                item.character_count || 0,
                                `<div class="action-buttons">${actions}</div>`
                            ];
                        };
                        break;

                    case 'characters':
                        endpoint = '/admin/characters';
                        columns = ['ID', 'è§’è‰²å', 'ç©å®¶', 'ä¸–ç•Œ', 'çŠ¶æ€', 'æœ€åæ¸¸æˆæ—¶é—´', 'æ“ä½œ'];
                        formatRow = (item) => {
                            const canView = currentUser?.role === 'super_admin' || currentUser?.role === 'admin';
                            let actions = '';
                            if (canView) {
                                actions += `<button class="action-btn edit" onclick="viewCharacterDetails(${item.id})">è¯¦æƒ…</button>`;
                                if (item.is_deleted) {
                                    actions += `<button class="action-btn" style="background: var(--success)" onclick="restoreCharacter(${item.id})">æ¢å¤</button>`;
                                } else {
                                    actions += `<button class="action-btn delete" onclick="deleteCharacter(${item.id})">åˆ é™¤</button>`;
                                }
                            }
                            return [
                                item.id,
                                item.character_name,
                                item.player_name || `ç”¨æˆ·${item.player_id}`,
                                item.world_name || `ä¸–ç•Œ${item.world_id}`,
                                `<span class="status-badge ${item.is_active ? 'status-active' : ''}">${item.is_active ? 'æ¿€æ´»' : ''}${item.is_deleted ? ' å·²åˆ é™¤' : ''}</span>`,
                                item.last_played ? new Date(item.last_played).toLocaleString('zh-CN') : 'ä»æœªæ¸¸æˆ',
                                `<div class="action-buttons">${actions}</div>`
                            ];
                        };
                        break;

                    case 'ban_records':
                        endpoint = '/ban/ban_records';
                        columns = ['ID', 'ç©å®¶', 'å°å·ç±»å‹', 'åŸå› ', 'å¼€å§‹æ—¶é—´', 'ç»“æŸæ—¶é—´', 'çŠ¶æ€', 'æ“ä½œ'];
                        formatRow = (item) => {
                            const canManage = currentUser?.role === 'super_admin' || currentUser?.role === 'admin';
                            let actions = '';
                            if (canManage && item.is_active) {
                                actions += `<button class="action-btn" style="background: var(--success)" onclick="liftBan(${item.id})">è§£å°</button>`;
                            }
                            return [
                                item.id,
                                item.player_name || `ç”¨æˆ·${item.player_id}`,
                                item.ban_type === 'permanent' ? 'æ°¸ä¹…å°å·' : 'ä¸´æ—¶å°å·',
                                item.reason.length > 30 ? item.reason.substring(0, 30) + '...' : item.reason,
                                new Date(item.ban_start_time).toLocaleString('zh-CN'),
                                item.ban_end_time ? new Date(item.ban_end_time).toLocaleString('zh-CN') : 'æ°¸ä¹…',
                                `<span class="status-badge ${item.is_active ? 'status-banned' : 'status-active'}">${item.is_active ? 'ç”Ÿæ•ˆä¸­' : 'å·²å¤±æ•ˆ'}</span>`,
                                `<div class="action-buttons">${actions}</div>`
                            ];
                        };
                        break;

                    case 'appeals':
                        endpoint = '/ban/ban_records?appeal_status=pending';
                        columns = ['ID', 'ç©å®¶', 'å°å·åŸå› ', 'ç”³è¯‰ç†ç”±', 'ç”³è¯‰æ—¶é—´', 'æ“ä½œ'];
                        formatRow = (item) => {
                            const canHandle = currentUser?.role === 'super_admin' || currentUser?.role === 'admin';
                            let actions = '';
                            if (canHandle && item.appeal_status === 'pending') {
                                actions += `<button class="action-btn" style="background: var(--success)" onclick="handleAppeal(${item.id}, true)">æ‰¹å‡†</button>`;
                                actions += `<button class="action-btn delete" onclick="handleAppeal(${item.id}, false)">æ‹’ç»</button>`;
                            }
                            return [
                                item.id,
                                item.player_name || `ç”¨æˆ·${item.player_id}`,
                                item.reason.length > 20 ? item.reason.substring(0, 20) + '...' : item.reason,
                                item.appeal_reason ? (item.appeal_reason.length > 30 ? item.appeal_reason.substring(0, 30) + '...' : item.appeal_reason) : '-',
                                item.appeal_time ? new Date(item.appeal_time).toLocaleString('zh-CN') : '-',
                                `<div class="action-buttons">${actions}</div>`
                            ];
                        };
                        break;

                    case 'admins':
                        endpoint = '/admin/accounts/';
                        columns = ['ID', 'ä»™å®˜é“å·', 'å“é˜¶', 'æˆå°æ—¶é—´', 'æ“ä½œ'];
                        formatRow = (item) => {
                            const canEdit = currentUser?.role === 'super_admin' || currentUser?.id === item.id;
                            const canDelete = currentUser?.role === 'super_admin' && currentUser?.id !== item.id;
                            let actions = '';
                            if (canEdit) {
                                actions += `<button class="action-btn edit" onclick="editItem('${tabName}', ${item.id})">ç¼–è¾‘</button>`;
                            }
                            if (canDelete) {
                                actions += `<button class="action-btn delete" onclick="deleteItem('${tabName}', ${item.id})">åˆ é™¤</button>`;
                            }
                            return [
                                item.id,
                                item.user_name,
                                item.role === 'super_admin' ? 'è¶…çº§ä»™å®˜' : 'æ™®é€šä»™å®˜',
                                new Date(item.created_at).toLocaleString('zh-CN'),
                                `<div class="action-buttons">${actions}</div>`
                            ];
                        };
                        break;

                    case 'worlds':
                        endpoint = '/worlds/';
                        columns = ['ID', 'ä¸–ç•Œåç§°', 'æ—¶ä»£', 'åˆ›å»ºæ—¶é—´', 'æ“ä½œ'];
                        formatRow = (item) => {
                            const canEdit = currentUser?.role === 'super_admin';
                            const canDelete = currentUser?.role === 'super_admin';
                            let actions = '';
                            if (canEdit) {
                                actions += `<button class="action-btn edit" onclick="editItem('${tabName}', ${item.id})">ç¼–è¾‘</button>`;
                            }
                            if (canDelete) {
                                actions += `<button class="action-btn delete" onclick="deleteItem('${tabName}', ${item.id})">åˆ é™¤</button>`;
                            }
                            return [
                                item.id,
                                item.name,
                                item.era || '-',
                                new Date(item.created_at).toLocaleString('zh-CN'),
                                `<div class="action-buttons">${actions}</div>`
                            ];
                        };
                        break;

                    case 'origins':
                        endpoint = '/origins/';
                        columns = ['ID', 'å‡ºèº«åç§°', 'ç¨€æœ‰åº¦', 'èŠ±è´¹ç‚¹æ•°', 'æè¿°', 'æ“ä½œ'];
                        formatRow = (item) => {
                            const canEdit = currentUser?.role === 'super_admin';
                            const canDelete = currentUser?.role === 'super_admin';
                            let actions = '';
                            if (canEdit) {
                                actions += `<button class="action-btn edit" onclick="editItem('${tabName}', ${item.id})">ç¼–è¾‘</button>`;
                            }
                            if (canDelete) {
                                actions += `<button class="action-btn delete" onclick="deleteItem('${tabName}', ${item.id})">åˆ é™¤</button>`;
                            }
                            return [
                                item.id,
                                item.name,
                                item.rarity || '-',
                                item.talent_cost || 0,
                                item.description ? (item.description.length > 50 ? item.description.substring(0, 50) + '...' : item.description) : '-',
                                `<div class="action-buttons">${actions}</div>`
                            ];
                        };
                        break;

                    case 'talents':
                        endpoint = '/talents/';
                        columns = ['ID', 'å¤©èµ‹åç§°', 'ç¨€æœ‰åº¦', 'èŠ±è´¹ç‚¹æ•°', 'æè¿°', 'æ“ä½œ'];
                        formatRow = (item) => {
                            const canManage = currentUser?.role === 'super_admin';
                            let actions = '';
                            if (canManage) {
                                actions += `<button class="action-btn edit" onclick="editItem('${tabName}', ${item.id})">ç¼–è¾‘</button>`;
                                actions += `<button class="action-btn delete" onclick="deleteItem('${tabName}', ${item.id})">åˆ é™¤</button>`;
                            }
                            return [
                                item.id,
                                item.name,
                                item.rarity || '-',
                                item.talent_cost || 0,
                                item.description ? (item.description.length > 30 ? item.description.substring(0, 30) + '...' : item.description) : '-',
                                `<div class="action-buttons">${actions}</div>`
                            ];
                        };
                        break;

                    case 'talent_tiers':
                        endpoint = '/talent_tiers/';
                        columns = ['ID', 'å¤©èµ„åç§°', 'ç¨€æœ‰åº¦', 'æ€»ç‚¹æ•°', 'é¢œè‰²', 'æè¿°', 'æ“ä½œ'];
                        formatRow = (item) => {
                            const canManage = currentUser?.role === 'super_admin';
                            let actions = '';
                            if (canManage) {
                                actions += `<button class="action-btn edit" onclick="editItem('${tabName}', ${item.id})">ç¼–è¾‘</button>`;
                                actions += `<button class="action-btn delete" onclick="deleteItem('${tabName}', ${item.id})">åˆ é™¤</button>`;
                            }
                            return [
                                item.id,
                                item.name,
                                item.rarity || '-',
                                item.total_points || 0,
                                `<span style="color:${item.color}; font-weight: bold;">${item.color}</span>`,
                                item.description ? (item.description.length > 30 ? item.description.substring(0, 30) + '...' : item.description) : '-',
                                `<div class="action-buttons">${actions}</div>`
                            ];
                        };
                        break;

                    case 'spirit_roots':
                        endpoint = '/spirit_roots/';
                        columns = ['ID', 'çµæ ¹åç§°', 'åŸºç¡€å€ç‡', 'èŠ±è´¹ç‚¹æ•°', 'æè¿°', 'æ“ä½œ'];
                        formatRow = (item) => {
                            const canEdit = currentUser?.role === 'super_admin';
                            const canDelete = currentUser?.role === 'super_admin';
                            let actions = '';
                            if (canEdit) {
                                actions += `<button class="action-btn edit" onclick="editItem('${tabName}', ${item.id})">ç¼–è¾‘</button>`;
                            }
                            if (canDelete) {
                                actions += `<button class="action-btn delete" onclick="deleteItem('${tabName}', ${item.id})">åˆ é™¤</button>`;
                            }
                            return [
                                item.id,
                                item.name,
                                item.base_multiplier || '-',
                                item.talent_cost || 0,
                                item.description ? (item.description.length > 50 ? item.description.substring(0, 50) + '...' : item.description) : '-',
                                `<div class="action-buttons">${actions}</div>`
                            ];
                        };
                        break;

                    case 'codes':
                        endpoint = '/admin/codes/';
                        columns = ['ID', 'å…‘æ¢ç ', 'ç±»å‹', 'ä½¿ç”¨æ¬¡æ•°', 'åˆ›å»ºæ—¶é—´', 'æ“ä½œ'];
                        formatRow = (item) => {
                            const canManage = currentUser?.role === 'super_admin' || currentUser?.role === 'admin';
                            let actions = '';
                            if (canManage) {
                                actions += `<button class="action-btn edit" onclick="editItem('${tabName}', ${item.id})">ç¼–è¾‘</button>`;
                                actions += `<button class="action-btn delete" onclick="deleteItem('${tabName}', ${item.id})">åˆ é™¤</button>`;
                            }
                            return [
                                item.id,
                                item.code,
                                item.type,
                                `${item.times_used}/${item.max_uses}`,
                                new Date(item.created_at).toLocaleString('zh-CN'),
                                `<div class="action-buttons">${actions}</div>`
                            ];
                        };
                        break;

                    default:
                        throw new Error('æœªçŸ¥çš„æ ‡ç­¾é¡µ');
                }

                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                displayTable(columns, data, formatRow);

            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
                showTableError(`${tabName} æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`);
            }
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            tableContainer.innerHTML = '<div class="loading">â³ æ•°æ®åŠ è½½ä¸­...</div>';
        }

        // æ˜¾ç¤ºè¡¨æ ¼
        function displayTable(columns, data, formatRow) {
            if (data.length === 0) {
                tableContainer.innerHTML = `
                    <div class="empty-state">
                        <h3>æš‚æ— æ•°æ®</h3>
                        <p>å½“å‰åˆ†ç±»ä¸‹è¿˜æ²¡æœ‰ä»»ä½•æ•°æ®</p>
                    </div>
                `;
                return;
            }

            const headerHtml = columns.map(col => `<th>${col}</th>`).join('');
            const rowsHtml = data.map(item => {
                const cells = formatRow(item);
                return `<tr>${cells.map(cell => `<td>${cell}</td>`).join('')}</tr>`;
            }).join('');

            tableContainer.innerHTML = `
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>${headerHtml}</tr>
                        </thead>
                        <tbody>
                            ${rowsHtml}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // æ˜¾ç¤ºè¡¨æ ¼é”™è¯¯
        function showTableError(message) {
            tableContainer.innerHTML = `
                <div class="empty-state">
                    <h3>âš ï¸ åŠ è½½å¤±è´¥</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="refreshCurrentTab()">é‡è¯•</button>
                </div>
            `;
        }

        // ä¿®æ”¹å¯†ç åŠŸèƒ½
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('hidden');
            document.getElementById('changePasswordForm').reset();
            // é¢„å¡«å……å½“å‰ç”¨æˆ·å
            document.getElementById('currentUserName').value = currentUser.user_name;
            document.getElementById('changePasswordError').classList.add('hidden');
        }

        function hideChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('hidden');
        }

        async function handleChangePassword(e) {
            e.preventDefault();
            const newUserName = document.getElementById('currentUserName').value;
            const current = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            
            if (newPass && newPass !== confirm) {
                document.getElementById('changePasswordError').textContent = 'æ–°å¯†ç ç¡®è®¤ä¸åŒ¹é…';
                document.getElementById('changePasswordError').classList.remove('hidden');
                return;
            }

            try {
                const updates = {
                    current_password: current
                };
                
                // åªæœ‰å½“ç”¨æˆ·åå‘ç”Ÿå˜åŒ–æ—¶æ‰æ›´æ–°
                if (newUserName !== currentUser.user_name) {
                    updates.user_name = newUserName;
                }
                
                // åªæœ‰å½“æ–°å¯†ç ä¸ä¸ºç©ºæ—¶æ‰æ›´æ–°
                if (newPass) {
                    updates.password = newPass;
                }

                const response = await fetch(`${API_BASE}/admin/accounts/${currentUser.id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updates)
                });

                if (response.ok) {
                    const updatedUser = await response.json();
                    currentUser.user_name = updatedUser.user_name;
                    userInfo.textContent = `æ¬¢è¿ï¼Œ${currentUser.user_name} ä»™å®˜ (${currentUser.role === 'super_admin' ? 'è¶…çº§ç®¡ç†å‘˜' : 'æ™®é€šç®¡ç†å‘˜'})`;
                    hideChangePasswordModal();
                    alert('è´¦æˆ·ä¿¡æ¯ä¿®æ”¹æˆåŠŸï¼');
                } else {
                    const error = await response.json();
                    document.getElementById('changePasswordError').textContent = error.detail || 'ä¿®æ”¹å¤±è´¥';
                    document.getElementById('changePasswordError').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('changePasswordError').textContent = 'ç½‘ç»œé”™è¯¯';
                document.getElementById('changePasswordError').classList.remove('hidden');
            }
        }

        // ç¼–è¾‘åŠŸèƒ½
        async function editItem(tabName, itemId) {
            try {
                let endpoint = '';
                switch(tabName) {
                    case 'admins':
                        endpoint = `/admin/accounts/${itemId}/`;
                        break;
                    case 'codes':
                        endpoint = `/admin/codes/${itemId}/`;
                        break;
                    case 'talents':
                        endpoint = `/talents/${itemId}/`;
                        break;
                    case 'talent_tiers':
                        endpoint = `/talent_tiers/${itemId}/`;
                        break;
                    case 'players':
                        endpoint = `/users/${itemId}/`;
                        break;
                    case 'worlds':
                        endpoint = `/worlds/${itemId}/`;
                        break;
                    case 'origins':
                        endpoint = `/origins/${itemId}/`;
                        break;
                    case 'spirit_roots':
                        endpoint = `/spirit_roots/${itemId}/`;
                        break;
                    default:
                        return;
                }

                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const item = await response.json();
                    currentEditItem = { tabName, itemId, data: item };
                    renderEditForm(tabName, item);
                    document.getElementById('editModal').classList.remove('hidden');
                }
            } catch (error) {
                alert('è·å–æ•°æ®å¤±è´¥');
            }
        }

        function renderEditForm(tabName, item) {
            let fields = '';
            let title = '';

            switch(tabName) {
                case 'admins':
                    title = 'ç¼–è¾‘ä»™å®˜ä¿¡æ¯';
                    fields = `
                        <div class="form-group">
                            <label class="form-label">ä»™å®˜é“å·</label>
                            <input type="text" name="user_name" class="form-input" value="${item.user_name || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å½“å‰å¯†ç ï¼ˆä¿®æ”¹å¯†ç æˆ–é“å·æ—¶å¿…å¡«ï¼‰</label>
                            <input type="password" name="current_password" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ–°å¯†ç ï¼ˆç•™ç©ºä¸ä¿®æ”¹ï¼‰</label>
                            <input type="password" name="password" class="form-input">
                        </div>
                        ${currentUser?.role === 'super_admin' ? `
                        <div class="form-group">
                            <label class="form-label">å“é˜¶</label>
                            <select name="role" class="form-select">
                                <option value="admin" ${item.role === 'admin' ? 'selected' : ''}>æ™®é€šä»™å®˜</option>
                                <option value="super_admin" ${item.role === 'super_admin' ? 'selected' : ''}>è¶…çº§ä»™å®˜</option>
                            </select>
                        </div>` : ''}
                    `;
                    break;
                case 'codes':
                    title = 'ç¼–è¾‘å…‘æ¢ç ';
                    fields = `
                        <div class="form-group">
                            <label class="form-label">å…‘æ¢ç </label>
                            <input type="text" name="code" class="form-input" value="${item.code || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç±»å‹</label>
                            <input type="text" name="type" class="form-input" value="${item.type || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æœ€å¤§ä½¿ç”¨æ¬¡æ•°</label>
                            <input type="number" name="max_uses" class="form-input" value="${item.max_uses || 1}" required>
                        </div>
                    `;
                    break;
                case 'talents':
                    title = 'ç¼–è¾‘å¤©èµ‹';
                    fields = `
                        <div class="form-group">
                            <label class="form-label">å¤©èµ‹åç§°</label>
                            <input type="text" name="name" class="form-input" value="${item.name || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç¨€æœ‰åº¦</label>
                            <input type="number" name="rarity" class="form-input" value="${item.rarity || 2}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">èŠ±è´¹ç‚¹æ•°</label>
                            <input type="number" name="talent_cost" class="form-input" value="${item.talent_cost || 1}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æè¿°</label>
                            <textarea name="description" class="form-input" rows="3">${item.description || ''}</textarea>
                        </div>
                    `;
                    break;
                case 'talent_tiers':
                    title = 'ç¼–è¾‘å¤©èµ„';
                    fields = `
                        <div class="form-group">
                            <label class="form-label">å¤©èµ„åç§°</label>
                            <input type="text" name="name" class="form-input" value="${item.name || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç¨€æœ‰åº¦</label>
                            <input type="number" name="rarity" class="form-input" value="${item.rarity || 2}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ€»ç‚¹æ•°</label>
                            <input type="number" name="total_points" class="form-input" value="${item.total_points || 70}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é¢œè‰²</label>
                            <input type="text" name="color" class="form-input" value="${item.color || 'white'}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æè¿°</label>
                            <textarea name="description" class="form-input" rows="3">${item.description || ''}</textarea>
                        </div>
                    `;
                    break;
                case 'players':
                    title = 'ç¼–è¾‘ç©å®¶ä¿¡æ¯';
                    fields = `
                        <div class="form-group">
                            <label class="form-label">ç”¨æˆ·å</label>
                            <input type="text" name="user_name" class="form-input" value="${item.user_name || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ–°å¯†ç ï¼ˆç•™ç©ºä¸ä¿®æ”¹ï¼‰</label>
                            <input type="password" name="password" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">çŠ¶æ€</label>
                            <select name="is_banned" class="form-select">
                                <option value="false" ${!item.is_banned ? 'selected' : ''}>æ­£å¸¸</option>
                                <option value="true" ${item.is_banned ? 'selected' : ''}>å·²å°ç¦</option>
                            </select>
                        </div>
                    `;
                    break;
                case 'worlds':
                    title = 'ç¼–è¾‘ä¸–ç•Œä¿¡æ¯';
                    fields = `
                        <div class="form-group">
                            <label class="form-label">ä¸–ç•Œåç§°</label>
                            <input type="text" name="name" class="form-input" value="${item.name || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ—¶ä»£èƒŒæ™¯</label>
                            <input type="text" name="era" class="form-input" value="${item.era || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ä¸–ç•Œæè¿°</label>
                            <textarea name="description" class="form-input" rows="4">${item.description || ''}</textarea>
                        </div>
                    `;
                    break;
                case 'origins':
                    title = 'ç¼–è¾‘å‡ºèº«ä¿¡æ¯';
                    fields = `
                        <div class="form-group">
                            <label class="form-label">å‡ºèº«åç§°</label>
                            <input type="text" name="name" class="form-input" value="${item.name || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç¨€æœ‰åº¦</label>
                            <input type="number" name="rarity" class="form-input" value="${item.rarity || 3}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">èŠ±è´¹ç‚¹æ•°</label>
                            <input type="number" name="talent_cost" class="form-input" value="${item.talent_cost || 0}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æè¿°</label>
                            <textarea name="description" class="form-input" rows="3">${item.description || ''}</textarea>
                        </div>
                    `;
                    break;
                case 'spirit_roots':
                    title = 'ç¼–è¾‘çµæ ¹ä¿¡æ¯';
                    fields = `
                        <div class="form-group">
                            <label class="form-label">çµæ ¹åç§°</label>
                            <input type="text" name="name" class="form-input" value="${item.name || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">åŸºç¡€å€ç‡</label>
                            <input type="number" name="base_multiplier" class="form-input" step="0.1" value="${item.base_multiplier || 1.0}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">èŠ±è´¹ç‚¹æ•°</label>
                            <input type="number" name="talent_cost" class="form-input" value="${item.talent_cost || 0}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æè¿°</label>
                            <textarea name="description" class="form-input" rows="3">${item.description || ''}</textarea>
                        </div>
                    `;
                    break;
            }

            document.getElementById('editModalTitle').textContent = title;
            document.getElementById('editFormFields').innerHTML = fields;
        }

        function hideEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            currentEditItem = null;
        }

        async function handleEditSubmit(e) {
            e.preventDefault();
            if (!currentEditItem) return;

            const formData = new FormData(e.target);
            let payload = {};
            
            // æ ¹æ® tabName æ„å»ºç‰¹å®šçš„ payload
            const tabName = currentEditItem.tabName;
            
            switch(tabName) {
                case 'admins':
                    payload = {
                        user_name: formData.get('user_name'),
                        role: formData.get('role')
                    };
                    if (formData.get('password')) {
                        payload.password = formData.get('password');
                    }
                    if (currentEditItem.itemId && (formData.get('password') || formData.get('user_name') !== currentEditItem.data.user_name)) {
                        payload.current_password = formData.get('current_password');
                    }
                    break;
                case 'codes':
                    if (currentEditItem.itemId) {
                        // ç¼–è¾‘é€»è¾‘
                        payload = {
                            code: formData.get('code'),
                            type: formData.get('type'),
                            max_uses: parseInt(formData.get('max_uses')) || 1
                        };
                    } else {
                        // åˆ›å»ºé€»è¾‘
                        payload = {
                            type: formData.get('type'),
                            max_uses: parseInt(formData.get('max_uses')) || 1,
                            payload: {} // æ ¹æ®æ–°åç«¯ï¼Œpayloadä¸ºç©ºå¯¹è±¡
                        };
                    }
                    break;
                case 'talents':
                    payload = {
                        name: formData.get('name'),
                        rarity: parseInt(formData.get('rarity')) || 2,
                        talent_cost: parseInt(formData.get('talent_cost')) || 1,
                        description: formData.get('description')
                    };
                    break;
                case 'talent_tiers':
                    payload = {
                        name: formData.get('name'),
                        rarity: parseInt(formData.get('rarity')) || 2,
                        total_points: parseInt(formData.get('total_points')) || 70,
                        color: formData.get('color'),
                        description: formData.get('description')
                    };
                    break;
                case 'players':
                     payload = {
                        user_name: formData.get('user_name'),
                        is_banned: formData.get('is_banned') === 'true'
                    };
                    if (formData.get('password')) {
                        payload.password = formData.get('password');
                    }
                    break;
                case 'worlds':
                    payload = {
                        name: formData.get('name'),
                        era: formData.get('era'),
                        description: formData.get('description')
                    };
                    break;
                case 'origins':
                    payload = {
                        name: formData.get('name'),
                        rarity: parseInt(formData.get('rarity')) || 3,
                        talent_cost: parseInt(formData.get('talent_cost')) || 0,
                        description: formData.get('description')
                    };
                    break;
                case 'spirit_roots':
                    payload = {
                        name: formData.get('name'),
                        base_multiplier: parseFloat(formData.get('base_multiplier')) || 1.0,
                        talent_cost: parseInt(formData.get('talent_cost')) || 0,
                        description: formData.get('description')
                    };
                    break;
                case 'characters':
                    // å¤„ç†å¤©èµ‹IDåˆ—è¡¨
                    const talentIdsStr = formData.get('selected_talent_ids');
                    let selectedTalentIds = [];
                    if (talentIdsStr && talentIdsStr.trim()) {
                        selectedTalentIds = talentIdsStr.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
                    }
                    
                    payload = {
                        character_name: formData.get('character_name'),
                        player_id: parseInt(formData.get('player_id')),
                        world_id: parseInt(formData.get('world_id')),
                        talent_tier_id: parseInt(formData.get('talent_tier_id')),
                        birth_age: parseInt(formData.get('birth_age')) || 16,
                        origin_id: formData.get('origin_id') ? parseInt(formData.get('origin_id')) : null,
                        spirit_root_id: formData.get('spirit_root_id') ? parseInt(formData.get('spirit_root_id')) : null,
                        selected_talent_ids: selectedTalentIds,
                        root_bone: parseInt(formData.get('root_bone')),
                        spirituality: parseInt(formData.get('spirituality')),
                        comprehension: parseInt(formData.get('comprehension')),
                        fortune: parseInt(formData.get('fortune')),
                        charm: parseInt(formData.get('charm')),
                        temperament: parseInt(formData.get('temperament'))
                    };
                    break;
                default:
                    // Fallback for any other case
                    for (let [key, value] of formData.entries()) {
                        payload[key] = value;
                    }
                    break;
            }

            try {
                let endpoint = '';
                let method = 'PUT';
                
                if (currentEditItem.itemId) {
                    // ç¼–è¾‘
                    method = 'PUT';
                    switch(tabName) {
                        case 'admins': endpoint = `/admin/accounts/${currentEditItem.itemId}`; break;
                        case 'codes': endpoint = `/admin/codes/${currentEditItem.itemId}`; break;
                        case 'talents': endpoint = `/talents/${currentEditItem.itemId}`; break;
                        case 'talent_tiers': endpoint = `/talent_tiers/${currentEditItem.itemId}`; break;
                        case 'players': endpoint = `/users/${currentEditItem.itemId}`; break;
                        case 'worlds': endpoint = `/worlds/${currentEditItem.itemId}`; break;
                        case 'origins': endpoint = `/origins/${currentEditItem.itemId}`; break;
                        case 'spirit_roots': endpoint = `/spirit_roots/${currentEditItem.itemId}`; break;
                    }
                } else {
                    // åˆ›å»º
                    method = 'POST';
                    switch(tabName) {
                        case 'admins': endpoint = '/admin/accounts'; break;
                        case 'codes': endpoint = '/admin/codes'; break;
                        case 'talents': endpoint = '/talents'; break;
                        case 'talent_tiers': endpoint = '/talent_tiers'; break;
                        case 'players': endpoint = '/register'; break;
                        case 'worlds': endpoint = '/worlds'; break;
                        case 'origins': endpoint = '/origins'; break;
                        case 'spirit_roots': endpoint = '/spirit_roots'; break;
                        case 'characters': endpoint = '/characters/create_by_admin'; break;
                    }
                }

                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    hideEditModal();
                    refreshCurrentTab();
                } else {
                    const error = await response.json();
                    document.getElementById('editError').textContent = error.detail || 'ä¿å­˜å¤±è´¥';
                    document.getElementById('editError').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('editError').textContent = 'ç½‘ç»œé”™è¯¯';
                document.getElementById('editError').classList.remove('hidden');
            }
        }

        // åˆ é™¤åŠŸèƒ½
        async function deleteItem(tabName, itemId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿ')) return;

            try {
                let endpoint = '';
                switch(tabName) {
                    case 'admins':
                        endpoint = `/admin/accounts/${itemId}`;
                        break;
                    case 'codes':
                        endpoint = `/admin/codes/${itemId}`;
                        break;
                    case 'talents':
                        endpoint = `/talents/${itemId}`;
                        break;
                    case 'talent_tiers':
                        endpoint = `/talent_tiers/${itemId}`;
                        break;
                    case 'players':
                        endpoint = `/users/${itemId}`;
                        break;
                    case 'worlds':
                        endpoint = `/worlds/${itemId}`;
                        break;
                    case 'origins':
                        endpoint = `/origins/${itemId}`;
                        break;
                    case 'spirit_roots':
                        endpoint = `/spirit_roots/${itemId}`;
                        break;
                }

                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    refreshCurrentTab();
                } else {
                    const error = await response.json();
                    alert(error.detail || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        // æ·»åŠ åŠŸèƒ½
        function showAddItemModal() {
            currentEditItem = { tabName: currentTab, itemId: null, data: {} };
            renderAddForm(currentTab);
            document.getElementById('editModal').classList.remove('hidden');
        }

        function renderAddForm(tabName) {
            let fields = '';
            let title = '';

            switch(tabName) {
                case 'admins':
                    title = 'æ·»åŠ æ–°ä»™å®˜';
                    fields = `
                        <div class="form-group">
                            <label class="form-label">ä»™å®˜é“å·</label>
                            <input type="text" name="user_name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å¯†ç </label>
                            <input type="password" name="password" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å“é˜¶</label>
                            <select name="role" class="form-select">
                                <option value="admin">æ™®é€šä»™å®˜</option>
                                <option value="super_admin">è¶…çº§ä»™å®˜</option>
                            </select>
                        </div>
                    `;
                    break;
                case 'codes':
                    title = 'ç”Ÿæˆå¤©æœºç¬¦ç®“ (å…‘æ¢ç )';
                    fields = `
                        <div class="form-group">
                            <label class="form-label">ç¬¦ç®“ç±»å‹</label>
                            <select name="type" id="codeTypeSelect" class="form-select">
                                <option value="world">ğŸŒ ä¸–ç•Œé€šè¡Œè¯</option>
                                <option value="talent_tier">â­ å¤©èµ„å·è½´</option>
                                <option value="origin">ğŸ‘‘ å‡ºèº«ä»¤ç‰Œ</option>
                                <option value="spirit_root">ğŸŒŸ çµæ ¹ç‰ç®€</option>
                                <option value="talent">ğŸ’ å¤©èµ‹ç§˜ç±</option>
                            </select>
                            <small style="color: var(--text-light); display: block; margin-top: 5px;">
                                ä½¿ç”¨æ—¶ä¼šæ ¹æ®ç±»å‹è‡ªåŠ¨æä¾›å¯¹åº”çš„ç¨€æœ‰å†…å®¹
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æœ€å¤§ä½¿ç”¨æ¬¡æ•°</label>
                            <input type="number" name="max_uses" class="form-input" value="1" min="1" required>
                            <small style="color: var(--text-light); display: block; margin-top: 5px;">
                                è®¾ç½®æ­¤å…‘æ¢ç å¯è¢«ä½¿ç”¨çš„æ¬¡æ•°
                            </small>
                        </div>
                    `;
                    break;
                case 'talents':
                    title = 'æ·»åŠ æ–°å¤©èµ‹';
                    fields = `
                        <div class="form-group">
                            <label class="form-label">å¤©èµ‹åç§°</label>
                            <input type="text" name="name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç¨€æœ‰åº¦</label>
                            <input type="number" name="rarity" class="form-input" value="2">
                        </div>
                        <div class="form-group">
                            <label class="form-label">èŠ±è´¹ç‚¹æ•°</label>
                            <input type="number" name="talent_cost" class="form-input" value="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æè¿°</label>
                            <textarea name="description" class="form-input" rows="3"></textarea>
                        </div>
                    `;
                    break;
                case 'talent_tiers':
                    title = 'æ·»åŠ æ–°å¤©èµ„';
                    fields = `
                        <div class="form-group">
                            <label class="form-label">å¤©èµ„åç§°</label>
                            <input type="text" name="name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç¨€æœ‰åº¦</label>
                            <input type="number" name="rarity" class="form-input" value="2">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ€»ç‚¹æ•°</label>
                            <input type="number" name="total_points" class="form-input" value="70">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é¢œè‰²</label>
                            <input type="text" name="color" class="form-input" value="#FFFFFF">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æè¿°</label>
                            <textarea name="description" class="form-input" rows="3"></textarea>
                        </div>
                    `;
                    break;
                case 'players':
                    title = 'æ·»åŠ æ–°ç©å®¶';
                    fields = `
                        <div class="form-group">
                            <label class="form-label">ç”¨æˆ·å</label>
                            <input type="text" name="user_name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å¯†ç </label>
                            <input type="password" name="password" class="form-input" required>
                        </div>
                    `;
                    break;
                case 'worlds':
                    title = 'æ·»åŠ æ–°ä¸–ç•Œ';
                    fields = `
                        <div class="form-group">
                            <label class="form-label">ä¸–ç•Œåç§°</label>
                            <input type="text" name="name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ—¶ä»£èƒŒæ™¯</label>
                            <input type="text" name="era" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ä¸–ç•Œæè¿°</label>
                            <textarea name="description" class="form-input" rows="4"></textarea>
                        </div>
                    `;
                    break;
                case 'origins':
                    title = 'æ·»åŠ æ–°å‡ºèº«';
                    fields = `
                        <div class="form-group">
                            <label class="form-label">å‡ºèº«åç§°</label>
                            <input type="text" name="name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç¨€æœ‰åº¦</label>
                            <input type="number" name="rarity" class="form-input" value="3">
                        </div>
                        <div class="form-group">
                            <label class="form-label">èŠ±è´¹ç‚¹æ•°</label>
                            <input type="number" name="talent_cost" class="form-input" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æè¿°</label>
                            <textarea name="description" class="form-input" rows="3"></textarea>
                        </div>
                    `;
                    break;
                case 'spirit_roots':
                    title = 'æ·»åŠ æ–°çµæ ¹';
                    fields = `
                        <div class="form-group">
                            <label class="form-label">çµæ ¹åç§°</label>
                            <input type="text" name="name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">åŸºç¡€å€ç‡</label>
                            <input type="number" name="base_multiplier" class="form-input" step="0.1" value="1.0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">èŠ±è´¹ç‚¹æ•°</label>
                            <input type="number" name="talent_cost" class="form-input" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æè¿°</label>
                            <textarea name="description" class="form-input" rows="3"></textarea>
                        </div>
                    `;
                    break;
                case 'characters':
                    title = 'åˆ›å»ºæ–°è§’è‰²';
                    fields = `
                        <div class="form-group">
                            <label class="form-label">è§’è‰²é“å·</label>
                            <input type="text" name="character_name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ‰€å±ç©å®¶ID</label>
                            <input type="number" name="player_id" class="form-input" min="1" required>
                            <small style="color: var(--text-light); display: block; margin-top: 5px;">
                                è¾“å…¥ç©å®¶çš„ç”¨æˆ·IDï¼Œè¯¥è§’è‰²å°†å½’å±äºæ­¤ç©å®¶
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ä¸–ç•ŒID</label>
                            <input type="number" name="world_id" class="form-input" min="1" required>
                            <small style="color: var(--text-light); display: block; margin-top: 5px;">
                                é€‰æ‹©è§’è‰²æ‰€åœ¨çš„ä¸–ç•ŒèƒŒæ™¯
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å¤©èµ„ç­‰çº§ID</label>
                            <input type="number" name="talent_tier_id" class="form-input" min="1" required>
                            <small style="color: var(--text-light); display: block; margin-top: 5px;">
                                é€‰æ‹©è§’è‰²çš„å¤©èµ„ç­‰çº§
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å‡ºèº«IDï¼ˆå¯é€‰ï¼‰</label>
                            <input type="number" name="origin_id" class="form-input" min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">çµæ ¹IDï¼ˆå¯é€‰ï¼‰</label>
                            <input type="number" name="spirit_root_id" class="form-input" min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">åˆå§‹å¹´é¾„</label>
                            <input type="number" name="birth_age" class="form-input" min="0" max="18" value="16" required>
                            <small style="color: var(--text-light); display: block; margin-top: 5px;">
                                è®¾ç½®è§’è‰²çš„åˆå§‹å¹´é¾„ï¼ˆ0-18å²ï¼‰
                            </small>
                        </div>
                        <div class="form-group">
                            <h4>å…ˆå¤©å…­å¸é…ç½®</h4>
                            <small style="color: var(--text-light); display: block; margin-bottom: 10px;">
                                æ¯é¡¹å±æ€§å€¼èŒƒå›´ï¼š0-10ç‚¹
                            </small>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div class="form-group">
                                <label class="form-label">æ ¹éª¨</label>
                                <input type="number" name="root_bone" class="form-input" min="0" max="10" value="5" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">çµæ€§</label>
                                <input type="number" name="spirituality" class="form-input" min="0" max="10" value="5" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ‚Ÿæ€§</label>
                                <input type="number" name="comprehension" class="form-input" min="0" max="10" value="5" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ç¦ç¼˜</label>
                                <input type="number" name="fortune" class="form-input" min="0" max="10" value="5" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">é­…åŠ›</label>
                                <input type="number" name="charm" class="form-input" min="0" max="10" value="5" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">å¿ƒæ€§</label>
                                <input type="number" name="temperament" class="form-input" min="0" max="10" value="5" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å¤©èµ‹IDåˆ—è¡¨ï¼ˆå¯é€‰ï¼‰</label>
                            <input type="text" name="selected_talent_ids" class="form-input" placeholder="ä¾‹å¦‚ï¼š1,2,3">
                            <small style="color: var(--text-light); display: block; margin-top: 5px;">
                                å¤šä¸ªå¤©èµ‹IDç”¨é€—å·åˆ†éš”ï¼Œç•™ç©ºè¡¨ç¤ºä¸é€‰æ‹©ä»»ä½•å¤©èµ‹
                            </small>
                        </div>
                    `;
                    break;
            }

            document.getElementById('editModalTitle').textContent = title;
            document.getElementById('editFormFields').innerHTML = fields;
        }

        // å°å·ç›¸å…³åŠŸèƒ½
        function banPlayer(playerId, playerName) {
            document.getElementById('banPlayerId').value = playerId;
            document.getElementById('banPlayerName').value = playerName;
            document.getElementById('banModal').classList.remove('hidden');
            document.getElementById('banError').classList.add('hidden');
            document.getElementById('banForm').reset();
            // è®¾ç½®é»˜è®¤ç»“æŸæ—¶é—´ä¸º1å¤©å
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('banEndTime').value = tomorrow.toISOString().slice(0, 16);
        }

        function hideBanModal() {
            document.getElementById('banModal').classList.add('hidden');
        }

        async function handleBanSubmit(e) {
            e.preventDefault();
            const playerId = document.getElementById('banPlayerId').value;
            const banType = document.getElementById('banType').value;
            const banReason = document.getElementById('banReason').value;
            let banEndTime = null;

            if (banType === 'temporary') {
                banEndTime = document.getElementById('banEndTime').value;
                if (!banEndTime) {
                    document.getElementById('banError').textContent = 'ä¸´æ—¶å°å·å¿…é¡»è®¾ç½®ç»“æŸæ—¶é—´';
                    document.getElementById('banError').classList.remove('hidden');
                    return;
                }
            }

            try {
                const payload = {
                    player_id: parseInt(playerId),
                    ban_type: banType,
                    reason: banReason
                };
                
                if (banEndTime) {
                    payload.ban_end_time = new Date(banEndTime).toISOString();
                }

                const response = await fetch(`${API_BASE}/ban/ban_player`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    hideBanModal();
                    refreshCurrentTab();
                    alert('ç©å®¶å°ç¦æˆåŠŸ');
                } else {
                    const error = await response.json();
                    document.getElementById('banError').textContent = error.detail || 'å°ç¦å¤±è´¥';
                    document.getElementById('banError').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('banError').textContent = 'ç½‘ç»œé”™è¯¯';
                document.getElementById('banError').classList.remove('hidden');
            }
        }

        async function unbanPlayer(playerId, playerName) {
            if (!confirm(`ç¡®å®šè¦è§£å°ç©å®¶ "${playerName}" å—ï¼Ÿ`)) return;

            try {
                const response = await fetch(`${API_BASE}/ban/unban_player/${playerId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    refreshCurrentTab();
                    alert('ç©å®¶è§£å°æˆåŠŸ');
                } else {
                    const error = await response.json();
                    alert(error.detail || 'è§£å°å¤±è´¥');
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        async function liftBan(banRecordId) {
            if (!confirm('ç¡®å®šè¦è§£é™¤æ­¤å°å·è®°å½•å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`${API_BASE}/ban/unban_player/${banRecordId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    refreshCurrentTab();
                    alert('å°å·å·²è§£é™¤');
                } else {
                    const error = await response.json();
                    alert(error.detail || 'è§£å°å¤±è´¥');
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        async function handleAppeal(banRecordId, approve) {
            const action = approve ? 'æ‰¹å‡†' : 'æ‹’ç»';
            if (!confirm(`ç¡®å®šè¦${action}æ­¤ç”³è¯‰å—ï¼Ÿ`)) return;

            try {
                const response = await fetch(`${API_BASE}/ban/handle_appeal/${banRecordId}?approve=${approve}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    refreshCurrentTab();
                    alert(`ç”³è¯‰å·²${action}`);
                } else {
                    const error = await response.json();
                    alert(error.detail || `${action}ç”³è¯‰å¤±è´¥`);
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        // è§’è‰²ç®¡ç†åŠŸèƒ½
        async function viewCharacterDetails(characterId) {
            try {
                const response = await fetch(`${API_BASE}/characters/${characterId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const character = await response.json();
                    
                    // è·å–æ¸¸æˆçŠ¶æ€
                    const stateResponse = await fetch(`${API_BASE}/characters/${characterId}/game_state`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    let gameState = null;
                    if (stateResponse.ok) {
                        gameState = await stateResponse.json();
                    }

                    displayCharacterDetails(character, gameState);
                    document.getElementById('characterModal').classList.remove('hidden');
                } else {
                    alert('è·å–è§’è‰²è¯¦æƒ…å¤±è´¥');
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        function displayCharacterDetails(character, gameState) {
            document.getElementById('characterModalTitle').textContent = `${character.character_name} - è¯¦ç»†ä¿¡æ¯`;
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div>
                        <h4>åŸºç¡€ä¿¡æ¯</h4>
                        <p><strong>è§’è‰²ID:</strong> ${character.id}</p>
                        <p><strong>è§’è‰²å:</strong> ${character.character_name}</p>
                        <p><strong>ä¸–ç•ŒID:</strong> ${character.world_id}</p>
                        <p><strong>å¤©èµ„ç­‰çº§ID:</strong> ${character.talent_tier_id}</p>
                        <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(character.created_at).toLocaleString('zh-CN')}</p>
                        <p><strong>æœ€åæ¸¸æˆ:</strong> ${character.last_played ? new Date(character.last_played).toLocaleString('zh-CN') : 'ä»æœªæ¸¸æˆ'}</p>
                        <p><strong>æ¸¸æˆæ—¶é•¿:</strong> ${Math.floor(character.play_time_minutes / 60)}å°æ—¶${character.play_time_minutes % 60}åˆ†é’Ÿ</p>
                        <p><strong>çŠ¶æ€:</strong> ${character.is_active ? 'æ¿€æ´»' : 'æœªæ¿€æ´»'} ${character.is_deleted ? '(å·²åˆ é™¤)' : ''}</p>
                    </div>
                    <div>
                        <h4>å…ˆå¤©å…­å¸</h4>
                        <p><strong>æ ¹éª¨:</strong> ${character.root_bone}</p>
                        <p><strong>çµæ€§:</strong> ${character.spirituality}</p>
                        <p><strong>æ‚Ÿæ€§:</strong> ${character.comprehension}</p>
                        <p><strong>ç¦ç¼˜:</strong> ${character.fortune}</p>
                        <p><strong>é­…åŠ›:</strong> ${character.charm}</p>
                        <p><strong>å¿ƒæ€§:</strong> ${character.temperament}</p>
                    </div>
            `;
            
            if (gameState) {
                html += `
                    <div>
                        <h4>æ¸¸æˆçŠ¶æ€</h4>
                        <p><strong>å½“å‰å¢ƒç•Œ:</strong> ${gameState.current_realm_id || 'å‡¡äºº'}</p>
                        <p><strong>ä¿®ç‚¼è¿›åº¦:</strong> ${gameState.cultivation_progress.toFixed(1)}%</p>
                        <p><strong>ä¿®ç‚¼ç»éªŒ:</strong> ${gameState.cultivation_experience.toLocaleString()}</p>
                        <p><strong>å½“å‰ä½ç½®:</strong> ${gameState.current_location || 'æœªçŸ¥'}</p>
                        <p><strong>çµçŸ³:</strong> ${gameState.spiritual_stones.toLocaleString()}</p>
                        <p><strong>ç”Ÿå‘½å€¼:</strong> ${gameState.health_points}/100</p>
                        <p><strong>æœ€ååŒæ­¥:</strong> ${new Date(gameState.last_sync_time).toLocaleString('zh-CN')}</p>
                        <p><strong>æ•°æ®ç‰ˆæœ¬:</strong> ${gameState.version}</p>
                    </div>
                `;
            }
            
            html += `</div>`;
            document.getElementById('characterDetails').innerHTML = html;
        }

        function hideCharacterModal() {
            document.getElementById('characterModal').classList.add('hidden');
        }

        async function deleteCharacter(characterId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤è§’è‰²å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`${API_BASE}/characters/${characterId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    refreshCurrentTab();
                    alert('è§’è‰²åˆ é™¤æˆåŠŸ');
                } else {
                    const error = await response.json();
                    alert(error.detail || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        async function restoreCharacter(characterId) {
            if (!confirm('ç¡®å®šè¦æ¢å¤æ­¤è§’è‰²å—ï¼Ÿ')) return;

            try {
                // è¿™é‡Œéœ€è¦æ·»åŠ æ¢å¤è§’è‰²çš„APIç«¯ç‚¹
                alert('æ¢å¤åŠŸèƒ½å¾…å®ç°');
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        // æ‰©å±•æ·»åŠ é¡¹ç›®åŠŸèƒ½ä»¥æ”¯æŒå°å·
        function showAddItemModal() {
            if (currentTab === 'ban_records') {
                // æ˜¾ç¤ºå°å·ç•Œé¢ï¼Œéœ€è¦é€‰æ‹©ç©å®¶
                showBanPlayerSelection();
            } else {
                currentEditItem = { tabName: currentTab, itemId: null, data: {} };
                renderAddForm(currentTab);
                document.getElementById('editModal').classList.remove('hidden');
            }
        }

        async function showBanPlayerSelection() {
            try {
                const response = await fetch(`${API_BASE}/users/`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const players = await response.json();
                    const normalPlayers = players.filter(p => !p.is_banned);
                    
                    if (normalPlayers.length === 0) {
                        alert('æ²¡æœ‰å¯å°ç¦çš„ç©å®¶');
                        return;
                    }

                    // åˆ›å»ºé€‰æ‹©ç•Œé¢
                    // åˆ›å»ºé€‰æ‹©ç•Œé¢
                    let html = `
                        <div class="form-group">
                            <label class="form-label">é€‰æ‹©è¦å°ç¦çš„ç©å®¶</label>
                            <select id="selectPlayerToBan" name="player_to_ban" class="form-select" required>
                                <option value="">è¯·é€‰æ‹©ç©å®¶</option>
                    `;
                    
                    normalPlayers.forEach(player => {
                        html += `<option value="${player.id}" data-name="${player.user_name}">${player.user_name} (ID: ${player.id})</option>`;
                    });
                    
                    html += `
                            </select>
                        </div>
                    `;

                    document.getElementById('editModalTitle').textContent = 'é€‰æ‹©è¦å°ç¦çš„ç©å®¶';
                    document.getElementById('editFormFields').innerHTML = html;
                    
                    const submitBtn = document.getElementById('editModalSubmitBtn');
                    submitBtn.textContent = 'ä¸‹ä¸€æ­¥';
                    submitBtn.className = 'btn btn-danger'; // æ›´æ”¹æŒ‰é’®æ ·å¼
                    
                    document.getElementById('editModal').classList.remove('hidden');
                }
            } catch (error) {
                alert('è·å–ç©å®¶åˆ—è¡¨å¤±è´¥');
            }
        }

        function proceedToBan() {
            const selectElement = document.getElementById('selectPlayerToBan');
            if (!selectElement) return;

            const playerId = selectElement.value;
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            
            if (!playerId || !selectedOption) {
                alert('è¯·é€‰æ‹©è¦å°ç¦çš„ç©å®¶');
                return;
            }
            const playerName = selectedOption.dataset.name;

            hideEditModal();
            // æ¢å¤æŒ‰é’®é»˜è®¤çŠ¶æ€
            const submitBtn = document.getElementById('editModalSubmitBtn');
            submitBtn.textContent = 'ä¿å­˜';
            submitBtn.className = 'btn btn-primary';
            
            banPlayer(playerId, playerName);
        }

    </script>
</body>
</html>