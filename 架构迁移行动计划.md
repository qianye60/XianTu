# 架构迁移行动计划

## 📋 概述

**目标**：将项目从"Pinia + 酒馆 + IndexedDB"三层架构迁移到"Pinia + IndexedDB"两层架构

**当前状态**：45% 完成（组件层完成，但底层仍依赖酒馆存储）

**预计工作量**：2-3天

---

## 🎯 目标架构

### 架构对比

**当前架构（实际）**：
```
组件 → Pinia (characterStore/gameStateStore)
         ↓
      酒馆助手全局变量 (saveData) ← 主要存储
         ↓
      IndexedDB (备份/离线存储)
         ↓
       AI 交互
```

**目标架构**：
```
组件 → Pinia (gameStateStore) ↔ IndexedDB (主要存储)
         ↓ (仅通过 prompt)
       AI 交互
```

---

## 📝 详细任务清单

### 阶段 1：IndexedDB 增强 (4小时)

#### 1.1 修改 `indexedDBManager.ts`
**文件**：`src/utils/indexedDBManager.ts`

**新增方法**：
```typescript
// 保存激活存档的 SaveData
export async function saveActiveSaveData(
  characterId: string,
  slotId: string,
  saveData: SaveData
): Promise<void>

// 加载激活存档的 SaveData
export async function loadActiveSaveData(
  characterId: string,
  slotId: string
): Promise<SaveData | null>
```

**任务**：
- [ ] 实现 `saveActiveSaveData()` - 直接保存 SaveData 到 IndexedDB
- [ ] 实现 `loadActiveSaveData()` - 直接从 IndexedDB 加载 SaveData
- [ ] 添加错误处理和重试机制
- [ ] 添加数据验证（确保 SaveData 结构完整）

---

### 阶段 2：修改 characterStore (6小时)

#### 2.1 重构存储方法
**文件**：`src/stores/characterStore.ts`

**需要修改的方法**：

##### `setActiveCharacterInTavern()`
**当前**：使用 `helper.setVariable('saveData', ...)`
**目标**：直接保存到 IndexedDB

```typescript
// 修改前
await helper.setVariable('saveData', JSON.stringify(currentSlot.存档数据), { type: 'global' });

// 修改后
await storage.saveActiveSaveData(charId, slotId, currentSlot.存档数据);
```

##### `syncFromTavern()`
**当前**：从酒馆变量读取 saveData
**目标**：改名为 `syncFromIndexedDB()`，从 IndexedDB 读取

```typescript
// 修改前
const vars = helper.getVariables({ type: 'global' });
const saveDataStr = vars['saveData'];
const saveData = JSON.parse(saveDataStr) as SaveData;

// 修改后
const saveData = await storage.loadActiveSaveData(charId, slotId);
```

##### `saveCurrentGame()`
**当前**：从酒馆变量读取最新数据
**目标**：从 gameStateStore 读取，保存到 IndexedDB

```typescript
// 修改前
const vars = helper.getVariables({ type: 'global' });
const saveDataStr = vars['saveData'];
const currentSaveData = JSON.parse(saveDataStr) as SaveData;

// 修改后
const gameState = useGameStateStore();
const currentSaveData = gameState.toSaveData();
```

##### `saveToSlot()`
**当前**：从酒馆变量读取数据
**目标**：从 gameStateStore 读取

**任务**：
- [ ] 修改 `setActiveCharacterInTavern()` 使用 IndexedDB
- [ ] 重命名 `syncFromTavern()` 为 `syncFromIndexedDB()`
- [ ] 修改 `syncFromIndexedDB()` 从 IndexedDB 读取
- [ ] 修改 `saveCurrentGame()` 从 gameStateStore 获取数据
- [ ] 修改 `saveToSlot()` 从 gameStateStore 获取数据
- [ ] 移除所有 `getTavernHelper()` 调用
- [ ] 移除所有 `helper.setVariable()`、`helper.getVariables()` 调用

---

### 阶段 3：修改 AI 交互层 (4小时)

#### 3.1 修改 `AIBidirectionalSystem.ts`
**文件**：`src/utils/AIBidirectionalSystem.ts`

**任务**：
- [ ] 确保从 gameStateStore 获取 saveData
- [ ] AI 请求仅通过 prompt 传递状态
- [ ] 移除任何酒馆变量读写
- [ ] AI 响应后直接更新 gameStateStore

#### 3.2 修改 `AIGameMaster.ts`
**文件**：`src/utils/AIGameMaster.ts`

**任务**：
- [ ] `processGmResponse()` 确保只从 gameStateStore 读写
- [ ] 移除任何酒馆同步代码
- [ ] 命令执行后更新 gameStateStore

---

### 阶段 4：修改角色初始化 (2小时)

#### 4.1 修改 `characterInitialization.ts`
**文件**：`src/services/characterInitialization.ts`

**任务**：
- [ ] 确保不使用酒馆变量保存初始数据
- [ ] 返回的 SaveData 直接保存到 IndexedDB
- [ ] 移除任何酒馆同步代码

#### 4.2 修改 `App.vue` 角色创建流程
**文件**：`src/App.vue`

**任务**：
- [ ] `handleCreationComplete()` 中移除酒馆同步
- [ ] 直接将 SaveData 保存到 IndexedDB
- [ ] 更新 gameStateStore

---

### 阶段 5：测试与验证 (4小时)

#### 5.1 功能测试
- [ ] 创建新角色 - 验证数据正确保存到 IndexedDB
- [ ] 加载角色 - 验证数据从 IndexedDB 正确加载
- [ ] AI 对话 - 验证不依赖酒馆变量
- [ ] 保存游戏 - 验证直接保存到 IndexedDB
- [ ] 存档切换 - 验证多存档正常工作
- [ ] 离线测试 - 验证不依赖 SillyTavern 运行时

#### 5.2 数据迁移测试
- [ ] 测试现有存档的加载（向后兼容）
- [ ] 验证数据完整性
- [ ] 验证所有游戏功能正常

#### 5.3 性能测试
- [ ] 对比迁移前后的保存/加载速度
- [ ] 检查内存使用
- [ ] 验证响应速度提升

---

### 阶段 6：清理代码 (2小时)

#### 6.1 移除废弃代码
- [ ] 删除所有 `getTavernHelper()` 相关代码（如不再需要）
- [ ] 清理 `src/utils/tavern.ts` 中的存储相关函数
- [ ] 移除未使用的导入
- [ ] 清理注释和 console.log

#### 6.2 更新文档
- [ ] 更新 README.md 说明新架构
- [ ] 更新架构重构文档标记为 100% 完成
- [ ] 添加迁移说明

---

## 📅 时间估算

| 阶段 | 任务 | 预计时间 |
|-----|------|---------|
| 1 | IndexedDB 增强 | 4 小时 |
| 2 | 修改 characterStore | 6 小时 |
| 3 | 修改 AI 交互层 | 4 小时 |
| 4 | 修改角色初始化 | 2 小时 |
| 5 | 测试与验证 | 4 小时 |
| 6 | 清理代码 | 2 小时 |
| **总计** | | **22 小时** (约 2-3 天) |

---

## ⚠️ 风险与注意事项

### 高风险项
1. **数据丢失风险**
   - 在迁移过程中确保现有存档不丢失
   - 建议先备份 IndexedDB 数据
   - 实现数据验证和恢复机制

2. **向后兼容性**
   - 确保现有存档可以正常加载
   - 可能需要数据迁移逻辑

3. **AI 交互中断**
   - 确保 AI 不依赖酒馆变量
   - 测试所有 AI 命令正常执行

### 降低风险的措施
1. **逐步迁移**
   - 先完成 IndexedDB 增强
   - 再逐个修改 characterStore 方法
   - 每个阶段都进行测试

2. **保留回退方案**
   - 使用 Git 分支进行开发
   - 保留酒馆存储代码（注释掉）以便回退
   - 完成测试后再删除

3. **充分测试**
   - 每个功能都要测试
   - 特别注意边界情况
   - 进行离线测试

---

## ✅ 验收标准

### 功能完整性
- [ ] 所有游戏功能正常工作
- [ ] 不依赖 SillyTavern 运行时环境
- [ ] 支持离线使用

### 性能指标
- [ ] 保存速度提升 30%+
- [ ] 加载速度提升 30%+
- [ ] 内存使用减少 20%+

### 代码质量
- [ ] TypeScript 编译通过
- [ ] 无废弃代码
- [ ] 无 console.log
- [ ] 文档已更新

### 架构清晰
- [ ] 数据流简洁明了
- [ ] 职责划分清晰
- [ ] 易于维护和扩展

---

## 🎉 预期收益

1. **架构简化**
   - 从三层架构简化为两层
   - 减少数据同步开销
   - 降低系统复杂度

2. **性能提升**
   - 减少数据序列化/反序列化
   - 减少网络请求（酒馆 API 调用）
   - 更快的保存/加载速度

3. **可维护性提升**
   - 数据流更清晰
   - 减少外部依赖
   - 更容易调试和测试

4. **独立性提升**
   - 不再依赖 SillyTavern 运行时
   - 可以独立运行
   - 更好的用户体验

---

## 📞 支持与反馈

如果在迁移过程中遇到问题：
1. 检查 Git 提交记录
2. 查看控制台错误日志
3. 回退到上一个稳定版本
4. 在架构重构文档中记录问题

---

**最后更新**：2025-01-XX
**状态**：待开始
**负责人**：开发团队
