# ä»»åŠ¡ç³»ç»Ÿè®¾è®¡æ–‡æ¡£ï¼ˆç®€åŒ–ç‰ˆï¼‰

> åŸºäºã€Šå¤§é“æœå¤©ã€‹é¡¹ç›®çš„ç®€æ´ä»»åŠ¡ç³»ç»Ÿè®¾è®¡

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æ•°æ®ç»“æ„](#æ•°æ®ç»“æ„)
3. [AIæç¤ºè¯](#aiæç¤ºè¯)
4. [ä»£ç å®ç°](#ä»£ç å®ç°)
5. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)

---

## ç³»ç»Ÿæ¦‚è¿°

### æ ¸å¿ƒç†å¿µ
- **ç®€å•ç›´è§‚**ï¼šä»»åŠ¡ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
- **AIé©±åŠ¨**ï¼šåˆ©ç”¨ç°æœ‰çš„é…’é¦†AIç³»ç»ŸåŠ¨æ€ç”Ÿæˆå’Œæ›´æ–°ä»»åŠ¡
- **æ— ç¼é›†æˆ**ï¼šä¸ç°æœ‰çš„å­˜æ¡£ç³»ç»Ÿã€èƒŒåŒ…ç³»ç»Ÿã€NPCç³»ç»Ÿæ·±åº¦æ•´åˆ

### ä»»åŠ¡æµç¨‹
```
1. AIæ ¹æ®å½“å‰çŠ¶æ€ç”Ÿæˆä»»åŠ¡
   â†“
2. ç©å®¶æ¥å—ä»»åŠ¡
   â†“
3. æ¸¸æˆä¸­å®Œæˆç›®æ ‡ï¼ˆå‡»æ€/é‡‡é›†/å¯¹è¯ç­‰ï¼‰
   â†“
4. AIåˆ¤æ–­å¹¶æ›´æ–°ä»»åŠ¡çŠ¶æ€
   â†“
5. ä»»åŠ¡å®Œæˆï¼Œå‘æ”¾å¥–åŠ±
```

---

## æ•°æ®ç»“æ„

### 1. æ ¸å¿ƒä»»åŠ¡æ•°æ®ï¼ˆæ·»åŠ åˆ° SaveDataï¼‰

```typescript
// src/types/game.d.ts

/** ä»»åŠ¡ç›®æ ‡ */
export interface QuestObjective {
  æè¿°: string;           // "å‡»è´¥3åªé»‘é£ç‹¼"
  ç±»å‹: 'å‡»æ€' | 'é‡‡é›†' | 'å¯¹è¯' | 'åˆ°è¾¾' | 'ä½¿ç”¨ç‰©å“';
  ç›®æ ‡ID: string;        // "monster_é»‘é£ç‹¼" æˆ– "npc_å¼ é•¿è€"
  éœ€æ±‚æ•°é‡: number;
  å½“å‰è¿›åº¦: number;
  å·²å®Œæˆ: boolean;
}

/** ä»»åŠ¡å¥–åŠ± */
export interface QuestReward {
  ä¿®ä¸º?: number;
  çµçŸ³?: {
    ä¸‹å“?: number;
    ä¸­å“?: number;
    ä¸Šå“?: number;
    æå“?: number;
  };
  ç‰©å“?: Array<{
    ç‰©å“ID: string;
    åç§°: string;
    æ•°é‡: number;
  }>;
  å£°æœ›?: {
    åŠ¿åŠ›åç§°: string;
    å˜åŒ–å€¼: number;
  };
}

/** ä»»åŠ¡ä¸»ä½“ */
export interface Quest {
  ä»»åŠ¡ID: string;
  ä»»åŠ¡åç§°: string;
  ä»»åŠ¡æè¿°: string;
  ä»»åŠ¡ç±»å‹: 'ä¸»çº¿' | 'æ”¯çº¿' | 'å®—é—¨' | 'å¥‡é‡' | 'æ—¥å¸¸';
  ä»»åŠ¡çŠ¶æ€: 'æœªæ¥å–' | 'è¿›è¡Œä¸­' | 'å·²å®Œæˆ' | 'å·²å¤±è´¥';
  ç›®æ ‡åˆ—è¡¨: QuestObjective[];
  å¥–åŠ±: QuestReward;
  å‘å¸ƒè€…?: string;       // NPCåç§°
  æäº¤è€…?: string;       // NPCåç§°
  å‰ç½®æ¡ä»¶?: {
    å¢ƒç•Œè¦æ±‚?: string;
    å‰ç½®ä»»åŠ¡?: string;
  };
  åˆ›å»ºæ—¶é—´: string;
  AIç”Ÿæˆ: boolean;
}

/** ä»»åŠ¡ç³»ç»Ÿï¼ˆæ·»åŠ åˆ°SaveDataï¼‰ */
export interface QuestSystem {
  å½“å‰ä»»åŠ¡åˆ—è¡¨: Quest[];
  å·²å®Œæˆä»»åŠ¡: string[];  // ä»»åŠ¡IDåˆ—è¡¨
  ä»»åŠ¡ç»Ÿè®¡: {
    å®Œæˆæ€»æ•°: number;
    ä¸»çº¿å®Œæˆ: number;
    æ”¯çº¿å®Œæˆ: number;
  };
}
```

### 2. æ›´æ–° SaveData æ¥å£

```typescript
export interface SaveData {
  ç©å®¶è§’è‰²çŠ¶æ€: PlayerStatus;
  è£…å¤‡æ : Equipment;
  ä¸‰åƒå¤§é“: ThousandDaoSystem;
  èƒŒåŒ…: Inventory;
  äººç‰©å…³ç³»: Record<string, NpcProfile>;
  å®—é—¨ç³»ç»Ÿ: SectSystemData;
  ä¸–ç•Œä¿¡æ¯: WorldInfo;
  ä»»åŠ¡ç³»ç»Ÿ: QuestSystem;  // âœ… æ–°å¢
  æ¸¸æˆæ—¶é—´: GameTime;
  // ...å…¶ä»–å­—æ®µ
}
```

---

## AIæç¤ºè¯

### 1. ä»»åŠ¡ç”Ÿæˆæç¤ºè¯

åœ¨ `src/utils/prompts/questPrompts.ts` åˆ›å»ºï¼š

```typescript
export const QUEST_GENERATION_PROMPT = `
# ä»»åŠ¡ç”Ÿæˆç³»ç»Ÿ

## å½“å‰çŠ¶æ€
- ç©å®¶å§“åï¼š{{ç©å®¶å§“å}}
- å¢ƒç•Œï¼š{{å½“å‰å¢ƒç•Œ}}
- ä½ç½®ï¼š{{å½“å‰ä½ç½®}}
- æœ€è¿‘äº‹ä»¶ï¼š{{æœ€è¿‘è®°å¿†}}

## ç”Ÿæˆè§„åˆ™
1. ä»»åŠ¡å¿…é¡»ç¬¦åˆå½“å‰å¢ƒç•Œå’Œä½ç½®
2. ä»»åŠ¡ç›®æ ‡å…·ä½“æ˜ç¡®ï¼Œå¯é‡åŒ–
3. å¥–åŠ±ä¸éš¾åº¦ç›¸åŒ¹é…
4. èå…¥ä¿®ä»™ä¸–ç•Œè§‚

## è¾“å‡ºæ ¼å¼
ä½¿ç”¨ tavern_commands åˆ›å»ºä»»åŠ¡ï¼š

\`\`\`json
{
  "text": "ä»»åŠ¡è§¦å‘çš„å‰§æƒ…æè¿°ï¼ˆ200-500å­—ï¼‰",
  "tavern_commands": [
    {
      "action": "set",
      "key": "ä»»åŠ¡ç³»ç»Ÿ.å½“å‰ä»»åŠ¡åˆ—è¡¨.<ä»»åŠ¡ID>",
      "value": {
        "ä»»åŠ¡ID": "quest_{{æ—¶é—´æˆ³}}",
        "ä»»åŠ¡åç§°": "ä»»åŠ¡æ ‡é¢˜",
        "ä»»åŠ¡æè¿°": "è¯¦ç»†æè¿°",
        "ä»»åŠ¡ç±»å‹": "æ”¯çº¿",
        "ä»»åŠ¡çŠ¶æ€": "è¿›è¡Œä¸­",
        "ç›®æ ‡åˆ—è¡¨": [
          {
            "æè¿°": "å‡»è´¥3åªé»‘é£ç‹¼",
            "ç±»å‹": "å‡»æ€",
            "ç›®æ ‡ID": "monster_é»‘é£ç‹¼",
            "éœ€æ±‚æ•°é‡": 3,
            "å½“å‰è¿›åº¦": 0,
            "å·²å®Œæˆ": false
          }
        ],
        "å¥–åŠ±": {
          "ä¿®ä¸º": 100,
          "çµçŸ³": { "ä¸‹å“": 50 },
          "ç‰©å“": [
            { "ç‰©å“ID": "item_healing_pill", "åç§°": "ç–—ä¼¤ä¸¹", "æ•°é‡": 2 }
          ]
        },
        "å‘å¸ƒè€…": "æ‘é•¿æå¤§å±±",
        "AIç”Ÿæˆ": true,
        "åˆ›å»ºæ—¶é—´": "{{å½“å‰æ¸¸æˆæ—¶é—´}}"
      }
    }
  ]
}
\`\`\`

## ä»»åŠ¡ç±»å‹è¯´æ˜
- **ä¸»çº¿**ï¼šæ¨åŠ¨å‰§æƒ…çš„æ ¸å¿ƒä»»åŠ¡
- **æ”¯çº¿**ï¼šå¯é€‰çš„é¢å¤–ä»»åŠ¡
- **å®—é—¨**ï¼šå®—é—¨å†…çš„ä»»åŠ¡
- **å¥‡é‡**ï¼šå¶ç„¶è§¦å‘çš„æœºç¼˜
- **æ—¥å¸¸**ï¼šå¯é‡å¤çš„æ—¥å¸¸ä»»åŠ¡

## ç›®æ ‡ç±»å‹è¯´æ˜
- **å‡»æ€**ï¼šç›®æ ‡IDä¸ºæ€ªç‰©åç§°ï¼Œå¦‚ "monster_é»‘é£ç‹¼"
- **é‡‡é›†**ï¼šç›®æ ‡IDä¸ºç‰©å“IDï¼Œå¦‚ "item_çµè‰"
- **å¯¹è¯**ï¼šç›®æ ‡IDä¸ºNPCåç§°ï¼Œå¦‚ "npc_å¼ é•¿è€"
- **åˆ°è¾¾**ï¼šç›®æ ‡IDä¸ºåœ°ç‚¹æè¿°ï¼Œå¦‚ "location_é’äº‘å³°"
- **ä½¿ç”¨ç‰©å“**ï¼šç›®æ ‡IDä¸ºç‰©å“ID
`;

export const QUEST_UPDATE_PROMPT = `
# ä»»åŠ¡æ›´æ–°ç³»ç»Ÿ

## å½“å‰ä»»åŠ¡
{{å½“å‰ä»»åŠ¡JSON}}

## ç©å®¶è¡Œä¸º
{{ç©å®¶æœ€è¿‘è¡Œä¸º}}

## æ›´æ–°è§„åˆ™
1. æ ¹æ®ç©å®¶è¡Œä¸ºæ›´æ–°ä»»åŠ¡è¿›åº¦
2. åˆ¤æ–­æ˜¯å¦è§¦å‘ä»»åŠ¡æ¼”åŒ–
3. æ£€æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰ç›®æ ‡

## è¾“å‡ºæ ¼å¼
\`\`\`json
{
  "text": "ä»»åŠ¡è¿›åº¦æ›´æ–°çš„æè¿°",
  "tavern_commands": [
    {
      "action": "set",
      "key": "ä»»åŠ¡ç³»ç»Ÿ.å½“å‰ä»»åŠ¡åˆ—è¡¨.{{ä»»åŠ¡ID}}.ç›®æ ‡åˆ—è¡¨.0.å½“å‰è¿›åº¦",
      "value": 1
    },
    {
      "action": "set",
      "key": "ä»»åŠ¡ç³»ç»Ÿ.å½“å‰ä»»åŠ¡åˆ—è¡¨.{{ä»»åŠ¡ID}}.ç›®æ ‡åˆ—è¡¨.0.å·²å®Œæˆ",
      "value": false
    }
  ]
}
\`\`\`
`;

export const QUEST_COMPLETE_PROMPT = `
# ä»»åŠ¡å®Œæˆç³»ç»Ÿ

## å®Œæˆçš„ä»»åŠ¡
{{ä»»åŠ¡JSON}}

## å‘æ”¾å¥–åŠ±
æ ¹æ®ä»»åŠ¡å¥–åŠ±é…ç½®ï¼Œä½¿ç”¨ tavern_commands å‘æ”¾ï¼š

\`\`\`json
{
  "text": "ä»»åŠ¡å®Œæˆçš„åº†ç¥æè¿°å’Œå¥–åŠ±å‘æ”¾åœºæ™¯ï¼ˆ200-300å­—ï¼‰",
  "tavern_commands": [
    // æ›´æ–°ä»»åŠ¡çŠ¶æ€
    {
      "action": "set",
      "key": "ä»»åŠ¡ç³»ç»Ÿ.å½“å‰ä»»åŠ¡åˆ—è¡¨.{{ä»»åŠ¡ID}}.ä»»åŠ¡çŠ¶æ€",
      "value": "å·²å®Œæˆ"
    },
    // æ·»åŠ ä¿®ä¸º
    {
      "action": "add",
      "key": "ç©å®¶è§’è‰²çŠ¶æ€.ä¿®ä¸º.å½“å‰",
      "value": {{å¥–åŠ±ä¿®ä¸º}}
    },
    // æ·»åŠ çµçŸ³
    {
      "action": "add",
      "key": "èƒŒåŒ….çµçŸ³.ä¸‹å“",
      "value": {{å¥–åŠ±çµçŸ³}}
    },
    // æ·»åŠ ç‰©å“
    {
      "action": "set",
      "key": "èƒŒåŒ….ç‰©å“.{{ç‰©å“ID}}",
      "value": {{ç‰©å“å¯¹è±¡}}
    },
    // ç§»åŠ¨åˆ°å·²å®Œæˆåˆ—è¡¨
    {
      "action": "add_to_array",
      "key": "ä»»åŠ¡ç³»ç»Ÿ.å·²å®Œæˆä»»åŠ¡",
      "value": "{{ä»»åŠ¡ID}}"
    },
    // æ›´æ–°ç»Ÿè®¡
    {
      "action": "add",
      "key": "ä»»åŠ¡ç³»ç»Ÿ.ä»»åŠ¡ç»Ÿè®¡.å®Œæˆæ€»æ•°",
      "value": 1
    }
  ]
}
\`\`\`
`;
```

---

## ä»£ç å®ç°

### 1. åˆ›å»ºä»»åŠ¡ç”Ÿæˆå·¥å…·

åœ¨ `src/utils/generators/questGenerators.ts`ï¼š

```typescript
import { generateWithRawPrompt } from '@/utils/tavernCore';
import { QUEST_GENERATION_PROMPT, QUEST_UPDATE_PROMPT, QUEST_COMPLETE_PROMPT } from '@/utils/prompts/questPrompts';
import type { Quest, SaveData } from '@/types/game';

/**
 * ç”Ÿæˆæ–°ä»»åŠ¡
 */
export async function generateQuest(saveData: SaveData): Promise<Quest | null> {
  try {
    const context = {
      ç©å®¶å§“å: saveData.ç©å®¶è§’è‰²çŠ¶æ€.åŸºç¡€ä¿¡æ¯.å§“å,
      å½“å‰å¢ƒç•Œ: saveData.ç©å®¶è§’è‰²çŠ¶æ€.ä¿®ä¸º.å¢ƒç•Œ,
      å½“å‰ä½ç½®: saveData.ç©å®¶è§’è‰²çŠ¶æ€.ä½ç½®.æè¿°,
      æœ€è¿‘è®°å¿†: saveData.ç©å®¶è§’è‰²çŠ¶æ€.è®°å¿†.slice(-3).map(m => m.äº‹ä»¶).join('ï¼›')
    };

    const prompt = QUEST_GENERATION_PROMPT
      .replace('{{ç©å®¶å§“å}}', context.ç©å®¶å§“å)
      .replace('{{å½“å‰å¢ƒç•Œ}}', context.å½“å‰å¢ƒç•Œ)
      .replace('{{å½“å‰ä½ç½®}}', context.å½“å‰ä½ç½®)
      .replace('{{æœ€è¿‘è®°å¿†}}', context.æœ€è¿‘è®°å¿†);

    const response = await generateWithRawPrompt('ç”Ÿæˆä¸€ä¸ªé€‚åˆå½“å‰æƒ…å†µçš„ä»»åŠ¡', prompt, false);

    // è§£æAIè¿”å›çš„JSON
    const jsonMatch = response.match(/```json\s*([\s\S]*?)\s*```/);
    if (!jsonMatch) {
      throw new Error('AIå“åº”æ ¼å¼é”™è¯¯');
    }

    const result = JSON.parse(jsonMatch[1]);

    // ä» tavern_commands ä¸­æå–ä»»åŠ¡æ•°æ®
    const questCommand = result.tavern_commands?.find(
      (cmd: any) => cmd.key.startsWith('ä»»åŠ¡ç³»ç»Ÿ.å½“å‰ä»»åŠ¡åˆ—è¡¨.')
    );

    return questCommand?.value || null;
  } catch (error) {
    console.error('ç”Ÿæˆä»»åŠ¡å¤±è´¥:', error);
    return null;
  }
}

/**
 * æ›´æ–°ä»»åŠ¡è¿›åº¦
 */
export async function updateQuestProgress(
  quest: Quest,
  playerAction: string
): Promise<any> {
  try {
    const prompt = QUEST_UPDATE_PROMPT
      .replace('{{å½“å‰ä»»åŠ¡JSON}}', JSON.stringify(quest, null, 2))
      .replace('{{ç©å®¶æœ€è¿‘è¡Œä¸º}}', playerAction);

    const response = await generateWithRawPrompt('æ›´æ–°ä»»åŠ¡è¿›åº¦', prompt, false);
    const jsonMatch = response.match(/```json\s*([\s\S]*?)\s*```/);

    if (!jsonMatch) return null;

    return JSON.parse(jsonMatch[1]);
  } catch (error) {
    console.error('æ›´æ–°ä»»åŠ¡è¿›åº¦å¤±è´¥:', error);
    return null;
  }
}

/**
 * å®Œæˆä»»åŠ¡å¹¶å‘æ”¾å¥–åŠ±
 */
export async function completeQuest(quest: Quest): Promise<any> {
  try {
    const prompt = QUEST_COMPLETE_PROMPT
      .replace('{{ä»»åŠ¡JSON}}', JSON.stringify(quest, null, 2))
      .replace('{{å¥–åŠ±ä¿®ä¸º}}', String(quest.å¥–åŠ±.ä¿®ä¸º || 0))
      .replace('{{å¥–åŠ±çµçŸ³}}', String(quest.å¥–åŠ±.çµçŸ³?.ä¸‹å“ || 0));

    const response = await generateWithRawPrompt('å®Œæˆä»»åŠ¡', prompt, false);
    const jsonMatch = response.match(/```json\s*([\s\S]*?)\s*```/);

    if (!jsonMatch) return null;

    return JSON.parse(jsonMatch[1]);
  } catch (error) {
    console.error('å®Œæˆä»»åŠ¡å¤±è´¥:', error);
    return null;
  }
}
```

### 2. åˆ›å»ºä»»åŠ¡ Store

åœ¨ `src/stores/questStore.ts`ï¼š

```typescript
import { defineStore } from 'pinia';
import { ref, computed } from 'vue';
import { useCharacterStore } from './characterStore';
import { generateQuest, updateQuestProgress, completeQuest } from '@/utils/generators/questGenerators';
import type { Quest } from '@/types/game';
import { toast } from '@/utils/toast';

export const useQuestStore = defineStore('quest', () => {
  const characterStore = useCharacterStore();
  const isGenerating = ref(false);

  // å½“å‰ä»»åŠ¡åˆ—è¡¨
  const currentQuests = computed(() => {
    return characterStore.currentSaveData?.ä»»åŠ¡ç³»ç»Ÿ?.å½“å‰ä»»åŠ¡åˆ—è¡¨ || [];
  });

  // è¿›è¡Œä¸­çš„ä»»åŠ¡
  const activeQuests = computed(() => {
    return currentQuests.value.filter(q => q.ä»»åŠ¡çŠ¶æ€ === 'è¿›è¡Œä¸­');
  });

  // å·²å®Œæˆçš„ä»»åŠ¡
  const completedQuests = computed(() => {
    return currentQuests.value.filter(q => q.ä»»åŠ¡çŠ¶æ€ === 'å·²å®Œæˆ');
  });

  /**
   * ç”Ÿæˆæ–°ä»»åŠ¡
   */
  async function generateNewQuest() {
    if (isGenerating.value) return;
    if (!characterStore.currentSaveData) {
      toast.error('è¯·å…ˆåŠ è½½å­˜æ¡£');
      return;
    }

    isGenerating.value = true;
    const toastId = toast.loading('å¤©æœºè¿è½¬ä¸­ï¼Œæ­£åœ¨æ¨æ¼”æœºç¼˜...');

    try {
      const quest = await generateQuest(characterStore.currentSaveData);

      if (!quest) {
        toast.error('å¤©æœºæ··æ²Œï¼Œæš‚æ— æœºç¼˜', { id: toastId });
        return;
      }

      // æ·»åŠ åˆ°å­˜æ¡£
      await characterStore.setNestedValue(
        `ä»»åŠ¡ç³»ç»Ÿ.å½“å‰ä»»åŠ¡åˆ—è¡¨.${quest.ä»»åŠ¡ID}`,
        quest
      );

      toast.success(`æ–°ä»»åŠ¡ï¼š${quest.ä»»åŠ¡åç§°}`, { id: toastId });
    } catch (error: any) {
      toast.error(`ç”Ÿæˆä»»åŠ¡å¤±è´¥ï¼š${error.message}`, { id: toastId });
    } finally {
      isGenerating.value = false;
    }
  }

  /**
   * æ£€æŸ¥ä»»åŠ¡ç›®æ ‡å®Œæˆ
   */
  function checkQuestObjective(questId: string, objectiveType: string, targetId: string) {
    const quest = currentQuests.value.find(q => q.ä»»åŠ¡ID === questId);
    if (!quest) return;

    const objective = quest.ç›®æ ‡åˆ—è¡¨.find(
      obj => obj.ç±»å‹ === objectiveType && obj.ç›®æ ‡ID === targetId
    );

    if (objective && !objective.å·²å®Œæˆ) {
      // æ›´æ–°è¿›åº¦
      const newProgress = objective.å½“å‰è¿›åº¦ + 1;
      characterStore.setNestedValue(
        `ä»»åŠ¡ç³»ç»Ÿ.å½“å‰ä»»åŠ¡åˆ—è¡¨.${questId}.ç›®æ ‡åˆ—è¡¨.${quest.ç›®æ ‡åˆ—è¡¨.indexOf(objective)}.å½“å‰è¿›åº¦`,
        newProgress
      );

      if (newProgress >= objective.éœ€æ±‚æ•°é‡) {
        characterStore.setNestedValue(
          `ä»»åŠ¡ç³»ç»Ÿ.å½“å‰ä»»åŠ¡åˆ—è¡¨.${questId}.ç›®æ ‡åˆ—è¡¨.${quest.ç›®æ ‡åˆ—è¡¨.indexOf(objective)}.å·²å®Œæˆ`,
          true
        );
        toast.success(`ä»»åŠ¡ç›®æ ‡å®Œæˆï¼š${objective.æè¿°}`);

        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç›®æ ‡å®Œæˆ
        const allCompleted = quest.ç›®æ ‡åˆ—è¡¨.every(obj => obj.å·²å®Œæˆ || obj === objective);
        if (allCompleted) {
          finishQuest(questId);
        }
      }
    }
  }

  /**
   * å®Œæˆä»»åŠ¡
   */
  async function finishQuest(questId: string) {
    const quest = currentQuests.value.find(q => q.ä»»åŠ¡ID === questId);
    if (!quest) return;

    const toastId = toast.loading('é¢†å–å¥–åŠ±ä¸­...');

    try {
      const result = await completeQuest(quest);

      if (result?.tavern_commands) {
        // æ‰§è¡Œå¥–åŠ±æŒ‡ä»¤
        for (const cmd of result.tavern_commands) {
          if (cmd.action === 'set') {
            await characterStore.setNestedValue(cmd.key, cmd.value);
          } else if (cmd.action === 'add') {
            const current = characterStore.getNestedValue(cmd.key) as number || 0;
            await characterStore.setNestedValue(cmd.key, current + cmd.value);
          }
        }
      }

      toast.success(`ä»»åŠ¡å®Œæˆï¼š${quest.ä»»åŠ¡åç§°}`, { id: toastId });
    } catch (error: any) {
      toast.error(`å®Œæˆä»»åŠ¡å¤±è´¥ï¼š${error.message}`, { id: toastId });
    }
  }

  return {
    currentQuests,
    activeQuests,
    completedQuests,
    isGenerating,
    generateNewQuest,
    checkQuestObjective,
    finishQuest
  };
});
```

### 3. æ›´æ–° QuestPanel ç»„ä»¶

```vue
<template>
  <div class="quest-panel">
    <div class="panel-header">
      <h2>ä»»åŠ¡</h2>
      <button @click="questStore.generateNewQuest()" :disabled="questStore.isGenerating" class="generate-btn">
        {{ questStore.isGenerating ? 'æ¨æ¼”ä¸­...' : 'å¯»æ‰¾æœºç¼˜' }}
      </button>
    </div>

    <div class="quest-tabs">
      <button
        :class="{ active: activeTab === 'active' }"
        @click="activeTab = 'active'"
      >
        è¿›è¡Œä¸­ ({{ questStore.activeQuests.length }})
      </button>
      <button
        :class="{ active: activeTab === 'completed' }"
        @click="activeTab = 'completed'"
      >
        å·²å®Œæˆ ({{ questStore.completedQuests.length }})
      </button>
    </div>

    <div class="quest-list">
      <div
        v-for="quest in displayQuests"
        :key="quest.ä»»åŠ¡ID"
        class="quest-item"
        :class="[quest.ä»»åŠ¡ç±»å‹]"
      >
        <div class="quest-header">
          <span class="quest-type">{{ quest.ä»»åŠ¡ç±»å‹ }}</span>
          <h3 class="quest-title">{{ quest.ä»»åŠ¡åç§° }}</h3>
        </div>

        <p class="quest-description">{{ quest.ä»»åŠ¡æè¿° }}</p>

        <div class="quest-objectives">
          <div
            v-for="(obj, idx) in quest.ç›®æ ‡åˆ—è¡¨"
            :key="idx"
            class="objective"
            :class="{ completed: obj.å·²å®Œæˆ }"
          >
            <span class="objective-desc">{{ obj.æè¿° }}</span>
            <span class="objective-progress">{{ obj.å½“å‰è¿›åº¦ }}/{{ obj.éœ€æ±‚æ•°é‡ }}</span>
          </div>
        </div>

        <div class="quest-rewards">
          <span class="reward-label">å¥–åŠ±ï¼š</span>
          <span v-if="quest.å¥–åŠ±.ä¿®ä¸º" class="reward">ä¿®ä¸º +{{ quest.å¥–åŠ±.ä¿®ä¸º }}</span>
          <span v-if="quest.å¥–åŠ±.çµçŸ³?.ä¸‹å“" class="reward">ä¸‹å“çµçŸ³ +{{ quest.å¥–åŠ±.çµçŸ³.ä¸‹å“ }}</span>
          <span v-if="quest.å¥–åŠ±.ç‰©å“" class="reward">
            {{ quest.å¥–åŠ±.ç‰©å“.map(i => i.åç§°).join('ã€') }}
          </span>
        </div>

        <div v-if="quest.å‘å¸ƒè€…" class="quest-issuer">
          å‘å¸ƒè€…ï¼š{{ quest.å‘å¸ƒè€… }}
        </div>
      </div>

      <div v-if="displayQuests.length === 0" class="no-quests">
        <p>{{ activeTab === 'active' ? 'æš‚æ— è¿›è¡Œä¸­çš„ä»»åŠ¡' : 'æš‚æ— å·²å®Œæˆçš„ä»»åŠ¡' }}</p>
        <p v-if="activeTab === 'active'" class="hint">ç‚¹å‡»ä¸Šæ–¹"å¯»æ‰¾æœºç¼˜"æŒ‰é’®è·å–æ–°ä»»åŠ¡</p>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue';
import { useQuestStore } from '@/stores/questStore';

const questStore = useQuestStore();
const activeTab = ref<'active' | 'completed'>('active');

const displayQuests = computed(() => {
  return activeTab.value === 'active' ? questStore.activeQuests : questStore.completedQuests;
});
</script>

<style scoped>
.quest-panel {
  height: 100%;
  display: flex;
  flex-direction: column;
  padding: 1rem;
  background: var(--color-surface);
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.panel-header h2 {
  margin: 0;
  color: var(--color-primary);
}

.generate-btn {
  padding: 0.5rem 1rem;
  background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
}

.generate-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.generate-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.quest-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  border-bottom: 2px solid var(--color-border);
}

.quest-tabs button {
  padding: 0.5rem 1rem;
  background: none;
  border: none;
  cursor: pointer;
  color: var(--color-text-secondary);
  transition: all 0.3s;
}

.quest-tabs button.active {
  color: var(--color-primary);
  border-bottom: 2px solid var(--color-primary);
}

.quest-list {
  flex: 1;
  overflow-y: auto;
}

.quest-item {
  background: var(--color-background);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1rem;
  transition: all 0.3s;
}

.quest-item:hover {
  border-color: var(--color-primary);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.quest-item.ä¸»çº¿ { border-left: 4px solid #ff6b6b; }
.quest-item.æ”¯çº¿ { border-left: 4px solid #4ecdc4; }
.quest-item.å®—é—¨ { border-left: 4px solid #45b7d1; }
.quest-item.å¥‡é‡ { border-left: 4px solid #f9ca24; }
.quest-item.æ—¥å¸¸ { border-left: 4px solid #95afc0; }

.quest-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.quest-type {
  padding: 0.2rem 0.5rem;
  background: var(--color-primary);
  color: white;
  border-radius: 4px;
  font-size: 0.75rem;
}

.quest-title {
  margin: 0;
  font-size: 1.1rem;
  color: var(--color-text);
}

.quest-description {
  color: var(--color-text-secondary);
  margin: 0.5rem 0;
  line-height: 1.5;
}

.quest-objectives {
  margin: 1rem 0;
}

.objective {
  display: flex;
  justify-content: space-between;
  padding: 0.5rem;
  background: var(--color-surface-light);
  border-radius: 4px;
  margin-bottom: 0.5rem;
}

.objective.completed {
  opacity: 0.6;
  text-decoration: line-through;
}

.objective-progress {
  font-weight: 600;
  color: var(--color-primary);
}

.quest-rewards {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin: 0.5rem 0;
}

.reward-label {
  font-weight: 600;
  color: var(--color-text);
}

.reward {
  padding: 0.2rem 0.5rem;
  background: rgba(var(--color-primary-rgb), 0.1);
  border-radius: 4px;
  color: var(--color-primary);
  font-size: 0.9rem;
}

.quest-issuer {
  margin-top: 0.5rem;
  font-size: 0.9rem;
  color: var(--color-text-secondary);
  font-style: italic;
}

.no-quests {
  text-align: center;
  padding: 2rem;
  color: var(--color-text-secondary);
}

.no-quests .hint {
  margin-top: 0.5rem;
  font-size: 0.9rem;
  opacity: 0.7;
}
</style>
```

---

## å¿«é€Ÿå¼€å§‹

### æ­¥éª¤1ï¼šæ·»åŠ æ•°æ®ç»“æ„

1. åœ¨ `src/types/game.d.ts` ä¸­æ·»åŠ ä¸Šè¿°æ¥å£å®šä¹‰
2. æ›´æ–° `SaveData` æ¥å£ï¼Œæ·»åŠ  `ä»»åŠ¡ç³»ç»Ÿ: QuestSystem`

### æ­¥éª¤2ï¼šåˆå§‹åŒ–ä»»åŠ¡ç³»ç»Ÿ

åœ¨è§’è‰²åˆå§‹åŒ–æ—¶æ·»åŠ ç©ºçš„ä»»åŠ¡ç³»ç»Ÿï¼š

```typescript
// src/services/characterInitialization.ts

saveData.ä»»åŠ¡ç³»ç»Ÿ = {
  å½“å‰ä»»åŠ¡åˆ—è¡¨: [],
  å·²å®Œæˆä»»åŠ¡: [],
  ä»»åŠ¡ç»Ÿè®¡: {
    å®Œæˆæ€»æ•°: 0,
    ä¸»çº¿å®Œæˆ: 0,
    æ”¯çº¿å®Œæˆ: 0
  }
};
```

### æ­¥éª¤3ï¼šåˆ›å»ºæç¤ºè¯å’Œå·¥å…·å‡½æ•°

1. åˆ›å»º `src/utils/prompts/questPrompts.ts`
2. åˆ›å»º `src/utils/generators/questGenerators.ts`
3. åˆ›å»º `src/stores/questStore.ts`

### æ­¥éª¤4ï¼šæ›´æ–°UI

æ›¿æ¢ `src/components/dashboard/QuestPanel.vue` çš„å†…å®¹

### æ­¥éª¤5ï¼šé›†æˆåˆ°æ¸¸æˆå¾ªç¯

åœ¨ `MainGamePanel.vue` ä¸­ï¼Œå½“ç©å®¶å‡»æ€æ€ªç‰©æˆ–é‡‡é›†ç‰©å“æ—¶ï¼Œè°ƒç”¨ï¼š

```typescript
import { useQuestStore } from '@/stores/questStore';

const questStore = useQuestStore();

// ç¤ºä¾‹ï¼šå‡»æ€æ€ªç‰©åæ£€æŸ¥ä»»åŠ¡
function onMonsterKilled(monsterId: string) {
  questStore.checkQuestObjective(currentQuestId, 'å‡»æ€', monsterId);
}
```

---

## æ€»ç»“

è¿™ä¸ªç®€åŒ–ç‰ˆä»»åŠ¡ç³»ç»Ÿï¼š

âœ… **æ•°æ®ç»“æ„æ¸…æ™°**ï¼šæ‰€æœ‰ä»»åŠ¡æ•°æ®å­˜å‚¨åœ¨ `SaveData.ä»»åŠ¡ç³»ç»Ÿ`
âœ… **AIé©±åŠ¨**ï¼šåˆ©ç”¨ç°æœ‰çš„é…’é¦†ç³»ç»Ÿç”Ÿæˆå’Œç®¡ç†ä»»åŠ¡
âœ… **æ˜“äºæ‰©å±•**ï¼šå¯ä»¥è½»æ¾æ·»åŠ æ–°çš„ä»»åŠ¡ç±»å‹å’Œç›®æ ‡ç±»å‹
âœ… **æ— ç¼é›†æˆ**ï¼šä¸ç°æœ‰ç³»ç»Ÿï¼ˆèƒŒåŒ…ã€NPCã€åœ°å›¾ï¼‰å®Œç¾é…åˆ

ç°åœ¨å°±å¯ä»¥å¼€å§‹å®ç°äº†ï¼
