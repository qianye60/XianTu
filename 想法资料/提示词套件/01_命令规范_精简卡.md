# 命令规范·速查卡（兼容）

输出唯一 JSON 字段：`text` | `mid_term_memory` | `tavern_commands`

命令分区（数组或对象）：
- set：写入/覆盖；支持 `options.mergeStrategy: replace|shallow|deep`
- add：向映射新增（唯一键 `options.uniqueBy`）
- update/patch：按字段合并（默认 shallow）
- ensure：仅当缺失时写入（等价 set+ifMissing）
- push：数组追加；`dedupe` 去重，`limit` 限长，`position` 头/尾
- pull：数组移除；`where` 条件，`count` 限量
- delete：删除；`softDelete` 软删入回收站

通用 options：
- reason（必填）：为何变更；便于审计
- idempotencyKey：幂等键；重复去重
- ifMissing / ifExists / ifEquals / ifVersion（CAS）
- tags / ttl / expiresAt
- expect：断言提交后状态（存在/等于某值）

时间与任务（统一路径）：
- `时间.当前`（set）；`时间.时间轴`（push {时间,事件,原因}）
- `任务.<ID>={阶段,备注,更新时间}`

记忆（每轮至少一条）：
- `push 记忆.短期记忆 += "……"`（无新事实亦写“确认：无变化”）

示例·移动+记忆+时间：
```json
{
  "set":[
    {"action":"set","key":"character.saveData.玩家角色状态.位置.描述","value":"集市南口"},
    {"action":"set","key":"character.saveData.玩家角色状态.位置.坐标","value":{"X":210,"Y":44}},
    {"action":"set","key":"character.saveData.时间.当前","value":"开阳历230年三月初六 日出"}
  ],
  "push":[
    {"action":"push","key":"character.saveData.记忆.短期记忆","value":"在集市南口与李四约定日出前见","options":{"dedupe":true}},
    {"action":"push","key":"character.saveData.时间.时间轴","value":{"时间":"2025-09-20T05:00:00Z","事件":"推进到日出","原因":"对话约定"}}
  ]
}
```

