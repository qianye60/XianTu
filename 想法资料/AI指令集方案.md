# AI指令集与双向数据流系统方案

# 注意：提示词生成目前有三种，初始化地图生成、初始化信息生成(这两种配合完成游戏初始化)，游戏中正常信息生成(和初始化消息生成格式一样，但是内容偏向正常游戏对话，也没有像初始化一次生成的这么多内容)

## 1. 核心目标：实现AI与酒馆的“状态感知”交互

本系统的核心目标是建立一个闭环、双向的数据流，让AI不仅能通过指令**改变**酒馆世界的状态，还能**感知**到这些变化，并基于最新的状态做出更智能、更连贯的决策。

这解决了传统指令系统的“盲目性”问题，使AI从一个简单的指令发出者，升级为一个能够进行有状态交互的智能伙伴。

## 2. 系统架构：AIBidirectionalSystem



我们设计并实现了一个名为 `AIBidirectionalSystem` 的核心系统，它自动完成以下所有工作：

- **监听AI回复**: 实时捕获AI生成的内容。
- **解析指令**: 自动从AI的回复中提取`tavern_commands` JSON代码块。
- **执行指令**: 安全地执行`set`, `add`, `delete`, `push`, `pull`等操作。
- **状态快照与比对**: 记录指令执行前后的变量变化，生成清晰的“变更日志”。
- **上下文注入**: 在下一次AI生成请求前，自动将“执行结果”和“当前关键变量状态”注入到提示词中。
 
## 3. 工作流程 (The Loop)

```
+--------------------------+
| 1. AI 生成回复           |
| (包含指令JSON)         |
+-----------+--------------+
            |
            v
+-----------+--------------+
| 2. 系统捕获回复并解析    |
| `AIBidirectionalSystem`  |
+-----------+--------------+
            |
            v
+-----------+--------------+
| 3. 执行指令对酒馆Chat一栏变量修改，页面更新数据 & 计算变更   |
| (set, add, push, etc.)   |
+-----------+--------------+
            |
            v
+-----------+--------------+
| 4. 用户发送下一条消息    |
+-----------+--------------+
            |
            v
+-----------+--------------+
| 5. 系统注入上下文到提示词|
| (执行结果 + 当前状态)    |
+-----------+--------------+
            |
            v
+-----------+--------------+
| 6. AI 接收到包含状态的   |
|    提示词，做出新回复    |
+--------------------------+
```

## 4. 统一“AI 请求提示词”规范（初始化 + 剧情推进）

本节用于规范“发送给 AI 的提示词”要求，确保 AI 进行状态感知与一致的路径写入。所有生成结果均需满足下述约定。

### 4.1 通用格式要求

- 输出唯一 JSON，包含字段：
  - `text`: 字符串（初始化≥1000字，剧情推进≥800字，建议多段详细叙事）；
  - `mid_term_memory`: 字符串（非空时）；
  - `tavern_commands`: 对象，包含 `{ set, add, push, pull, delete }` 五个分区，分别为数组或对象；
- 禁止返回数组根对象或多份 JSON；
- 不使用 `path/target` 字段，统一使用 `key` 字段；
- 所有 `key` 必须以 `character.saveData.` 开头；
- 仅在 `text` 有明确依据时，才生成/修改状态（物品/位置/状态效果/关系等）。

### 4.2 命令分区与条目格式

- `tavern_commands` 为对象：
  - `set/add/push/pull/delete` 之一；
  - 每个分区可以是：
    - 数组：`[{ action, key, value }]`（delete 可为 `[{ action:'delete', key:'…' }]` 或 `['key1','key2']`）；
    - 对象：`{ 'key': value }`；
- 条目字段：
  - `action`: `set|add|push|pull|delete`；
  - `key`: 以 `character.saveData.` 开头的点状路径（禁止 `path/target`）；
  - `value`: 任意 JSON（delete 可省略或传 `null`）。

### 4.3 路径变量参考（必须遵循）

- 角色基础信息：
  - `character.saveData.角色基础信息.(名字|性别|年龄|出生|灵根|天赋|天资|先天六司.{根骨,灵性,悟性,气运,魅力,心性}|世界)`
  - 详情字段：`灵根详情.{quality,attributes}`、`天赋详情.[{名称,描述}]`
- 玩家角色状态：
  - 统一使用“玩家角色状态”，禁止“角色状态”；
  - `character.saveData.玩家角色状态.(境界|位置|气血|灵气|神识|寿命|修为|状态效果|身份|当前活动|心情)`；
  - `位置` 为对象：`位置.{描述:string, 坐标:{X:number,Y:number}}`；
  - `气血/灵气/神识/寿命/修为` 为对象：`{当前:number, 最大:number}`；
- 背包/装备栏：
  - 背包灵石：`character.saveData.背包.灵石.(下品|中品|上品|极品)`；
  - 背包物品：`character.saveData.背包.物品.<物品ID>=Item`（物品ID为单层键，不能包含点号）；
  - 装备栏：`character.saveData.装备栏.法宝{1..6}=Item|null`（仅法宝）；
- 修炼功法：
  - `character.saveData.修炼功法.(功法|熟练度|已解锁技能|修炼时间|突破次数)`；
- 记忆：
  - `character.saveData.记忆.(短期记忆[]|中期记忆[]|长期记忆[])`（元素为字符串）；
- 人物关系：
  - `character.saveData.人物关系.<姓名或称谓>=NpcProfile`（最小结构，见下）；
- 世界信息：
  - `character.saveData.世界信息.(世界名称|世界背景|大陆信息[]|势力信息[]|地点信息[]|生成信息)`；

### 4.4 对象结构规范

- Item 物品对象：
  ```json
  {
    "物品ID": "ID",
    "名称": "物品名称",
    "类型": "法宝|功法|其他",
    "品质": { "quality": "凡|黄|玄|地|天|仙|神|凡阶|…", "grade": 0 },
    "数量": 1,
    "描述": "…",
    "使用效果": "…",
    "装备增幅": { "气血上限": 0, "后天六司": {"根骨":0} },
    "功法效果": { "修炼速度加成": 0 },
    "功法技能": { "技能名": {"解锁条件":"…","技能描述":"…","技能类型":""} },
    "修炼进度": 0
  }
  ```
  - 品质.quality 可接受“凡阶/黄阶…”；系统会规范化为“凡/黄/玄/地/天/仙/神”，未知显示“未知”。
  - 品质.grade：0=残缺，1-3=下品，4-6=中品，7-9=上品，10=极品。

- StatusEffect 状态效果对象：
  ```json
  {
    "状态名称": "神魂初定",
    "类型": "buff|debuff",          
    "时间": "未指定",               
    "状态描述": "…",               
    "强度": 1,                     
    "来源": "《引气决》修炼",
    "剩余时间": "…"
  }
  ```
  - 允许 `push` 一个字符串，如“健康”，解析层会转换为上述对象并给默认值。

- NpcProfile 人物关系最小结构：
  ```json
  {
    "角色基础信息": {"名字":"白须老者","性别":"男","年龄":60,"世界":"朝天大陆","天资":"未知","出生":"-","灵根":"-","天赋":[],"先天六司":{"根骨":0,"灵性":0,"悟性":0,"气运":0,"魅力":0,"心性":0}},
    "外貌描述": "…",
    "人物关系": "引路人",
    "人物好感度": 10,
    "人物记忆": ["…"],
    "互动次数": 1,
    "最后互动时间": "ISO时间",
    "特殊标记": []
  }
  ```

### 4.5 初始化与剧情推进的最小指令集

- 初始化（初始化消息）：
  - set: 角色基础信息.(年龄|出生|灵根|天赋)
  - set: 玩家角色状态.位置.(描述|坐标)
  - push: 记忆.(短期记忆|中期记忆)
  - set: 背包.物品.<物品ID>（仅在 text 明确提及时）
  - set: 修炼功法.功法（如叙事获得）
  - set: 人物关系.<姓名或称谓>（当 text 中发生明确互动时）

- 剧情推进：
  - set: 玩家角色状态.位置.(描述|坐标)（移动≤100）
  - push: 记忆.(短期记忆|中期记忆)
  - set: 背包.物品.<物品ID>（如叙事所述）
  - set/push: 玩家角色状态.状态效果（对象格式）
  - set: 人物关系.<姓名或称谓>（当 text 中发生互动时）

### 4.6 初始化/推进示例（精简）

```json
{
  "text": "……≥1000字详细叙事（初始化）……",
  "mid_term_memory": "我，千夜……",
  "tavern_commands": {
    "set": [
      {"action":"set","key":"character.saveData.角色基础信息.年龄","value":16},
      {"action":"set","key":"character.saveData.角色基础信息.出生","value":"书香门第"},
      {"action":"set","key":"character.saveData.玩家角色状态.位置.描述","value":"青石镇"},
      {"action":"set","key":"character.saveData.玩家角色状态.位置.坐标","value":{"X":120,"Y":35}},
      {"action":"set","key":"character.saveData.背包.物品.引气决","value":{ "物品ID":"引气决","名称":"引气决","类型":"功法","品质":{"quality":"凡","grade":1},"数量":1,"描述":"修仙入门功法" }}
    ],
    "push": [
      {"action":"push","key":"character.saveData.记忆.短期记忆","value":"青石镇入门测试……"},
      {"action":"push","key":"character.saveData.记忆.中期记忆","value":"我，千夜，十六岁，踏上仙途……"}
    ],
    "add": [],
    "pull": [],
    "delete": []
  }
}
```

## 5. 解析与容错策略（引擎侧已实现）

- 接受 `tavern_commands` 为对象或数组；对象会被展开为数组执行；
- 自动修正历史遗留/模型常见错误：
  - `角色状态.*` → `玩家角色状态.*`；
  - `character.saveData.物品.*` → `character.saveData.背包.物品.*`；
  - `玩家角色状态.位置` 若为字符串 → 规范化为 `{描述, 坐标}`；
  - 状态效果若为字符串 → 规范为对象 `{状态名称, 类型:'buff', 时间:'未指定', 状态描述:''}`；
  - 灵根对象/天赋对象数组 → 拆分写入 `灵根` 与 `灵根详情.*`、`天赋` 与 `天赋详情`；
- 品质显示规范：quality 兼容“*阶”与单字；未知显示“未知”；无效样式不叠加。

## 6. 运行时上下文注入（参考路径）

- 初始化与剧情推进的提示词输入，均注入：
  ```json
  {
    "gmRequest": { …当前游戏状态… },
    "reference": {
      "chatVariables": { …当前全部chat变量… },
      "note": "所有路径请统一以 character.saveData. 开头，并严格匹配参考中已有字段结构。"
    }
  }
  ```
  AI 必须参照 `reference.chatVariables` 的结构进行写入，禁止新建平行根路径。

---

以上约定与引擎容错已在代码中实现；如需扩展字段或增加新模块，请先在此文档补充结构与示例，再更新提示词与解析器映射。
