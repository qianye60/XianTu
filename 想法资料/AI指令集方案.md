# AI指令集与双向数据流系统方案

## 1. 核心目标：实现AI与酒馆的“状态感知”交互

本系统的核心目标是建立一个闭环、双向的数据流，让AI不仅能通过指令**改变**酒馆世界的状态，还能**感知**到这些变化，并基于最新的状态做出更智能、更连贯的决策。

这解决了传统指令系统的“盲目性”问题，使AI从一个简单的指令发出者，升级为一个能够进行有状态交互的智能伙伴。

## 2. 系统架构：AIBidirectionalSystem

我们设计并实现了一个名为 `AIBidirectionalSystem` 的核心系统，它自动完成以下所有工作：

- **监听AI回复**: 实时捕获AI生成的内容。
- **解析指令**: 自动从AI的回复中提取`tavern_commands` JSON代码块。
- **执行指令**: 安全地执行`set`, `add`, `delete`, `push`, `pull`等操作。
- **状态快照与比对**: 记录指令执行前后的变量变化，生成清晰的“变更日志”。
- **上下文注入**: 在下一次AI生成请求前，自动将“执行结果”和“当前关键变量状态”注入到提示词中。

## 3. 工作流程 (The Loop)

```
+--------------------------+
| 1. AI 生成回复           |
| (包含指令JSON)         |
+-----------+--------------+
            |
            v
+-----------+--------------+
| 2. 系统捕获回复并解析    |
| `AIBidirectionalSystem`  |
+-----------+--------------+
            |
            v
+-----------+--------------+
| 3. 执行指令对酒馆Chat一栏变量修改，页面更新数据 & 计算变更   |
| (set, add, push, etc.)   |
+-----------+--------------+
            |
            v
+-----------+--------------+
| 4. 用户发送下一条消息    |
+-----------+--------------+
            |
            v
+-----------+--------------+
| 5. 系统注入上下文到提示词|
| (执行结果 + 当前状态)    |
+-----------+--------------+
            |
            v
+-----------+--------------+
| 6. AI 接收到包含状态的   |
|    提示词，做出新回复    |
+--------------------------+
```
