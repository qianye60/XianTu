# AI指令集与双向数据流系统方案

# 注意：提示词生成目前有三种，初始化地图生成、初始化信息生成(这两种配合完成游戏初始化)，游戏中正常信息生成(和初始化消息生成格式一样，但是内容偏向正常游戏对话，也没有像初始化一次生成的这么多内容)

## 1. 核心目标：实现AI与酒馆的“状态感知”交互

本系统的核心目标是建立一个闭环、双向的数据流，让AI不仅能通过指令**改变**酒馆世界的状态，还能**感知**到这些变化，并基于最新的状态做出更智能、更连贯的决策。

这解决了传统指令系统的“盲目性”问题，使AI从一个简单的指令发出者，升级为一个能够进行有状态交互的智能伙伴。

## 2. 系统架构：AIBidirectionalSystem



我们设计并实现了一个名为 `AIBidirectionalSystem` 的核心系统，它自动完成以下所有工作：

- **监听AI回复**: 实时捕获AI生成的内容。
- **解析指令**: 自动从AI的回复中提取`tavern_commands` JSON代码块。
- **执行指令**: 安全地执行`set`, `add`, `delete`, `push`, `pull`等操作。
- **状态快照与比对**: 记录指令执行前后的变量变化，生成清晰的“变更日志”。
- **上下文注入**: 在下一次AI生成请求前，自动将“执行结果”和“当前关键变量状态”注入到提示词中。
 
## 3. 工作流程 (The Loop)

```
+--------------------------+
| 1. AI 生成回复           |
| (包含指令JSON)         |
+-----------+--------------+
            |
            v
+-----------+--------------+
| 2. 系统捕获回复并解析    |
| `AIBidirectionalSystem`  |
+-----------+--------------+
            |
            v
+-----------+--------------+
| 3. 执行指令对酒馆Chat一栏变量修改，页面更新数据 & 计算变更   |
| (set, add, push, etc.)   |
+-----------+--------------+
            |
            v
+-----------+--------------+
| 4. 用户发送下一条消息    |
+-----------+--------------+
            |
            v
+-----------+--------------+
| 5. 系统注入上下文到提示词|
| (执行结果 + 当前状态)    |
+-----------+--------------+
            |
            v
+-----------+--------------+
| 6. AI 接收到包含状态的   |
|    提示词，做出新回复    |
+--------------------------+
```

## 4. 统一“AI 请求提示词”规范（初始化 + 剧情推进）

本节用于规范“发送给 AI 的提示词”要求，确保 AI 进行状态感知与一致的路径写入。所有生成结果均需满足下述约定。

重要提醒（示例名禁止照搬）
- 文档中的具体名称（如功法/物品/地点/NPC名）仅用于“结构示例”，实际生成时必须根据上下文与世界设定自拟合理名称；严禁直接使用示例名。
- 若需要占位，请使用抽象占位符（如“<入门功法>”“<草药材>”），生成时替换为符合世界观的专有名词。

### 4.1 通用格式要求

- 输出唯一 JSON，包含字段：
  - `text`: 字符串（初始化≥1000字，剧情推进≥800字，建议多段详细叙事）；
  - `mid_term_memory`: 字符串（非空时）；
  - `tavern_commands`: 对象，包含 `{ set, add, push, pull, delete }` 五个分区，分别为数组或对象；
- 禁止返回数组根对象或多份 JSON；
- 不使用 `path/target` 字段，统一使用 `key` 字段；
- 所有 `key` 必须以 `character.saveData.` 开头；
- 仅在 `text` 有明确依据时，才生成/修改状态（物品/位置/状态效果/关系等）。

### 4.2 命令分区与条目格式

- `tavern_commands` 为对象：
  - `set/add/push/pull/delete` 之一；
  - 每个分区可以是：
    - 数组：`[{ action, key, value }]`（delete 可为 `[{ action:'delete', key:'…' }]` 或 `['key1','key2']`）；
    - 对象：`{ 'key': value }`；
- 条目字段：
  - `action`: `set|add|push|pull|delete`；
  - `key`: 以 `character.saveData.` 开头的点状路径（禁止 `path/target`）；
  - `value`: 任意 JSON（delete 可省略或传 `null`）。禁止在实际生成中照搬本规范中的示例名。
