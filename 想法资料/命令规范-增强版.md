# 命令规范 2.0（兼容 tavern_commands）

目标：在保持现有 `tavern_commands`（set/add/push/pull/delete）不变的前提下，增强“增删改查”的表达力、可审计性与幂等性；读操作通过“请求注入与条件断言”实现，不要求AI在同轮向后端取数。

注意：本文件中的具体名称（功法/物品/地点/NPC等）仅为结构示例，生成时必须自拟符合上下文的名称；严禁直接使用示例名。

兼容性：下述增强字段均为“可选”。解析器不识别时安全忽略，或按降级映射至原有语义执行。

---

## 1. 统一条目结构

- 基本形：`{ action, key, value?, options? }`
- action：`set | add | update | patch | push | pull | delete | ensure`
- key：点状路径，必须以 `character.saveData.` 开头
- value：任意 JSON（`delete` 可省略或为 `null`）
- options（可选）：
  - idempotencyKey：string，幂等键，重复提交时去重
  - reason：string，变更原因，便于审计与回溯
  - ifMissing：boolean，仅当目标缺失时执行（常配合 `ensure`）
  - ifExists：boolean，仅当目标存在时执行
  - ifEquals：JSON | primitive，比较值相等才执行
  - ifVersion：number，对象版本号匹配才执行（CAS）
  - mergeStrategy：`replace | shallow | deep`（用于 set/update/patch）
  - uniqueBy：string | string[]（数组去重/对象集合唯一键）
  - dedupe：boolean（push 去重）
  - position：`head | tail`（push/pull 插入位置）
  - limit：number（push 后保留尾部/头部 N 条）
  - where：对象（pull 过滤条件，键值相等匹配）
  - count：number（pull 移除数量上限）
  - softDelete：boolean（true 则移动到回收站而非直接删除）
  - recycleBinKey：string（软删目标，默认 `character.saveData.回收站`）
  - cascade：boolean（删除子键时是否级联）
  - allowMissing：boolean（删除/更新时，缺失是否视为成功）
  - tags：string[]（打标签，供审计/检索）
  - ttl：number（秒，过期自动清理，可选）
  - expiresAt：ISO 字符串（精确过期时间，可选）
  - expect：对象（断言执行后状态，如 `{ exists:true }`、`{ equals: <JSON> }`）

降级映射：
- update/patch → set + `mergeStrategy`（默认 shallow）
- ensure → set + `ifMissing:true`

---

## 2. 增：set / add / update / patch / ensure

1) set（覆盖或创建）
```json
{
  "action":"set",
  "key":"character.saveData.玩家角色状态.位置",
  "value":{"描述":"集市南口","坐标":{"X":210,"Y":44}},
  "options":{"mergeStrategy":"replace","reason":"角色移动"}
}
```

2) add（向“映射/字典”新增键，带唯一约束）
```json
{
  "action":"add",
  "key":"character.saveData.背包.物品",
  "value":{"物品ID":"入门功法_示例","名称":"<入门功法>","类型":"功法"},
  "options":{"uniqueBy":"物品ID","reason":"获得功法"}
}
```

3) update / patch（按字段合并）
```json
{
  "action":"update",
  "key":"character.saveData.人物关系.李四",
  "value":{"人物好感度":15,"最后互动时间":"2025-09-20T08:00:00Z"},
  "options":{"mergeStrategy":"deep","ifExists":true,"reason":"对话提升好感"}
}
```

4) ensure（若缺失则写入默认值）
```json
{
  "action":"ensure",
  "key":"character.saveData.时间.当前",
  "value":"开阳历 230 年 3 月 初五 辰时",
  "options":{"ifMissing":true,"reason":"初始化时间基线"}
}
```

---

## 3. 删：delete（支持软删/回收站）

```json
{
  "action":"delete",
  "key":"character.saveData.背包.物品.破损木剑",
  "options":{"softDelete":true,"recycleBinKey":"character.saveData.回收站","reason":"丢弃无用物品"}
}
```

- softDelete=false：直接删除
- allowMissing=true：缺失视为成功（幂等）

---

## 4. 查：读操作与断言（非必须，推荐）

出于“同轮不读取后端”的设计，推荐用两种方式实现“查”：

- 请求侧注入：运行时会自动把关键 `saveData` 片段注入到提示词（参考清单见《提示词套件/02_对话请求拼装清单.md》），AI无需主动 get。
- 条件断言 expect：在变更条目里用 `options.expect` 断言结果；解析器验证失败则拒绝或回滚。

示例（变更并断言存在）：
```json
{
  "action":"set",
  "key":"character.saveData.修炼功法.功法",
  "value":"<入门功法>",
  "options":{"expect":{"exists":true},"reason":"叙事授予"}
}
```

可选扩展（引擎支持时启用）：`tavern_inspect:[{"key":"…"}]` 仅用于调试与日志，并不会影响生成；若解析器不支持，安全忽略。

---

## 5. 改：push / pull（数组增删，带去重与过滤）

1) push（可去重、限长、头尾插入）
```json
{
  "action":"push",
  "key":"character.saveData.记忆.短期记忆",
  "value":"在集市南口与李四约定日出前见",
  "options":{"dedupe":true,"limit":50,"position":"tail","reason":"记录新对话"}
}
```

2) pull（可按条件删除，限制数量）
```json
{
  "action":"pull",
  "key":"character.saveData.记忆.短期记忆",
  "options":{"where":{"包含":"无关闲谈"},"count":5,"reason":"清理噪声记忆"}
}
```

---

## 6. 条件与并发（CAS / 幂等）

- ifVersion：对象需维护 `__version`（解析器递增），仅当版本匹配时更新，解决并发覆盖。
- idempotencyKey：同一 key + idempotencyKey 的重复命令自动去重。
- ifEquals：仅当当前值等于期望时才执行（例如防止二次推进时间）。

---

## 7. 时间与任务的统一路径

- 时间：`character.saveData.时间.{当前, 线索[], 时间轴[]}`
  - 推进：`set 时间.当前="…"` 并 `push 时间.时间轴+= {时间, 事件, 原因}`
- 任务：`character.saveData.任务.<任务ID>={阶段, 备注, 更新时间}`

示例（推进时间 + 任务阶段）
```json
{
  "set":[
    {"action":"set","key":"character.saveData.时间.当前","value":"开阳历 230 年 3 月 初六 日出"},
    {"action":"set","key":"character.saveData.任务.寻图","value":{"阶段":"等待地图","备注":"与李四约定日出前见","更新时间":"2025-09-20T05:00:00Z"}}
  ],
  "push":[
    {"action":"push","key":"character.saveData.时间.时间轴","value":{"时间":"2025-09-20T05:00:00Z","事件":"推进到日出","原因":"对话约定"}}
  ]
}
```

---

## 8. 审计与回滚

- 建议解析器为每条命令记录审计日志：`{opId, time, actor:'AI', action, key, before, after, options}`
- 出错策略：单条失败即回滚该条；批内可 `options.transaction:true`（全部成功或全部回滚）
