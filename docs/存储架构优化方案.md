# å­˜å‚¨æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ - è§£å†³Tokençˆ†ç‚¸é—®é¢˜

## é—®é¢˜è¯Šæ–­

### 1. å½“å‰æ¶æ„çš„Tokenæ¶ˆè€—åˆ†æ

**å®Œæ•´SaveDataç»“æ„å¤§å°ä¼°ç®—**:
```
- ç©å®¶è§’è‰²çŠ¶æ€: ~2000 tokens
- äººç‰©å…³ç³» (10+ NPCs): ~5000 tokens
- èƒŒåŒ…ç‰©å“ (20+ items): ~3000 tokens
- ä¸‰åƒå¤§é“ç³»ç»Ÿ: ~2000 tokens
- ä¸–ç•Œä¿¡æ¯: ~4000 tokens
- ä¿®ç‚¼åŠŸæ³• + è£…å¤‡æ : ~1000 tokens
- è®°å¿†ç³»ç»Ÿ: ~3000 tokens
--------------------------------------
æ€»è®¡: ~20,000 tokens (æ¯æ¬¡AIè¯·æ±‚)
```

**å½“å‰é—®é¢˜**:
1. âŒ æ¯æ¬¡AIè¯·æ±‚éƒ½å‘é€å®Œæ•´SaveData (~20,000 tokens)
2. âŒ `syncToTavernAndSave()` ä»ç„¶æ•´ä½“è¯»å†™ (~20,000 tokens)
3. âŒ åµŒå¥—è·¯å¾„ `character.saveData.ç©å®¶è§’è‰²çŠ¶æ€.å¢ƒç•Œ.åç§°` é‡å¤å‰ç¼€
4. âŒ AIæŒ‡ä»¤ä¹Ÿä½¿ç”¨å®Œæ•´è·¯å¾„ï¼Œå¢åŠ å“åº”token

### 2. æ ¹æœ¬åŸå› 

**å­˜å‚¨ç»“æ„è®¾è®¡ç¼ºé™·**:
```typescript
// å½“å‰: æ‰€æœ‰æ•°æ®åµŒå¥—åœ¨ä¸€ä¸ªå·¨å¤§å¯¹è±¡ä¸‹
character.saveData = {
  ç©å®¶è§’è‰²çŠ¶æ€: {...},  // åµŒå¥—å¤šå±‚
  äººç‰©å…³ç³»: {...},      // åµŒå¥—å¤šå±‚
  èƒŒåŒ…: {...},          // åµŒå¥—å¤šå±‚
  // ... æ•°åä¸ªå­—æ®µ
}
```

**é—®é¢˜**:
- æ— æ³•å•ç‹¬è®¿é—®æŸä¸ªå­—æ®µè€Œä¸è¯»å–æ•´ä¸ªSaveData
- SillyTavernçš„ `getVariable()` åªèƒ½æŒ‰é¡¶å±‚keyè¯»å–
- å¯¼è‡´å³ä½¿åªéœ€è¦ä¿®æ”¹ä¸€ä¸ªæ•°å€¼ï¼Œä¹Ÿè¦ä¼ è¾“æ•´ä¸ª20k tokensçš„æ•°æ®

---

## ä¼˜åŒ–æ–¹æ¡ˆ: æ‰å¹³åŒ–å­˜å‚¨ + çœŸæ­£çš„å¢é‡æ›´æ–°

### æ–¹æ¡ˆä¸€: æ‰å¹³åŒ–Chatå˜é‡ (æ¨è)

**æ ¸å¿ƒæ€è·¯**: å°†åµŒå¥—çš„SaveDataæ‹†åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹çš„é¡¶å±‚chatå˜é‡

#### æ–°çš„å­˜å‚¨ç»“æ„

```typescript
// æ‰å¹³åŒ–å­˜å‚¨ - æ¯ä¸ªå­ç³»ç»Ÿç‹¬ç«‹å­˜å‚¨
Chatå˜é‡:
â”œâ”€ char.åŸºç¡€ä¿¡æ¯          // è§’è‰²åã€ä¸–ç•Œã€å¤©èµ„ã€çµæ ¹ (~500 tokens)
â”œâ”€ char.å¢ƒç•Œ             // å½“å‰å¢ƒç•Œã€ä¿®ä¸ºè¿›åº¦ (~200 tokens)
â”œâ”€ char.å±æ€§             // æ°”è¡€ã€çµæ°”ã€ç¥è¯†ã€å¯¿å‘½ (~300 tokens)
â”œâ”€ char.ä½ç½®             // å½“å‰ä½ç½®ã€åœ°å›¾åæ ‡ (~200 tokens)
â”œâ”€ char.çŠ¶æ€æ•ˆæœ          // å¢ç›Š/è´Ÿé¢çŠ¶æ€æ•°ç»„ (~500 tokens)
â”œâ”€ char.ä¿®ç‚¼åŠŸæ³•          // å½“å‰åŠŸæ³•ã€ç†Ÿç»ƒåº¦ã€æŠ€èƒ½ (~800 tokens)
â”œâ”€ char.è£…å¤‡æ            // 7ä¸ªè£…å¤‡æ§½ä½ (~700 tokens)
â”œâ”€ char.èƒŒåŒ…_çµçŸ³        // å››ç§çµçŸ³æ•°é‡ (~100 tokens)
â”œâ”€ char.èƒŒåŒ…_ç‰©å“        // ç‰©å“Record (~3000 tokens)
â”œâ”€ char.äººç‰©å…³ç³»         // NPCå…³ç³»Record (~5000 tokens)
â”œâ”€ char.ä¸‰åƒå¤§é“         // å¤§é“ç³»ç»Ÿ (~2000 tokens)
â”œâ”€ char.ä¸–ç•Œä¿¡æ¯         // ä¸–ç•Œæ•°æ® (~4000 tokens)
â”œâ”€ char.è®°å¿†_çŸ­æœŸ        // 5æ¡çŸ­æœŸè®°å¿† (~1000 tokens)
â”œâ”€ char.è®°å¿†_ä¸­æœŸ        // 25æ¡ä¸­æœŸè®°å¿† (~2000 tokens)
â”œâ”€ char.è®°å¿†_é•¿æœŸ        // é•¿æœŸè®°å¿† (~1000 tokens)
â””â”€ char.æ¸¸æˆæ—¶é—´         // å¹´æœˆæ—¥æ—¶åˆ† + æ€»åˆ†é’Ÿ (~100 tokens)
```

#### ä¼˜åŠ¿

1. **ç²¾å‡†è®¿é—®**: åªè¯»å–éœ€è¦çš„å­—æ®µ
   ```typescript
   // ä»…è·å–å¢ƒç•Œä¿¡æ¯ (200 tokens)
   const realm = await helper.getVariable('char.å¢ƒç•Œ', { type: 'chat' });

   // ä»…è·å–èƒŒåŒ…çµçŸ³ (100 tokens)
   const coins = await helper.getVariable('char.èƒŒåŒ…_çµçŸ³', { type: 'chat' });
   ```

2. **çœŸæ­£çš„å¢é‡æ›´æ–°**:
   ```typescript
   // åªæ›´æ–°å¢ƒç•Œï¼Œæ— éœ€è¯»å–æ•´ä¸ªSaveData
   await helper.setVariable('char.å¢ƒç•Œ', newRealmData, { type: 'chat' });
   ```

3. **AIæŒ‡ä»¤è·¯å¾„ç®€åŒ–**:
   ```json
   // æ—§è·¯å¾„ (38å­—ç¬¦)
   {"key": "character.saveData.ç©å®¶è§’è‰²çŠ¶æ€.å¢ƒç•Œ.åç§°", "value": "ç­‘åŸºæœŸ"}

   // æ–°è·¯å¾„ (14å­—ç¬¦, å‡å°‘62% token)
   {"key": "char.å¢ƒç•Œ.åç§°", "value": "ç­‘åŸºæœŸ"}
   ```

4. **AIè¯·æ±‚æœ€å°åŒ–**:
   ```typescript
   // åªå‘é€ç›¸å…³å­—æ®µç»™AIï¼Œè€Œä¸æ˜¯æ•´ä¸ªSaveData
   const contextForAI = {
     åŸºç¡€ä¿¡æ¯: await helper.getVariable('char.åŸºç¡€ä¿¡æ¯'),
     å¢ƒç•Œ: await helper.getVariable('char.å¢ƒç•Œ'),
     å±æ€§: await helper.getVariable('char.å±æ€§'),
     ä½ç½®: await helper.getVariable('char.ä½ç½®'),
     // çº¦ 1200 tokensï¼Œç›¸æ¯”20000 tokenså‡å°‘94%
   };
   ```

#### å®æ–½æ­¥éª¤

**1. åˆ›å»ºæ•°æ®åˆ†ç‰‡å·¥å…· `src/utils/storageSharding.ts`**

```typescript
/**
 * SaveDataåˆ†ç‰‡å­˜å‚¨å·¥å…·
 * å°†å·¨å¤§çš„SaveDataæ‹†åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹çš„chatå˜é‡
 */

import type { SaveData } from '@/types/game';
import type { TavernHelper } from './tavernCore';

// å®šä¹‰åˆ†ç‰‡ç»“æ„
export interface StorageShards {
  'char.åŸºç¡€ä¿¡æ¯': {
    åå­—: string;
    ä¸–ç•Œ: string;
    å¤©èµ„: string;
    å‡ºç”Ÿ: string;
    çµæ ¹: any;
    å¤©èµ‹: any[];
    å…ˆå¤©å…­å¸: Record<string, number>;
  };
  'char.å¢ƒç•Œ': {
    åç§°: string;
    é˜¶æ®µ: number;
    å½“å‰è¿›åº¦: number;
    ä¸‹ä¸€çº§æ‰€éœ€: number;
  };
  'char.å±æ€§': {
    æ°”è¡€: { å½“å‰: number; ä¸Šé™: number };
    çµæ°”: { å½“å‰: number; ä¸Šé™: number };
    ç¥è¯†: { å½“å‰: number; ä¸Šé™: number };
  };
  'char.ä½ç½®': {
    æè¿°: string;
    åŒºåŸŸ: string;
    åæ ‡?: { x: number; y: number };
  };
  'char.ä¿®ç‚¼åŠŸæ³•': SaveData['ä¿®ç‚¼åŠŸæ³•'];
  'char.è£…å¤‡æ ': SaveData['è£…å¤‡æ '];
  'char.èƒŒåŒ…_çµçŸ³': SaveData['èƒŒåŒ…']['çµçŸ³'];
  'char.èƒŒåŒ…_ç‰©å“': SaveData['èƒŒåŒ…']['ç‰©å“'];
  'char.äººç‰©å…³ç³»': SaveData['äººç‰©å…³ç³»'];
  'char.ä¸‰åƒå¤§é“': SaveData['ä¸‰åƒå¤§é“'];
  'char.ä¸–ç•Œä¿¡æ¯': SaveData['ä¸–ç•Œä¿¡æ¯'];
  'char.è®°å¿†_çŸ­æœŸ': string[];
  'char.è®°å¿†_ä¸­æœŸ': string[];
  'char.è®°å¿†_é•¿æœŸ': string[];
  'char.æ¸¸æˆæ—¶é—´': SaveData['æ¸¸æˆæ—¶é—´'];
  'char.çŠ¶æ€æ•ˆæœ': SaveData['ç©å®¶è§’è‰²çŠ¶æ€']['çŠ¶æ€æ•ˆæœ'];
  'char.å¯¿å‘½': SaveData['ç©å®¶è§’è‰²çŠ¶æ€']['å¯¿å‘½'];
}

/**
 * å°†å®Œæ•´SaveDataæ‹†åˆ†ä¸ºåˆ†ç‰‡
 */
export function shardSaveData(saveData: SaveData): StorageShards {
  return {
    'char.åŸºç¡€ä¿¡æ¯': {
      åå­—: saveData.è§’è‰²åŸºç¡€ä¿¡æ¯.åå­—,
      ä¸–ç•Œ: saveData.è§’è‰²åŸºç¡€ä¿¡æ¯.ä¸–ç•Œ,
      å¤©èµ„: saveData.è§’è‰²åŸºç¡€ä¿¡æ¯.å¤©èµ„,
      å‡ºç”Ÿ: saveData.è§’è‰²åŸºç¡€ä¿¡æ¯.å‡ºç”Ÿ,
      çµæ ¹: saveData.è§’è‰²åŸºç¡€ä¿¡æ¯.çµæ ¹,
      å¤©èµ‹: saveData.è§’è‰²åŸºç¡€ä¿¡æ¯.å¤©èµ‹,
      å…ˆå¤©å…­å¸: saveData.è§’è‰²åŸºç¡€ä¿¡æ¯.å…ˆå¤©å…­å¸,
    },
    'char.å¢ƒç•Œ': saveData.ç©å®¶è§’è‰²çŠ¶æ€.å¢ƒç•Œ,
    'char.å±æ€§': {
      æ°”è¡€: saveData.ç©å®¶è§’è‰²çŠ¶æ€.æ°”è¡€,
      çµæ°”: saveData.ç©å®¶è§’è‰²çŠ¶æ€.çµæ°”,
      ç¥è¯†: saveData.ç©å®¶è§’è‰²çŠ¶æ€.ç¥è¯†,
    },
    'char.ä½ç½®': saveData.ç©å®¶è§’è‰²çŠ¶æ€.ä½ç½®,
    'char.ä¿®ç‚¼åŠŸæ³•': saveData.ä¿®ç‚¼åŠŸæ³•,
    'char.è£…å¤‡æ ': saveData.è£…å¤‡æ ,
    'char.èƒŒåŒ…_çµçŸ³': saveData.èƒŒåŒ….çµçŸ³,
    'char.èƒŒåŒ…_ç‰©å“': saveData.èƒŒåŒ….ç‰©å“,
    'char.äººç‰©å…³ç³»': saveData.äººç‰©å…³ç³»,
    'char.ä¸‰åƒå¤§é“': saveData.ä¸‰åƒå¤§é“ || { å·²è§£é”å¤§é“: [], å¤§é“è¿›åº¦: {}, å¤§é“è·¯å¾„å®šä¹‰: {} },
    'char.ä¸–ç•Œä¿¡æ¯': saveData.ä¸–ç•Œä¿¡æ¯,
    'char.è®°å¿†_çŸ­æœŸ': saveData.è®°å¿†.çŸ­æœŸè®°å¿†,
    'char.è®°å¿†_ä¸­æœŸ': saveData.è®°å¿†.ä¸­æœŸè®°å¿†,
    'char.è®°å¿†_é•¿æœŸ': saveData.è®°å¿†.é•¿æœŸè®°å¿†,
    'char.æ¸¸æˆæ—¶é—´': saveData.æ¸¸æˆæ—¶é—´,
    'char.çŠ¶æ€æ•ˆæœ': saveData.ç©å®¶è§’è‰²çŠ¶æ€.çŠ¶æ€æ•ˆæœ,
    'char.å¯¿å‘½': saveData.ç©å®¶è§’è‰²çŠ¶æ€.å¯¿å‘½,
  };
}

/**
 * ä»åˆ†ç‰‡é‡ç»„å®Œæ•´SaveData
 */
export function assembleSaveData(shards: Partial<StorageShards>): SaveData {
  // æ„å»ºå®Œæ•´SaveDataç»“æ„
  const saveData: SaveData = {
    è§’è‰²åŸºç¡€ä¿¡æ¯: shards['char.åŸºç¡€ä¿¡æ¯']!,
    ç©å®¶è§’è‰²çŠ¶æ€: {
      åå­—: shards['char.åŸºç¡€ä¿¡æ¯']!.åå­—,
      å¢ƒç•Œ: shards['char.å¢ƒç•Œ']!,
      æ°”è¡€: shards['char.å±æ€§']!.æ°”è¡€,
      çµæ°”: shards['char.å±æ€§']!.çµæ°”,
      ç¥è¯†: shards['char.å±æ€§']!.ç¥è¯†,
      ä½ç½®: shards['char.ä½ç½®']!,
      çŠ¶æ€æ•ˆæœ: shards['char.çŠ¶æ€æ•ˆæœ']!,
      å¯¿å‘½: shards['char.å¯¿å‘½']!,
    },
    ä¿®ç‚¼åŠŸæ³•: shards['char.ä¿®ç‚¼åŠŸæ³•']!,
    è£…å¤‡æ : shards['char.è£…å¤‡æ ']!,
    èƒŒåŒ…: {
      çµçŸ³: shards['char.èƒŒåŒ…_çµçŸ³']!,
      ç‰©å“: shards['char.èƒŒåŒ…_ç‰©å“']!,
    },
    äººç‰©å…³ç³»: shards['char.äººç‰©å…³ç³»']!,
    ä¸‰åƒå¤§é“: shards['char.ä¸‰åƒå¤§é“']!,
    ä¸–ç•Œä¿¡æ¯: shards['char.ä¸–ç•Œä¿¡æ¯']!,
    è®°å¿†: {
      çŸ­æœŸè®°å¿†: shards['char.è®°å¿†_çŸ­æœŸ']!,
      ä¸­æœŸè®°å¿†: shards['char.è®°å¿†_ä¸­æœŸ']!,
      é•¿æœŸè®°å¿†: shards['char.è®°å¿†_é•¿æœŸ']!,
    },
    æ¸¸æˆæ—¶é—´: shards['char.æ¸¸æˆæ—¶é—´']!,
  };

  return saveData;
}

/**
 * ä¿å­˜æ‰€æœ‰åˆ†ç‰‡åˆ°é…’é¦†
 */
export async function saveAllShards(
  shards: StorageShards,
  helper: TavernHelper
): Promise<void> {
  const vars: Record<string, unknown> = {};
  for (const [key, value] of Object.entries(shards)) {
    vars[key] = value;
  }
  await helper.insertOrAssignVariables(vars, { type: 'chat' });
  console.log('[åˆ†ç‰‡å­˜å‚¨] å·²ä¿å­˜æ‰€æœ‰åˆ†ç‰‡');
}

/**
 * ä»é…’é¦†åŠ è½½æ‰€æœ‰åˆ†ç‰‡
 */
export async function loadAllShards(helper: TavernHelper): Promise<Partial<StorageShards>> {
  const allVars = await helper.getVariables({ type: 'chat' });
  const shards: Partial<StorageShards> = {};

  for (const key of Object.keys({} as StorageShards)) {
    if (allVars[key]) {
      (shards as any)[key] = allVars[key];
    }
  }

  console.log('[åˆ†ç‰‡å­˜å‚¨] å·²åŠ è½½åˆ†ç‰‡æ•°é‡:', Object.keys(shards).length);
  return shards;
}

/**
 * å¢é‡æ›´æ–°å•ä¸ªåˆ†ç‰‡
 */
export async function updateShard<K extends keyof StorageShards>(
  key: K,
  value: StorageShards[K],
  helper: TavernHelper
): Promise<void> {
  await helper.setVariable(key, value, { type: 'chat' });
  console.log(`[åˆ†ç‰‡å­˜å‚¨] å·²æ›´æ–°åˆ†ç‰‡: ${key}`);
}

/**
 * æ‰¹é‡æ›´æ–°å¤šä¸ªåˆ†ç‰‡
 */
export async function updateShards(
  updates: Partial<StorageShards>,
  helper: TavernHelper
): Promise<void> {
  const vars: Record<string, unknown> = {};
  for (const [key, value] of Object.entries(updates)) {
    vars[key] = value;
  }
  await helper.insertOrAssignVariables(vars, { type: 'chat' });
  console.log(`[åˆ†ç‰‡å­˜å‚¨] å·²æ‰¹é‡æ›´æ–° ${Object.keys(updates).length} ä¸ªåˆ†ç‰‡`);
}

/**
 * è·¯å¾„æ˜ å°„: æ—§è·¯å¾„ -> æ–°åˆ†ç‰‡è·¯å¾„
 * ç”¨äºè¿ç§»æ—§çš„tavern_commands
 */
export function mapOldPathToShard(oldPath: string): {
  shardKey: keyof StorageShards;
  subPath: string;
} | null {
  // ç§»é™¤ character.saveData. å‰ç¼€
  const cleanPath = oldPath.replace(/^character\.saveData\./, '');

  // æ˜ å°„è§„åˆ™
  if (cleanPath.startsWith('è§’è‰²åŸºç¡€ä¿¡æ¯.')) {
    return { shardKey: 'char.åŸºç¡€ä¿¡æ¯', subPath: cleanPath.substring('è§’è‰²åŸºç¡€ä¿¡æ¯.'.length) };
  }
  if (cleanPath.startsWith('ç©å®¶è§’è‰²çŠ¶æ€.å¢ƒç•Œ')) {
    return { shardKey: 'char.å¢ƒç•Œ', subPath: cleanPath.substring('ç©å®¶è§’è‰²çŠ¶æ€.å¢ƒç•Œ.'.length) };
  }
  if (cleanPath.startsWith('ç©å®¶è§’è‰²çŠ¶æ€.æ°”è¡€') || cleanPath.startsWith('ç©å®¶è§’è‰²çŠ¶æ€.çµæ°”') || cleanPath.startsWith('ç©å®¶è§’è‰²çŠ¶æ€.ç¥è¯†')) {
    return { shardKey: 'char.å±æ€§', subPath: cleanPath.substring('ç©å®¶è§’è‰²çŠ¶æ€.'.length) };
  }
  if (cleanPath.startsWith('ç©å®¶è§’è‰²çŠ¶æ€.ä½ç½®')) {
    return { shardKey: 'char.ä½ç½®', subPath: cleanPath.substring('ç©å®¶è§’è‰²çŠ¶æ€.ä½ç½®.'.length) };
  }
  if (cleanPath.startsWith('ç©å®¶è§’è‰²çŠ¶æ€.çŠ¶æ€æ•ˆæœ')) {
    return { shardKey: 'char.çŠ¶æ€æ•ˆæœ', subPath: cleanPath.substring('ç©å®¶è§’è‰²çŠ¶æ€.çŠ¶æ€æ•ˆæœ.'.length) };
  }
  if (cleanPath.startsWith('ç©å®¶è§’è‰²çŠ¶æ€.å¯¿å‘½')) {
    return { shardKey: 'char.å¯¿å‘½', subPath: cleanPath.substring('ç©å®¶è§’è‰²çŠ¶æ€.å¯¿å‘½.'.length) };
  }
  if (cleanPath.startsWith('ä¿®ç‚¼åŠŸæ³•')) {
    return { shardKey: 'char.ä¿®ç‚¼åŠŸæ³•', subPath: cleanPath.substring('ä¿®ç‚¼åŠŸæ³•.'.length) };
  }
  if (cleanPath.startsWith('è£…å¤‡æ ')) {
    return { shardKey: 'char.è£…å¤‡æ ', subPath: cleanPath.substring('è£…å¤‡æ .'.length) };
  }
  if (cleanPath.startsWith('èƒŒåŒ….çµçŸ³')) {
    return { shardKey: 'char.èƒŒåŒ…_çµçŸ³', subPath: cleanPath.substring('èƒŒåŒ….çµçŸ³.'.length) };
  }
  if (cleanPath.startsWith('èƒŒåŒ….ç‰©å“')) {
    return { shardKey: 'char.èƒŒåŒ…_ç‰©å“', subPath: cleanPath.substring('èƒŒåŒ….ç‰©å“.'.length) };
  }
  if (cleanPath.startsWith('äººç‰©å…³ç³»')) {
    return { shardKey: 'char.äººç‰©å…³ç³»', subPath: cleanPath.substring('äººç‰©å…³ç³».'.length) };
  }
  if (cleanPath.startsWith('ä¸‰åƒå¤§é“')) {
    return { shardKey: 'char.ä¸‰åƒå¤§é“', subPath: cleanPath.substring('ä¸‰åƒå¤§é“.'.length) };
  }
  if (cleanPath.startsWith('ä¸–ç•Œä¿¡æ¯')) {
    return { shardKey: 'char.ä¸–ç•Œä¿¡æ¯', subPath: cleanPath.substring('ä¸–ç•Œä¿¡æ¯.'.length) };
  }
  if (cleanPath.startsWith('è®°å¿†.çŸ­æœŸè®°å¿†')) {
    return { shardKey: 'char.è®°å¿†_çŸ­æœŸ', subPath: '' };
  }
  if (cleanPath.startsWith('è®°å¿†.ä¸­æœŸè®°å¿†')) {
    return { shardKey: 'char.è®°å¿†_ä¸­æœŸ', subPath: '' };
  }
  if (cleanPath.startsWith('è®°å¿†.é•¿æœŸè®°å¿†')) {
    return { shardKey: 'char.è®°å¿†_é•¿æœŸ', subPath: '' };
  }
  if (cleanPath.startsWith('æ¸¸æˆæ—¶é—´')) {
    return { shardKey: 'char.æ¸¸æˆæ—¶é—´', subPath: cleanPath.substring('æ¸¸æˆæ—¶é—´.'.length) };
  }

  return null;
}
```

**2. ä¿®æ”¹ `characterStore.ts` ä½¿ç”¨åˆ†ç‰‡å­˜å‚¨**

```typescript
// å…³é”®ä¿®æ”¹ç‚¹:

// syncToTavernAndSave - ä½¿ç”¨åˆ†ç‰‡å¢é‡æ›´æ–°
const syncToTavernAndSave = async (options?: {
  fullSync?: boolean;
  changedPaths?: string[]
}): Promise<void> => {
  // ... å‰ç½®æ£€æŸ¥ ...

  const helper = getTavernHelper();
  if (!helper) return;

  const fullSync = options?.fullSync ?? false;
  const changedPaths = options?.changedPaths;

  if (fullSync) {
    // å®Œæ•´åŒæ­¥: ä¿å­˜æ‰€æœ‰åˆ†ç‰‡
    const shards = shardSaveData(slot.å­˜æ¡£æ•°æ®!);
    await saveAllShards(shards, helper);
  } else if (changedPaths && changedPaths.length > 0) {
    // å¢é‡åŒæ­¥: åªæ›´æ–°å˜åŒ–çš„åˆ†ç‰‡
    const updates: Partial<StorageShards> = {};

    for (const path of changedPaths) {
      const mapping = mapOldPathToShard(path);
      if (mapping) {
        // è·å–å¯¹åº”åˆ†ç‰‡çš„å®Œæ•´æ•°æ®
        const shardData = getShardFromSaveData(slot.å­˜æ¡£æ•°æ®!, mapping.shardKey);
        updates[mapping.shardKey] = shardData;
      }
    }

    await updateShards(updates, helper);
    console.log(`[åŒæ­¥] å¢é‡æ›´æ–°äº† ${Object.keys(updates).length} ä¸ªåˆ†ç‰‡`);
  }

  // ... åç»­ä¿å­˜æœ¬åœ°é€»è¾‘ ...
};

// syncFromTavern - ä»åˆ†ç‰‡åŠ è½½
const syncFromTavern = async () => {
  const helper = getTavernHelper();
  if (!helper) return;

  // åŠ è½½æ‰€æœ‰åˆ†ç‰‡
  const shards = await loadAllShards(helper);

  // é‡ç»„ä¸ºå®Œæ•´SaveData
  const saveData = assembleSaveData(shards as StorageShards);

  // æ›´æ–°æœ¬åœ°å­˜æ¡£
  slot.å­˜æ¡£æ•°æ® = saveData;
  await commitToStorage();
};
```

**3. ä¿®æ”¹AIæç¤ºè¯ä½¿ç”¨ç²¾ç®€ä¸Šä¸‹æ–‡**

```typescript
// src/utils/generators/gameMasterGenerators.ts

export async function generateInGameResponse(
  currentGameData: any,
  userAction: string,
  useStreaming?: boolean,
  onStreamChunk?: (chunk: string) => void
): Promise<GM_Response> {
  const helper = getTavernHelper();

  // ğŸ”¥ åªåŠ è½½å¿…è¦çš„åˆ†ç‰‡ï¼Œè€Œä¸æ˜¯å®Œæ•´SaveData
  const minimalContext = {
    åŸºç¡€ä¿¡æ¯: await helper.getVariable('char.åŸºç¡€ä¿¡æ¯', { type: 'chat' }),
    å¢ƒç•Œ: await helper.getVariable('char.å¢ƒç•Œ', { type: 'chat' }),
    å±æ€§: await helper.getVariable('char.å±æ€§', { type: 'chat' }),
    ä½ç½®: await helper.getVariable('char.ä½ç½®', { type: 'chat' }),
    ä¿®ç‚¼åŠŸæ³•: await helper.getVariable('char.ä¿®ç‚¼åŠŸæ³•', { type: 'chat' }),
    è£…å¤‡æ : await helper.getVariable('char.è£…å¤‡æ ', { type: 'chat' }),
    èƒŒåŒ…_çµçŸ³: await helper.getVariable('char.èƒŒåŒ…_çµçŸ³', { type: 'chat' }),
    æ¸¸æˆæ—¶é—´: await helper.getVariable('char.æ¸¸æˆæ—¶é—´', { type: 'chat' }),
    çŠ¶æ€æ•ˆæœ: await helper.getVariable('char.çŠ¶æ€æ•ˆæœ', { type: 'chat' }),
    // åªåœ¨éœ€è¦æ—¶åŠ è½½å¤§å‹æ•°æ®
    // äººç‰©å…³ç³»: ä»…å½“ç©å®¶è¡ŒåŠ¨æ¶‰åŠNPCæ—¶æ‰åŠ è½½
    // èƒŒåŒ…ç‰©å“: ä»…å½“ç©å®¶è¡ŒåŠ¨æ¶‰åŠç‰©å“æ—¶æ‰åŠ è½½
    // ä¸–ç•Œä¿¡æ¯: ä»…å½“ç©å®¶è¡ŒåŠ¨æ¶‰åŠæ¢ç´¢æ—¶æ‰åŠ è½½
  };

  // Tokenæ¶ˆè€—: çº¦1500-2000 tokens (ç›¸æ¯”åŸæ¥çš„20000 tokenså‡å°‘90%)

  const prompt = buildPromptWithMinimalContext(minimalContext, userAction);
  // ...
}
```

**4. æ›´æ–°AIæŒ‡ä»¤è·¯å¾„æ ¼å¼**

```typescript
// src/utils/prompts/inGameGMPromptsV2.ts

export const IN_GAME_MESSAGE_PROMPT = [
  // ...
  'ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¿”å›å“åº”ï¼š',
  '```json',
  '{',
  '  "text": "è¯¦ç»†å™è¿°å†…å®¹",',
  '  "mid_term_memory": "é‡è¦äº‹ä»¶æ€»ç»“",',
  '  "state_changes": {...},',
  '  "tavern_commands": [',
  '    // ğŸ”¥ æ–°çš„ç®€åŒ–è·¯å¾„æ ¼å¼',
  '    {"action": "add", "key": "char.æ¸¸æˆæ—¶é—´.æ€»åˆ†é’Ÿæ•°", "value": 180},',
  '    {"action": "set", "key": "char.å¢ƒç•Œ.åç§°", "value": "ç»ƒæ°”ä¸€å±‚"},',
  '    {"action": "set", "key": "char.å±æ€§.æ°”è¡€.ä¸Šé™", "value": 150},',
  '    {"action": "delete", "key": "char.èƒŒåŒ…_ç‰©å“.æ··æ²Œé“çŸ³"}',
  '  ]',
  '}',
  '```',
  // ...
].join('\n');
```

---

### æ–¹æ¡ˆäºŒ: ä½¿ç”¨Globalå˜é‡ + å¢é‡æ›´æ–° (å¤‡é€‰)

**æ ¸å¿ƒæ€è·¯**: åˆ©ç”¨SillyTavernçš„Globalå˜é‡ç³»ç»Ÿï¼Œé…åˆSTScriptå‘½ä»¤

```typescript
// ä½¿ç”¨Globalå˜é‡å­˜å‚¨å¸¸ç”¨æ•°æ®
await helper.setGlobalVariable('player_realm', realmData);
await helper.setGlobalVariable('player_stats', statsData);

// STScriptå¢é‡æ›´æ–° (å¯åœ¨AIå“åº”ä¸­ç›´æ¥ä½¿ç”¨)
/setglobalvar key=player_realm.å½“å‰è¿›åº¦ 150
/addvar key=player_stats.æ°”è¡€.å½“å‰ -50
```

**ä¼˜åŠ¿**: STScriptå‘½ä»¤å¯ä»¥ç›´æ¥åœ¨AIçš„textå­—æ®µä¸­è¿”å›å¹¶è‡ªåŠ¨æ‰§è¡Œ

**åŠ£åŠ¿**: Globalå˜é‡è·¨è§’è‰²å…±äº«ï¼Œä¸é€‚åˆå¤šè§’è‰²åœºæ™¯

---

## TokenèŠ‚çœæ•ˆæœé¢„ä¼°

### ä¼˜åŒ–å‰ (å½“å‰æ¶æ„)

```
AIè¯·æ±‚:
- å®Œæ•´SaveData: 20,000 tokens
- æç¤ºè¯: 2,000 tokens
- ç”¨æˆ·è¾“å…¥: 200 tokens
- æ€»è®¡: 22,200 tokens/æ¬¡

AIå“åº”:
- å™è¿°æ–‡æœ¬: 1,500 tokens
- tavern_commands (å®Œæ•´è·¯å¾„): 500 tokens
- æ€»è®¡: 2,000 tokens/æ¬¡

å¾€è¿”æ€»è®¡: 24,200 tokens/æ¬¡
```

### ä¼˜åŒ–å (æ‰å¹³åŒ–åˆ†ç‰‡)

```
AIè¯·æ±‚:
- ç²¾ç®€ä¸Šä¸‹æ–‡ (ä»…å¿…è¦åˆ†ç‰‡): 1,500 tokens â¬‡ï¸ å‡å°‘92.5%
- æç¤ºè¯: 1,500 tokens â¬‡ï¸ å‡å°‘25% (è·¯å¾„ç¤ºä¾‹æ›´çŸ­)
- ç”¨æˆ·è¾“å…¥: 200 tokens
- æ€»è®¡: 3,200 tokens/æ¬¡ â¬‡ï¸ å‡å°‘85.6%

AIå“åº”:
- å™è¿°æ–‡æœ¬: 1,500 tokens
- tavern_commands (ç®€åŒ–è·¯å¾„): 200 tokens â¬‡ï¸ å‡å°‘60%
- æ€»è®¡: 1,700 tokens/æ¬¡ â¬‡ï¸ å‡å°‘15%

å¾€è¿”æ€»è®¡: 4,900 tokens/æ¬¡ â¬‡ï¸ å‡å°‘79.8%
```

**èŠ‚çœ**: æ¯æ¬¡å¯¹è¯èŠ‚çœçº¦ **19,300 tokens**ï¼Œå¦‚æœæ¯å±€æ¸¸æˆ100è½®å¯¹è¯ï¼Œå…±èŠ‚çœ **1,930,000 tokens**

---

## è¿ç§»è®¡åˆ’

### é˜¶æ®µ1: å…¼å®¹å±‚ (1-2å¤©)

1. åˆ›å»º `storageSharding.ts` å·¥å…·
2. åœ¨ `characterStore.ts` ä¸­æ·»åŠ åˆ†ç‰‡è½¬æ¢é€»è¾‘
3. ä¿æŒå‘åå…¼å®¹ï¼Œæ–°å­˜æ¡£ä½¿ç”¨åˆ†ç‰‡ï¼Œæ—§å­˜æ¡£è‡ªåŠ¨è¿ç§»

### é˜¶æ®µ2: æ ¸å¿ƒæ”¹é€  (2-3å¤©)

1. ä¿®æ”¹ `syncToTavernAndSave` ä½¿ç”¨åˆ†ç‰‡ä¿å­˜
2. ä¿®æ”¹ `syncFromTavern` ä»åˆ†ç‰‡åŠ è½½
3. æ›´æ–° `setActiveCharacterInTavern` åˆå§‹åŒ–æ‰€æœ‰åˆ†ç‰‡

### é˜¶æ®µ3: AIé›†æˆ (2-3å¤©)

1. ä¿®æ”¹ `gameMasterGenerators.ts` ä½¿ç”¨ç²¾ç®€ä¸Šä¸‹æ–‡
2. æ›´æ–° `inGameGMPromptsV2.ts` æç¤ºè¯ä¸­çš„è·¯å¾„ç¤ºä¾‹
3. ä¿®æ”¹ `AIGameMaster.ts` å¤„ç†æ–°çš„ç®€åŒ–è·¯å¾„æ ¼å¼

### é˜¶æ®µ4: æµ‹è¯•éªŒè¯ (1-2å¤©)

1. åˆ›å»ºtokenè®¡æ•°å·¥å…·ï¼Œæµ‹é‡ä¼˜åŒ–æ•ˆæœ
2. å®Œæ•´æ¸¸æˆæµç¨‹æµ‹è¯•
3. æ—§å­˜æ¡£è¿ç§»æµ‹è¯•

---

## é£é™©è¯„ä¼°

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| æ—§å­˜æ¡£ä¸å…¼å®¹ | é«˜ | å®ç°è‡ªåŠ¨è¿ç§»é€»è¾‘ + å¤‡ä»½æç¤º |
| åˆ†ç‰‡ä¸å®Œæ•´ | ä¸­ | æ·»åŠ å®Œæ•´æ€§æ ¡éªŒï¼Œç¼ºå¤±åˆ†ç‰‡è‡ªåŠ¨è¡¥å…¨ |
| AIè·¯å¾„æ ¼å¼é”™è¯¯ | ä¸­ | ä¿ç•™æ—§æ ¼å¼å…¼å®¹å±‚ï¼Œè‡ªåŠ¨è½¬æ¢ |
| æ€§èƒ½ä¸‹é™ | ä½ | æ‰¹é‡è¯»å†™ä¼˜åŒ–ï¼Œç¼“å­˜å¸¸ç”¨åˆ†ç‰‡ |

---

## å¼€å‘ä¼˜å…ˆçº§

âœ… **ç«‹å³æ‰§è¡Œ**:
1. åˆ›å»º `storageSharding.ts`
2. å®ç°åˆ†ç‰‡è½¬æ¢å’ŒåŠ è½½é€»è¾‘
3. ä¿®æ”¹ `syncToTavernAndSave` å’Œ `syncFromTavern`

â° **ä¸‹ä¸€æ­¥**:
4. æ›´æ–°AIç”Ÿæˆå™¨ä½¿ç”¨ç²¾ç®€ä¸Šä¸‹æ–‡
5. ä¿®æ”¹æç¤ºè¯è·¯å¾„æ ¼å¼

ğŸ” **åç»­ä¼˜åŒ–**:
6. å®ç°æ™ºèƒ½åˆ†ç‰‡æŒ‰éœ€åŠ è½½ (å¦‚åªåœ¨éœ€è¦æ—¶åŠ è½½äººç‰©å…³ç³»)
7. æ·»åŠ åˆ†ç‰‡ç¼“å­˜æœºåˆ¶
8. å®ç°åˆ†ç‰‡å‹ç¼©å­˜å‚¨
